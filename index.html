<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <meta name="description" content="LEXORA - برنامه هوشمند یادگیری زبان با الگوریتم FSRS">
    
    <title>LEXORA | یادگیری هوشمند زبان</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="icon" type="image/png" href="icon-192.png">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        /* ═══════════════════════════════════════════════════════════════
           ROOT VARIABLES & RESET
           ═══════════════════════════════════════════════════════════════ */
        :root {
            /* Colors - Dark Theme */
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --bg-card: #1e293b;
            
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-tertiary: #64748b;
            
            --primary: #6366f1;
            --primary-light: #818cf8;
            --primary-dark: #4f46e5;
            --primary-glow: rgba(99, 102, 241, 0.3);
            
            --secondary: #8b5cf6;
            --accent: #06b6d4;
            
            --success: #10b981;
            --success-light: #34d399;
            --warning: #f59e0b;
            --danger: #ef4444;
            
            --gradient-primary: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --gradient-secondary: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);
            --gradient-success: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            --gradient-gold: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
            
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);
            --shadow-glow: 0 0 20px var(--primary-glow);
            
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-full: 9999px;
            
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            --nav-height: 70px;
            
            --font-family: 'Vazirmatn', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        /* Light Theme */
        [data-theme="light"] {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e2e8f0;
            --bg-card: #ffffff;
            
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-tertiary: #94a3b8;
            
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.16);
        }

        /* Reset */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            font-size: 16px;
            -webkit-text-size-adjust: 100%;
        }

        body {
            font-family: var(--font-family);
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
            padding-bottom: calc(var(--nav-height) + var(--safe-bottom));
        }

        /* ═══════════════════════════════════════════════════════════════
           APP CONTAINER & SCREENS
           ═══════════════════════════════════════════════════════════════ */
        .app-container {
            max-width: 100%;
            min-height: 100vh;
            min-height: 100dvh;
            position: relative;
        }

        .screen {
            display: none;
            padding: 20px;
            padding-top: calc(var(--safe-top) + 20px);
            padding-bottom: 100px;
            animation: fadeIn 0.3s ease;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ═══════════════════════════════════════════════════════════════
           BOTTOM NAVIGATION
           ═══════════════════════════════════════════════════════════════ */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--nav-height);
            background: var(--bg-secondary);
            border-top: 1px solid var(--bg-tertiary);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding-bottom: var(--safe-bottom);
            z-index: 1000;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            border-radius: var(--radius-md);
            transition: all 0.3s ease;
            cursor: pointer;
            -webkit-user-select: none;
            user-select: none;
            position: relative;
        }

        .nav-item:active {
            transform: scale(0.92);
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 3px;
            background: var(--primary);
            border-radius: 0 0 4px 4px;
        }

        .nav-icon {
            font-size: 24px;
            margin-bottom: 2px;
            transition: transform 0.3s ease;
        }

        .nav-item.active .nav-icon {
            transform: scale(1.1);
        }

        .nav-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-tertiary);
            transition: color 0.3s ease;
        }

        .nav-item.active .nav-label {
            color: var(--primary);
        }

        .nav-badge {
            position: absolute;
            top: 2px;
            right: 8px;
            background: var(--danger);
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: var(--radius-full);
            min-width: 18px;
            text-align: center;
        }

        /* ═══════════════════════════════════════════════════════════════
           HERO SECTION (HOME)
           ═══════════════════════════════════════════════════════════════ */
        .hero-section {
            background: var(--gradient-primary);
            border-radius: var(--radius-xl);
            padding: 24px;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
        }

        .hero-section::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            pointer-events: none;
        }

        .hero-greeting {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 4px;
        }

        .hero-title {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 16px;
        }

        .hero-stats {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .hero-stat {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.15);
            padding: 8px 14px;
            border-radius: var(--radius-full);
            font-size: 14px;
            font-weight: 600;
        }

        .hero-stat-icon {
            font-size: 18px;
        }

        /* XP Bar */
        .xp-bar-container {
            margin-top: 16px;
            background: rgba(255,255,255,0.15);
            border-radius: var(--radius-full);
            padding: 4px;
        }

        .xp-bar {
            height: 8px;
            background: rgba(255,255,255,0.3);
            border-radius: var(--radius-full);
            overflow: hidden;
        }

        .xp-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #fbbf24, #f59e0b);
            border-radius: var(--radius-full);
            transition: width 0.5s ease;
        }

        .xp-bar-text {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            margin-top: 6px;
            opacity: 0.9;
        }

        /* ═══════════════════════════════════════════════════════════════
           DAILY PROGRESS RING
           ═══════════════════════════════════════════════════════════════ */
        .progress-card {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-md);
        }

        .progress-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .progress-title {
            font-size: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .progress-content {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .progress-ring-container {
            position: relative;
            width: 100px;
            height: 100px;
            flex-shrink: 0;
        }

        .progress-ring {
            transform: rotate(-90deg);
            width: 100px;
            height: 100px;
        }

        .progress-ring-bg {
            fill: none;
            stroke: var(--bg-tertiary);
            stroke-width: 8;
        }

        .progress-ring-fill {
            fill: none;
            stroke: url(#progressGradient);
            stroke-width: 8;
            stroke-linecap: round;
            stroke-dasharray: 251.2;
            stroke-dashoffset: 251.2;
            transition: stroke-dashoffset 1s ease;
        }

        .progress-ring-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .progress-percent {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary);
        }

        .progress-details {
            flex: 1;
        }

        .progress-detail-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--bg-tertiary);
            font-size: 14px;
        }

        .progress-detail-item:last-child {
            border-bottom: none;
        }

        .progress-detail-label {
            color: var(--text-secondary);
        }

        .progress-detail-value {
            font-weight: 700;
        }

        /* ═══════════════════════════════════════════════════════════════
           STREAK SECTION
           ═══════════════════════════════════════════════════════════════ */
        .streak-card {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-md);
        }

        .streak-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .streak-title {
            font-size: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .streak-count {
            font-size: 28px;
            font-weight: 800;
            color: var(--warning);
        }

        .streak-days {
            display: flex;
            justify-content: space-between;
            gap: 8px;
        }

        .streak-day {
            flex: 1;
            aspect-ratio: 1;
            max-width: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            color: var(--text-tertiary);
            transition: all 0.3s ease;
        }

        .streak-day.completed {
            background: var(--gradient-gold);
            color: white;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);
        }

        .streak-day.today {
            border: 2px solid var(--primary);
        }

        /* ═══════════════════════════════════════════════════════════════
           ACTION BUTTONS GRID
           ═══════════════════════════════════════════════════════════════ */
        .action-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 16px 8px;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            box-shadow: var(--shadow-sm);
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        .action-btn-icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
        }

        .action-btn-text {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-align: center;
        }

        /* ═══════════════════════════════════════════════════════════════
           SECTION TITLES
           ═══════════════════════════════════════════════════════════════ */
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-link {
            font-size: 14px;
            color: var(--primary);
            font-weight: 600;
            cursor: pointer;
        }

        /* ═══════════════════════════════════════════════════════════════
           DECK CARDS
           ═══════════════════════════════════════════════════════════════ */
        .decks-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .deck-card {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
            border: 1px solid transparent;
        }

        .deck-card:active {
            transform: scale(0.98);
        }

        .deck-card:hover {
            border-color: var(--primary);
        }

        .deck-icon {
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            flex-shrink: 0;
        }

        .deck-info {
            flex: 1;
            min-width: 0;
        }

        .deck-name {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .deck-meta {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .deck-stats {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .deck-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 6px 10px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            min-width: 44px;
        }

        .deck-stat-value {
            font-size: 16px;
            font-weight: 700;
        }

        .deck-stat-label {
            font-size: 10px;
            color: var(--text-tertiary);
        }

        .deck-stat.new .deck-stat-value { color: var(--accent); }
        .deck-stat.due .deck-stat-value { color: var(--warning); }
        .deck-stat.done .deck-stat-value { color: var(--success); }

        /* ═══════════════════════════════════════════════════════════════
           BADGES SECTION
           ═══════════════════════════════════════════════════════════════ */
        .badges-scroll {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding: 8px 0;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .badges-scroll::-webkit-scrollbar {
            display: none;
        }

        .badge-card {
            flex-shrink: 0;
            width: 80px;
            padding: 16px 8px;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
        }

        .badge-card:active {
            transform: scale(0.95);
        }

        .badge-card.locked {
            opacity: 0.5;
            filter: grayscale(1);
        }

        .badge-card.earned {
            border: 2px solid var(--warning);
        }

        .badge-card-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .badge-card-name {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        /* ═══════════════════════════════════════════════════════════════
           WORD OF THE DAY
           ═══════════════════════════════════════════════════════════════ */
        .wod-card {
            background: var(--gradient-secondary);
            border-radius: var(--radius-xl);
            padding: 24px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .wod-label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 8px;
        }

        .wod-word {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 4px;
        }

        .wod-pronunciation {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 12px;
        }

        .wod-meaning {
            font-size: 18px;
            font-weight: 600;
        }

        .wod-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .wod-btn {
            flex: 1;
            padding: 12px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: var(--radius-md);
            color: white;
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .wod-btn:active {
            transform: scale(0.95);
        }

        /* ═══════════════════════════════════════════════════════════════
           MODAL STYLES
           ═══════════════════════════════════════════════════════════════ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 2000;
            display: none;
            align-items: flex-end;
            justify-content: center;
            padding: 20px;
            padding-bottom: calc(20px + var(--safe-bottom));
        }

        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .modal-container {
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            background: var(--bg-secondary);
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease;
        }

        .modal-container.modal-large {
            max-height: 95vh;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            border-bottom: 1px solid var(--bg-tertiary);
            flex-shrink: 0;
        }

        .modal-header h2 {
            font-size: 18px;
            font-weight: 700;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border: none;
            border-radius: var(--radius-full);
            font-size: 18px;
            cursor: pointer;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .modal-close:active {
            transform: scale(0.9);
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        /* ═══════════════════════════════════════════════════════════════
           FLASHCARD MODAL
           ═══════════════════════════════════════════════════════════════ */
        .flashcard-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            z-index: 3000;
            display: none;
        }

        .flashcard-modal.active {
            display: flex;
            flex-direction: column;
        }

        .flashcard-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            padding-top: calc(var(--safe-top) + 16px);
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--bg-tertiary);
        }

        .flashcard-close {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border: none;
            border-radius: var(--radius-full);
            font-size: 20px;
            cursor: pointer;
            color: var(--text-primary);
        }

        .flashcard-progress {
            flex: 1;
            margin: 0 16px;
        }

        .flashcard-progress-bar {
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-full);
            overflow: hidden;
        }

        .flashcard-progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: var(--radius-full);
            transition: width 0.3s ease;
        }

        .flashcard-progress-text {
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
            margin-top: 4px;
        }

        .flashcard-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        /* Flashcard */
        .flashcard-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            perspective: 1000px;
        }

        .flashcard {
            width: 100%;
            max-width: 360px;
            aspect-ratio: 3/4;
            max-height: 450px;
            position: relative;
            cursor: pointer;
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .flashcard.flipped {
            transform: rotateY(180deg);
        }

        .flashcard-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            border-radius: var(--radius-xl);
            padding: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            box-shadow: var(--shadow-lg);
        }

        .flashcard-front {
            background: var(--bg-card);
            border: 2px solid var(--bg-tertiary);
        }

        .flashcard-back {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-secondary) 100%);
            border: 2px solid var(--primary);
            transform: rotateY(180deg);
        }

        .card-word {
            font-size: 36px;
            font-weight: 800;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .card-pronunciation {
            font-size: 18px;
            color: var(--primary);
            margin-bottom: 20px;
            font-family: monospace;
        }

        .card-meaning {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        .card-example {
            font-size: 16px;
            color: var(--text-secondary);
            font-style: italic;
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .card-mnemonic {
            font-size: 14px;
            color: var(--accent);
            padding: 12px;
            background: rgba(6, 182, 212, 0.1);
            border-radius: var(--radius-md);
            border: 1px dashed var(--accent);
        }

        .speak-btn {
            position: absolute;
            top: 16px;
            left: 16px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border: none;
            border-radius: var(--radius-full);
            font-size: 22px;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .speak-btn:active {
            transform: scale(0.9);
            background: var(--primary);
        }

        .star-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border: none;
            border-radius: var(--radius-full);
            font-size: 22px;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .star-btn.starred {
            background: var(--warning);
        }

        .flip-hint {
            position: absolute;
            bottom: 16px;
            font-size: 13px;
            color: var(--text-tertiary);
        }

        /* Rating Buttons */
        .rating-container {
            padding: 20px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--bg-tertiary);
            display: none;
        }

        .rating-container.active {
            display: block;
        }

        .rating-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .rating-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 14px 8px;
            background: var(--bg-tertiary);
            border: 2px solid transparent;
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .rating-btn:active {
            transform: scale(0.95);
        }

        .rating-btn.again {
            border-color: var(--danger);
            color: var(--danger);
        }

        .rating-btn.hard {
            border-color: var(--warning);
            color: var(--warning);
        }

        .rating-btn.good {
            border-color: var(--success);
            color: var(--success);
        }

        .rating-btn.easy {
            border-color: var(--accent);
            color: var(--accent);
        }

        .rating-btn:active.again { background: rgba(239, 68, 68, 0.2); }
        .rating-btn:active.hard { background: rgba(245, 158, 11, 0.2); }
        .rating-btn:active.good { background: rgba(16, 185, 129, 0.2); }
        .rating-btn:active.easy { background: rgba(6, 182, 212, 0.2); }

        .rating-label {
            font-size: 14px;
            font-weight: 700;
        }

        .rating-time {
            font-size: 11px;
            color: var(--text-tertiary);
        }

        /* ═══════════════════════════════════════════════════════════════
           COMPLETE SCREEN
           ═══════════════════════════════════════════════════════════════ */
        .complete-screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
            min-height: 100%;
        }

        .complete-screen.active {
            display: flex;
        }

        .complete-icon {
            font-size: 80px;
            margin-bottom: 24px;
            animation: bounce 0.6s ease;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .complete-title {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 12px;
        }

        .complete-message {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 32px;
        }

        .complete-stats {
            display: flex;
            gap: 24px;
            margin-bottom: 32px;
        }

        .complete-stat {
            text-align: center;
        }

        .complete-stat-value {
            font-size: 36px;
            font-weight: 800;
            color: var(--primary);
        }

        .complete-stat-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .complete-xp {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: var(--gradient-gold);
            border-radius: var(--radius-full);
            font-size: 18px;
            font-weight: 700;
            color: white;
            margin-bottom: 32px;
        }

        .complete-btn {
            width: 100%;
            max-width: 300px;
            padding: 16px;
            background: var(--gradient-primary);
            border: none;
            border-radius: var(--radius-lg);
            color: white;
            font-family: inherit;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .complete-btn:active {
            transform: scale(0.98);
        }

        /* ═══════════════════════════════════════════════════════════════
           FORMS
           ═══════════════════════════════════════════════════════════════ */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-tertiary);
            border: 2px solid transparent;
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--bg-secondary);
        }

        .form-input::placeholder {
            color: var(--text-tertiary);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* ═══════════════════════════════════════════════════════════════
           BUTTONS
           ═══════════════════════════════════════════════════════════════ */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 24px;
            border: none;
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-success {
            background: var(--gradient-success);
            color: white;
        }

        .btn-block {
            width: 100%;
        }

        .btn-sm {
            padding: 10px 16px;
            font-size: 14px;
        }

        /* ═══════════════════════════════════════════════════════════════
           TOAST NOTIFICATIONS
           ═══════════════════════════════════════════════════════════════ */
        .toast-container {
            position: fixed;
            top: calc(var(--safe-top) + 20px);
            left: 20px;
            right: 20px;
            z-index: 5000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            animation: toastIn 0.3s ease;
            pointer-events: auto;
        }

        .toast.hiding {
            animation: toastOut 0.3s ease forwards;
        }

        @keyframes toastIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes toastOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }

        .toast-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .toast-message {
            font-size: 14px;
            font-weight: 500;
            flex: 1;
        }

        .toast.success { border-right: 4px solid var(--success); }
        .toast.error { border-right: 4px solid var(--danger); }
        .toast.warning { border-right: 4px solid var(--warning); }
        .toast.info { border-right: 4px solid var(--primary); }

        /* ═══════════════════════════════════════════════════════════════
           CONFIRM DIALOG
           ═══════════════════════════════════════════════════════════════ */
        .confirm-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 4000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .confirm-overlay.active {
            display: flex;
        }

        .confirm-modal {
            width: 100%;
            max-width: 340px;
            background: var(--bg-secondary);
            border-radius: var(--radius-xl);
            overflow: hidden;
            animation: scaleIn 0.3s ease;
        }

        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .confirm-header {
            padding: 20px;
            font-size: 18px;
            font-weight: 700;
            text-align: center;
        }

        .confirm-body {
            padding: 0 20px 20px;
            text-align: center;
            color: var(--text-secondary);
        }

        .confirm-actions {
            display: flex;
            border-top: 1px solid var(--bg-tertiary);
        }

        .confirm-actions button {
            flex: 1;
            padding: 16px;
            border: none;
            background: transparent;
            font-family: inherit;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .confirm-cancel {
            color: var(--text-secondary);
            border-left: 1px solid var(--bg-tertiary);
        }

        .confirm-cancel:active {
            background: var(--bg-tertiary);
        }

        .confirm-delete {
            color: var(--danger);
        }

        .confirm-delete:active {
            background: rgba(239, 68, 68, 0.1);
        }

        /* ═══════════════════════════════════════════════════════════════
           MODE SELECTOR
           ═══════════════════════════════════════════════════════════════ */
        .mode-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 20px;
        }

        .mode-option {
            flex: 1;
            min-width: calc(50% - 6px);
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--bg-card);
            border: 2px solid var(--bg-tertiary);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-option:active {
            transform: scale(0.98);
        }

        .mode-option.selected {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .mode-option-icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            flex-shrink: 0;
        }

        .mode-option-info {
            flex: 1;
        }

        .mode-option-title {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .mode-option-desc {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* ═══════════════════════════════════════════════════════════════
           QUIZ MODE
           ═══════════════════════════════════════════════════════════════ */
        .quiz-container {
            padding: 20px;
        }

        .quiz-question {
            text-align: center;
            margin-bottom: 32px;
        }

        .quiz-word {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .quiz-pronunciation {
            font-size: 16px;
            color: var(--primary);
            font-family: monospace;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .quiz-option {
            padding: 18px 20px;
            background: var(--bg-card);
            border: 2px solid var(--bg-tertiary);
            border-radius: var(--radius-lg);
            font-size: 16px;
            font-weight: 500;
            text-align: right;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quiz-option:active {
            transform: scale(0.98);
        }

        .quiz-option.selected {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .quiz-option.correct {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.15);
        }

        .quiz-option.wrong {
            border-color: var(--danger);
            background: rgba(239, 68, 68, 0.15);
        }

        /* ═══════════════════════════════════════════════════════════════
           LISTENING MODE
           ═══════════════════════════════════════════════════════════════ */
        .listening-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
            text-align: center;
        }

        .listening-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .listening-hint {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 32px;
        }

        .listening-play-btn {
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            background: var(--gradient-primary);
            border: none;
            border-radius: var(--radius-full);
            cursor: pointer;
            margin-bottom: 32px;
            box-shadow: var(--shadow-glow);
            transition: all 0.3s ease;
        }

        .listening-play-btn:active {
            transform: scale(0.95);
        }

        .listening-input {
            width: 100%;
            max-width: 300px;
            padding: 16px 20px;
            background: var(--bg-tertiary);
            border: 2px solid var(--bg-tertiary);
            border-radius: var(--radius-lg);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 18px;
            text-align: center;
            margin-bottom: 16px;
        }

        .listening-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* ═══════════════════════════════════════════════════════════════
           SPELLING MODE
           ═══════════════════════════════════════════════════════════════ */
        .spelling-container {
            padding: 20px;
            text-align: center;
        }

        .spelling-meaning {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .spelling-hint {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 32px;
        }

        /* ═══════════════════════════════════════════════════════════════
           REVERSE MODE
           ═══════════════════════════════════════════════════════════════ */
        .reverse-meaning {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 16px;
        }

        .reverse-hint-text {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* ═══════════════════════════════════════════════════════════════
           FEEDBACK
           ═══════════════════════════════════════════════════════════════ */
        .feedback-container {
            text-align: center;
            padding: 20px;
            margin-top: 20px;
        }

        .feedback-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .feedback-text {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .feedback-correct {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .feedback-container.success .feedback-icon { color: var(--success); }
        .feedback-container.error .feedback-icon { color: var(--danger); }

        /* ═══════════════════════════════════════════════════════════════
           LIBRARY PAGE
           ═══════════════════════════════════════════════════════════════ */
        .library-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .library-title {
            font-size: 24px;
            font-weight: 800;
        }

        .library-actions {
            display: flex;
            gap: 10px;
        }

        .library-btn {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-card);
            border: none;
            border-radius: var(--radius-md);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .library-btn:active {
            transform: scale(0.9);
        }

        .library-search {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            margin-bottom: 20px;
        }

        .library-search-icon {
            font-size: 20px;
            color: var(--text-tertiary);
        }

        .library-search-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 16px;
        }

        .library-search-input:focus {
            outline: none;
        }

        .library-search-input::placeholder {
            color: var(--text-tertiary);
        }

        .library-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 4px;
        }

        .library-tab {
            padding: 10px 18px;
            background: var(--bg-card);
            border: none;
            border-radius: var(--radius-full);
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .library-tab.active {
            background: var(--primary);
            color: white;
        }

        /* Cards in Library */
        .card-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .card-item:active {
            transform: scale(0.98);
        }

        .card-item-word {
            font-size: 16px;
            font-weight: 700;
            flex: 1;
        }

        .card-item-meaning {
            font-size: 14px;
            color: var(--text-secondary);
            flex: 1;
            text-align: left;
        }

        .card-item-actions {
            display: flex;
            gap: 8px;
        }

        .card-item-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border: none;
            border-radius: var(--radius-sm);
            font-size: 16px;
            cursor: pointer;
        }

        /* ═══════════════════════════════════════════════════════════════
           STATS PAGE
           ═══════════════════════════════════════════════════════════════ */
        .stats-header {
            margin-bottom: 24px;
        }

        .stats-title {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 4px;
        }

        .stats-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow-sm);
        }

        .stat-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .stat-card.primary .stat-value { color: var(--primary); }
        .stat-card.success .stat-value { color: var(--success); }
        .stat-card.warning .stat-value { color: var(--warning); }
        .stat-card.accent .stat-value { color: var(--accent); }

        /* ═══════════════════════════════════════════════════════════════
           SETTINGS PAGE
           ═══════════════════════════════════════════════════════════════ */
        .settings-header {
            margin-bottom: 24px;
        }

        .settings-title {
            font-size: 24px;
            font-weight: 800;
        }

        .settings-section {
            margin-bottom: 24px;
        }

        .settings-section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .setting-item:active {
            transform: scale(0.99);
        }

        .setting-info {
            flex: 1;
        }

        .setting-label {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .setting-desc {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .setting-value {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 52px;
            height: 28px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-full);
			cursor: pointer;
            transition: background 0.3s ease;
        }

        .toggle-switch.active {
            background: var(--primary);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: var(--radius-full);
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-switch.active::after {
            transform: translateX(24px);
        }

        /* ═══════════════════════════════════════════════════════════════
           CHALLENGES
           ═══════════════════════════════════════════════════════════════ */
        .challenge-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 12px;
            border: 2px solid var(--bg-tertiary);
            transition: all 0.3s ease;
        }

        .challenge-card.completed {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.05);
        }

        .challenge-card.active {
            border-color: var(--primary);
        }

        .challenge-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .challenge-icon {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            flex-shrink: 0;
        }

        .challenge-info {
            flex: 1;
            min-width: 0;
        }

        .challenge-title {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .challenge-desc {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .challenge-reward {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            background: var(--gradient-gold);
            border-radius: var(--radius-full);
            font-size: 14px;
            font-weight: 700;
            color: white;
        }

        .challenge-progress {
            margin-bottom: 12px;
        }

        .challenge-progress-bar {
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-full);
            overflow: hidden;
        }

        .challenge-progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: var(--radius-full);
            transition: width 0.5s ease;
        }

        .challenge-progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 6px;
        }

        .challenge-btn {
            width: 100%;
            padding: 12px;
            background: var(--bg-tertiary);
            border: none;
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .challenge-btn:active {
            transform: scale(0.98);
        }

        .challenge-btn.claim {
            background: var(--gradient-success);
            color: white;
        }

        /* ═══════════════════════════════════════════════════════════════
           HEATMAP
           ═══════════════════════════════════════════════════════════════ */
        .heatmap-container {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 20px;
        }

        .heatmap-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .heatmap-title {
            font-size: 16px;
            font-weight: 700;
        }

        .heatmap-year-nav {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .heatmap-year-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border: none;
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            cursor: pointer;
        }

        .heatmap-year {
            font-size: 16px;
            font-weight: 700;
        }

        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(53, 1fr);
            gap: 3px;
            direction: ltr;
        }

        .heatmap-cell {
            aspect-ratio: 1;
            background: var(--bg-tertiary);
            border-radius: 2px;
            min-width: 8px;
        }

        .heatmap-cell.level-1 { background: rgba(99, 102, 241, 0.2); }
        .heatmap-cell.level-2 { background: rgba(99, 102, 241, 0.4); }
        .heatmap-cell.level-3 { background: rgba(99, 102, 241, 0.6); }
        .heatmap-cell.level-4 { background: rgba(99, 102, 241, 0.8); }
        .heatmap-cell.level-5 { background: var(--primary); }

        .heatmap-legend {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 6px;
            margin-top: 12px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .heatmap-legend-cell {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        /* ═══════════════════════════════════════════════════════════════
           MINI STATS
           ═══════════════════════════════════════════════════════════════ */
        .mini-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .mini-stat-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
        }

        .mini-stat-icon {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            border-radius: var(--radius-md);
        }

        .mini-stat-icon.xp { background: rgba(99, 102, 241, 0.15); }
        .mini-stat-icon.streak { background: rgba(245, 158, 11, 0.15); }
        .mini-stat-icon.accuracy { background: rgba(16, 185, 129, 0.15); }
        .mini-stat-icon.mastered { background: rgba(6, 182, 212, 0.15); }

        .mini-stat-value {
            font-size: 20px;
            font-weight: 800;
        }

        .mini-stat-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* ═══════════════════════════════════════════════════════════════
           TAG SYSTEM
           ═══════════════════════════════════════════════════════════════ */
        .tags-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tag-filter-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: var(--bg-card);
            border: 2px solid var(--bg-tertiary);
            border-radius: var(--radius-full);
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tag-filter-btn.active {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .tag-count {
            padding: 2px 8px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-full);
            font-size: 11px;
        }

        .card-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .card-tag {
            padding: 4px 10px;
            background: transparent;
            border: 1px solid;
            border-radius: var(--radius-full);
            font-size: 11px;
            font-weight: 600;
        }

        /* ═══════════════════════════════════════════════════════════════
           WEAKNESS SECTION
           ═══════════════════════════════════════════════════════════════ */
        .weakness-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 16px;
        }

        .weakness-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--bg-tertiary);
        }

        .weakness-item:last-child {
            border-bottom: none;
        }

        .weakness-rank {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border-radius: var(--radius-full);
            font-size: 12px;
            font-weight: 700;
        }

        .weakness-info {
            flex: 1;
            min-width: 0;
        }

        .weakness-word {
            font-size: 15px;
            font-weight: 700;
        }

        .weakness-meaning {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .weakness-stats {
            text-align: left;
        }

        .weakness-accuracy {
            font-size: 16px;
            font-weight: 700;
            color: var(--danger);
        }

        .weakness-attempts {
            font-size: 11px;
            color: var(--text-tertiary);
        }

        /* ═══════════════════════════════════════════════════════════════
           VOICE MODE
           ═══════════════════════════════════════════════════════════════ */
        .voice-btn {
            width: 100px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            background: var(--bg-tertiary);
            border: 4px solid var(--bg-tertiary);
            border-radius: var(--radius-full);
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 auto 20px;
        }

        .voice-btn.listening {
            border-color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
            animation: pulse-voice 1s infinite;
        }

        @keyframes pulse-voice {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .voice-status {
            text-align: center;
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .voice-result {
            text-align: center;
            padding: 20px;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            margin-top: 20px;
        }

        .voice-result-text {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 12px;
        }

        /* Audio Waveform */
        .audio-waveform {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            height: 40px;
            margin: 20px 0;
        }

        .waveform-bar {
            width: 6px;
            height: 20px;
            background: var(--primary);
            border-radius: var(--radius-full);
            animation: waveform 0.8s ease-in-out infinite;
        }

        .waveform-bar:nth-child(1) { animation-delay: 0s; }
        .waveform-bar:nth-child(2) { animation-delay: 0.1s; }
        .waveform-bar:nth-child(3) { animation-delay: 0.2s; }
        .waveform-bar:nth-child(4) { animation-delay: 0.3s; }
        .waveform-bar:nth-child(5) { animation-delay: 0.4s; }
        .waveform-bar:nth-child(6) { animation-delay: 0.5s; }
        .waveform-bar:nth-child(7) { animation-delay: 0.6s; }

        @keyframes waveform {
            0%, 100% { height: 20px; }
            50% { height: 40px; }
        }

        .audio-waveform.paused .waveform-bar {
            animation: none;
            height: 20px;
        }

        .speed-btn {
            padding: 8px 14px;
            background: var(--bg-tertiary);
            border: none;
            border-radius: var(--radius-full);
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .speed-btn.active {
            background: var(--primary);
            color: white;
        }

        /* ═══════════════════════════════════════════════════════════════
           READY DECKS
           ═══════════════════════════════════════════════════════════════ */
        .ready-decks-categories {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 12px;
            margin-bottom: 16px;
        }

        .category-btn {
            padding: 10px 18px;
            background: var(--bg-card);
            border: none;
            border-radius: var(--radius-full);
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .category-btn.active {
            background: var(--primary);
            color: white;
        }

        .ready-decks-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .ready-deck-card {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 2px solid var(--bg-tertiary);
        }

        .ready-deck-card.installed {
            border-color: var(--success);
            opacity: 0.7;
        }

        .ready-deck-icon {
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            border-radius: var(--radius-md);
            flex-shrink: 0;
        }

        .ready-deck-icon.exam { background: rgba(239, 68, 68, 0.15); }
        .ready-deck-icon.level { background: rgba(99, 102, 241, 0.15); }
        .ready-deck-icon.topic { background: rgba(16, 185, 129, 0.15); }
        .ready-deck-icon.phrase { background: rgba(245, 158, 11, 0.15); }

        .ready-deck-info {
            flex: 1;
            min-width: 0;
        }

        .ready-deck-name {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .ready-deck-desc {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .ready-deck-meta {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .ready-deck-action button {
            padding: 10px 20px;
            background: var(--gradient-primary);
            border: none;
            border-radius: var(--radius-md);
            color: white;
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        /* ═══════════════════════════════════════════════════════════════
           IMAGE CARD
           ═══════════════════════════════════════════════════════════════ */
        .image-upload-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            background: var(--bg-tertiary);
            border: 2px dashed var(--text-tertiary);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .image-upload-area:active {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .image-upload-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .image-upload-text {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .image-upload-hint {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .image-preview {
            width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: var(--radius-md);
            margin-bottom: 12px;
        }

        /* ═══════════════════════════════════════════════════════════════
           SPACED READING
           ═══════════════════════════════════════════════════════════════ */
        .reading-mode-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .reading-mode-btn {
            flex: 1;
            padding: 12px;
            background: var(--bg-card);
            border: 2px solid var(--bg-tertiary);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .reading-mode-btn.active {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .reading-container {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .reading-text {
            font-size: 16px;
            line-height: 2;
            direction: ltr;
            text-align: left;
        }

        .reading-text .word {
            padding: 2px 4px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .reading-text .word:hover {
            background: var(--bg-tertiary);
        }

        .reading-text .word.known {
            color: var(--success);
        }

        .reading-text .word.learning {
            background: rgba(99, 102, 241, 0.2);
            color: var(--primary);
        }

        .reading-text .word.unknown {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .word-info-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 20px;
            border: 2px solid var(--primary);
        }

        .word-info-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .word-info-word {
            font-size: 24px;
            font-weight: 800;
        }

        .word-info-meaning {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .word-info-example {
            font-size: 14px;
            color: var(--text-secondary);
            font-style: italic;
            margin-bottom: 12px;
        }

        .word-info-actions {
            display: flex;
            gap: 10px;
        }

        .reading-stats {
            display: flex;
            justify-content: space-around;
            padding: 16px;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            margin-bottom: 20px;
        }

        .reading-stat {
            text-align: center;
        }

        .reading-stat-value {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary);
        }

        .reading-stat-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .sample-texts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .sample-text-card {
            padding: 16px;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .sample-text-card:active {
            transform: scale(0.98);
        }

        .sample-text-card:hover {
            border-color: var(--primary);
        }

        .sample-text-title {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .sample-text-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* ═══════════════════════════════════════════════════════════════
           INSTALL MODAL
           ═══════════════════════════════════════════════════════════════ */
        .install-modal-content {
            text-align: center;
            padding: 20px 0;
        }

        .install-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .install-modal-content h2 {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 12px;
        }

        .install-modal-content p {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        .install-steps {
            text-align: right;
            margin-bottom: 24px;
        }

        .install-step {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            margin-bottom: 10px;
            font-size: 14px;
        }

        .step-number {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary);
            color: white;
            border-radius: var(--radius-full);
            font-size: 14px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .install-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* ═══════════════════════════════════════════════════════════════
           NOTIFICATION MODAL
           ═══════════════════════════════════════════════════════════════ */
        .notification-modal-content {
            text-align: center;
            padding: 20px 0;
        }

        .notification-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .notification-features {
            text-align: right;
            margin-bottom: 24px;
        }

        .notification-feature {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            margin-bottom: 10px;
            font-size: 14px;
        }

        .feature-icon {
            font-size: 20px;
        }

        .notification-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* ═══════════════════════════════════════════════════════════════
           LEVEL UP MODAL
           ═══════════════════════════════════════════════════════════════ */
        .level-up-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 6000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .level-up-modal.active {
            display: flex;
        }

        .level-up-content {
            text-align: center;
            animation: levelUpPop 0.5s ease;
        }

        @keyframes levelUpPop {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        .level-up-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .level-up-title {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 16px;
            color: white;
        }

        .level-up-level {
            font-size: 72px;
            font-weight: 900;
            background: var(--gradient-gold);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 16px;
        }

        .level-up-reward {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 32px;
        }

        .level-up-btn {
            padding: 16px 48px;
            background: var(--gradient-primary);
            border: none;
            border-radius: var(--radius-lg);
            color: white;
            font-family: inherit;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
        }

        /* ═══════════════════════════════════════════════════════════════
           CONFETTI
           ═══════════════════════════════════════════════════════════════ */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 7000;
            overflow: hidden;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            animation: confettiFall 3s ease-out forwards;
        }

        @keyframes confettiFall {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* ═══════════════════════════════════════════════════════════════
           FAB BUTTONS
           ═══════════════════════════════════════════════════════════════ */
        .fab-container {
            position: fixed;
            bottom: calc(var(--nav-height) + 20px + var(--safe-bottom));
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 1500;
        }

        .fab-btn {
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: var(--gradient-primary);
            border: none;
            border-radius: var(--radius-full);
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .fab-btn:active {
            transform: scale(0.9);
        }

        /* ═══════════════════════════════════════════════════════════════
           DICTIONARY MODAL
           ═══════════════════════════════════════════════════════════════ */
        .dictionary-search-box {
            display: flex;
            gap: 10px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-lg);
        }

        .dictionary-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 16px;
        }

        .dictionary-input:focus {
            outline: none;
        }

        .dictionary-search-btn {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary);
            border: none;
            border-radius: var(--radius-md);
            font-size: 20px;
            cursor: pointer;
        }

        .dictionary-result {
            padding: 20px;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            margin-top: 16px;
        }

        .dictionary-word {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 4px;
        }

        .dictionary-phonetic {
            font-size: 16px;
            color: var(--primary);
            margin-bottom: 16px;
        }

        .dictionary-meaning {
            margin-bottom: 16px;
        }

        .dictionary-pos {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 8px;
        }

        .dictionary-definition {
            font-size: 15px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .dictionary-example {
            font-size: 14px;
            font-style: italic;
            color: var(--text-tertiary);
            padding-right: 12px;
            border-right: 3px solid var(--primary);
        }

        /* ═══════════════════════════════════════════════════════════════
           DECK MANAGER
           ═══════════════════════════════════════════════════════════════ */
        .deck-form-section {
            margin-bottom: 24px;
        }

        .deck-form-section h3 {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .emoji-picker {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .emoji-option {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: var(--bg-tertiary);
            border: 2px solid transparent;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .emoji-option.selected {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .add-card-btn {
            width: 100%;
            padding: 14px;
            background: var(--bg-tertiary);
            border: 2px dashed var(--text-tertiary);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-card-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .save-deck-btn {
            width: 100%;
            padding: 16px;
            background: var(--gradient-success);
            border: none;
            border-radius: var(--radius-lg);
            color: white;
            font-family: inherit;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 20px;
        }

        .csv-import-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            background: var(--bg-tertiary);
            border: 2px dashed var(--text-tertiary);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .csv-import-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .csv-import-text {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .csv-import-hint {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* ═══════════════════════════════════════════════════════════════
           DAILY REWARD
           ═══════════════════════════════════════════════════════════════ */
        .daily-reward-card {
            background: var(--gradient-gold);
            border-radius: var(--radius-xl);
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .daily-reward-card.claimed {
            opacity: 0.6;
        }

        .daily-reward-icon {
            font-size: 40px;
        }

        .daily-reward-info {
            flex: 1;
        }

        .daily-reward-title {
            font-size: 16px;
            font-weight: 700;
            color: white;
        }

        .daily-reward-desc {
            font-size: 13px;
            opacity: 0.9;
            color: white;
        }

        .daily-reward-btn {
            padding: 12px 20px;
            background: rgba(255,255,255,0.25);
            border: none;
            border-radius: var(--radius-md);
            color: white;
            font-family: inherit;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
        }

        /* ═══════════════════════════════════════════════════════════════
           MODE TOGGLE
           ═══════════════════════════════════════════════════════════════ */
        .mode-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .mode-btn {
            flex: 1;
            padding: 12px;
            background: var(--bg-card);
            border: 2px solid var(--bg-tertiary);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        /* ═══════════════════════════════════════════════════════════════
           RESPONSIVE ADJUSTMENTS
           ═══════════════════════════════════════════════════════════════ */
        @media (max-width: 380px) {
            .action-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .hero-stats {
                flex-direction: column;
                gap: 8px;
            }

            .progress-content {
                flex-direction: column;
                text-align: center;
            }

            .rating-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 768px) {
            .app-container {
                max-width: 500px;
                margin: 0 auto;
            }
        }

        /* ═══════════════════════════════════════════════════════════════
           SCROLLBAR CUSTOM
           ═══════════════════════════════════════════════════════════════ */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-tertiary);
        }

        /* ═══════════════════════════════════════════════════════════════
           CARD MODES (inside flashcard modal)
           ═══════════════════════════════════════════════════════════════ */
        .card-mode {
            display: none;
            flex: 1;
        }

        .card-mode.active {
            display: flex;
            flex-direction: column;
        }

        /* Card image */
        .card-image-container {
            width: 100%;
            max-height: 150px;
            overflow: hidden;
            border-radius: var(--radius-md);
            margin-bottom: 16px;
        }

        .card-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Check answer button */
        .check-answer-btn {
            width: 100%;
            max-width: 300px;
            padding: 14px 24px;
            background: var(--gradient-primary);
            border: none;
            border-radius: var(--radius-lg);
            color: white;
            font-family: inherit;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 16px;
        }

        /* Hidden class */
        .hidden {
            display: none !important;
        }

        /* ═══════════════════════════════════════════════════════════════
           DESIGNER CREDIT
           ═══════════════════════════════════════════════════════════════ */
        .designer-credit {
            text-align: center;
            padding: 20px;
            margin-top: 20px;
            color: var(--text-tertiary);
            font-size: 12px;
        }

        .designer-credit a {
            color: var(--primary);
            text-decoration: none;
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Confetti Container -->
    <div class="confetti-container" id="confettiContainer"></div>

    <!-- App Container -->
    <div class="app-container">
		<!-- ═══════════════════════════════════════════════════════════════
             HOME SCREEN
             ═══════════════════════════════════════════════════════════════ -->
        <div id="home" class="screen active">
            <!-- Hero Section -->
            <div class="hero-section">
                <div class="hero-greeting" id="heroGreeting">سلام! 👋</div>
                <div class="hero-title">به LEXORA خوش آمدید</div>
                <div class="hero-stats">
                    <div class="hero-stat">
                        <span class="hero-stat-icon">🔥</span>
                        <span id="heroStreak">۰</span> روز متوالی
                    </div>
                    <div class="hero-stat">
                        <span class="hero-stat-icon">⭐</span>
                        سطح <span id="heroLevel">۱</span>
                    </div>
                </div>
                <div class="xp-bar-container">
                    <div class="xp-bar">
                        <div class="xp-bar-fill" id="heroXpBar" style="width: 0%"></div>
                    </div>
                    <div class="xp-bar-text">
                        <span><span id="heroXpCurrent">۰</span> XP</span>
                        <span><span id="heroXpNext">۱۰۰</span> XP تا سطح بعد</span>
                    </div>
                </div>
            </div>

            <!-- Daily Progress -->
            <div class="progress-card">
                <div class="progress-header">
                    <div class="progress-title">📊 پیشرفت امروز</div>
                </div>
                <div class="progress-content">
                    <div class="progress-ring-container">
                        <svg class="progress-ring" viewBox="0 0 100 100">
                            <defs>
                                <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:#6366f1"/>
                                    <stop offset="100%" style="stop-color:#8b5cf6"/>
                                </linearGradient>
                            </defs>
                            <circle class="progress-ring-bg" cx="50" cy="50" r="40"/>
                            <circle class="progress-ring-fill" id="progressRingFill" cx="50" cy="50" r="40"/>
                        </svg>
                        <div class="progress-ring-text">
                            <div class="progress-percent" id="progressPercent">۰٪</div>
                        </div>
                    </div>
                    <div class="progress-details">
                        <div class="progress-detail-item">
                            <span class="progress-detail-label">مرور شده</span>
                            <span class="progress-detail-value" id="detailReviewed">۰ کارت</span>
                        </div>
                        <div class="progress-detail-item">
                            <span class="progress-detail-label">هدف روزانه</span>
                            <span class="progress-detail-value" id="detailGoal">۲۰ کارت</span>
                        </div>
                        <div class="progress-detail-item">
                            <span class="progress-detail-label">دقت امروز</span>
                            <span class="progress-detail-value" id="detailAccuracy">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Streak Section -->
            <div class="streak-card">
                <div class="streak-header">
                    <div class="streak-title">🔥 روزهای متوالی</div>
                    <div class="streak-count" id="streakCount">۰</div>
                </div>
                <div class="streak-days" id="streakDays">
                    <!-- Generated by JS -->
                </div>
            </div>

            <!-- Daily Reward -->
            <div class="daily-reward-card" id="dailyRewardCard" onclick="Gamification.claimDailyReward()">
                <div class="daily-reward-icon">🎁</div>
                <div class="daily-reward-info">
                    <div class="daily-reward-title">پاداش روزانه</div>
                    <div class="daily-reward-desc" id="dailyRewardDesc">برای دریافت XP کلیک کنید!</div>
                </div>
                <button class="daily-reward-btn" id="dailyRewardBtn">
                    <span id="dailyRewardBtnText">دریافت</span>
                </button>
            </div>

            <!-- Action Buttons -->
            <div class="action-grid">
                <div class="action-btn" onclick="Review.start()">
                    <div class="action-btn-icon" style="background: linear-gradient(135deg, #ddd6fe, #c4b5fd);">📖</div>
                    <div class="action-btn-text">مرور</div>
                </div>
                <div class="action-btn" onclick="ReadyDecks.open()">
                    <div class="action-btn-icon" style="background: linear-gradient(135deg, #fce7f3, #fbcfe8);">📦</div>
                    <div class="action-btn-text">دک آماده</div>
                </div>
                <div class="action-btn" onclick="Dictionary.open()">
                    <div class="action-btn-icon" style="background: linear-gradient(135deg, #cffafe, #a5f3fc);">📖</div>
                    <div class="action-btn-text">دیکشنری</div>
                </div>
                <div class="action-btn" onclick="SpacedReading.open()">
                    <div class="action-btn-icon" style="background: linear-gradient(135deg, #fef3c7, #fde68a);">📰</div>
                    <div class="action-btn-text">مطالعه</div>
                </div>
                <div class="action-btn" onclick="Challenges.open()">
                    <div class="action-btn-icon" style="background: linear-gradient(135deg, #d1fae5, #a7f3d0);">🏆</div>
                    <div class="action-btn-text">چالش‌ها</div>
                </div>
                <div class="action-btn" onclick="VoiceMode.open()">
                    <div class="action-btn-icon" style="background: linear-gradient(135deg, #fee2e2, #fecaca);">🎤</div>
                    <div class="action-btn-text">صوتی</div>
                </div>
                <div class="action-btn" onclick="AdvancedStats.open()">
                    <div class="action-btn-icon" style="background: linear-gradient(135deg, #e0e7ff, #c7d2fe);">📊</div>
                    <div class="action-btn-text">آمار</div>
                </div>
                <div class="action-btn" onclick="TagSystem.open()">
                    <div class="action-btn-icon" style="background: linear-gradient(135deg, #f3e8ff, #e9d5ff);">🏷️</div>
                    <div class="action-btn-text">تگ‌ها</div>
                </div>
            </div>

            <!-- Word of the Day -->
            <div class="wod-card" id="wodCard">
                <div class="wod-label">📚 کلمه امروز</div>
                <div class="wod-word" id="wodWord">Serendipity</div>
                <div class="wod-pronunciation" id="wodPronunciation">/ˌserənˈdɪpɪti/</div>
                <div class="wod-meaning" id="wodMeaning">خوش‌شانسی غیرمنتظره</div>
                <div class="wod-actions">
                    <button class="wod-btn" onclick="WordOfDay.speak()">🔊 تلفظ</button>
                    <button class="wod-btn" onclick="WordOfDay.addToReview()">➕ افزودن</button>
                </div>
            </div>

            <!-- Quick Start Decks -->
            <div class="section-header">
                <div class="section-title">📚 شروع سریع</div>
                <div class="section-link" onclick="Navigation.go('library')">همه دک‌ها</div>
            </div>
            <div class="decks-grid" id="quickStartDecks">
                <!-- Generated by JS -->
            </div>

            <!-- Badges Preview -->
            <div class="section-header" style="margin-top: 24px;">
                <div class="section-title">🏅 مدال‌ها</div>
                <div class="section-link" id="badgeCount">۰/۱۲</div>
            </div>
            <div class="badges-scroll" id="badgesScrollContainer">
                <!-- Generated by JS -->
            </div>

            <!-- Designer Credit -->
            <div class="designer-credit">
                طراح و برنامه‌نویس: <a href="#">محمد عباسی</a>
                <br>
                LEXORA v3.5 | الگوریتم FSRS-4.5
            </div>
        </div>

        <!-- ═══════════════════════════════════════════════════════════════
             LIBRARY SCREEN
             ═══════════════════════════════════════════════════════════════ -->
        <div id="library" class="screen">
            <div class="library-header">
                <div class="library-title">📚 کتابخانه</div>
                <div class="library-actions">
                    <button class="library-btn" onclick="DeckManager.openCreate()">➕</button>
                    <button class="library-btn" onclick="ReadyDecks.open()">📦</button>
                </div>
            </div>

            <div class="library-search">
                <span class="library-search-icon">🔍</span>
                <input type="text" class="library-search-input" id="librarySearch" 
                       placeholder="جستجوی دک یا کارت..." oninput="Library.search(this.value)">
            </div>

            <div class="library-tabs" id="libraryTabs">
                <button class="library-tab active" data-view="decks" onclick="Library.setView('decks', this)">
                    دک‌ها
                </button>
                <button class="library-tab" data-view="cards" onclick="Library.setView('cards', this)">
                    همه کارت‌ها
                </button>
                <button class="library-tab" data-view="starred" onclick="Library.setView('starred', this)">
                    ⭐ ستاره‌دار
                </button>
            </div>

            <!-- Decks View -->
            <div id="decksView" class="library-view active">
                <div class="decks-grid" id="libraryDecksGrid">
                    <!-- Generated by JS -->
                </div>
            </div>

            <!-- Cards View -->
            <div id="cardsView" class="library-view" style="display: none;">
                <div id="libraryCardsGrid">
                    <!-- Generated by JS -->
                </div>
            </div>

            <!-- Deck Detail View -->
            <div id="deckDetailView" class="library-view" style="display: none;">
                <div class="deck-detail-header" id="deckDetailHeader">
                    <!-- Generated by JS -->
                </div>
                <div class="deck-detail-actions">
                    <button class="btn btn-primary" onclick="Library.startDeckReview()">
                        📖 شروع مرور
                    </button>
                    <button class="btn btn-secondary" onclick="Library.openAddCard()">
                        ➕ افزودن کارت
                    </button>
                </div>
                <div id="deckCardsGrid" style="margin-top: 20px;">
                    <!-- Generated by JS -->
                </div>
            </div>
        </div>

        <!-- ═══════════════════════════════════════════════════════════════
             STATS SCREEN
             ═══════════════════════════════════════════════════════════════ -->
        <div id="stats" class="screen">
            <div class="stats-header">
                <div class="stats-title">📊 آمار یادگیری</div>
                <div class="stats-subtitle">عملکرد و پیشرفت شما</div>
            </div>

            <div class="stats-grid">
                <div class="stat-card primary">
                    <div class="stat-icon">📚</div>
                    <div class="stat-value" id="statTotalCards">۰</div>
                    <div class="stat-label">کل کارت‌ها</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-icon">✅</div>
                    <div class="stat-value" id="statMasteredCards">۰</div>
                    <div class="stat-label">تسلط یافته</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-icon">🔥</div>
                    <div class="stat-value" id="statCurrentStreak">۰</div>
                    <div class="stat-label">روز متوالی</div>
                </div>
                <div class="stat-card accent">
                    <div class="stat-icon">⚡</div>
                    <div class="stat-value" id="statTotalXP">۰</div>
                    <div class="stat-label">کل XP</div>
                </div>
            </div>

            <!-- Weekly Chart -->
            <div class="section-header">
                <div class="section-title">📈 هفته اخیر</div>
            </div>
            <div class="progress-card">
                <div id="weeklyChart" style="height: 150px; display: flex; align-items: flex-end; justify-content: space-around; gap: 8px;">
                    <!-- Generated by JS -->
                </div>
            </div>

            <!-- More Stats Button -->
            <button class="btn btn-secondary btn-block" onclick="AdvancedStats.open()" style="margin-top: 20px;">
                📊 آمار پیشرفته
            </button>

            <!-- Learning Stats -->
            <div class="section-header" style="margin-top: 24px;">
                <div class="section-title">📋 جزئیات یادگیری</div>
            </div>
            <div class="progress-card">
                <div class="progress-detail-item">
                    <span class="progress-detail-label">کل مرور‌ها</span>
                    <span class="progress-detail-value" id="statTotalReviews">۰</span>
                </div>
                <div class="progress-detail-item">
                    <span class="progress-detail-label">میانگین روزانه</span>
                    <span class="progress-detail-value" id="statDailyAvg">۰</span>
                </div>
                <div class="progress-detail-item">
                    <span class="progress-detail-label">بهترین روز</span>
                    <span class="progress-detail-value" id="statBestDay">۰</span>
                </div>
                <div class="progress-detail-item">
                    <span class="progress-detail-label">دقت کلی</span>
                    <span class="progress-detail-value" id="statOverallAccuracy">۰٪</span>
                </div>
            </div>
        </div>

        <!-- ═══════════════════════════════════════════════════════════════
             SETTINGS SCREEN
             ═══════════════════════════════════════════════════════════════ -->
        <div id="settings" class="screen">
            <div class="settings-header">
                <div class="settings-title">⚙️ تنظیمات</div>
            </div>

            <!-- Learning Settings -->
            <div class="settings-section">
                <div class="settings-section-title">یادگیری</div>
                
                <div class="setting-item" onclick="Settings.openDailyGoal()">
                    <div class="setting-info">
                        <div class="setting-label">هدف روزانه</div>
                        <div class="setting-desc">تعداد کارت‌های مرور روزانه</div>
                    </div>
                    <div class="setting-value" id="settingDailyGoal">۲۰ کارت</div>
                </div>

                <div class="setting-item" onclick="Settings.openNewCardsPerDay()">
                    <div class="setting-info">
                        <div class="setting-label">کارت‌های جدید</div>
                        <div class="setting-desc">تعداد کارت جدید در روز</div>
                    </div>
                    <div class="setting-value" id="settingNewCards">۱۰ کارت</div>
                </div>
            </div>

            <!-- Appearance Settings -->
            <div class="settings-section">
                <div class="settings-section-title">ظاهر</div>
                
                <div class="setting-item" onclick="Settings.toggleTheme()">
                    <div class="setting-info">
                        <div class="setting-label">حالت تاریک</div>
                        <div class="setting-desc">تغییر تم برنامه</div>
                    </div>
                    <div class="toggle-switch active" id="themeToggle"></div>
                </div>

                <div class="setting-item" onclick="Settings.toggleSound()">
                    <div class="setting-info">
                        <div class="setting-label">صدای تلفظ</div>
                        <div class="setting-desc">پخش خودکار تلفظ</div>
                    </div>
                    <div class="toggle-switch active" id="soundToggle"></div>
                </div>
            </div>

            <!-- Notifications Settings -->
            <div class="settings-section">
                <div class="settings-section-title">اعلان‌ها</div>
                
                <div class="setting-item" onclick="SmartNotifications.showModal()">
                    <div class="setting-info">
                        <div class="setting-label">مدیریت اعلان‌ها</div>
                        <div class="setting-desc">یادآوری مرور و پیشرفت</div>
                    </div>
                    <div class="setting-value" id="notifStatus">غیرفعال</div>
                </div>

                <div class="setting-item" onclick="InstallManager.showPrompt()">
                    <div class="setting-info">
                        <div class="setting-label">نصب برنامه</div>
                        <div class="setting-desc">نصب روی صفحه اصلی گوشی</div>
                    </div>
                    <div class="setting-value">📲</div>
                </div>
            </div>

            <!-- Data Settings -->
            <div class="settings-section">
                <div class="settings-section-title">داده‌ها</div>
                
                <div class="setting-item" onclick="Settings.exportData()">
                    <div class="setting-info">
                        <div class="setting-label">پشتیبان‌گیری</div>
                        <div class="setting-desc">خروجی از تمام داده‌ها</div>
                    </div>
                    <div class="setting-value">📤</div>
                </div>

                <div class="setting-item" onclick="Settings.importData()">
                    <div class="setting-info">
                        <div class="setting-label">بازیابی</div>
                        <div class="setting-desc">ورود داده‌های پشتیبان</div>
                    </div>
                    <div class="setting-value">📥</div>
                </div>

                <div class="setting-item" onclick="Settings.confirmReset()" style="border: 1px solid var(--danger);">
                    <div class="setting-info">
                        <div class="setting-label" style="color: var(--danger);">پاک کردن همه</div>
                        <div class="setting-desc">حذف تمام داده‌ها و شروع مجدد</div>
                    </div>
                    <div class="setting-value" style="color: var(--danger);">🗑️</div>
                </div>
            </div>

            <!-- About -->
            <div class="settings-section">
                <div class="settings-section-title">درباره</div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-label">نسخه</div>
                        <div class="setting-desc">LEXORA v3.5</div>
                    </div>
                    <div class="setting-value">۳.۵</div>
                </div>

                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-label">الگوریتم</div>
                        <div class="setting-desc">Free Spaced Repetition Scheduler</div>
                    </div>
                    <div class="setting-value">FSRS-4.5</div>
                </div>
            </div>

            <!-- Designer Credit -->
            <div class="designer-credit">
                طراح و برنامه‌نویس: <a href="#">محمد عباسی</a>
                <br>
                ساخته شده با ❤️ برای یادگیری بهتر
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════
         BOTTOM NAVIGATION
         ═══════════════════════════════════════════════════════════════ -->
    <nav class="bottom-nav">
        <div class="nav-item active" data-screen="home" onclick="Navigation.go('home')">
            <span class="nav-icon">🏠</span>
            <span class="nav-label">خانه</span>
        </div>
        <div class="nav-item" data-screen="library" onclick="Navigation.go('library')">
            <span class="nav-icon">📚</span>
            <span class="nav-label">کتابخانه</span>
            <span class="nav-badge" id="libraryBadge" style="display: none;">۰</span>
        </div>
        <div class="nav-item nav-center" onclick="Review.start()">
            <span class="nav-icon" style="font-size: 32px;">▶️</span>
        </div>
        <div class="nav-item" data-screen="stats" onclick="Navigation.go('stats')">
            <span class="nav-icon">📊</span>
            <span class="nav-label">آمار</span>
        </div>
        <div class="nav-item" data-screen="settings" onclick="Navigation.go('settings')">
            <span class="nav-icon">⚙️</span>
            <span class="nav-label">تنظیمات</span>
        </div>
    </nav>

    <!-- ═══════════════════════════════════════════════════════════════
         FLASHCARD MODAL
         ═══════════════════════════════════════════════════════════════ -->
    <div id="flashcardModal" class="flashcard-modal">
        <div class="flashcard-header">
            <button class="flashcard-close" onclick="Review.close()">✕</button>
            <div class="flashcard-progress">
                <div class="flashcard-progress-bar">
                    <div class="flashcard-progress-fill" id="reviewProgressBar" style="width: 0%"></div>
                </div>
                <div class="flashcard-progress-text">
                    <span id="reviewProgressText">۰ از ۰</span>
                </div>
            </div>
            <div id="reviewModeIndicator" style="font-size: 14px; font-weight: 600;">👁️</div>
        </div>

        <div class="flashcard-body">
            <!-- Recognition Mode (Default) -->
            <div id="recognitionMode" class="card-mode active">
                <div class="flashcard-container">
                    <div class="flashcard" id="flashcard" onclick="Review.flip()">
                        <div class="flashcard-face flashcard-front">
                            <button class="speak-btn" onclick="event.stopPropagation(); Review.speak()">🔊</button>
                            <button class="star-btn" id="starBtn" onclick="event.stopPropagation(); Review.toggleStar()">☆</button>
                            <div class="card-word" id="cardWord">Word</div>
                            <div class="card-pronunciation" id="cardPronunciation">/pronunciation/</div>
                            <div class="flip-hint">👆 برای دیدن معنی کلیک کنید</div>
                        </div>
                        <div class="flashcard-face flashcard-back">
                            <button class="speak-btn" onclick="event.stopPropagation(); Review.speak()">🔊</button>
                            <div class="card-meaning" id="cardMeaning">معنی</div>
                            <div class="card-example" id="cardExample">مثال کاربردی</div>
                            <div class="card-mnemonic" id="cardMnemonic">💡 نکته یادآوری</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reverse Mode -->
            <div id="reverseMode" class="card-mode">
                <div class="flashcard-container">
                    <div class="flashcard" id="reverseFlashcard" onclick="Review.flipReverse()">
                        <div class="flashcard-face flashcard-front">
                            <div class="reverse-meaning" id="reverseMeaning">معنی فارسی</div>
                            <div class="reverse-hint-text">کلمه انگلیسی چیست؟</div>
                            <div class="flip-hint">👆 برای دیدن جواب کلیک کنید</div>
                        </div>
                        <div class="flashcard-face flashcard-back">
                            <button class="speak-btn" onclick="event.stopPropagation(); Review.speak()">🔊</button>
                            <div class="card-word" id="reverseWord">Word</div>
                            <div class="card-pronunciation" id="reversePronunciation">/pronunciation/</div>
                            <div class="card-example" id="reverseExample">مثال</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Listening Mode -->
            <div id="listeningMode" class="card-mode">
                <div class="listening-container">
                    <div class="listening-icon">🎧</div>
                    <div class="listening-hint">به تلفظ کلمه گوش دهید و آن را تایپ کنید</div>
                    <button class="listening-play-btn" onclick="Review.speak()">🔊</button>
                    <input type="text" class="listening-input" id="listeningInput" 
                           placeholder="کلمه انگلیسی را تایپ کنید..." autocomplete="off" dir="ltr">
                    <button class="check-answer-btn" onclick="Review.checkListening()">بررسی پاسخ</button>
                    <div class="feedback-container" id="listeningFeedback" style="display: none;">
                        <div class="feedback-icon" id="listeningFeedbackIcon">✅</div>
                        <div class="feedback-text" id="listeningFeedbackText">آفرین!</div>
                        <div class="feedback-correct">پاسخ صحیح: <strong id="listeningCorrectAnswer"></strong></div>
                    </div>
                </div>
            </div>

            <!-- Spelling Mode -->
            <div id="spellingMode" class="card-mode">
                <div class="spelling-container">
                    <div class="spelling-meaning" id="spellingMeaning">معنی فارسی</div>
                    <div class="spelling-hint">املای کلمه انگلیسی را تایپ کنید</div>
                    <input type="text" class="listening-input" id="spellingInput" 
                           placeholder="English word..." autocomplete="off" dir="ltr">
                    <button class="check-answer-btn" onclick="Review.checkSpelling()">بررسی پاسخ</button>
                    <div class="feedback-container" id="spellingFeedback" style="display: none;">
                        <div class="feedback-icon" id="spellingFeedbackIcon">✅</div>
                        <div class="feedback-text" id="spellingFeedbackText">آفرین!</div>
                        <div class="feedback-correct">پاسخ صحیح: <strong id="spellingCorrectAnswer"></strong></div>
                    </div>
                </div>
            </div>

            <!-- Quiz Mode -->
            <div id="quizMode" class="card-mode">
                <div class="quiz-container">
                    <button class="speak-btn" onclick="Review.speak()" style="position: absolute; top: 16px; right: 16px;">🔊</button>
                    <div class="quiz-question">
                        <div class="quiz-word" id="quizWord">Word</div>
                        <div class="quiz-pronunciation" id="quizPronunciation">/pronunciation/</div>
                    </div>
                    <div class="quiz-options" id="quizOptions">
                        <!-- Generated by JS -->
                    </div>
                </div>
            </div>

            <!-- Complete Screen -->
            <div class="complete-screen" id="completeScreen">
                <div class="complete-icon">🎉</div>
                <div class="complete-title">آفرین!</div>
                <div class="complete-message">مرور امروز تمام شد</div>
                <div class="complete-stats">
                    <div class="complete-stat">
                        <div class="complete-stat-value" id="completeReviewed">۰</div>
                        <div class="complete-stat-label">مرور شده</div>
                    </div>
                    <div class="complete-stat">
                        <div class="complete-stat-value" id="completeAccuracy">۰٪</div>
                        <div class="complete-stat-label">دقت</div>
                    </div>
                </div>
                <div class="complete-xp" id="completeXP">+۵۰ XP</div>
                <button class="complete-btn" onclick="Review.close()">بازگشت به خانه</button>
            </div>
        </div>

        <!-- Rating Buttons -->
        <div class="rating-container" id="ratingContainer">
            <div class="rating-buttons">
                <button class="rating-btn again" onclick="Review.rate(1)">
                    <span class="rating-label">دوباره</span>
                    <span class="rating-time" id="timeAgain">&lt;۱ دقیقه</span>
                </button>
                <button class="rating-btn hard" onclick="Review.rate(2)">
                    <span class="rating-label">سخت</span>
                    <span class="rating-time" id="timeHard">۶ دقیقه</span>
                </button>
                <button class="rating-btn good" onclick="Review.rate(3)">
                    <span class="rating-label">خوب</span>
                    <span class="rating-time" id="timeGood">۱۰ دقیقه</span>
                </button>
                <button class="rating-btn easy" onclick="Review.rate(4)">
                    <span class="rating-label">آسان</span>
                    <span class="rating-time" id="timeEasy">۴ روز</span>
                </button>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════
         MODE SELECTOR MODAL
         ═══════════════════════════════════════════════════════════════ -->
    <div id="modeSelectorModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h2>🎮 انتخاب حالت مرور</h2>
                <button class="modal-close" onclick="ModeSelector.close()">✕</button>
            </div>
            <div class="modal-body">
                <div class="mode-selector">
                    <div class="mode-option selected" data-mode="recognition" onclick="ModeSelector.select('recognition', this)">
                        <div class="mode-option-icon">👁️</div>
                        <div class="mode-option-info">
                            <div class="mode-option-title">شناسایی</div>
                            <div class="mode-option-desc">کلمه را ببینید، معنی را به خاطر بیاورید</div>
                        </div>
                    </div>
                    <div class="mode-option" data-mode="reverse" onclick="ModeSelector.select('reverse', this)">
                        <div class="mode-option-icon">🔄</div>
                        <div class="mode-option-info">
                            <div class="mode-option-title">معکوس</div>
                            <div class="mode-option-desc">معنی را ببینید، کلمه را حدس بزنید</div>
                        </div>
                    </div>
                    <div class="mode-option" data-mode="listening" onclick="ModeSelector.select('listening', this)">
                        <div class="mode-option-icon">🎧</div>
                        <div class="mode-option-info">
                            <div class="mode-option-title">شنیداری</div>
                            <div class="mode-option-desc">گوش دهید و تایپ کنید</div>
                        </div>
                    </div>
                    <div class="mode-option" data-mode="spelling" onclick="ModeSelector.select('spelling', this)">
                        <div class="mode-option-icon">✍️</div>
                        <div class="mode-option-info">
                            <div class="mode-option-title">املا</div>
                            <div class="mode-option-desc">معنی را ببینید، املا را تایپ کنید</div>
                        </div>
                    </div>
                    <div class="mode-option" data-mode="quiz" onclick="ModeSelector.select('quiz', this)">
                        <div class="mode-option-icon">🎯</div>
                        <div class="mode-option-info">
                            <div class="mode-option-title">آزمون</div>
                            <div class="mode-option-desc">از چهار گزینه انتخاب کنید</div>
                        </div>
                    </div>
                </div>
                <button class="btn btn-primary btn-block" onclick="ModeSelector.startReview()">
                    🚀 شروع مرور
                </button>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════
         DICTIONARY MODAL
         ═══════════════════════════════════════════════════════════════ -->
    <div id="dictionaryModal" class="modal-overlay">
        <div class="modal-container modal-large">
            <div class="modal-header">
                <h2>📖 دیکشنری</h2>
                <button class="modal-close" onclick="Dictionary.close()">✕</button>
            </div>
            <div class="modal-body">
                <div class="dictionary-search-box">
                    <input type="text" class="dictionary-input" id="dictionaryInput" 
                           placeholder="کلمه انگلیسی را وارد کنید..." dir="ltr"
                           onkeypress="if(event.key==='Enter')Dictionary.search()">
                    <button class="dictionary-search-btn" onclick="Dictionary.search()">🔍</button>
                </div>
                <div id="dictionaryResult">
                    <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                        <div style="font-size: 64px; margin-bottom: 16px;">📖</div>
                        <div>کلمه‌ای را جستجو کنید</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════
         READY DECKS MODAL
         ═══════════════════════════════════════════════════════════════ -->
    <div id="readyDecksModal" class="modal-overlay">
        <div class="modal-container modal-large">
            <div class="modal-header">
                <h2>📦 دک‌های آماده</h2>
                <button class="modal-close" onclick="ReadyDecks.close()">✕</button>
            </div>
            <div class="modal-body">
                <div class="ready-decks-categories">
                    <button class="category-btn active" onclick="ReadyDecks.filterCategory('all', this)">همه</button>
                    <button class="category-btn" onclick="ReadyDecks.filterCategory('exam', this)">آزمون‌ها</button>
                    <button class="category-btn" onclick="ReadyDecks.filterCategory('level', this)">سطح‌بندی</button>
                    <button class="category-btn" onclick="ReadyDecks.filterCategory('topic', this)">موضوعی</button>
                    <button class="category-btn" onclick="ReadyDecks.filterCategory('phrase', this)">اصطلاحات</button>
                </div>
                <div class="ready-decks-grid" id="readyDecksGrid">
                    <!-- Generated by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════
         ADD CARD MODAL
         ═══════════════════════════════════════════════════════════════ -->
    <div id="addCardModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h2>➕ افزودن کارت</h2>
                <button class="modal-close" onclick="document.getElementById('addCardModal').classList.remove('active')">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">کلمه انگلیسی *</label>
                    <input type="text" class="form-input" id="newCardWord" placeholder="مثال: Serendipity" dir="ltr">
                </div>
                <div class="form-group">
                    <label class="form-label">معنی فارسی *</label>
                    <input type="text" class="form-input" id="newCardMeaning" placeholder="مثال: خوش‌شانسی غیرمنتظره">
                </div>
                <div class="form-group">
                    <label class="form-label">تلفظ (اختیاری)</label>
                    <input type="text" class="form-input" id="newCardPronunciation" placeholder="/ˌserənˈdɪpɪti/" dir="ltr">
                </div>
                <div class="form-group">
                    <label class="form-label">مثال (اختیاری)</label>
                    <textarea class="form-input form-textarea" id="newCardExample" placeholder="It was pure serendipity..." dir="ltr"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">نکته یادآوری (اختیاری)</label>
                    <textarea class="form-input form-textarea" id="newCardNote" placeholder="هر چیزی که به یادآوری کمک کند..."></textarea>
                </div>
                <button class="btn btn-primary btn-block" onclick="AddCard.save()">✅ ذخیره کارت</button>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════
         CREATE DECK MODAL
         ═══════════════════════════════════════════════════════════════ -->
    <div id="createDeckModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h2>➕ ساخت دک جدید</h2>
                <button class="modal-close" onclick="DeckManager.closeCreate()">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">نام دک *</label>
                    <input type="text" class="form-input" id="newDeckName" placeholder="مثال: کلمات پیشرفته">
                </div>
                <div class="form-group">
                    <label class="form-label">توضیحات</label>
                    <textarea class="form-input form-textarea" id="newDeckDesc" placeholder="توضیح کوتاه..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">آیکون</label>
                    <div class="emoji-picker" id="emojiPicker">
                        <div class="emoji-option selected" data-emoji="📚" onclick="DeckManager.selectEmoji('📚', this)">📚</div>
                        <div class="emoji-option" data-emoji="🎯" onclick="DeckManager.selectEmoji('🎯', this)">🎯</div>
                        <div class="emoji-option" data-emoji="💼" onclick="DeckManager.selectEmoji('💼', this)">💼</div>
                        <div class="emoji-option" data-emoji="🎓" onclick="DeckManager.selectEmoji('🎓', this)">🎓</div>
                        <div class="emoji-option" data-emoji="✈️" onclick="DeckManager.selectEmoji('✈️', this)">✈️</div>
                        <div class="emoji-option" data-emoji="🏠" onclick="DeckManager.selectEmoji('🏠', this)">🏠</div>
                        <div class="emoji-option" data-emoji="💻" onclick="DeckManager.selectEmoji('💻', this)">💻</div>
                        <div class="emoji-option" data-emoji="🎬" onclick="DeckManager.selectEmoji('🎬', this)">🎬</div>
                        <div class="emoji-option" data-emoji="🎵" onclick="DeckManager.selectEmoji('🎵', this)">🎵</div>
                        <div class="emoji-option" data-emoji="⚽" onclick="DeckManager.selectEmoji('⚽', this)">⚽</div>
                        <div class="emoji-option" data-emoji="🍔" onclick="DeckManager.selectEmoji('🍔', this)">🍔</div>
                        <div class="emoji-option" data-emoji="❤️" onclick="DeckManager.selectEmoji('❤️', this)">❤️</div>
                    </div>
                </div>
                <button class="btn btn-success btn-block" onclick="DeckManager.create()">💾 ساخت دک</button>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════
         CHALLENGES MODAL
         ═══════════════════════════════════════════════════════════════ -->
    <div id="challengesModal" class="modal-overlay">
        <div class="modal-container modal-large">
            <div class="modal-header">
                <h2>🏆 چالش‌ها</h2>
                <button class="modal-close" onclick="Challenges.close()">✕</button>
            </div>
            <div class="modal-body">
                <div class="section-title" style="margin-bottom: 16px;">📅 چالش‌های روزانه</div>
                <div id="dailyChallenges"></div>
                
                <div class="section-title" style="margin: 24px 0 16px;">📆 چالش‌های هفتگی</div>
                <div id="weeklyChallenges"></div>
                
                <div class="section-title" style="margin: 24px 0 16px;">⭐ چالش‌های ویژه</div>
                <div id="specialChallenges"></div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════
         ADVANCED STATS MODAL
         ═══════════════════════════════════════════════════════════════ -->
    <div id="advancedStatsModal" class="modal-overlay">
        <div class="modal-container modal-large">
            <div class="modal-header">
                <h2>📊 آمار پیشرفته</h2>
                <button class="modal-close" onclick="AdvancedStats.close()">✕</button>
            </div>
            <div class="modal-body">
                <div class="mini-stats">
                    <div class="mini-stat-card">
                        <div class="mini-stat-icon xp">⚡</div>
                        <div class="mini-stat-info">
                            <div class="mini-stat-value" id="advStatXP">۰</div>
                            <div class="mini-stat-label">کل XP</div>
                        </div>
                    </div>
                    <div class="mini-stat-card">
                        <div class="mini-stat-icon streak">🔥</div>
                        <div class="mini-stat-info">
                            <div class="mini-stat-value" id="advStatStreak">۰</div>
                            <div class="mini-stat-label">بیشترین Streak</div>
                        </div>
                    </div>
                    <div class="mini-stat-card">
                        <div class="mini-stat-icon accuracy">🎯</div>
                        <div class="mini-stat-info">
                            <div class="mini-stat-value" id="advStatAccuracy">۰٪</div>
                            <div class="mini-stat-label">میانگین دقت</div>
                        </div>
                    </div>
                    <div class="mini-stat-card">
                        <div class="mini-stat-icon mastered">✅</div>
                        <div class="mini-stat-info">
                            <div class="mini-stat-value" id="advStatMastered">۰</div>
                            <div class="mini-stat-label">تسلط یافته</div>
                        </div>
                    </div>
                </div>

                <!-- Heatmap -->
                <div class="heatmap-container">
                    <div class="heatmap-header">
                        <div class="heatmap-title">📅 فعالیت سالانه</div>
                    </div>
                    <div class="heatmap-grid" id="heatmapGrid"></div>
                    <div class="heatmap-legend">
                        <span>کمتر</span>
                        <div class="heatmap-legend-cell" style="background: var(--bg-tertiary);"></div>
                        <div class="heatmap-legend-cell level-1"></div>
                        <div class="heatmap-legend-cell level-2"></div>
                        <div class="heatmap-legend-cell level-3"></div>
                        <div class="heatmap-legend-cell level-4"></div>
                        <div class="heatmap-legend-cell level-5"></div>
                        <span>بیشتر</span>
                    </div>
                </div>

                <!-- Weakness -->
                <div class="section-title" style="margin: 20px 0 16px;">📉 کلمات نیازمند تمرین</div>
                <div class="weakness-card" id="weaknessCard"></div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════
         TAG MANAGER MODAL
         ═══════════════════════════════════════════════════════════════ -->
    <div id="tagManagerModal" class="modal-overlay">
        <div class="modal-container modal-large">
            <div class="modal-header">
                <h2>🏷️ مدیریت تگ‌ها</h2>
                <button class="modal-close" onclick="TagSystem.close()">✕</button>
            </div>
            <div class="modal-body">
                <div class="tags-filter" id="tagsFilter">
                    <button class="tag-filter-btn active" onclick="TagSystem.filter('all', this)">همه</button>
                    <button class="tag-filter-btn" onclick="TagSystem.filter('starred', this)">⭐ ستاره‌دار</button>
                    <button class="tag-filter-btn" onclick="TagSystem.filter('difficult', this)">🔴 سخت</button>
                    <button class="tag-filter-btn" onclick="TagSystem.filter('new', this)">🆕 جدید</button>
                    <button class="tag-filter-btn" onclick="TagSystem.filter('mastered', this)">✅ تسلط</button>
                </div>
                <div class="section-title" style="margin: 20px 0 16px;">🃏 کارت‌ها (<span id="filteredCount">۰</span>)</div>
                <div id="filteredCardsList"></div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════
         VOICE MODE MODAL
         ═══════════════════════════════════════════════════════════════ -->
    <div id="voiceModeModal" class="modal-overlay">
        <div class="modal-container modal-large">
            <div class="modal-header">
                <h2>🎤 حالت صوتی</h2>
                <button class="modal-close" onclick="VoiceMode.close()">✕</button>
            </div>
            <div class="modal-body">
                <div class="mode-toggle">
                    <button class="mode-btn active" onclick="VoiceMode.setMode('listen', this)">🎧 گوش دادن</button>
                    <button class="mode-btn" onclick="VoiceMode.setMode('speak', this)">🎤 صحبت کردن</button>
                </div>

                <!-- Listen Mode -->
                <div id="voiceListenMode">
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 28px; font-weight: 800;" id="voiceWord">Hello</div>
                        <div style="color: var(--primary); margin-bottom: 24px;" id="voicePronunciation">/həˈloʊ/</div>
                        <div class="audio-waveform" id="audioWaveform">
                            <div class="waveform-bar"></div>
                            <div class="waveform-bar"></div>
                            <div class="waveform-bar"></div>
                            <div class="waveform-bar"></div>
                            <div class="waveform-bar"></div>
                        </div>
                        <div style="display: flex; justify-content: center; gap: 12px; margin: 20px 0;">
                            <button class="btn btn-secondary" onclick="VoiceMode.prevWord()">⏮️</button>
                            <button class="btn btn-primary" onclick="VoiceMode.play()" style="width: 60px; height: 60px; border-radius: 50%; font-size: 24px;">▶️</button>
                            <button class="btn btn-secondary" onclick="VoiceMode.nextWord()">⏭️</button>
                        </div>
                        <div style="display: flex; justify-content: center; gap: 8px;">
                            <button class="speed-btn" onclick="VoiceMode.setSpeed(0.5, this)">۰.۵x</button>
                            <button class="speed-btn active" onclick="VoiceMode.setSpeed(0.75, this)">۰.۷۵x</button>
                            <button class="speed-btn" onclick="VoiceMode.setSpeed(1, this)">۱x</button>
                        </div>
                        <button class="btn btn-secondary btn-block" onclick="VoiceMode.showMeaning()" style="margin-top: 20px;">👁️ نمایش معنی</button>
                        <div id="voiceMeaningReveal" style="display: none; margin-top: 16px; font-size: 20px; font-weight: 700;"></div>
                    </div>
                </div>

                <!-- Speak Mode -->
                <div id="voiceSpeakMode" style="display: none;">
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 16px; color: var(--text-secondary); margin-bottom: 8px;">این کلمه را بخوانید:</div>
                        <div style="font-size: 32px; font-weight: 800; margin-bottom: 32px;" id="speakTargetWord">Hello</div>
                        <button class="voice-btn" id="voiceRecordBtn" onclick="VoiceMode.toggleRecording()">🎤</button>
                        <div class="voice-status" id="voiceStatus">برای شروع ضبط کلیک کنید</div>
                        <div class="voice-result" id="voiceResult" style="display: none;">
                            <div class="voice-result-text" id="voiceResultText"></div>
                            <div id="voiceResultFeedback"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════
         SPACED READING MODAL
         ═══════════════════════════════════════════════════════════════ -->
    <div id="spacedReadingModal" class="modal-overlay">
        <div class="modal-container modal-large">
            <div class="modal-header">
                <h2>📖 مطالعه فاصله‌دار</h2>
                <button class="modal-close" onclick="SpacedReading.close()">✕</button>
            </div>
            <div class="modal-body">
                <div class="reading-mode-toggle">
                    <button class="reading-mode-btn active" onclick="SpacedReading.setMode('learn', this)">🎓 یادگیری</button>
                    <button class="reading-mode-btn" onclick="SpacedReading.setMode('read', this)">📖 مطالعه</button>
                </div>

                <div class="reading-container">
                    <div class="reading-text" id="readingText">
                        متنی را انتخاب کنید یا متن خود را وارد کنید...
                    </div>
                </div>

                <div class="word-info-card" id="wordInfoCard" style="display: none;">
                    <div class="word-info-header">
                        <span class="word-info-word" id="wordInfoWord"></span>
                        <button class="btn-sm" onclick="AudioPlayer.speak(document.getElementById('wordInfoWord').textContent)">🔊</button>
                    </div>
                    <div class="word-info-meaning" id="wordInfoMeaning"></div>
                    <div class="word-info-example" id="wordInfoExample"></div>
                    <div class="word-info-actions">
                        <button class="btn btn-sm" onclick="SpacedReading.markKnown()">✅ می‌دانم</button>
                        <button class="btn btn-sm btn-primary" onclick="SpacedReading.addToReview()">➕ اضافه به مرور</button>
                    </div>
                </div>

                <div class="reading-stats">
                    <div class="reading-stat">
                        <span class="reading-stat-value" id="readingWordsCount">۰</span>
                        <span class="reading-stat-label">کلمه</span>
                    </div>
                    <div class="reading-stat">
                        <span class="reading-stat-value" id="readingKnownCount">۰</span>
                        <span class="reading-stat-label">شناخته</span>
                    </div>
                    <div class="reading-stat">
                        <span class="reading-stat-value" id="readingNewCount">۰</span>
                        <span class="reading-stat-label">جدید</span>
                    </div>
                </div>

                <div class="section-title" style="margin-top: 20px;">📚 متن‌های نمونه</div>
                <div class="sample-texts-grid" id="sampleTextsGrid"></div>

                <div class="form-group" style="margin-top: 16px;">
                    <label class="form-label">متن دلخواه</label>
                    <textarea class="form-input form-textarea" id="customReadingText" rows="4" placeholder="متن انگلیسی خود را اینجا وارد کنید..." dir="ltr"></textarea>
                    <button class="btn btn-primary btn-block" style="margin-top: 12px;" onclick="SpacedReading.loadCustomText()">📖 شروع مطالعه</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════
         IMAGE CARD MODAL
         ═══════════════════════════════════════════════════════════════ -->
    <div id="imageCardModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h2>🖼️ کارت تصویری</h2>
                <button class="modal-close" onclick="ImageCard.close()">✕</button>
            </div>
            <div class="modal-body">
                <div class="image-upload-area" id="imageUploadArea" onclick="document.getElementById('imageInput').click()">
                    <div class="image-upload-icon">🖼️</div>
                    <div class="image-upload-text">برای آپلود تصویر کلیک کنید</div>
                    <div class="image-upload-hint">حداکثر 5MB</div>
                    <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="ImageCard.handleUpload(event)">
                </div>
                <div id="imagePreviewContainer" style="display: none; text-align: center; margin-bottom: 16px;">
                    <img id="imagePreview" class="image-preview">
                    <button class="btn btn-sm btn-secondary" onclick="ImageCard.removeImage()">🗑️ حذف</button>
                </div>
                <div class="form-group">
                    <label class="form-label">کلمه انگلیسی *</label>
                    <input type="text" class="form-input" id="imageCardWord" placeholder="Apple" dir="ltr">
                </div>
                <div class="form-group">
                    <label class="form-label">معنی فارسی *</label>
                    <input type="text" class="form-input" id="imageCardMeaning" placeholder="سیب">
                </div>
                <div class="form-group">
                    <label class="form-label">توضیح (اختیاری)</label>
                    <input type="text" class="form-input" id="imageCardDesc" placeholder="توضیح کوتاه...">
                </div>
                <button class="btn btn-primary btn-block" onclick="ImageCard.save()">✅ ذخیره</button>
            </div>
        </div
			</div>

    <!-- ═══════════════════════════════════════════════════════════════
         INSTALL MODAL
         ═══════════════════════════════════════════════════════════════ -->
    <div id="installModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-body">
                <div class="install-modal-content">
                    <div class="install-icon">📲</div>
                    <h2>نصب LEXORA</h2>
                    <p>برنامه را روی گوشی خود نصب کنید تا دسترسی سریع‌تری داشته باشید.</p>
                    <div class="install-steps" id="installSteps"></div>
                    <div class="install-buttons">
                        <button class="btn btn-primary btn-block" id="installBtn" onclick="InstallManager.install()">📲 نصب برنامه</button>
                        <button class="btn btn-secondary btn-block" onclick="InstallManager.close()">بعداً</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════
         NOTIFICATION MODAL
         ═══════════════════════════════════════════════════════════════ -->
    <div id="notificationModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-body">
                <div class="notification-modal-content">
                    <div class="notification-icon">🔔</div>
                    <h2>اعلان‌های هوشمند</h2>
                    <p>با فعال‌سازی اعلان‌ها، یادآوری مرور و پیشرفت‌های روزانه را دریافت کنید.</p>
                    <div class="notification-features">
                        <div class="notification-feature">
                            <span class="feature-icon">⏰</span>
                            <span>یادآوری مرور روزانه</span>
                        </div>
                        <div class="notification-feature">
                            <span class="feature-icon">🔥</span>
                            <span>هشدار از دست دادن Streak</span>
                        </div>
                        <div class="notification-feature">
                            <span class="feature-icon">🏆</span>
                            <span>اطلاع از دستاوردها</span>
                        </div>
                    </div>
                    <div class="notification-buttons">
                        <button class="btn btn-primary btn-block" onclick="SmartNotifications.requestPermission()">🔔 فعال‌سازی</button>
                        <button class="btn btn-secondary btn-block" onclick="SmartNotifications.closeModal()">بعداً</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════
         LEVEL UP MODAL
         ═══════════════════════════════════════════════════════════════ -->
    <div id="levelUpModal" class="level-up-modal">
        <div class="level-up-content">
            <div class="level-up-icon">🎉</div>
            <div class="level-up-title">سطح بالا رفت!</div>
            <div class="level-up-level" id="newLevelDisplay">۲</div>
            <div class="level-up-reward" id="levelUpReward">🎁 ۵۰ XP جایزه!</div>
            <button class="level-up-btn" onclick="Gamification.closeLevelUp()">عالی! 🚀</button>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════
         CONFIRM DIALOG
         ═══════════════════════════════════════════════════════════════ -->
    <div id="confirmModal" class="confirm-overlay">
        <div class="confirm-modal">
            <div class="confirm-header" id="confirmTitle">تأیید</div>
            <div class="confirm-body" id="confirmMessage">آیا مطمئن هستید؟</div>
            <div class="confirm-actions">
                <button class="confirm-delete" id="confirmYes" onclick="ConfirmDialog.yes()">بله</button>
                <button class="confirm-cancel" onclick="ConfirmDialog.close()">انصراف</button>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════
         ADD TO DECK MODAL
         ═══════════════════════════════════════════════════════════════ -->
    <div id="addToDeckModal" class="confirm-overlay">
        <div class="confirm-modal" style="max-width: 360px;">
            <div class="confirm-header">➕ افزودن به دک</div>
            <div class="confirm-body">
                <div class="form-group">
                    <label class="form-label">انتخاب دک:</label>
                    <select class="form-input" id="selectDeckForAdd" style="padding: 14px;"></select>
                </div>
            </div>
            <div class="confirm-actions">
                <button class="confirm-delete" style="background: var(--success); color: white;" onclick="Dictionary.confirmAddToDeck()">افزودن</button>
                <button class="confirm-cancel" onclick="Dictionary.closeAddModal()">انصراف</button>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════
         FAB BUTTONS
         ═══════════════════════════════════════════════════════════════ -->
    <div class="fab-container" id="fabContainer">
        <button class="fab-btn" onclick="Dictionary.open()" title="دیکشنری">📖</button>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════
         JAVASCRIPT - CORE UTILITIES
         ═══════════════════════════════════════════════════════════════ -->
    <script>
        'use strict';

        // ═══════════════════════════════════════════════════════════════
        // UTILITY FUNCTIONS
        // ═══════════════════════════════════════════════════════════════
        const Utils = {
            // Convert numbers to Persian
            toPersian(num) {
                if (num === null || num === undefined) return '۰';
                const persianDigits = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
                return String(num).replace(/[0-9]/g, d => persianDigits[parseInt(d)]);
            },

            // Convert Persian to English numbers
            toEnglish(str) {
                const persianDigits = '۰۱۲۳۴۵۶۷۸۹';
                return String(str).replace(/[۰-۹]/g, d => persianDigits.indexOf(d));
            },

            // Generate unique ID
            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            },

            // Format date
            formatDate(date) {
                const d = new Date(date);
                return d.toLocaleDateString('fa-IR');
            },

            // Format time interval
            formatInterval(minutes) {
                if (minutes < 1) return 'کمتر از ۱ دقیقه';
                if (minutes < 60) return `${this.toPersian(Math.round(minutes))} دقیقه`;
                if (minutes < 1440) return `${this.toPersian(Math.round(minutes / 60))} ساعت`;
                return `${this.toPersian(Math.round(minutes / 1440))} روز`;
            },

            // Shuffle array
            shuffle(array) {
                const arr = [...array];
                for (let i = arr.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [arr[i], arr[j]] = [arr[j], arr[i]];
                }
                return arr;
            },

            // Debounce function
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },

            // Get today's date string
            getTodayString() {
                return new Date().toDateString();
            },

            // Check if same day
            isSameDay(date1, date2) {
                const d1 = new Date(date1);
                const d2 = new Date(date2);
                return d1.toDateString() === d2.toDateString();
            },

            // Deep clone object
            deepClone(obj) {
                return JSON.parse(JSON.stringify(obj));
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // DATABASE (LocalStorage Wrapper)
        // ═══════════════════════════════════════════════════════════════
        const DB = {
            prefix: 'lexora_',

            get(key, defaultValue = null) {
                try {
                    const item = localStorage.getItem(this.prefix + key);
                    return item ? JSON.parse(item) : defaultValue;
                } catch (e) {
                    console.error('DB get error:', e);
                    return defaultValue;
                }
            },

            set(key, value) {
                try {
                    localStorage.setItem(this.prefix + key, JSON.stringify(value));
                    return true;
                } catch (e) {
                    console.error('DB set error:', e);
                    return false;
                }
            },

            remove(key) {
                try {
                    localStorage.removeItem(this.prefix + key);
                    return true;
                } catch (e) {
                    return false;
                }
            },

            clear() {
                try {
                    Object.keys(localStorage)
                        .filter(k => k.startsWith(this.prefix))
                        .forEach(k => localStorage.removeItem(k));
                    return true;
                } catch (e) {
                    return false;
                }
            },

            // Export all data
            exportAll() {
                const data = {};
                Object.keys(localStorage)
                    .filter(k => k.startsWith(this.prefix))
                    .forEach(k => {
                        data[k.replace(this.prefix, '')] = JSON.parse(localStorage.getItem(k));
                    });
                return data;
            },

            // Import all data
            importAll(data) {
                Object.keys(data).forEach(k => {
                    this.set(k, data[k]);
                });
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // TOAST NOTIFICATIONS
        // ═══════════════════════════════════════════════════════════════
        const Toast = {
            container: null,

            init() {
                this.container = document.getElementById('toastContainer');
            },

            show(message, type = 'info', duration = 3000) {
                if (!this.container) this.init();

                const icons = {
                    success: '✅',
                    error: '❌',
                    warning: '⚠️',
                    info: 'ℹ️'
                };

                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <span class="toast-icon">${icons[type]}</span>
                    <span class="toast-message">${message}</span>
                `;

                this.container.appendChild(toast);

                setTimeout(() => {
                    toast.classList.add('hiding');
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            },

            success(message) { this.show(message, 'success'); },
            error(message) { this.show(message, 'error'); },
            warning(message) { this.show(message, 'warning'); },
            info(message) { this.show(message, 'info'); }
        };

        // ═══════════════════════════════════════════════════════════════
        // CONFIRM DIALOG
        // ═══════════════════════════════════════════════════════════════
        const ConfirmDialog = {
            callback: null,

            show(title, message, onConfirm) {
                document.getElementById('confirmTitle').textContent = title;
                document.getElementById('confirmMessage').textContent = message;
                document.getElementById('confirmModal').classList.add('active');
                this.callback = onConfirm;
            },

            yes() {
                if (this.callback) this.callback();
                this.close();
            },

            close() {
                document.getElementById('confirmModal').classList.remove('active');
                this.callback = null;
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // AUDIO PLAYER (Text-to-Speech)
        // ═══════════════════════════════════════════════════════════════
        const AudioPlayer = {
            synth: window.speechSynthesis,
            rate: 0.8,
            voice: null,

            init() {
                // Load voices
                const loadVoices = () => {
                    const voices = this.synth.getVoices();
                    // Prefer English voices
                    this.voice = voices.find(v => v.lang.startsWith('en-US')) ||
                                 voices.find(v => v.lang.startsWith('en')) ||
                                 voices[0];
                };

                loadVoices();
                if (speechSynthesis.onvoiceschanged !== undefined) {
                    speechSynthesis.onvoiceschanged = loadVoices;
                }
            },

            speak(text, rate = this.rate) {
                if (!text) return;
                
                // Cancel any ongoing speech
                this.synth.cancel();

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = rate;
                utterance.pitch = 1;
                utterance.volume = 1;
                if (this.voice) utterance.voice = this.voice;

                this.synth.speak(utterance);
            },

            setRate(rate) {
                this.rate = rate;
            },

            stop() {
                this.synth.cancel();
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // CONFETTI EFFECT
        // ═══════════════════════════════════════════════════════════════
        const Confetti = {
            colors: ['#6366f1', '#8b5cf6', '#06b6d4', '#10b981', '#f59e0b', '#ef4444'],

            show(count = 50) {
                const container = document.getElementById('confettiContainer');
                
                for (let i = 0; i < count; i++) {
                    setTimeout(() => {
                        const confetti = document.createElement('div');
                        confetti.className = 'confetti';
                        confetti.style.left = Math.random() * 100 + 'vw';
                        confetti.style.background = this.colors[Math.floor(Math.random() * this.colors.length)];
                        confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                        confetti.style.animationDuration = (2 + Math.random() * 2) + 's';
                        
                        container.appendChild(confetti);
                        
                        setTimeout(() => confetti.remove(), 4000);
                    }, i * 30);
                }
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // NAVIGATION
        // ═══════════════════════════════════════════════════════════════
        const Navigation = {
            currentScreen: 'home',

            init() {
                // Handle back button
                window.addEventListener('popstate', (e) => {
                    if (e.state && e.state.screen) {
                        this.go(e.state.screen, false);
                    }
                });

                // Set initial state
                history.replaceState({ screen: 'home' }, '', '');
            },

            go(screenId, pushState = true) {
                // Hide all screens
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                
                // Show target screen
                const screen = document.getElementById(screenId);
                if (screen) {
                    screen.classList.add('active');
                    this.currentScreen = screenId;
                }

                // Update nav items
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.screen === screenId);
                });

                // Push to history
                if (pushState) {
                    history.pushState({ screen: screenId }, '', '');
                }

                // Screen-specific initialization
                this.onScreenChange(screenId);
            },

            onScreenChange(screenId) {
                switch (screenId) {
                    case 'home':
                        HomePage.refresh();
                        break;
                    case 'library':
                        Library.render();
                        break;
                    case 'stats':
                        StatsPage.refresh();
                        break;
                    case 'settings':
                        SettingsPage.refresh();
                        break;
                }
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // SETTINGS MANAGER
        // ═══════════════════════════════════════════════════════════════
        const Settings = {
            defaults: {
                dailyGoal: 20,
                newCardsPerDay: 10,
                darkMode: true,
                autoPlaySound: true,
                streak: 0,
                maxStreak: 0,
                lastReviewDate: null,
                reminderTime: 20
            },

            get() {
                return { ...this.defaults, ...DB.get('settings', {}) };
            },

            set(key, value) {
                const settings = this.get();
                settings[key] = value;
                DB.set('settings', settings);
            },

            toggleTheme() {
                const settings = this.get();
                settings.darkMode = !settings.darkMode;
                DB.set('settings', settings);
                
                document.documentElement.setAttribute('data-theme', settings.darkMode ? 'dark' : 'light');
                document.getElementById('themeToggle').classList.toggle('active', settings.darkMode);
                
                Toast.success(settings.darkMode ? 'حالت تاریک فعال شد' : 'حالت روشن فعال شد');
            },

            toggleSound() {
                const settings = this.get();
                settings.autoPlaySound = !settings.autoPlaySound;
                DB.set('settings', settings);
                
                document.getElementById('soundToggle').classList.toggle('active', settings.autoPlaySound);
                Toast.success(settings.autoPlaySound ? 'صدا فعال شد' : 'صدا غیرفعال شد');
            },

            openDailyGoal() {
                const current = this.get().dailyGoal;
                const newGoal = prompt('هدف روزانه (تعداد کارت):', current);
                if (newGoal && !isNaN(newGoal) && newGoal > 0) {
                    this.set('dailyGoal', parseInt(newGoal));
                    document.getElementById('settingDailyGoal').textContent = Utils.toPersian(newGoal) + ' کارت';
                    Toast.success('هدف روزانه تغییر کرد');
                }
            },

            openNewCardsPerDay() {
                const current = this.get().newCardsPerDay;
                const newCount = prompt('تعداد کارت جدید در روز:', current);
                if (newCount && !isNaN(newCount) && newCount >= 0) {
                    this.set('newCardsPerDay', parseInt(newCount));
                    document.getElementById('settingNewCards').textContent = Utils.toPersian(newCount) + ' کارت';
                    Toast.success('تنظیمات ذخیره شد');
                }
            },

            exportData() {
                const data = DB.exportAll();
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `lexora-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                Toast.success('پشتیبان‌گیری انجام شد');
            },

            importData() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = JSON.parse(event.target.result);
                            DB.importAll(data);
                            Toast.success('داده‌ها بازیابی شدند');
                            setTimeout(() => location.reload(), 1000);
                        } catch (err) {
                            Toast.error('فایل معتبر نیست');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            },

            confirmReset() {
                ConfirmDialog.show(
                    'پاک کردن همه داده‌ها',
                    'آیا مطمئن هستید؟ این عمل قابل بازگشت نیست.',
                    () => {
                        DB.clear();
                        Toast.success('همه داده‌ها پاک شدند');
                        setTimeout(() => location.reload(), 1000);
                    }
                );
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // SETTINGS PAGE
        // ═══════════════════════════════════════════════════════════════
        const SettingsPage = {
            refresh() {
                const settings = Settings.get();
                
                document.getElementById('settingDailyGoal').textContent = Utils.toPersian(settings.dailyGoal) + ' کارت';
                document.getElementById('settingNewCards').textContent = Utils.toPersian(settings.newCardsPerDay) + ' کارت';
                document.getElementById('themeToggle').classList.toggle('active', settings.darkMode);
                document.getElementById('soundToggle').classList.toggle('active', settings.autoPlaySound);
                
                // Notification status
                const notifStatus = document.getElementById('notifStatus');
                if (notifStatus) {
                    notifStatus.textContent = SmartNotifications.permission === 'granted' ? '✅ فعال' : 'غیرفعال';
                }
            }
        };
		// ═══════════════════════════════════════════════════════════════
        // DECK MANAGER
        // ═══════════════════════════════════════════════════════════════
        const DeckManager = {
            selectedEmoji: '📚',

            getAll() {
                return DB.get('decks', []);
            },

            get(id) {
                return this.getAll().find(d => d.id === id);
            },

            create(name, description = '', emoji = '📚') {
                const decks = this.getAll();
                const newDeck = {
                    id: Utils.generateId(),
                    name: name,
                    description: description,
                    emoji: emoji,
                    createdAt: Date.now(),
                    isCustom: true
                };
                decks.push(newDeck);
                DB.set('decks', decks);
                return newDeck;
            },

            update(id, updates) {
                const decks = this.getAll();
                const index = decks.findIndex(d => d.id === id);
                if (index !== -1) {
                    decks[index] = { ...decks[index], ...updates };
                    DB.set('decks', decks);
                    return decks[index];
                }
                return null;
            },

            delete(id) {
                // Delete deck
                let decks = this.getAll();
                decks = decks.filter(d => d.id !== id);
                DB.set('decks', decks);

                // Delete associated cards
                let cards = CardManager.getAll();
                cards = cards.filter(c => c.deckId !== id);
                DB.set('cards', cards);

                return true;
            },

            getCardCount(deckId) {
                const cards = CardManager.getAll();
                return cards.filter(c => c.deckId === deckId).length;
            },

            getDueCount(deckId) {
                const cards = CardManager.getAll();
                const now = Date.now();
                return cards.filter(c => c.deckId === deckId && c.nextReview <= now).length;
            },

            getNewCount(deckId) {
                const cards = CardManager.getAll();
                return cards.filter(c => c.deckId === deckId && c.state === 'new').length;
            },

            // UI Methods
            openCreate() {
                this.selectedEmoji = '📚';
                document.getElementById('newDeckName').value = '';
                document.getElementById('newDeckDesc').value = '';
                document.querySelectorAll('.emoji-option').forEach(e => {
                    e.classList.toggle('selected', e.dataset.emoji === '📚');
                });
                document.getElementById('createDeckModal').classList.add('active');
            },

            closeCreate() {
                document.getElementById('createDeckModal').classList.remove('active');
            },

            selectEmoji(emoji, el) {
                this.selectedEmoji = emoji;
                document.querySelectorAll('.emoji-option').forEach(e => e.classList.remove('selected'));
                el.classList.add('selected');
            },

            createFromUI() {
                const name = document.getElementById('newDeckName').value.trim();
                const desc = document.getElementById('newDeckDesc').value.trim();

                if (!name) {
                    Toast.warning('لطفاً نام دک را وارد کنید');
                    return;
                }

                this.create(name, desc, this.selectedEmoji);
                this.closeCreate();
                Toast.success('دک جدید ساخته شد');
                Gamification.addXP(10, '📦 ساخت دک جدید');
                Library.render();
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // CARD MANAGER
        // ═══════════════════════════════════════════════════════════════
        const CardManager = {
            getAll() {
                return DB.get('cards', []);
            },

            get(id) {
                return this.getAll().find(c => c.id === id);
            },

            create(cardData) {
                const cards = this.getAll();
                const newCard = {
                    id: Utils.generateId(),
                    deckId: cardData.deckId,
                    word: cardData.word,
                    meaning: cardData.meaning,
                    pronunciation: cardData.pronunciation || '',
                    example: cardData.example || '',
                    mnemonic: cardData.mnemonic || '',
                    image: cardData.image || null,
                    tags: cardData.tags || [],
                    starred: false,
                    // FSRS Parameters
                    state: 'new', // new, learning, review, relearning
                    stability: 0,
                    difficulty: 0,
                    elapsedDays: 0,
                    scheduledDays: 0,
                    reps: 0,
                    lapses: 0,
                    lastReview: null,
                    nextReview: Date.now(),
                    createdAt: Date.now()
                };
                cards.push(newCard);
                DB.set('cards', cards);
                return newCard;
            },

            update(id, updates) {
                const cards = this.getAll();
                const index = cards.findIndex(c => c.id === id);
                if (index !== -1) {
                    cards[index] = { ...cards[index], ...updates };
                    DB.set('cards', cards);
                    return cards[index];
                }
                return null;
            },

            delete(id) {
                let cards = this.getAll();
                cards = cards.filter(c => c.id !== id);
                DB.set('cards', cards);
                return true;
            },

            getByDeck(deckId) {
                return this.getAll().filter(c => c.deckId === deckId);
            },

            getDueCards(deckId = null) {
                const now = Date.now();
                let cards = this.getAll().filter(c => c.nextReview <= now);
                if (deckId) {
                    cards = cards.filter(c => c.deckId === deckId);
                }
                return cards;
            },

            getNewCards(deckId = null, limit = null) {
                let cards = this.getAll().filter(c => c.state === 'new');
                if (deckId) {
                    cards = cards.filter(c => c.deckId === deckId);
                }
                if (limit) {
                    cards = cards.slice(0, limit);
                }
                return cards;
            },

            toggleStar(id) {
                const card = this.get(id);
                if (card) {
                    this.update(id, { starred: !card.starred });
                    return !card.starred;
                }
                return false;
            },

            getStarred() {
                return this.getAll().filter(c => c.starred);
            },

            getMastered() {
                return this.getAll().filter(c => c.stability >= 30 && c.reps >= 5);
            },

            search(query) {
                const q = query.toLowerCase();
                return this.getAll().filter(c => 
                    c.word.toLowerCase().includes(q) ||
                    c.meaning.toLowerCase().includes(q)
                );
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // FSRS-4.5 ALGORITHM
        // ═══════════════════════════════════════════════════════════════
        const FSRS = {
            // FSRS-4.5 Parameters (optimized defaults)
            params: {
                w: [0.4, 0.6, 2.4, 5.8, 4.93, 0.94, 0.86, 0.01, 1.49, 0.14, 0.94, 2.18, 0.05, 0.34, 1.26, 0.29, 2.61],
                requestRetention: 0.9,
                maximumInterval: 36500,
                easyBonus: 1.3,
                hardInterval: 1.2
            },

            // Rating constants
            AGAIN: 1,
            HARD: 2,
            GOOD: 3,
            EASY: 4,

            // Calculate initial difficulty
            initDifficulty(rating) {
                return Math.min(Math.max(
                    this.params.w[4] - (rating - 3) * this.params.w[5],
                    1
                ), 10);
            },

            // Calculate initial stability
            initStability(rating) {
                return Math.max(this.params.w[rating - 1], 0.1);
            },

            // Calculate next difficulty
            nextDifficulty(d, rating) {
                const nextD = d - this.params.w[6] * (rating - 3);
                return Math.min(Math.max(
                    this.meanReversion(this.params.w[4], nextD),
                    1
                ), 10);
            },

            // Mean reversion
            meanReversion(init, current) {
                return this.params.w[7] * init + (1 - this.params.w[7]) * current;
            },

            // Calculate next stability after recall
            nextRecallStability(d, s, r, rating) {
                const hardPenalty = rating === this.HARD ? this.params.w[15] : 1;
                const easyBonus = rating === this.EASY ? this.params.w[16] : 1;

                return s * (
                    1 +
                    Math.exp(this.params.w[8]) *
                    (11 - d) *
                    Math.pow(s, -this.params.w[9]) *
                    (Math.exp((1 - r) * this.params.w[10]) - 1) *
                    hardPenalty *
                    easyBonus
                );
            },

            // Calculate next stability after forgetting
            nextForgetStability(d, s, r) {
                return this.params.w[11] *
                    Math.pow(d, -this.params.w[12]) *
                    (Math.pow(s + 1, this.params.w[13]) - 1) *
                    Math.exp((1 - r) * this.params.w[14]);
            },

            // Calculate retrievability (probability of recall)
            retrievability(elapsedDays, stability) {
                if (stability <= 0) return 0;
                return Math.pow(1 + elapsedDays / (9 * stability), -1);
            },

            // Calculate next interval
            nextInterval(stability) {
                const interval = Math.round(
                    stability * 9 * (1 / this.params.requestRetention - 1)
                );
                return Math.min(Math.max(interval, 1), this.params.maximumInterval);
            },

            // Main scheduling function
            schedule(card, rating) {
                const now = Date.now();
                const elapsedDays = card.lastReview 
                    ? (now - card.lastReview) / (1000 * 60 * 60 * 24) 
                    : 0;

                let newState = card.state;
                let newStability = card.stability;
                let newDifficulty = card.difficulty;
                let newReps = card.reps;
                let newLapses = card.lapses;
                let interval = 0;

                // Calculate current retrievability
                const r = card.state === 'new' ? 0 : this.retrievability(elapsedDays, card.stability);

                if (card.state === 'new') {
                    // New card
                    newDifficulty = this.initDifficulty(rating);
                    newStability = this.initStability(rating);
                    newReps = 1;

                    if (rating === this.AGAIN) {
                        newState = 'learning';
                        interval = 1 / (24 * 60); // 1 minute
                    } else if (rating === this.HARD) {
                        newState = 'learning';
                        interval = 5 / (24 * 60); // 5 minutes
                    } else if (rating === this.GOOD) {
                        newState = 'learning';
                        interval = 10 / (24 * 60); // 10 minutes
                    } else {
                        newState = 'review';
                        interval = this.nextInterval(newStability);
                    }
                } else if (card.state === 'learning' || card.state === 'relearning') {
                    // Learning/relearning card
                    if (rating === this.AGAIN) {
                        newStability = this.initStability(rating);
                        interval = 1 / (24 * 60); // 1 minute
                    } else if (rating === this.HARD) {
                        newStability = this.initStability(rating);
                        interval = 5 / (24 * 60); // 5 minutes
                    } else if (rating === this.GOOD) {
                        newState = 'review';
                        newStability = this.initStability(rating);
                        interval = this.nextInterval(newStability);
                        newReps = card.reps + 1;
                    } else {
                        newState = 'review';
                        newStability = this.initStability(rating) * this.params.easyBonus;
                        interval = this.nextInterval(newStability);
                        newReps = card.reps + 1;
                    }
                } else {
                    // Review card
                    newDifficulty = this.nextDifficulty(card.difficulty, rating);
                    newReps = card.reps + 1;

                    if (rating === this.AGAIN) {
                        newState = 'relearning';
                        newStability = this.nextForgetStability(newDifficulty, card.stability, r);
                        newLapses = card.lapses + 1;
                        interval = 1 / (24 * 60); // 1 minute
                    } else {
                        newStability = this.nextRecallStability(newDifficulty, card.stability, r, rating);
                        interval = this.nextInterval(newStability);

                        if (rating === this.HARD) {
                            interval = Math.min(interval, card.scheduledDays * this.params.hardInterval);
                        }
                    }
                }

                // Convert interval to milliseconds
                const intervalMs = interval * 24 * 60 * 60 * 1000;

                return {
                    state: newState,
                    stability: newStability,
                    difficulty: newDifficulty,
                    reps: newReps,
                    lapses: newLapses,
                    elapsedDays: elapsedDays,
                    scheduledDays: interval,
                    lastReview: now,
                    nextReview: now + intervalMs
                };
            },

            // Get preview intervals for all ratings
            getIntervals(card) {
                const intervals = {};
                const ratings = [this.AGAIN, this.HARD, this.GOOD, this.EASY];
                const labels = ['again', 'hard', 'good', 'easy'];

                ratings.forEach((rating, i) => {
                    const scheduled = this.schedule(card, rating);
                    intervals[labels[i]] = scheduled.scheduledDays;
                });

                return intervals;
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // MODE SELECTOR
        // ═══════════════════════════════════════════════════════════════
        const ModeSelector = {
            selectedMode: 'recognition',
            deckId: null,

            open(deckId = null) {
                this.deckId = deckId;
                this.selectedMode = 'recognition';
                
                // Update UI
                document.querySelectorAll('.mode-option').forEach(opt => {
                    opt.classList.toggle('selected', opt.dataset.mode === 'recognition');
                });
                
                document.getElementById('modeSelectorModal').classList.add('active');
            },

            close() {
                document.getElementById('modeSelectorModal').classList.remove('active');
            },

            select(mode, element) {
                this.selectedMode = mode;
                document.querySelectorAll('.mode-option').forEach(opt => opt.classList.remove('selected'));
                element.classList.add('selected');
            },

            startReview() {
                this.close();
                Review.start(this.deckId, this.selectedMode);
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // REVIEW SYSTEM
        // ═══════════════════════════════════════════════════════════════
        const Review = {
            // State
            cards: [],
            currentIndex: 0,
            currentCard: null,
            mode: 'recognition',
            deckId: null,
            isFlipped: false,
            sessionStats: {
                reviewed: 0,
                correct: 0,
                xpEarned: 0
            },

            start(deckId = null, mode = 'recognition') {
                this.deckId = deckId;
                this.mode = mode;
                this.currentIndex = 0;
                this.isFlipped = false;
                this.sessionStats = { reviewed: 0, correct: 0, xpEarned: 0 };

                // Get cards to review
                const settings = Settings.get();
                let dueCards = CardManager.getDueCards(deckId);
                let newCards = CardManager.getNewCards(deckId, settings.newCardsPerDay);

                // Combine and shuffle
                this.cards = Utils.shuffle([...dueCards, ...newCards]);

                // Limit to daily goal
                this.cards = this.cards.slice(0, settings.dailyGoal);

                if (this.cards.length === 0) {
                    Toast.info('کارتی برای مرور نیست! 🎉');
                    return;
                }

                // Show modal
                document.getElementById('flashcardModal').classList.add('active');
                
                // Set mode indicator
                const modeIcons = {
                    'recognition': '👁️',
                    'reverse': '🔄',
                    'listening': '🎧',
                    'spelling': '✍️',
                    'quiz': '🎯'
                };
                document.getElementById('reviewModeIndicator').textContent = modeIcons[mode] || '👁️';

                // Hide all modes, show current
                document.querySelectorAll('.card-mode').forEach(m => m.classList.remove('active'));
                document.getElementById(mode + 'Mode').classList.add('active');

                // Hide complete screen
                document.getElementById('completeScreen').classList.remove('active');
                document.getElementById('ratingContainer').classList.remove('active');

                // Show first card
                this.showCard();
            },

            showCard() {
                if (this.currentIndex >= this.cards.length) {
                    this.showComplete();
                    return;
                }

                this.currentCard = this.cards[this.currentIndex];
                this.isFlipped = false;

                // Update progress
                this.updateProgress();

                // Reset UI
                document.getElementById('ratingContainer').classList.remove('active');
                
                const flashcard = document.getElementById('flashcard');
                if (flashcard) flashcard.classList.remove('flipped');

                const reverseFlashcard = document.getElementById('reverseFlashcard');
                if (reverseFlashcard) reverseFlashcard.classList.remove('flipped');

                // Render based on mode
                switch (this.mode) {
                    case 'recognition':
                        this.renderRecognition();
                        break;
                    case 'reverse':
                        this.renderReverse();
                        break;
                    case 'listening':
                        this.renderListening();
                        break;
                    case 'spelling':
                        this.renderSpelling();
                        break;
                    case 'quiz':
                        this.renderQuiz();
                        break;
                }

                // Update intervals preview
                this.updateIntervalsPreview();
            },

            renderRecognition() {
                const card = this.currentCard;
                
                document.getElementById('cardWord').textContent = card.word;
                document.getElementById('cardPronunciation').textContent = card.pronunciation || '';
                document.getElementById('cardMeaning').textContent = card.meaning;
                document.getElementById('cardExample').textContent = card.example || '';
                document.getElementById('cardMnemonic').textContent = card.mnemonic ? `💡 ${card.mnemonic}` : '';
                document.getElementById('cardMnemonic').style.display = card.mnemonic ? 'block' : 'none';

                // Star button
                const starBtn = document.getElementById('starBtn');
                starBtn.textContent = card.starred ? '★' : '☆';
                starBtn.classList.toggle('starred', card.starred);

                // Auto-play sound
                const settings = Settings.get();
                if (settings.autoPlaySound) {
                    setTimeout(() => this.speak(), 300);
                }
            },

            renderReverse() {
                const card = this.currentCard;
                
                document.getElementById('reverseMeaning').textContent = card.meaning;
                document.getElementById('reverseWord').textContent = card.word;
                document.getElementById('reversePronunciation').textContent = card.pronunciation || '';
                document.getElementById('reverseExample').textContent = card.example || '';
            },

            renderListening() {
                const card = this.currentCard;
                
                document.getElementById('listeningInput').value = '';
                document.getElementById('listeningFeedback').style.display = 'none';
                document.getElementById('listeningCorrectAnswer').textContent = card.word;

                // Play sound
                setTimeout(() => this.speak(), 500);
            },

            renderSpelling() {
                const card = this.currentCard;
                
                document.getElementById('spellingMeaning').textContent = card.meaning;
                document.getElementById('spellingInput').value = '';
                document.getElementById('spellingFeedback').style.display = 'none';
                document.getElementById('spellingCorrectAnswer').textContent = card.word;
            },

            renderQuiz() {
                const card = this.currentCard;
                
                document.getElementById('quizWord').textContent = card.word;
                document.getElementById('quizPronunciation').textContent = card.pronunciation || '';

                // Get wrong options (random meanings from other cards)
                const allCards = CardManager.getAll().filter(c => c.id !== card.id);
                const shuffled = Utils.shuffle(allCards);
                const wrongOptions = shuffled.slice(0, 3).map(c => c.meaning);

                // Combine and shuffle options
                const options = Utils.shuffle([card.meaning, ...wrongOptions]);

                // Render options
                const optionsContainer = document.getElementById('quizOptions');
                optionsContainer.innerHTML = options.map((opt, i) => `
                    <div class="quiz-option" data-correct="${opt === card.meaning}" onclick="Review.selectQuizOption(this, ${opt === card.meaning})">
                        ${opt}
                    </div>
                `).join('');

                // Auto-play sound
                const settings = Settings.get();
                if (settings.autoPlaySound) {
                    setTimeout(() => this.speak(), 300);
                }
            },

            flip() {
                if (this.isFlipped) return;
                
                this.isFlipped = true;
                document.getElementById('flashcard').classList.add('flipped');
                document.getElementById('ratingContainer').classList.add('active');

                // Play sound on flip
                this.speak();
            },

            flipReverse() {
                if (this.isFlipped) return;
                
                this.isFlipped = true;
                document.getElementById('reverseFlashcard').classList.add('flipped');
                document.getElementById('ratingContainer').classList.add('active');

                // Play sound
                this.speak();
            },

            speak() {
                if (this.currentCard) {
                    AudioPlayer.speak(this.currentCard.word);
                }
            },

            toggleStar() {
                if (!this.currentCard) return;
                
                const newStarred = CardManager.toggleStar(this.currentCard.id);
                this.currentCard.starred = newStarred;

                const starBtn = document.getElementById('starBtn');
                starBtn.textContent = newStarred ? '★' : '☆';
                starBtn.classList.toggle('starred', newStarred);

                Toast.success(newStarred ? 'به ستاره‌دار‌ها اضافه شد' : 'از ستاره‌دار‌ها حذف شد');
            },

            checkListening() {
                const input = document.getElementById('listeningInput').value.trim().toLowerCase();
                const correct = this.currentCard.word.toLowerCase();
                const isCorrect = input === correct;

                const feedback = document.getElementById('listeningFeedback');
                const icon = document.getElementById('listeningFeedbackIcon');
                const text = document.getElementById('listeningFeedbackText');

                feedback.style.display = 'block';
                feedback.classList.toggle('success', isCorrect);
                feedback.classList.toggle('error', !isCorrect);

                if (isCorrect) {
                    icon.textContent = '✅';
                    text.textContent = 'آفرین! درست بود';
                    this.sessionStats.correct++;
                    setTimeout(() => this.autoRate(isCorrect), 1500);
                } else {
                    icon.textContent = '❌';
                    text.textContent = 'اشتباه بود';
                    document.getElementById('ratingContainer').classList.add('active');
                }
            },

            checkSpelling() {
                const input = document.getElementById('spellingInput').value.trim().toLowerCase();
                const correct = this.currentCard.word.toLowerCase();
                const isCorrect = input === correct;

                const feedback = document.getElementById('spellingFeedback');
                const icon = document.getElementById('spellingFeedbackIcon');
                const text = document.getElementById('spellingFeedbackText');

                feedback.style.display = 'block';
                feedback.classList.toggle('success', isCorrect);
                feedback.classList.toggle('error', !isCorrect);

                if (isCorrect) {
                    icon.textContent = '✅';
                    text.textContent = 'آفرین! درست بود';
                    this.sessionStats.correct++;
                    setTimeout(() => this.autoRate(isCorrect), 1500);
                } else {
                    icon.textContent = '❌';
                    text.textContent = 'اشتباه بود';
                    document.getElementById('ratingContainer').classList.add('active');
                }
            },

            selectQuizOption(element, isCorrect) {
                // Disable all options
                document.querySelectorAll('.quiz-option').forEach(opt => {
                    opt.style.pointerEvents = 'none';
                    if (opt.dataset.correct === 'true') {
                        opt.classList.add('correct');
                    }
                });

                if (isCorrect) {
                    element.classList.add('correct');
                    this.sessionStats.correct++;
                    Gamification.addXP(5, '✅ پاسخ صحیح');
                    setTimeout(() => this.autoRate(true), 1000);
                } else {
                    element.classList.add('wrong');
                    document.getElementById('ratingContainer').classList.add('active');
                }
            },

            autoRate(isCorrect) {
                this.rate(isCorrect ? FSRS.GOOD : FSRS.AGAIN);
            },

            rate(rating) {
                if (!this.currentCard) return;

                // Apply FSRS scheduling
                const updates = FSRS.schedule(this.currentCard, rating);
                CardManager.update(this.currentCard.id, updates);

                // Record review
                this.recordReview(rating);

                // Update stats
                this.sessionStats.reviewed++;
                if (rating >= FSRS.GOOD) {
                    this.sessionStats.correct++;
                }

                // Add XP based on rating
                const xpAmounts = { 1: 1, 2: 3, 3: 5, 4: 8 };
                const xp = xpAmounts[rating] || 5;
                this.sessionStats.xpEarned += xp;
                Gamification.addXP(xp, rating >= FSRS.GOOD ? '✅ مرور موفق' : '📖 مرور');

                // Next card
                this.currentIndex++;
                this.showCard();
            },

            recordReview(rating) {
                const reviews = DB.get('reviews', []);
                reviews.push({
                    cardId: this.currentCard.id,
                    rating: rating,
                    timestamp: Date.now()
                });
                DB.set('reviews', reviews);
            },

            updateProgress() {
                const total = this.cards.length;
                const current = this.currentIndex;
                const percent = total > 0 ? Math.round((current / total) * 100) : 0;

                document.getElementById('reviewProgressBar').style.width = percent + '%';
                document.getElementById('reviewProgressText').textContent = 
                    `${Utils.toPersian(current)} از ${Utils.toPersian(total)}`;
            },

            updateIntervalsPreview() {
                if (!this.currentCard) return;

                const intervals = FSRS.getIntervals(this.currentCard);

                document.getElementById('timeAgain').textContent = Utils.formatInterval(intervals.again * 24 * 60);
                document.getElementById('timeHard').textContent = Utils.formatInterval(intervals.hard * 24 * 60);
                document.getElementById('timeGood').textContent = Utils.formatInterval(intervals.good * 24 * 60);
                document.getElementById('timeEasy').textContent = Utils.formatInterval(intervals.easy * 24 * 60);
            },

            showComplete() {
                // Hide card mode
                document.querySelectorAll('.card-mode').forEach(m => m.classList.remove('active'));
                document.getElementById('ratingContainer').classList.remove('active');

                // Show complete screen
                document.getElementById('completeScreen').classList.add('active');

                // Update stats
                const accuracy = this.sessionStats.reviewed > 0 
                    ? Math.round((this.sessionStats.correct / this.sessionStats.reviewed) * 100) 
                    : 0;

                document.getElementById('completeReviewed').textContent = Utils.toPersian(this.sessionStats.reviewed);
                document.getElementById('completeAccuracy').textContent = Utils.toPersian(accuracy) + '٪';
                document.getElementById('completeXP').textContent = '+' + Utils.toPersian(this.sessionStats.xpEarned) + ' XP';

                // Update streak
                this.updateStreak();

                // Check challenges
                Challenges.checkProgress();

                // Show confetti if good performance
                if (accuracy >= 80 && this.sessionStats.reviewed >= 5) {
                    Confetti.show(30);
                }

                // Bonus XP for completion
                Gamification.addXP(10, '🎯 تکمیل مرور');
            },

            updateStreak() {
                const settings = Settings.get();
                const today = Utils.getTodayString();
                const lastReview = settings.lastReviewDate;

                if (lastReview !== today) {
                    // Check if yesterday
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    
                    if (lastReview === yesterday.toDateString()) {
                        // Continue streak
                        settings.streak = (settings.streak || 0) + 1;
                    } else if (lastReview) {
                        // Reset streak
                        settings.streak = 1;
                    } else {
                        settings.streak = 1;
                    }

                    // Update max streak
                    settings.maxStreak = Math.max(settings.maxStreak || 0, settings.streak);
                    settings.lastReviewDate = today;
                    
                    DB.set('settings', settings);

                    // Check streak milestones
                    if ([3, 7, 14, 30, 50, 100].includes(settings.streak)) {
                        Gamification.addXP(settings.streak * 2, `🔥 ${Utils.toPersian(settings.streak)} روز متوالی!`);
                        SmartNotifications.onStreakMilestone(settings.streak);
                    }
                }
            },

            close() {
                document.getElementById('flashcardModal').classList.remove('active');
                
                // Refresh home page
                HomePage.refresh();
            }
        };
		// ═══════════════════════════════════════════════════════════════
        // HOME PAGE
        // ═══════════════════════════════════════════════════════════════
        const HomePage = {
            init() {
                this.refresh();
                this.renderWordOfDay();
                this.updateGreeting();
            },

            refresh() {
                this.updateHeroStats();
                this.updateDailyProgress();
                this.updateStreakDays();
                this.updateDailyReward();
                this.renderQuickStartDecks();
                this.renderBadges();
            },

            updateGreeting() {
                const hour = new Date().getHours();
                let greeting = '';
                
                if (hour < 12) {
                    greeting = 'صبح بخیر! ☀️';
                } else if (hour < 17) {
                    greeting = 'ظهر بخیر! 🌤️';
                } else if (hour < 21) {
                    greeting = 'عصر بخیر! 🌅';
                } else {
                    greeting = 'شب بخیر! 🌙';
                }

                const el = document.getElementById('heroGreeting');
                if (el) el.textContent = greeting;
            },

            updateHeroStats() {
                const settings = Settings.get();
                const gamification = Gamification.getData();

                // Streak
                const streakEl = document.getElementById('heroStreak');
                if (streakEl) streakEl.textContent = Utils.toPersian(settings.streak || 0);

                // Level
                const levelEl = document.getElementById('heroLevel');
                if (levelEl) levelEl.textContent = Utils.toPersian(gamification.level || 1);

                // XP Bar
                const currentXP = gamification.xp || 0;
                const xpForCurrentLevel = Gamification.getXPForLevel(gamification.level);
                const xpForNextLevel = Gamification.getXPForLevel(gamification.level + 1);
                const xpProgress = xpForNextLevel - xpForCurrentLevel;
                const xpInLevel = currentXP - xpForCurrentLevel;
                const xpPercent = Math.min((xpInLevel / xpProgress) * 100, 100);

                const xpBar = document.getElementById('heroXpBar');
                if (xpBar) xpBar.style.width = xpPercent + '%';

                const xpCurrentEl = document.getElementById('heroXpCurrent');
                if (xpCurrentEl) xpCurrentEl.textContent = Utils.toPersian(xpInLevel);

                const xpNextEl = document.getElementById('heroXpNext');
                if (xpNextEl) xpNextEl.textContent = Utils.toPersian(xpProgress - xpInLevel);
            },

            updateDailyProgress() {
                const settings = Settings.get();
                const today = Utils.getTodayString();
                
                // Get today's reviews
                const reviews = DB.get('reviews', []);
                const todayReviews = reviews.filter(r => 
                    Utils.isSameDay(r.timestamp, Date.now())
                );

                const reviewed = todayReviews.length;
                const goal = settings.dailyGoal || 20;
                const percent = Math.min(Math.round((reviewed / goal) * 100), 100);

                // Update ring
                const ring = document.getElementById('progressRingFill');
                if (ring) {
                    const circumference = 2 * Math.PI * 40; // r=40
                    const offset = circumference - (percent / 100) * circumference;
                    ring.style.strokeDashoffset = offset;
                }

                // Update percent text
                const percentEl = document.getElementById('progressPercent');
                if (percentEl) percentEl.textContent = Utils.toPersian(percent) + '٪';

                // Update details
                const reviewedEl = document.getElementById('detailReviewed');
                if (reviewedEl) reviewedEl.textContent = Utils.toPersian(reviewed) + ' کارت';

                const goalEl = document.getElementById('detailGoal');
                if (goalEl) goalEl.textContent = Utils.toPersian(goal) + ' کارت';

                // Today's accuracy
                const correctReviews = todayReviews.filter(r => r.rating >= 3).length;
                const accuracy = reviewed > 0 ? Math.round((correctReviews / reviewed) * 100) : 0;
                
                const accuracyEl = document.getElementById('detailAccuracy');
                if (accuracyEl) accuracyEl.textContent = reviewed > 0 ? Utils.toPersian(accuracy) + '٪' : '-';
            },

            updateStreakDays() {
                const settings = Settings.get();
                const container = document.getElementById('streakDays');
                const streakCountEl = document.getElementById('streakCount');
                
                if (streakCountEl) {
                    streakCountEl.textContent = Utils.toPersian(settings.streak || 0);
                }

                if (!container) return;

                // Get last 7 days
                const days = ['ش', 'ی', 'د', 'س', 'چ', 'پ', 'ج'];
                const today = new Date();
                const reviews = DB.get('reviews', []);

                let html = '';
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    
                    const dayName = days[date.getDay()];
                    const hasReview = reviews.some(r => Utils.isSameDay(r.timestamp, date.getTime()));
                    const isToday = i === 0;

                    html += `
                        <div class="streak-day ${hasReview ? 'completed' : ''} ${isToday ? 'today' : ''}">
                            ${dayName}
                        </div>
                    `;
                }

                container.innerHTML = html;
            },

            updateDailyReward() {
                const today = Utils.getTodayString();
                const lastClaim = DB.get('lastDailyReward', null);
                const claimed = lastClaim === today;

                const card = document.getElementById('dailyRewardCard');
                const btn = document.getElementById('dailyRewardBtn');
                const btnText = document.getElementById('dailyRewardBtnText');
                const desc = document.getElementById('dailyRewardDesc');

                if (card) card.classList.toggle('claimed', claimed);
                if (btnText) btnText.textContent = claimed ? 'دریافت شد ✓' : 'دریافت';
                if (desc) desc.textContent = claimed ? 'فردا دوباره بیا!' : 'برای دریافت XP کلیک کنید!';
            },

            renderWordOfDay() {
                // Sample words of the day
                const words = [
                    { word: 'Serendipity', pronunciation: '/ˌserənˈdɪpɪti/', meaning: 'خوش‌شانسی غیرمنتظره' },
                    { word: 'Eloquent', pronunciation: '/ˈeləkwənt/', meaning: 'فصیح، خوش‌بیان' },
                    { word: 'Ephemeral', pronunciation: '/ɪˈfemərəl/', meaning: 'زودگذر، فانی' },
                    { word: 'Resilience', pronunciation: '/rɪˈzɪliəns/', meaning: 'تاب‌آوری، انعطاف‌پذیری' },
                    { word: 'Ubiquitous', pronunciation: '/juːˈbɪkwɪtəs/', meaning: 'همه‌جا حاضر' },
                    { word: 'Pragmatic', pronunciation: '/præɡˈmætɪk/', meaning: 'عمل‌گرا، واقع‌بین' },
                    { word: 'Meticulous', pronunciation: '/məˈtɪkjələs/', meaning: 'دقیق، موشکاف' }
                ];

                // Select based on date
                const dayIndex = new Date().getDate() % words.length;
                const wod = words[dayIndex];

                const wordEl = document.getElementById('wodWord');
                const pronEl = document.getElementById('wodPronunciation');
                const meaningEl = document.getElementById('wodMeaning');

                if (wordEl) wordEl.textContent = wod.word;
                if (pronEl) pronEl.textContent = wod.pronunciation;
                if (meaningEl) meaningEl.textContent = wod.meaning;
            },

            renderQuickStartDecks() {
                const container = document.getElementById('quickStartDecks');
                if (!container) return;

                const decks = DeckManager.getAll();
                
                if (decks.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                            <div style="font-size: 48px; margin-bottom: 16px;">📚</div>
                            <div style="margin-bottom: 16px;">هنوز دکی نداری!</div>
                            <button class="btn btn-primary" onclick="ReadyDecks.open()">
                                📦 دک آماده اضافه کن
                            </button>
                        </div>
                    `;
                    return;
                }

                // Show first 3 decks with most due cards
                const decksWithStats = decks.map(deck => ({
                    ...deck,
                    dueCount: DeckManager.getDueCount(deck.id),
                    totalCount: DeckManager.getCardCount(deck.id)
                })).sort((a, b) => b.dueCount - a.dueCount).slice(0, 3);

                container.innerHTML = decksWithStats.map(deck => `
                    <div class="deck-card" onclick="ModeSelector.open('${deck.id}')">
                        <div class="deck-icon">${deck.emoji || '📚'}</div>
                        <div class="deck-info">
                            <div class="deck-name">${deck.name}</div>
                            <div class="deck-meta">${Utils.toPersian(deck.totalCount)} کارت</div>
                        </div>
                        <div class="deck-stats">
                            <div class="deck-stat due">
                                <div class="deck-stat-value">${Utils.toPersian(deck.dueCount)}</div>
                                <div class="deck-stat-label">مرور</div>
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            renderBadges() {
                const container = document.getElementById('badgesScrollContainer');
                const countEl = document.getElementById('badgeCount');
                if (!container) return;

                const badges = Gamification.getBadges();
                const earnedCount = badges.filter(b => b.earned).length;

                if (countEl) {
                    countEl.textContent = `${Utils.toPersian(earnedCount)}/${Utils.toPersian(badges.length)}`;
                }

                container.innerHTML = badges.map(badge => `
                    <div class="badge-card ${badge.earned ? 'earned' : 'locked'}" title="${badge.description}">
                        <div class="badge-card-icon">${badge.icon}</div>
                        <div class="badge-card-name">${badge.name}</div>
                    </div>
                `).join('');
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // WORD OF DAY
        // ═══════════════════════════════════════════════════════════════
        const WordOfDay = {
            speak() {
                const word = document.getElementById('wodWord').textContent;
                AudioPlayer.speak(word);
            },

            addToReview() {
                const word = document.getElementById('wodWord').textContent;
                const pronunciation = document.getElementById('wodPronunciation').textContent;
                const meaning = document.getElementById('wodMeaning').textContent;

                // Check if already exists
                const existingCards = CardManager.getAll();
                if (existingCards.some(c => c.word.toLowerCase() === word.toLowerCase())) {
                    Toast.warning('این کلمه قبلاً اضافه شده');
                    return;
                }

                // Get first deck or create one
                let decks = DeckManager.getAll();
                if (decks.length === 0) {
                    DeckManager.create('کلمات من', 'کلمات شخصی', '📝');
                    decks = DeckManager.getAll();
                }

                CardManager.create({
                    deckId: decks[0].id,
                    word: word,
                    meaning: meaning,
                    pronunciation: pronunciation
                });

                Toast.success('کلمه اضافه شد! 🎉');
                Gamification.addXP(5, '📚 کلمه روز اضافه شد');
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // LIBRARY
        // ═══════════════════════════════════════════════════════════════
        const Library = {
            currentView: 'decks',
            currentDeck: null,
            searchQuery: '',

            render() {
                switch (this.currentView) {
                    case 'decks':
                        this.renderDecks();
                        break;
                    case 'cards':
                        this.renderAllCards();
                        break;
                    case 'starred':
                        this.renderStarredCards();
                        break;
                }
            },

            setView(view, buttonEl) {
                this.currentView = view;
                
                // Update tabs
                document.querySelectorAll('.library-tab').forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.view === view);
                });

                // Show/hide views
                document.getElementById('decksView').style.display = view === 'decks' ? 'block' : 'none';
                document.getElementById('cardsView').style.display = view !== 'decks' ? 'block' : 'none';
                document.getElementById('deckDetailView').style.display = 'none';

                this.render();
            },

            renderDecks() {
                const container = document.getElementById('libraryDecksGrid');
                if (!container) return;

                const decks = DeckManager.getAll();

                if (decks.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                            <div style="font-size: 64px; margin-bottom: 16px;">📚</div>
                            <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">کتابخانه خالی است</div>
                            <div style="margin-bottom: 24px;">اولین دک خود را بسازید یا از دک‌های آماده استفاده کنید</div>
                            <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                                <button class="btn btn-primary" onclick="DeckManager.openCreate()">➕ ساخت دک</button>
                                <button class="btn btn-secondary" onclick="ReadyDecks.open()">📦 دک آماده</button>
                            </div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = decks.map(deck => {
                    const totalCount = DeckManager.getCardCount(deck.id);
                    const dueCount = DeckManager.getDueCount(deck.id);
                    const newCount = DeckManager.getNewCount(deck.id);

                    return `
                        <div class="deck-card" onclick="Library.openDeck('${deck.id}')">
                            <div class="deck-icon">${deck.emoji || '📚'}</div>
                            <div class="deck-info">
                                <div class="deck-name">${deck.name}</div>
                                <div class="deck-meta">${Utils.toPersian(totalCount)} کارت</div>
                            </div>
                            <div class="deck-stats">
                                <div class="deck-stat new">
                                    <div class="deck-stat-value">${Utils.toPersian(newCount)}</div>
                                    <div class="deck-stat-label">جدید</div>
                                </div>
                                <div class="deck-stat due">
                                    <div class="deck-stat-value">${Utils.toPersian(dueCount)}</div>
                                    <div class="deck-stat-label">مرور</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            renderAllCards() {
                const container = document.getElementById('libraryCardsGrid');
                if (!container) return;

                let cards = CardManager.getAll();
                
                // Apply search filter
                if (this.searchQuery) {
                    const q = this.searchQuery.toLowerCase();
                    cards = cards.filter(c => 
                        c.word.toLowerCase().includes(q) ||
                        c.meaning.toLowerCase().includes(q)
                    );
                }

                if (cards.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                            ${this.searchQuery ? 'کارتی یافت نشد' : 'هنوز کارتی نداری'}
                        </div>
                    `;
                    return;
                }

                container.innerHTML = cards.map(card => this.renderCardItem(card)).join('');
            },

            renderStarredCards() {
                const container = document.getElementById('libraryCardsGrid');
                if (!container) return;

                const cards = CardManager.getStarred();

                if (cards.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                            <div style="font-size: 48px; margin-bottom: 16px;">⭐</div>
                            <div>هنوز کارت ستاره‌داری نداری</div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = cards.map(card => this.renderCardItem(card)).join('');
            },

            renderCardItem(card) {
                return `
                    <div class="card-item">
                        <div class="card-item-word">${card.word}</div>
                        <div class="card-item-meaning">${card.meaning}</div>
                        <div class="card-item-actions">
                            <button class="card-item-btn" onclick="event.stopPropagation(); AudioPlayer.speak('${card.word}')">🔊</button>
                            <button class="card-item-btn" onclick="event.stopPropagation(); Library.editCard('${card.id}')">✏️</button>
                            <button class="card-item-btn" onclick="event.stopPropagation(); Library.deleteCard('${card.id}')">🗑️</button>
                        </div>
                    </div>
                `;
            },

            openDeck(deckId) {
                this.currentDeck = DeckManager.get(deckId);
                if (!this.currentDeck) return;

                // Show deck detail view
                document.getElementById('decksView').style.display = 'none';
                document.getElementById('cardsView').style.display = 'none';
                document.getElementById('deckDetailView').style.display = 'block';

                this.renderDeckDetail();
            },

            renderDeckDetail() {
                const deck = this.currentDeck;
                if (!deck) return;

                const headerContainer = document.getElementById('deckDetailHeader');
                const cardsContainer = document.getElementById('deckCardsGrid');
                const cards = CardManager.getByDeck(deck.id);

                // Render header
                headerContainer.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
                        <button class="btn btn-secondary" onclick="Library.closeDeckDetail()" style="padding: 8px 12px;">
                            → بازگشت
                        </button>
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="font-size: 32px;">${deck.emoji || '📚'}</span>
                                <div>
                                    <div style="font-size: 20px; font-weight: 800;">${deck.name}</div>
                                    <div style="font-size: 14px; color: var(--text-secondary);">${Utils.toPersian(cards.length)} کارت</div>
                                </div>
                            </div>
                        </div>
                        ${deck.isCustom ? `
                            <button class="btn btn-secondary" onclick="Library.deleteDeck('${deck.id}')" style="padding: 8px 12px; color: var(--danger);">
                                🗑️
                            </button>
                        ` : ''}
                    </div>
                `;

                // Render cards
                if (cards.length === 0) {
                    cardsContainer.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                            <div style="font-size: 48px; margin-bottom: 16px;">📝</div>
                            <div>این دک هنوز کارتی ندارد</div>
                        </div>
                    `;
                } else {
                    cardsContainer.innerHTML = cards.map(card => this.renderCardItem(card)).join('');
                }
            },

            closeDeckDetail() {
                this.currentDeck = null;
                document.getElementById('deckDetailView').style.display = 'none';
                document.getElementById('decksView').style.display = 'block';
            },

            startDeckReview() {
                if (this.currentDeck) {
                    ModeSelector.open(this.currentDeck.id);
                }
            },

            openAddCard() {
                if (this.currentDeck) {
                    AddCard.openForDeck(this.currentDeck.id);
                }
            },

            search(query) {
                this.searchQuery = query;
                if (this.currentView === 'cards') {
                    this.renderAllCards();
                }
            },

            editCard(cardId) {
                const card = CardManager.get(cardId);
                if (!card) return;

                document.getElementById('editCardId').value = cardId;
                document.getElementById('editCardWord').value = card.word;
                document.getElementById('editCardMeaning').value = card.meaning;
                document.getElementById('editCardExample').value = card.example || '';

                document.getElementById('editCardModal').classList.add('active');
            },

            saveEditCard() {
                const cardId = document.getElementById('editCardId').value;
                const word = document.getElementById('editCardWord').value.trim();
                const meaning = document.getElementById('editCardMeaning').value.trim();
                const example = document.getElementById('editCardExample').value.trim();

                if (!word || !meaning) {
                    Toast.warning('کلمه و معنی الزامی است');
                    return;
                }

                CardManager.update(cardId, { word, meaning, example });
                document.getElementById('editCardModal').classList.remove('active');
                Toast.success('کارت ویرایش شد');
                this.render();
            },

            deleteCard(cardId) {
                ConfirmDialog.show(
                    'حذف کارت',
                    'آیا از حذف این کارت مطمئن هستید؟',
                    () => {
                        CardManager.delete(cardId);
                        Toast.success('کارت حذف شد');
                        this.render();
                        if (this.currentDeck) {
                            this.renderDeckDetail();
                        }
                    }
                );
            },

            deleteDeck(deckId) {
                ConfirmDialog.show(
                    'حذف دک',
                    'آیا از حذف این دک و تمام کارت‌های آن مطمئن هستید؟',
                    () => {
                        DeckManager.delete(deckId);
                        Toast.success('دک حذف شد');
                        this.closeDeckDetail();
                        this.render();
                        HomePage.refresh();
                    }
                );
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // ADD CARD
        // ═══════════════════════════════════════════════════════════════
        const AddCard = {
            targetDeckId: null,

            open() {
                this.targetDeckId = null;
                this.clearForm();
                document.getElementById('addCardModal').classList.add('active');
            },

            openForDeck(deckId) {
                this.targetDeckId = deckId;
                this.clearForm();
                document.getElementById('addCardModal').classList.add('active');
            },

            clearForm() {
                document.getElementById('newCardWord').value = '';
                document.getElementById('newCardMeaning').value = '';
                document.getElementById('newCardPronunciation').value = '';
                document.getElementById('newCardExample').value = '';
                document.getElementById('newCardNote').value = '';
            },

            save() {
                const word = document.getElementById('newCardWord').value.trim();
                const meaning = document.getElementById('newCardMeaning').value.trim();
                const pronunciation = document.getElementById('newCardPronunciation').value.trim();
                const example = document.getElementById('newCardExample').value.trim();
                const note = document.getElementById('newCardNote').value.trim();

                if (!word || !meaning) {
                    Toast.warning('کلمه و معنی الزامی است');
                    return;
                }

                // Get target deck
                let deckId = this.targetDeckId;
                if (!deckId) {
                    const decks = DeckManager.getAll();
                    if (decks.length === 0) {
                        DeckManager.create('کلمات من', 'کلمات شخصی', '📝');
                        deckId = DeckManager.getAll()[0].id;
                    } else {
                        deckId = decks[0].id;
                    }
                }

                CardManager.create({
                    deckId: deckId,
                    word: word,
                    meaning: meaning,
                    pronunciation: pronunciation,
                    example: example,
                    mnemonic: note
                });

                document.getElementById('addCardModal').classList.remove('active');
                Toast.success('کارت اضافه شد! 🎉');
                Gamification.addXP(3, '📝 کارت جدید');
                
                Library.render();
                if (Library.currentDeck && Library.currentDeck.id === deckId) {
                    Library.renderDeckDetail();
                }
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // STATS PAGE
        // ═══════════════════════════════════════════════════════════════
        const StatsPage = {
            refresh() {
                this.updateMainStats();
                this.renderWeeklyChart();
                this.updateDetailStats();
            },

            updateMainStats() {
                const cards = CardManager.getAll();
                const mastered = CardManager.getMastered();
                const settings = Settings.get();
                const gamification = Gamification.getData();

                document.getElementById('statTotalCards').textContent = Utils.toPersian(cards.length);
                document.getElementById('statMasteredCards').textContent = Utils.toPersian(mastered.length);
                document.getElementById('statCurrentStreak').textContent = Utils.toPersian(settings.streak || 0);
                document.getElementById('statTotalXP').textContent = Utils.toPersian(gamification.xp || 0);
            },

            renderWeeklyChart() {
                const container = document.getElementById('weeklyChart');
                if (!container) return;

                const reviews = DB.get('reviews', []);
                const days = ['ش', 'ی', 'د', 'س', 'چ', 'پ', 'ج'];
                const today = new Date();
                const data = [];

                // Get last 7 days
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    
                    const dayReviews = reviews.filter(r => 
                        Utils.isSameDay(r.timestamp, date.getTime())
                    ).length;

                    data.push({
                        day: days[date.getDay()],
                        count: dayReviews,
                        isToday: i === 0
                    });
                }

                const maxCount = Math.max(...data.map(d => d.count), 1);

                container.innerHTML = data.map(d => {
                    const height = (d.count / maxCount) * 100;
                    return `
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px;">
                            <div style="font-size: 12px; font-weight: 700; color: var(--primary);">
                                ${d.count > 0 ? Utils.toPersian(d.count) : ''}
                            </div>
                            <div style="width: 100%; max-width: 32px; height: ${Math.max(height, 5)}%; 
                                        background: ${d.isToday ? 'var(--gradient-primary)' : 'var(--bg-tertiary)'}; 
                                        border-radius: 4px; transition: height 0.5s ease;">
                            </div>
                            <div style="font-size: 11px; color: var(--text-secondary);">${d.day}</div>
                        </div>
                    `;
                }).join('');
            },

            updateDetailStats() {
                const reviews = DB.get('reviews', []);
                const totalReviews = reviews.length;
                
                // Calculate daily average
                const reviewDays = new Set(reviews.map(r => new Date(r.timestamp).toDateString())).size;
                const dailyAvg = reviewDays > 0 ? Math.round(totalReviews / reviewDays) : 0;

                // Find best day
                const dayMap = {};
                reviews.forEach(r => {
                    const day = new Date(r.timestamp).toDateString();
                    dayMap[day] = (dayMap[day] || 0) + 1;
                });
                const bestDay = Math.max(...Object.values(dayMap), 0);

                // Overall accuracy
                const correctReviews = reviews.filter(r => r.rating >= 3).length;
                const accuracy = totalReviews > 0 ? Math.round((correctReviews / totalReviews) * 100) : 0;

                document.getElementById('statTotalReviews').textContent = Utils.toPersian(totalReviews);
                document.getElementById('statDailyAvg').textContent = Utils.toPersian(dailyAvg);
                document.getElementById('statBestDay').textContent = Utils.toPersian(bestDay);
                document.getElementById('statOverallAccuracy').textContent = Utils.toPersian(accuracy) + '٪';
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // GAMIFICATION
        // ═══════════════════════════════════════════════════════════════
        const Gamification = {
            // Level thresholds
            levelThresholds: [
                0, 100, 250, 450, 700, 1000, 1400, 1900, 2500, 3200,
                4000, 5000, 6200, 7600, 9200, 11000, 13000, 15500, 18500, 22000,
                26000, 30500, 35500, 41000, 47000, 54000, 62000, 71000, 81000, 92000
            ],

            getData() {
                return DB.get('gamification', { xp: 0, level: 1, badges: [] });
            },

            saveData(data) {
                DB.set('gamification', data);
            },

            addXP(amount, reason = '') {
                const data = this.getData();
                const previousLevel = data.level;
                
                data.xp += amount;
                data.level = this.calculateLevel(data.xp);
                
                this.saveData(data);

                // Show toast
                Toast.success(`+${Utils.toPersian(amount)} XP ${reason}`);

                // Check for level up
                if (data.level > previousLevel) {
                    this.showLevelUp(data.level);
                }

                // Update UI
                HomePage.updateHeroStats();

                return data.xp;
            },

            calculateLevel(xp) {
                for (let i = this.levelThresholds.length - 1; i >= 0; i--) {
                    if (xp >= this.levelThresholds[i]) {
                        return i + 1;
                    }
                }
                return 1;
            },

            getXPForLevel(level) {
                return this.levelThresholds[Math.min(level - 1, this.levelThresholds.length - 1)] || 0;
            },

            showLevelUp(newLevel) {
                const modal = document.getElementById('levelUpModal');
                const levelDisplay = document.getElementById('newLevelDisplay');
                const reward = document.getElementById('levelUpReward');

                levelDisplay.textContent = Utils.toPersian(newLevel);
                reward.textContent = `🎁 ${Utils.toPersian(newLevel * 10)} XP جایزه!`;

                modal.classList.add('active');
                Confetti.show(50);

                // Auto-close after 5 seconds
                setTimeout(() => {
                    this.closeLevelUp();
                }, 5000);
            },

            closeLevelUp() {
                document.getElementById('levelUpModal').classList.remove('active');
            },

            claimDailyReward() {
                const today = Utils.getTodayString();
                const lastClaim = DB.get('lastDailyReward', null);

                if (lastClaim === today) {
                    Toast.info('پاداش امروز را قبلاً گرفتی!');
                    return;
                }

                DB.set('lastDailyReward', today);
                
                // Calculate streak bonus
                const settings = Settings.get();
                const streakBonus = Math.min((settings.streak || 0) * 2, 20);
                const totalReward = 15 + streakBonus;

                this.addXP(totalReward, '🎁 پاداش روزانه');
                
                HomePage.updateDailyReward();
                Confetti.show(20);
            },

            // Badges
            getBadges() {
                const data = this.getData();
                const earnedIds = data.badges || [];
                const settings = Settings.get();
                const cards = CardManager.getAll();
                const mastered = CardManager.getMastered();
                const reviews = DB.get('reviews', []);

                const allBadges = [
                    { id: 'first_card', name: 'شروع', icon: '🌱', description: 'اولین کارت', condition: cards.length >= 1 },
                    { id: 'ten_cards', name: 'دانش‌آموز', icon: '📚', description: '۱۰ کارت', condition: cards.length >= 10 },
                    { id: 'fifty_cards', name: 'پژوهشگر', icon: '🔬', description: '۵۰ کارت', condition: cards.length >= 50 },
                    { id: 'hundred_cards', name: 'دانشمند', icon: '🎓', description: '۱۰۰ کارت', condition: cards.length >= 100 },
                    { id: 'streak_3', name: 'پشتکار', icon: '🔥', description: '۳ روز متوالی', condition: (settings.streak || 0) >= 3 },
                    { id: 'streak_7', name: 'متعهد', icon: '💪', description: '۷ روز متوالی', condition: (settings.streak || 0) >= 7 },
                    { id: 'streak_30', name: 'قهرمان', icon: '🏆', description: '۳۰ روز متوالی', condition: (settings.streak || 0) >= 30 },
                    { id: 'first_master', name: 'استاد', icon: '✅', description: 'اولین تسلط', condition: mastered.length >= 1 },
                    { id: 'ten_master', name: 'حرفه‌ای', icon: '⭐', description: '۱۰ کارت تسلط', condition: mastered.length >= 10 },
                    { id: 'hundred_reviews', name: 'مرورگر', icon: '📖', description: '۱۰۰ مرور', condition: reviews.length >= 100 },
                    { id: 'level_5', name: 'سطح ۵', icon: '🎖️', description: 'رسیدن به سطح ۵', condition: data.level >= 5 },
                    { id: 'level_10', name: 'سطح ۱۰', icon: '👑', description: 'رسیدن به سطح ۱۰', condition: data.level >= 10 }
                ];

                // Update earned status and check new badges
                const newBadges = [];
                allBadges.forEach(badge => {
                    badge.earned = earnedIds.includes(badge.id) || badge.condition;
                    
                    if (badge.condition && !earnedIds.includes(badge.id)) {
                        earnedIds.push(badge.id);
                        newBadges.push(badge);
                    }
                });

                // Save new badges
                if (newBadges.length > 0) {
                    data.badges = earnedIds;
                    this.saveData(data);
                    
                    // Notify
                    newBadges.forEach(badge => {
                        Toast.success(`🏅 مدال جدید: ${badge.name}`);
                        this.addXP(20, `🏅 ${badge.name}`);
                    });
                }

                return allBadges;
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // CHALLENGES
        // ═══════════════════════════════════════════════════════════════
        const Challenges = {
            open() {
                this.render();
                document.getElementById('challengesModal').classList.add('active');
            },

            close() {
                document.getElementById('challengesModal').classList.remove('active');
            },

            getChallenges() {
                const reviews = DB.get('reviews', []);
                const todayReviews = reviews.filter(r => Utils.isSameDay(r.timestamp, Date.now()));
                const settings = Settings.get();
                const cards = CardManager.getAll();

                // Get week reviews
                const weekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
                const weekReviews = reviews.filter(r => r.timestamp >= weekAgo);

                // Challenge completion data
                const claimed = DB.get('claimedChallenges', {});
                const today = Utils.getTodayString();

                return {
                    daily: [
                        {
                            id: 'daily_5',
                            title: '۵ کارت مرور',
                            description: '۵ کارت را امروز مرور کن',
                            icon: '📖',
                            current: todayReviews.length,
                            target: 5,
                            xp: 10,
                            claimed: claimed[`daily_5_${today}`]
                        },
                        {
                            id: 'daily_20',
                            title: 'هدف روزانه',
                            description: '۲۰ کارت را امروز مرور کن',
                            icon: '🎯',
                            current: todayReviews.length,
                            target: 20,
                            xp: 30,
                            claimed: claimed[`daily_20_${today}`]
                        },
                        {
                            id: 'daily_perfect',
                            title: 'بدون خطا',
                            description: '۱۰ کارت متوالی بدون خطا',
                            icon: '✨',
                            current: this.getConsecutiveCorrect(todayReviews),
                            target: 10,
                            xp: 25,
                            claimed: claimed[`daily_perfect_${today}`]
                        }
                    ],
                    weekly: [
                        {
                            id: 'weekly_100',
                            title: '۱۰۰ مرور هفتگی',
                            description: '۱۰۰ کارت در این هفته مرور کن',
                            icon: '📚',
                            current: weekReviews.length,
                            target: 100,
                            xp: 75,
                            claimed: claimed[`weekly_100_${this.getWeekId()}`]
                        },
                        {
                            id: 'weekly_streak',
                            title: '۷ روز متوالی',
                            description: 'هر روز این هفته مرور کن',
                            icon: '🔥',
                            current: Math.min(settings.streak || 0, 7),
                            target: 7,
                            xp: 100,
                            claimed: claimed[`weekly_streak_${this.getWeekId()}`]
                        }
                    ],
                    special: [
                        {
                            id: 'add_10_cards',
                            title: 'مجموعه‌ساز',
                            description: '۱۰ کارت جدید اضافه کن',
                            icon: '📝',
                            current: cards.length,
                            target: 10,
                            xp: 50,
                            claimed: claimed['add_10_cards']
                        },
                        {
                            id: 'master_5',
                            title: 'تسلط',
                            description: 'بر ۵ کارت تسلط پیدا کن',
                            icon: '✅',
                            current: CardManager.getMastered().length,
                            target: 5,
                            xp: 75,
                            claimed: claimed['master_5']
                        }
                    ]
                };
            },

            getConsecutiveCorrect(reviews) {
                if (reviews.length === 0) return 0;
                
                let consecutive = 0;
                let maxConsecutive = 0;
                
                // Sort by timestamp descending
                const sorted = [...reviews].sort((a, b) => b.timestamp - a.timestamp);
                
                for (const review of sorted) {
                    if (review.rating >= 3) {
                        consecutive++;
                        maxConsecutive = Math.max(maxConsecutive, consecutive);
                    } else {
                        consecutive = 0;
                    }
                }
                
                return maxConsecutive;
            },

            getWeekId() {
                const now = new Date();
                const start = new Date(now.getFullYear(), 0, 1);
                const week = Math.ceil((((now - start) / 86400000) + start.getDay() + 1) / 7);
                return `${now.getFullYear()}_${week}`;
            },

            render() {
                const challenges = this.getChallenges();

                document.getElementById('dailyChallenges').innerHTML = this.renderChallengeList(challenges.daily, 'daily');
                document.getElementById('weeklyChallenges').innerHTML = this.renderChallengeList(challenges.weekly, 'weekly');
                document.getElementById('specialChallenges').innerHTML = this.renderChallengeList(challenges.special, 'special');
            },

            renderChallengeList(challenges, type) {
                return challenges.map(ch => {
                    const progress = Math.min((ch.current / ch.target) * 100, 100);
                    const isComplete = ch.current >= ch.target;
                    const canClaim = isComplete && !ch.claimed;

                    return `
                        <div class="challenge-card ${isComplete ? 'completed' : ''} ${canClaim ? 'active' : ''}">
                            <div class="challenge-header">
                                <div class="challenge-icon">${ch.icon}</div>
                                <div class="challenge-info">
                                    <div class="challenge-title">${ch.title}</div>
                                    <div class="challenge-desc">${ch.description}</div>
                                </div>
                                <div class="challenge-reward">
                                    <span>+${Utils.toPersian(ch.xp)}</span>
                                    <span>XP</span>
                                </div>
                            </div>
                            <div class="challenge-progress">
                                <div class="challenge-progress-bar">
                                    <div class="challenge-progress-fill" style="width: ${progress}%"></div>
                                </div>
                                <div class="challenge-progress-text">
                                    <span>${Utils.toPersian(Math.min(ch.current, ch.target))} از ${Utils.toPersian(ch.target)}</span>
                                    <span>${Math.round(progress)}٪</span>
                                </div>
                            </div>
                            ${canClaim ? `
                                <button class="challenge-btn claim" onclick="Challenges.claim('${ch.id}', '${type}', ${ch.xp})">
                                    🎁 دریافت جایزه
                                </button>
                            ` : ch.claimed ? `
                                <button class="challenge-btn" disabled>✓ دریافت شد</button>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            },

            claim(id, type, xp) {
                const claimed = DB.get('claimedChallenges', {});
                
                let key = id;
                if (type === 'daily') {
                    key = `${id}_${Utils.getTodayString()}`;
                } else if (type === 'weekly') {
                    key = `${id}_${this.getWeekId()}`;
                }

                claimed[key] = true;
                DB.set('claimedChallenges', claimed);

                Gamification.addXP(xp, '🏆 چالش تکمیل شد');
                Confetti.show(20);
                this.render();
            },

            checkProgress() {
                // Auto-check and notify about challenges
                const challenges = this.getChallenges();
                const allChallenges = [...challenges.daily, ...challenges.weekly, ...challenges.special];

                allChallenges.forEach(ch => {
                    if (ch.current >= ch.target && !ch.claimed) {
                        Toast.success(`🏆 چالش "${ch.title}" تکمیل شد!`);
                    }
                });
            }
        };
		// ═══════════════════════════════════════════════════════════════
        // ADVANCED STATS
        // ═══════════════════════════════════════════════════════════════
        const AdvancedStats = {
            open() {
                this.render();
                document.getElementById('advancedStatsModal').classList.add('active');
            },

            close() {
                document.getElementById('advancedStatsModal').classList.remove('active');
            },

            render() {
                this.updateMiniStats();
                this.renderHeatmap();
                this.renderWeakness();
            },

            updateMiniStats() {
                const gamification = Gamification.getData();
                const settings = Settings.get();
                const reviews = DB.get('reviews', []);
                const mastered = CardManager.getMastered();

                // XP
                document.getElementById('advStatXP').textContent = Utils.toPersian(gamification.xp || 0);

                // Max Streak
                document.getElementById('advStatStreak').textContent = Utils.toPersian(settings.maxStreak || 0);

                // Accuracy
                const correct = reviews.filter(r => r.rating >= 3).length;
                const accuracy = reviews.length > 0 ? Math.round((correct / reviews.length) * 100) : 0;
                document.getElementById('advStatAccuracy').textContent = Utils.toPersian(accuracy) + '٪';

                // Mastered
                document.getElementById('advStatMastered').textContent = Utils.toPersian(mastered.length);
            },

            renderHeatmap() {
                const container = document.getElementById('heatmapGrid');
                if (!container) return;

                const reviews = DB.get('reviews', []);
                const reviewMap = {};

                // Count reviews per day
                reviews.forEach(r => {
                    const date = new Date(r.timestamp).toDateString();
                    reviewMap[date] = (reviewMap[date] || 0) + 1;
                });

                // Generate last 365 days
                const today = new Date();
                let html = '';

                for (let i = 364; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toDateString();
                    const count = reviewMap[dateStr] || 0;

                    let level = 0;
                    if (count > 0) level = 1;
                    if (count >= 5) level = 2;
                    if (count >= 10) level = 3;
                    if (count >= 20) level = 4;
                    if (count >= 30) level = 5;

                    html += `<div class="heatmap-cell level-${level}" title="${Utils.formatDate(date)}: ${Utils.toPersian(count)} مرور"></div>`;
                }

                container.innerHTML = html;
            },

            renderWeakness() {
                const container = document.getElementById('weaknessCard');
                if (!container) return;

                const reviews = DB.get('reviews', []);
                const cards = CardManager.getAll();

                // Calculate weakness score for each card
                const cardStats = {};

                reviews.forEach(r => {
                    if (!cardStats[r.cardId]) {
                        cardStats[r.cardId] = { correct: 0, total: 0 };
                    }
                    cardStats[r.cardId].total++;
                    if (r.rating >= 3) {
                        cardStats[r.cardId].correct++;
                    }
                });

                // Find weakest cards
                const weakCards = cards
                    .filter(c => cardStats[c.id] && cardStats[c.id].total >= 2)
                    .map(c => ({
                        ...c,
                        accuracy: Math.round((cardStats[c.id].correct / cardStats[c.id].total) * 100),
                        attempts: cardStats[c.id].total
                    }))
                    .sort((a, b) => a.accuracy - b.accuracy)
                    .slice(0, 5);

                if (weakCards.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                            هنوز داده کافی برای تحلیل نیست
                        </div>
                    `;
                    return;
                }

                container.innerHTML = weakCards.map((card, i) => `
                    <div class="weakness-item">
                        <div class="weakness-rank">${Utils.toPersian(i + 1)}</div>
                        <div class="weakness-info">
                            <div class="weakness-word">${card.word}</div>
                            <div class="weakness-meaning">${card.meaning}</div>
                        </div>
                        <div class="weakness-stats">
                            <div class="weakness-accuracy">${Utils.toPersian(card.accuracy)}٪</div>
                            <div class="weakness-attempts">${Utils.toPersian(card.attempts)} تلاش</div>
                        </div>
                    </div>
                `).join('');
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // TAG SYSTEM
        // ═══════════════════════════════════════════════════════════════
        const TagSystem = {
            currentFilter: 'all',

            open() {
                this.render();
                document.getElementById('tagManagerModal').classList.add('active');
            },

            close() {
                document.getElementById('tagManagerModal').classList.remove('active');
            },

            filter(filterType, element) {
                this.currentFilter = filterType;
                
                // Update buttons
                document.querySelectorAll('.tag-filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                element.classList.add('active');

                this.renderCards();
            },

            render() {
                this.renderCards();
            },

            renderCards() {
                const container = document.getElementById('filteredCardsList');
                const countEl = document.getElementById('filteredCount');
                if (!container) return;

                let cards = CardManager.getAll();

                // Apply filter
                switch (this.currentFilter) {
                    case 'starred':
                        cards = cards.filter(c => c.starred);
                        break;
                    case 'difficult':
                        cards = cards.filter(c => c.difficulty >= 7 || c.lapses >= 3);
                        break;
                    case 'new':
                        cards = cards.filter(c => c.state === 'new');
                        break;
                    case 'mastered':
                        cards = cards.filter(c => c.stability >= 30 && c.reps >= 5);
                        break;
                }

                if (countEl) {
                    countEl.textContent = Utils.toPersian(cards.length);
                }

                if (cards.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                            کارتی با این فیلتر یافت نشد
                        </div>
                    `;
                    return;
                }

                container.innerHTML = cards.map(card => `
                    <div class="card-item" onclick="AudioPlayer.speak('${card.word}')">
                        <div class="card-item-word">
                            ${card.starred ? '⭐ ' : ''}${card.word}
                        </div>
                        <div class="card-item-meaning">${card.meaning}</div>
                        <div class="card-item-actions">
                            <button class="card-item-btn" onclick="event.stopPropagation(); CardManager.toggleStar('${card.id}'); TagSystem.renderCards();">
                                ${card.starred ? '★' : '☆'}
                            </button>
                        </div>
                    </div>
                `).join('');
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // VOICE MODE
        // ═══════════════════════════════════════════════════════════════
        const VoiceMode = {
            currentMode: 'listen',
            currentIndex: 0,
            cards: [],
            isRecording: false,
            recognition: null,
            speed: 0.75,

            open() {
                // Get cards
                this.cards = CardManager.getAll();
                
                if (this.cards.length === 0) {
                    Toast.warning('کارتی برای تمرین وجود ندارد');
                    return;
                }

                this.cards = Utils.shuffle(this.cards);
                this.currentIndex = 0;
                
                // Initialize speech recognition if available
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    this.recognition.lang = 'en-US';
                    this.recognition.continuous = false;
                    this.recognition.interimResults = false;
                    
                    this.recognition.onresult = (event) => {
                        const result = event.results[0][0].transcript.toLowerCase();
                        this.handleVoiceResult(result);
                    };
                    
                    this.recognition.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        this.stopRecording();
                        Toast.error('خطا در تشخیص صدا');
                    };
                    
                    this.recognition.onend = () => {
                        this.stopRecording();
                    };
                }

                this.renderCurrentCard();
                document.getElementById('voiceModeModal').classList.add('active');
            },

            close() {
                AudioPlayer.stop();
                if (this.recognition && this.isRecording) {
                    this.recognition.stop();
                }
                document.getElementById('voiceModeModal').classList.remove('active');
            },

            setMode(mode, element) {
                this.currentMode = mode;
                
                document.querySelectorAll('#voiceModeModal .mode-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                element.classList.add('active');

                document.getElementById('voiceListenMode').style.display = mode === 'listen' ? 'block' : 'none';
                document.getElementById('voiceSpeakMode').style.display = mode === 'speak' ? 'block' : 'none';

                this.renderCurrentCard();
            },

            renderCurrentCard() {
                if (this.cards.length === 0) return;
                
                const card = this.cards[this.currentIndex];

                if (this.currentMode === 'listen') {
                    document.getElementById('voiceWord').textContent = card.word;
                    document.getElementById('voicePronunciation').textContent = card.pronunciation || '';
                    document.getElementById('voiceMeaningReveal').style.display = 'none';
                    document.getElementById('voiceMeaningReveal').textContent = card.meaning;
                } else {
                    document.getElementById('speakTargetWord').textContent = card.word;
                    document.getElementById('voiceResult').style.display = 'none';
                    document.getElementById('voiceRecordBtn').classList.remove('listening');
                }
            },

            play() {
                const card = this.cards[this.currentIndex];
                if (card) {
                    AudioPlayer.speak(card.word, this.speed);
                    
                    // Animate waveform
                    const waveform = document.getElementById('audioWaveform');
                    waveform.classList.remove('paused');
                    setTimeout(() => waveform.classList.add('paused'), 2000);
                }
            },

            setSpeed(speed, element) {
                this.speed = speed;
                AudioPlayer.setRate(speed);
                
                document.querySelectorAll('.speed-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                element.classList.add('active');
            },

            showMeaning() {
                document.getElementById('voiceMeaningReveal').style.display = 'block';
            },

            prevWord() {
                if (this.currentIndex > 0) {
                    this.currentIndex--;
                    this.renderCurrentCard();
                }
            },

            nextWord() {
                if (this.currentIndex < this.cards.length - 1) {
                    this.currentIndex++;
                    this.renderCurrentCard();
                }
            },

            toggleRecording() {
                if (!this.recognition) {
                    Toast.error('مرورگر شما از تشخیص صدا پشتیبانی نمی‌کند');
                    return;
                }

                if (this.isRecording) {
                    this.recognition.stop();
                } else {
                    this.startRecording();
                }
            },

            startRecording() {
                this.isRecording = true;
                document.getElementById('voiceRecordBtn').classList.add('listening');
                document.getElementById('voiceStatus').textContent = 'در حال گوش دادن...';
                document.getElementById('voiceResult').style.display = 'none';
                
                try {
                    this.recognition.start();
                } catch (e) {
                    console.error('Recognition start error:', e);
                    this.stopRecording();
                }
            },

            stopRecording() {
                this.isRecording = false;
                document.getElementById('voiceRecordBtn').classList.remove('listening');
                document.getElementById('voiceStatus').textContent = 'برای شروع ضبط کلیک کنید';
            },

            handleVoiceResult(result) {
                const card = this.cards[this.currentIndex];
                const target = card.word.toLowerCase();
                const spoken = result.trim();

                const isCorrect = spoken === target || 
                                  spoken.includes(target) || 
                                  target.includes(spoken);

                document.getElementById('voiceResult').style.display = 'block';
                document.getElementById('voiceResultText').textContent = spoken;

                const feedback = document.getElementById('voiceResultFeedback');
                if (isCorrect) {
                    feedback.innerHTML = `
                        <div style="color: var(--success); font-size: 18px; margin-top: 12px;">
                            ✅ عالی! درست گفتی
                        </div>
                    `;
                    Gamification.addXP(5, '🎤 تلفظ صحیح');
                } else {
                    feedback.innerHTML = `
                        <div style="color: var(--danger); font-size: 16px; margin-top: 12px;">
                            ❌ نادرست
                        </div>
                        <div style="color: var(--text-secondary); margin-top: 8px;">
                            درست: <strong>${card.word}</strong>
                        </div>
                    `;
                }
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // DICTIONARY
        // ═══════════════════════════════════════════════════════════════
        const Dictionary = {
            currentWord: null,
            lastResult: null,

            open() {
                document.getElementById('dictionaryModal').classList.add('active');
                document.getElementById('dictionaryInput').focus();
            },

            close() {
                document.getElementById('dictionaryModal').classList.remove('active');
            },

            async search() {
                const word = document.getElementById('dictionaryInput').value.trim();
                if (!word) {
                    Toast.warning('کلمه‌ای وارد کنید');
                    return;
                }

                this.currentWord = word;
                const resultContainer = document.getElementById('dictionaryResult');
                
                resultContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 32px; margin-bottom: 16px;">🔍</div>
                        <div>در حال جستجو...</div>
                    </div>
                `;

                try {
                    const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`);
                    
                    if (!response.ok) {
                        throw new Error('Not found');
                    }

                    const data = await response.json();
                    this.lastResult = data[0];
                    this.renderResult(data[0]);

                } catch (error) {
                    resultContainer.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <div style="font-size: 48px; margin-bottom: 16px;">😕</div>
                            <div style="margin-bottom: 8px;">کلمه یافت نشد</div>
                            <div style="font-size: 14px;">می‌توانید آن را دستی اضافه کنید</div>
                            <button class="btn btn-primary" style="margin-top: 16px;" onclick="Dictionary.addManually()">
                                ➕ افزودن دستی
                            </button>
                        </div>
                    `;
                }
            },

            renderResult(data) {
                const container = document.getElementById('dictionaryResult');
                
                // Get phonetic
                const phonetic = data.phonetic || 
                                 (data.phonetics && data.phonetics.find(p => p.text)?.text) || 
                                 '';

                // Get audio URL
                const audioUrl = data.phonetics?.find(p => p.audio)?.audio || '';

                // Get meanings
                const meanings = data.meanings || [];

                container.innerHTML = `
                    <div class="dictionary-result">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                            <div>
                                <div class="dictionary-word">${data.word}</div>
                                <div class="dictionary-phonetic">${phonetic}</div>
                            </div>
                            <button class="btn btn-secondary" onclick="Dictionary.speak('${data.word}')" style="padding: 12px;">
                                🔊
                            </button>
                        </div>
                        
                        ${meanings.map(meaning => `
                            <div class="dictionary-meaning">
                                <div class="dictionary-pos">${this.translatePOS(meaning.partOfSpeech)}</div>
                                ${meaning.definitions.slice(0, 3).map(def => `
                                    <div class="dictionary-definition">• ${def.definition}</div>
                                    ${def.example ? `<div class="dictionary-example">"${def.example}"</div>` : ''}
                                `).join('')}
                            </div>
                        `).join('')}

                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn btn-primary" style="flex: 1;" onclick="Dictionary.addToDeck()">
                                ➕ افزودن به دک
                            </button>
                        </div>
                    </div>
                `;
            },

            translatePOS(pos) {
                const translations = {
                    'noun': 'اسم',
                    'verb': 'فعل',
                    'adjective': 'صفت',
                    'adverb': 'قید',
                    'pronoun': 'ضمیر',
                    'preposition': 'حرف اضافه',
                    'conjunction': 'حرف ربط',
                    'interjection': 'حرف ندا'
                };
                return translations[pos] || pos;
            },

            speak(word) {
                AudioPlayer.speak(word);
            },

            addToDeck() {
                if (!this.lastResult) return;

                // Show deck selector
                const decks = DeckManager.getAll();
                const select = document.getElementById('selectDeckForAdd');
                
                if (decks.length === 0) {
                    // Create default deck
                    DeckManager.create('کلمات دیکشنری', 'کلمات جستجو شده', '📖');
                }

                const updatedDecks = DeckManager.getAll();
                select.innerHTML = updatedDecks.map(deck => 
                    `<option value="${deck.id}">${deck.emoji} ${deck.name}</option>`
                ).join('');

                document.getElementById('addToDeckModal').classList.add('active');
            },

            confirmAddToDeck() {
                const deckId = document.getElementById('selectDeckForAdd').value;
                if (!deckId || !this.lastResult) return;

                const data = this.lastResult;
                
                // Get first definition
                const firstMeaning = data.meanings?.[0];
                const definition = firstMeaning?.definitions?.[0]?.definition || '';
                const example = firstMeaning?.definitions?.[0]?.example || '';
                const phonetic = data.phonetic || data.phonetics?.find(p => p.text)?.text || '';

                // Create card
                CardManager.create({
                    deckId: deckId,
                    word: data.word,
                    meaning: definition,
                    pronunciation: phonetic,
                    example: example
                });

                document.getElementById('addToDeckModal').classList.remove('active');
                Toast.success('کارت اضافه شد! 🎉');
                Gamification.addXP(5, '📖 از دیکشنری');
            },

            closeAddModal() {
                document.getElementById('addToDeckModal').classList.remove('active');
            },

            addManually() {
                this.close();
                AddCard.open();
                document.getElementById('newCardWord').value = this.currentWord || '';
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // READY DECKS
        // ═══════════════════════════════════════════════════════════════
        const ReadyDecks = {
            currentCategory: 'all',

            // Pre-made decks data
            decksData: {
                'ielts_academic': {
                    name: 'IELTS آکادمیک',
                    description: 'کلمات ضروری آیلتس آکادمیک',
                    emoji: '🎓',
                    category: 'exam',
                    cards: [
                        { word: 'Analyze', meaning: 'تحلیل کردن', pronunciation: '/ˈænəlaɪz/', example: 'We need to analyze the data carefully.' },
                        { word: 'Approach', meaning: 'رویکرد، نزدیک شدن', pronunciation: '/əˈproʊtʃ/', example: 'Their approach to the problem was unique.' },
                        { word: 'Assessment', meaning: 'ارزیابی', pronunciation: '/əˈsesmənt/', example: 'The assessment will be next week.' },
                        { word: 'Authority', meaning: 'مرجع، قدرت', pronunciation: '/əˈθɔːrəti/', example: 'She is an authority on ancient history.' },
                        { word: 'Benefit', meaning: 'سود، منفعت', pronunciation: '/ˈbenɪfɪt/', example: 'There are many benefits to regular exercise.' },
                        { word: 'Concept', meaning: 'مفهوم', pronunciation: '/ˈkɑːnsept/', example: 'The concept is difficult to understand.' },
                        { word: 'Consistent', meaning: 'سازگار، ثابت', pronunciation: '/kənˈsɪstənt/', example: 'Be consistent in your efforts.' },
                        { word: 'Context', meaning: 'زمینه، متن', pronunciation: '/ˈkɑːntekst/', example: 'You need to understand the context.' },
                        { word: 'Contribute', meaning: 'مشارکت کردن', pronunciation: '/kənˈtrɪbjuːt/', example: 'Everyone should contribute to the project.' },
                        { word: 'Define', meaning: 'تعریف کردن', pronunciation: '/dɪˈfaɪn/', example: 'Can you define this term?' }
                    ]
                },
                'toefl_essential': {
                    name: 'TOEFL ضروری',
                    description: 'لغات پرتکرار تافل',
                    emoji: '📝',
                    category: 'exam',
                    cards: [
                        { word: 'Abundant', meaning: 'فراوان', pronunciation: '/əˈbʌndənt/', example: 'The region has abundant natural resources.' },
                        { word: 'Accurate', meaning: 'دقیق', pronunciation: '/ˈækjərət/', example: 'The report must be accurate.' },
                        { word: 'Achieve', meaning: 'دستیابی', pronunciation: '/əˈtʃiːv/', example: 'She achieved her goals.' },
                        { word: 'Acquire', meaning: 'کسب کردن', pronunciation: '/əˈkwaɪər/', example: 'He acquired new skills.' },
                        { word: 'Adapt', meaning: 'سازگار شدن', pronunciation: '/əˈdæpt/', example: 'Animals adapt to their environment.' },
                        { word: 'Adjacent', meaning: 'مجاور', pronunciation: '/əˈdʒeɪsənt/', example: 'The park is adjacent to the school.' },
                        { word: 'Advocate', meaning: 'طرفداری کردن', pronunciation: '/ˈædvəkeɪt/', example: 'She advocates for education reform.' },
                        { word: 'Affect', meaning: 'تأثیر گذاشتن', pronunciation: '/əˈfekt/', example: 'The weather affects our mood.' },
                        { word: 'Allocate', meaning: 'تخصیص دادن', pronunciation: '/ˈæləkeɪt/', example: 'We need to allocate resources wisely.' },
                        { word: 'Alter', meaning: 'تغییر دادن', pronunciation: '/ˈɔːltər/', example: 'Do not alter the document.' }
                    ]
                },
                'essential_100': {
                    name: '۱۰۰ کلمه ضروری',
                    description: 'پرکاربردترین کلمات انگلیسی',
                    emoji: '⭐',
                    category: 'level',
                    cards: [
                        { word: 'Ability', meaning: 'توانایی', pronunciation: '/əˈbɪləti/', example: 'She has the ability to learn quickly.' },
                        { word: 'Accept', meaning: 'پذیرفتن', pronunciation: '/əkˈsept/', example: 'I accept your apology.' },
                        { word: 'Account', meaning: 'حساب', pronunciation: '/əˈkaʊnt/', example: 'Open a bank account.' },
                        { word: 'Achieve', meaning: 'به دست آوردن', pronunciation: '/əˈtʃiːv/', example: 'Work hard to achieve your dreams.' },
                        { word: 'Action', meaning: 'عمل', pronunciation: '/ˈækʃən/', example: 'Take action now.' },
                        { word: 'Activity', meaning: 'فعالیت', pronunciation: '/ækˈtɪvəti/', example: 'Physical activity is important.' },
                        { word: 'Actually', meaning: 'در واقع', pronunciation: '/ˈæktʃuəli/', example: 'Actually, I disagree.' },
                        { word: 'Advice', meaning: 'نصیحت', pronunciation: '/ədˈvaɪs/', example: 'Thank you for your advice.' },
                        { word: 'Affect', meaning: 'تأثیر گذاشتن', pronunciation: '/əˈfekt/', example: 'Music affects my mood.' },
                        { word: 'Afford', meaning: 'استطاعت داشتن', pronunciation: '/əˈfɔːrd/', example: 'I can\'t afford this.' }
                    ]
                },
                'daily_conversation': {
                    name: 'مکالمه روزمره',
                    description: 'عبارات کاربردی روزانه',
                    emoji: '💬',
                    category: 'topic',
                    cards: [
                        { word: 'How are you?', meaning: 'حالت چطوره؟', pronunciation: '/haʊ ɑːr juː/', example: 'Hey! How are you today?' },
                        { word: 'Nice to meet you', meaning: 'از آشناییتون خوشحالم', pronunciation: '/naɪs tuː miːt juː/', example: 'Nice to meet you, John.' },
                        { word: 'Thank you', meaning: 'ممنونم', pronunciation: '/θæŋk juː/', example: 'Thank you for your help.' },
                        { word: 'Excuse me', meaning: 'ببخشید', pronunciation: '/ɪkˈskjuːz miː/', example: 'Excuse me, where is the station?' },
                        { word: 'I\'m sorry', meaning: 'متأسفم', pronunciation: '/aɪm ˈsɑːri/', example: 'I\'m sorry for being late.' },
                        { word: 'You\'re welcome', meaning: 'خواهش می‌کنم', pronunciation: '/jʊər ˈwelkəm/', example: 'You\'re welcome!' },
                        { word: 'See you later', meaning: 'بعداً می‌بینمت', pronunciation: '/siː juː ˈleɪtər/', example: 'See you later!' },
                        { word: 'Take care', meaning: 'مراقب خودت باش', pronunciation: '/teɪk ker/', example: 'Goodbye, take care!' },
                        { word: 'No problem', meaning: 'مشکلی نیست', pronunciation: '/noʊ ˈprɑːbləm/', example: 'No problem at all.' },
                        { word: 'Never mind', meaning: 'عیبی نداره', pronunciation: '/ˈnevər maɪnd/', example: 'Never mind, it\'s okay.' }
                    ]
                },
                'business_english': {
                    name: 'انگلیسی تجاری',
                    description: 'اصطلاحات کسب و کار',
                    emoji: '💼',
                    category: 'topic',
                    cards: [
                        { word: 'Meeting', meaning: 'جلسه', pronunciation: '/ˈmiːtɪŋ/', example: 'We have a meeting at 3 PM.' },
                        { word: 'Deadline', meaning: 'مهلت', pronunciation: '/ˈdedlaɪn/', example: 'The deadline is tomorrow.' },
                        { word: 'Budget', meaning: 'بودجه', pronunciation: '/ˈbʌdʒɪt/', example: 'We need to stay within budget.' },
                        { word: 'Negotiate', meaning: 'مذاکره کردن', pronunciation: '/nɪˈɡoʊʃieɪt/', example: 'Let\'s negotiate the terms.' },
                        { word: 'Partnership', meaning: 'مشارکت', pronunciation: '/ˈpɑːrtnərʃɪp/', example: 'We formed a partnership.' },
                        { word: 'Investment', meaning: 'سرمایه‌گذاری', pronunciation: '/ɪnˈvestmənt/', example: 'It\'s a good investment.' },
                        { word: 'Revenue', meaning: 'درآمد', pronunciation: '/ˈrevənuː/', example: 'Revenue increased this quarter.' },
                        { word: 'Strategy', meaning: 'استراتژی', pronunciation: '/ˈstrætədʒi/', example: 'What\'s our marketing strategy?' },
                        { word: 'Client', meaning: 'مشتری', pronunciation: '/ˈklaɪənt/', example: 'The client is satisfied.' },
                        { word: 'Proposal', meaning: 'پیشنهاد', pronunciation: '/prəˈpoʊzl/', example: 'Submit your proposal by Friday.' }
                    ]
                },
                'idioms': {
                    name: 'اصطلاحات رایج',
                    description: 'اصطلاحات و ضرب‌المثل‌ها',
                    emoji: '🎭',
                    category: 'phrase',
                    cards: [
                        { word: 'Break the ice', meaning: 'شروع صحبت کردن، جو را عوض کردن', pronunciation: '', example: 'Let me break the ice with a joke.' },
                        { word: 'Piece of cake', meaning: 'خیلی آسان', pronunciation: '', example: 'The test was a piece of cake.' },
                        { word: 'Hit the nail on the head', meaning: 'دقیقاً درست گفتن', pronunciation: '', example: 'You hit the nail on the head!' },
                        { word: 'Cost an arm and a leg', meaning: 'خیلی گران بودن', pronunciation: '', example: 'That car costs an arm and a leg.' },
                        { word: 'Under the weather', meaning: 'حالم خوب نیست', pronunciation: '', example: 'I\'m feeling under the weather today.' },
                        { word: 'Bite the bullet', meaning: 'تحمل کردن', pronunciation: '', example: 'Just bite the bullet and do it.' },
                        { word: 'Burn the midnight oil', meaning: 'تا دیروقت کار کردن', pronunciation: '', example: 'I burned the midnight oil studying.' },
                        { word: 'Let the cat out of the bag', meaning: 'راز را فاش کردن', pronunciation: '', example: 'Don\'t let the cat out of the bag!' },
                        { word: 'Once in a blue moon', meaning: 'به ندرت', pronunciation: '', example: 'I see her once in a blue moon.' },
                        { word: 'When pigs fly', meaning: 'هرگز، محال است', pronunciation: '', example: 'He\'ll clean his room when pigs fly.' }
                    ]
                }
            },

            open() {
                this.render();
                document.getElementById('readyDecksModal').classList.add('active');
            },

            close() {
                document.getElementById('readyDecksModal').classList.remove('active');
            },

            filterCategory(category, element) {
                this.currentCategory = category;
                
                document.querySelectorAll('.category-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                element.classList.add('active');

                this.render();
            },

            render() {
                const container = document.getElementById('readyDecksGrid');
                if (!container) return;

                const existingDecks = DeckManager.getAll();
                const installedNames = existingDecks.map(d => d.name);

                let decks = Object.entries(this.decksData);
                
                if (this.currentCategory !== 'all') {
                    decks = decks.filter(([id, deck]) => deck.category === this.currentCategory);
                }

                container.innerHTML = decks.map(([id, deck]) => {
                    const isInstalled = installedNames.includes(deck.name);
                    const cardCount = deck.cards.length;

                    return `
                        <div class="ready-deck-card ${isInstalled ? 'installed' : ''}">
                            <div class="ready-deck-icon ${deck.category}">${deck.emoji}</div>
                            <div class="ready-deck-info">
                                <div class="ready-deck-name">${deck.name}</div>
                                <div class="ready-deck-desc">${deck.description}</div>
                                <div class="ready-deck-meta">
                                    <span>📚 ${Utils.toPersian(cardCount)} کارت</span>
                                </div>
                            </div>
                            <div class="ready-deck-action">
                                ${isInstalled ? 
                                    `<button disabled style="opacity: 0.5;">✓ نصب شده</button>` :
                                    `<button onclick="ReadyDecks.install('${id}')">نصب</button>`
                                }
                            </div>
                        </div>
                    `;
                }).join('');
            },

            install(deckId) {
                const deckData = this.decksData[deckId];
                if (!deckData) return;

                // Create deck
                const newDeck = DeckManager.create(deckData.name, deckData.description, deckData.emoji);

                // Add cards
                deckData.cards.forEach(card => {
                    CardManager.create({
                        deckId: newDeck.id,
                        word: card.word,
                        meaning: card.meaning,
                        pronunciation: card.pronunciation || '',
                        example: card.example || ''
                    });
                });

                Toast.success(`دک "${deckData.name}" نصب شد! 🎉`);
                Gamification.addXP(20, '📦 نصب دک جدید');

                this.render();
                HomePage.refresh();
                Library.render();
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // SPACED READING
        // ═══════════════════════════════════════════════════════════════
        const SpacedReading = {
            currentMode: 'learn',
            currentText: '',
            selectedWord: null,

            sampleTexts: [
                {
                    title: 'The Morning Routine',
                    level: 'ساده',
                    text: 'Every morning, I wake up at 7 AM. I brush my teeth and take a shower. Then I have breakfast with my family. I usually eat toast and drink coffee. After breakfast, I check my email and prepare for work.'
                },
                {
                    title: 'Climate Change',
                    level: 'متوسط',
                    text: 'Climate change is one of the most pressing issues of our time. Rising temperatures are causing ice caps to melt and sea levels to rise. Scientists warn that we must reduce carbon emissions to prevent catastrophic environmental damage.'
                },
                {
                    title: 'Artificial Intelligence',
                    level: 'پیشرفته',
                    text: 'Artificial intelligence has revolutionized numerous industries, from healthcare to transportation. Machine learning algorithms can now diagnose diseases, drive vehicles, and even create art. However, ethical considerations regarding AI development remain a subject of intense debate.'
                },
                {
                    title: 'Travel Experience',
                    level: 'ساده',
                    text: 'Last summer, I traveled to Japan. I visited Tokyo and Kyoto. The food was delicious, especially sushi and ramen. I saw beautiful temples and met friendly people. It was an unforgettable experience.'
                }
            ],

            open() {
                this.renderSampleTexts();
                document.getElementById('spacedReadingModal').classList.add('active');
            },

            close() {
                document.getElementById('spacedReadingModal').classList.remove('active');
            },

            setMode(mode, element) {
                this.currentMode = mode;
                
                document.querySelectorAll('.reading-mode-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                element.classList.add('active');
            },

            renderSampleTexts() {
                const container = document.getElementById('sampleTextsGrid');
                if (!container) return;

                container.innerHTML = this.sampleTexts.map((text, index) => `
                    <div class="sample-text-card" onclick="SpacedReading.loadText(${index})">
                        <div class="sample-text-title">${text.title}</div>
                        <div class="sample-text-meta">📊 ${text.level}</div>
                    </div>
                `).join('');
            },

            loadText(index) {
                const text = this.sampleTexts[index];
                if (text) {
                    this.currentText = text.text;
                    this.renderText();
                }
            },

            loadCustomText() {
                const input = document.getElementById('customReadingText');
                const text = input.value.trim();
                
                if (!text) {
                    Toast.warning('متنی وارد کنید');
                    return;
                }

                this.currentText = text;
                this.renderText();
            },

            renderText() {
                const container = document.getElementById('readingText');
                if (!container || !this.currentText) return;

                // Get known words
                const knownCards = CardManager.getAll();
                const knownWords = new Set(knownCards.map(c => c.word.toLowerCase()));

                // Split text into words
                const words = this.currentText.split(/(\s+|[.,!?;:'"()-])/);
                
                let totalWords = 0;
                let knownCount = 0;

                const html = words.map(word => {
                    const cleanWord = word.trim().toLowerCase().replace(/[^a-zA-Z]/g, '');
                    
                    if (cleanWord.length <= 2) {
                        return word;
                    }

                    totalWords++;
                    const isKnown = knownWords.has(cleanWord);
                    if (isKnown) knownCount++;

                    const className = isKnown ? 'known' : 'unknown';
                    return `<span class="word ${className}" onclick="SpacedReading.selectWord('${cleanWord}')">${word}</span>`;
                }).join('');

                container.innerHTML = html;

                // Update stats
                document.getElementById('readingWordsCount').textContent = Utils.toPersian(totalWords);
                document.getElementById('readingKnownCount').textContent = Utils.toPersian(knownCount);
                document.getElementById('readingNewCount').textContent = Utils.toPersian(totalWords - knownCount);
            },

            async selectWord(word) {
                this.selectedWord = word;
                
                const infoCard = document.getElementById('wordInfoCard');
                infoCard.style.display = 'block';
                
                document.getElementById('wordInfoWord').textContent = word;
                document.getElementById('wordInfoMeaning').textContent = 'در حال جستجو...';
                document.getElementById('wordInfoExample').textContent = '';

                // Try to get meaning from dictionary
                try {
                    const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
                    if (response.ok) {
                        const data = await response.json();
                        const meaning = data[0]?.meanings?.[0]?.definitions?.[0]?.definition || 'معنی یافت نشد';
                        const example = data[0]?.meanings?.[0]?.definitions?.[0]?.example || '';
                        
                        document.getElementById('wordInfoMeaning').textContent = meaning;
                        document.getElementById('wordInfoExample').textContent = example ? `"${example}"` : '';
                    } else {
                        document.getElementById('wordInfoMeaning').textContent = 'معنی یافت نشد';
                    }
                } catch (e) {
                    document.getElementById('wordInfoMeaning').textContent = 'خطا در دریافت معنی';
                }
            },

            markKnown() {
                Toast.success('کلمه به عنوان شناخته علامت‌گذاری شد');
                document.getElementById('wordInfoCard').style.display = 'none';
                this.renderText();
            },

            addToReview() {
                if (!this.selectedWord) return;

                const meaning = document.getElementById('wordInfoMeaning').textContent;
                const example = document.getElementById('wordInfoExample').textContent;

                // Get or create deck
                let decks = DeckManager.getAll();
                let readingDeck = decks.find(d => d.name === 'کلمات مطالعه');
                
                if (!readingDeck) {
                    readingDeck = DeckManager.create('کلمات مطالعه', 'کلمات از متن‌های خوانده شده', '📖');
                }

                // Check if already exists
                const existingCards = CardManager.getAll();
                if (existingCards.some(c => c.word.toLowerCase() === this.selectedWord.toLowerCase())) {
                    Toast.warning('این کلمه قبلاً اضافه شده');
                    return;
                }

                CardManager.create({
                    deckId: readingDeck.id,
                    word: this.selectedWord,
                    meaning: meaning,
                    example: example.replace(/"/g, '')
                });

                Toast.success('کلمه به مرور اضافه شد! 🎉');
                Gamification.addXP(3, '📖 از مطالعه');
                
                document.getElementById('wordInfoCard').style.display = 'none';
                this.renderText();
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // IMAGE CARD
        // ═══════════════════════════════════════════════════════════════
        const ImageCard = {
            currentImage: null,

            open() {
                this.clearForm();
                document.getElementById('imageCardModal').classList.add('active');
            },

            close() {
                document.getElementById('imageCardModal').classList.remove('active');
            },

            clearForm() {
                this.currentImage = null;
                document.getElementById('imageCardWord').value = '';
                document.getElementById('imageCardMeaning').value = '';
                document.getElementById('imageCardDesc').value = '';
                document.getElementById('imagePreviewContainer').style.display = 'none';
                document.getElementById('imageUploadArea').style.display = 'flex';
            },

            handleUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                if (file.size > 5 * 1024 * 1024) {
                    Toast.error('حجم فایل نباید بیشتر از 5MB باشد');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    this.currentImage = e.target.result;
                    document.getElementById('imagePreview').src = this.currentImage;
                    document.getElementById('imagePreviewContainer').style.display = 'block';
                    document.getElementById('imageUploadArea').style.display = 'none';
                };
                reader.readAsDataURL(file);
            },

            removeImage() {
                this.currentImage = null;
                document.getElementById('imagePreviewContainer').style.display = 'none';
                document.getElementById('imageUploadArea').style.display = 'flex';
                document.getElementById('imageInput').value = '';
            },

            save() {
                const word = document.getElementById('imageCardWord').value.trim();
                const meaning = document.getElementById('imageCardMeaning').value.trim();

                if (!word || !meaning) {
                    Toast.warning('کلمه و معنی الزامی است');
                    return;
                }

                // Get or create deck
                let decks = DeckManager.getAll();
                let imageDeck = decks.find(d => d.name === 'کارت‌های تصویری');
                
                if (!imageDeck) {
                    imageDeck = DeckManager.create('کارت‌های تصویری', 'کارت‌های دارای تصویر', '🖼️');
                }

                CardManager.create({
                    deckId: imageDeck.id,
                    word: word,
                    meaning: meaning,
                    image: this.currentImage
                });

                Toast.success('کارت تصویری اضافه شد! 🎉');
                Gamification.addXP(5, '🖼️ کارت تصویری');
                this.close();
            }
        };
		
// ═══════════════════════════════════════════════════════════════
        // SMART NOTIFICATIONS
        // ═══════════════════════════════════════════════════════════════
        const SmartNotifications = {
            permission: 'default',

            init() {
                if ('Notification' in window) {
                    this.permission = Notification.permission;
                }
            },

            showModal() {
                document.getElementById('notificationModal').classList.add('active');
            },

            closeModal() {
                document.getElementById('notificationModal').classList.remove('active');
            },

            async requestPermission() {
                if (!('Notification' in window)) {
                    Toast.error('مرورگر شما از اعلان پشتیبانی نمی‌کند');
                    this.closeModal();
                    return;
                }

                try {
                    const permission = await Notification.requestPermission();
                    this.permission = permission;

                    if (permission === 'granted') {
                        Toast.success('اعلان‌ها فعال شدند! 🔔');
                        this.scheduleReminders();
                        
                        // Update settings page
                        const notifStatus = document.getElementById('notifStatus');
                        if (notifStatus) notifStatus.textContent = '✅ فعال';
                    } else {
                        Toast.warning('دسترسی اعلان داده نشد');
                    }
                } catch (e) {
                    Toast.error('خطا در درخواست اعلان');
                }

                this.closeModal();
            },

            scheduleReminders() {
                // Check every hour for reminders
                setInterval(() => {
                    this.checkAndNotify();
                }, 60 * 60 * 1000);

                // Also check on init
                setTimeout(() => this.checkAndNotify(), 5000);
            },

            checkAndNotify() {
                if (this.permission !== 'granted') return;

                const settings = Settings.get();
                const now = new Date();
                const hour = now.getHours();

                // Evening reminder (if not reviewed today)
                if (hour >= 19 && hour <= 21) {
                    const reviews = DB.get('reviews', []);
                    const todayReviews = reviews.filter(r => Utils.isSameDay(r.timestamp, Date.now()));

                    if (todayReviews.length === 0) {
                        this.send('یادآوری مرور 📚', 'امروز هنوز مرور نکردی! Streak خودت رو حفظ کن 🔥');
                    }
                }
            },

            send(title, body, icon = '📚') {
                if (this.permission !== 'granted') return;

                try {
                    new Notification(title, {
                        body: body,
                        icon: '/icon-192.png',
                        badge: '/icon-192.png',
                        tag: 'lexora-notification',
                        renotify: true
                    });
                } catch (e) {
                    console.error('Notification error:', e);
                }
            },

            onStreakMilestone(streak) {
                this.send(
                    `🔥 ${Utils.toPersian(streak)} روز متوالی!`,
                    'آفرین! به پیشرفت خودت ادامه بده!'
                );
            },

            onLevelUp(level) {
                this.send(
                    '🎉 سطح بالا رفت!',
                    `تبریک! به سطح ${Utils.toPersian(level)} رسیدی!`
                );
            },

            onBadgeEarned(badgeName) {
                this.send(
                    '🏅 مدال جدید!',
                    `مدال "${badgeName}" رو به دست آوردی!`
                );
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // INSTALL MANAGER (PWA)
        // ═══════════════════════════════════════════════════════════════
        const InstallManager = {
            deferredPrompt: null,
            isIOS: false,
            isStandalone: false,

            init() {
                // Check if iOS
                this.isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

                // Check if already installed
                this.isStandalone = window.matchMedia('(display-mode: standalone)').matches ||
                                    window.navigator.standalone === true;

                // Listen for install prompt
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    this.deferredPrompt = e;
                });

                // Show install hint for first-time users
                if (!this.isStandalone && !DB.get('installHintShown')) {
                    setTimeout(() => {
                        this.showHint();
                    }, 30000); // Show after 30 seconds
                }
            },

            showHint() {
                if (this.isStandalone) return;
                
                Toast.info('💡 برای تجربه بهتر، برنامه را نصب کنید!');
                DB.set('installHintShown', true);
            },

            showPrompt() {
                this.renderSteps();
                document.getElementById('installModal').classList.add('active');
            },

            close() {
                document.getElementById('installModal').classList.remove('active');
            },

            renderSteps() {
                const stepsContainer = document.getElementById('installSteps');
                const installBtn = document.getElementById('installBtn');

                if (this.isStandalone) {
                    stepsContainer.innerHTML = `
                        <div class="install-step">
                            <span class="step-number">✓</span>
                            <span>برنامه قبلاً نصب شده است!</span>
                        </div>
                    `;
                    installBtn.style.display = 'none';
                    return;
                }

                if (this.isIOS) {
                    stepsContainer.innerHTML = `
                        <div class="install-step">
                            <span class="step-number">1</span>
                            <span>روی دکمه Share (اشتراک‌گذاری) کلیک کنید</span>
                        </div>
                        <div class="install-step">
                            <span class="step-number">2</span>
                            <span>گزینه "Add to Home Screen" را انتخاب کنید</span>
                        </div>
                        <div class="install-step">
                            <span class="step-number">3</span>
                            <span>روی "Add" کلیک کنید</span>
                        </div>
                    `;
                    installBtn.textContent = 'متوجه شدم';
                    installBtn.onclick = () => this.close();
                } else if (this.deferredPrompt) {
                    stepsContainer.innerHTML = `
                        <div class="install-step">
                            <span class="step-number">1</span>
                            <span>روی دکمه "نصب برنامه" کلیک کنید</span>
                        </div>
                        <div class="install-step">
                            <span class="step-number">2</span>
                            <span>در پنجره باز شده "Install" را بزنید</span>
                        </div>
                    `;
                    installBtn.textContent = '📲 نصب برنامه';
                    installBtn.onclick = () => this.install();
                } else {
                    stepsContainer.innerHTML = `
                        <div class="install-step">
                            <span class="step-number">1</span>
                            <span>منوی مرورگر را باز کنید (⋮)</span>
                        </div>
                        <div class="install-step">
                            <span class="step-number">2</span>
                            <span>گزینه "Install app" یا "Add to Home screen" را انتخاب کنید</span>
                        </div>
                    `;
                    installBtn.textContent = 'متوجه شدم';
                    installBtn.onclick = () => this.close();
                }
            },

            async install() {
                if (!this.deferredPrompt) {
                    Toast.warning('نصب از طریق منوی مرورگر امکان‌پذیر است');
                    return;
                }

                try {
                    this.deferredPrompt.prompt();
                    const { outcome } = await this.deferredPrompt.userChoice;

                    if (outcome === 'accepted') {
                        Toast.success('برنامه نصب شد! 🎉');
                        Gamification.addXP(50, '📲 نصب برنامه');
                    }

                    this.deferredPrompt = null;
                    this.close();
                } catch (e) {
                    console.error('Install error:', e);
                    Toast.error('خطا در نصب');
                }
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // ONBOARDING
        // ═══════════════════════════════════════════════════════════════
        const Onboarding = {
            steps: [
                {
                    title: 'به LEXORA خوش آمدید! 🎉',
                    description: 'بهترین برنامه یادگیری لغات انگلیسی با الگوریتم هوشمند FSRS',
                    icon: '👋'
                },
                {
                    title: 'دک‌های آماده 📦',
                    description: 'از دک‌های آماده IELTS، TOEFL و موضوعات مختلف استفاده کنید',
                    icon: '📚'
                },
                {
                    title: 'مرور هوشمند 🧠',
                    description: 'الگوریتم FSRS بهترین زمان مرور را برای شما تعیین می‌کند',
                    icon: '⚡'
                },
                {
                    title: 'چالش‌ها و جوایز 🏆',
                    description: 'با تکمیل چالش‌ها XP کسب کنید و سطح خود را بالا ببرید',
                    icon: '🎮'
                },
                {
                    title: 'آماده‌اید؟ 🚀',
                    description: 'همین الان شروع کنید و هر روز پیشرفت کنید!',
                    icon: '✨'
                }
            ],
            currentStep: 0,

            shouldShow() {
                return !DB.get('onboardingComplete');
            },

            show() {
                if (!this.shouldShow()) return;

                // Create onboarding modal
                const modal = document.createElement('div');
                modal.id = 'onboardingModal';
                modal.className = 'modal-overlay active';
                modal.innerHTML = this.renderStep();
                document.body.appendChild(modal);
            },

            renderStep() {
                const step = this.steps[this.currentStep];
                const isLast = this.currentStep === this.steps.length - 1;
                const isFirst = this.currentStep === 0;

                return `
                    <div class="modal-container" style="text-align: center;">
                        <div style="padding: 40px 20px;">
                            <div style="font-size: 64px; margin-bottom: 24px;">${step.icon}</div>
                            <h2 style="font-size: 24px; margin-bottom: 16px;">${step.title}</h2>
                            <p style="color: var(--text-secondary); margin-bottom: 32px; line-height: 1.8;">${step.description}</p>
                            
                            <div style="display: flex; justify-content: center; gap: 8px; margin-bottom: 24px;">
                                ${this.steps.map((_, i) => `
                                    <div style="width: 8px; height: 8px; border-radius: 50%; background: ${i === this.currentStep ? 'var(--primary)' : 'var(--bg-tertiary)'};"></div>
                                `).join('')}
                            </div>

                            <div style="display: flex; gap: 12px; justify-content: center;">
                                ${!isFirst ? `
                                    <button class="btn btn-secondary" onclick="Onboarding.prev()">قبلی</button>
                                ` : ''}
                                ${isLast ? `
                                    <button class="btn btn-primary" onclick="Onboarding.complete()">شروع کنید! 🚀</button>
                                ` : `
                                    <button class="btn btn-primary" onclick="Onboarding.next()">بعدی</button>
                                `}
                            </div>

                            ${isFirst ? `
                                <button style="margin-top: 16px; background: none; border: none; color: var(--text-tertiary); cursor: pointer;" onclick="Onboarding.skip()">
                                    رد شدن
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            },

            next() {
                if (this.currentStep < this.steps.length - 1) {
                    this.currentStep++;
                    document.getElementById('onboardingModal').innerHTML = this.renderStep();
                }
            },

            prev() {
                if (this.currentStep > 0) {
                    this.currentStep--;
                    document.getElementById('onboardingModal').innerHTML = this.renderStep();
                }
            },

            skip() {
                this.complete();
            },

            complete() {
                DB.set('onboardingComplete', true);
                document.getElementById('onboardingModal').remove();
                
                // Show ready decks for new users
                if (DeckManager.getAll().length === 0) {
                    setTimeout(() => {
                        ReadyDecks.open();
                    }, 500);
                }
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // DAILY STATS TRACKER
        // ═══════════════════════════════════════════════════════════════
        const DailyStats = {
            record(type, value = 1) {
                const today = Utils.getTodayString();
                const stats = DB.get('dailyStats', {});

                if (!stats[today]) {
                    stats[today] = {
                        reviews: 0,
                        correct: 0,
                        xp: 0,
                        time: 0,
                        newCards: 0
                    };
                }

                stats[today][type] = (stats[today][type] || 0) + value;
                DB.set('dailyStats', stats);
            },

            getToday() {
                const today = Utils.getTodayString();
                const stats = DB.get('dailyStats', {});
                return stats[today] || { reviews: 0, correct: 0, xp: 0, time: 0, newCards: 0 };
            },

            getWeek() {
                const stats = DB.get('dailyStats', {});
                const weekData = [];
                
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toDateString();
                    weekData.push(stats[dateStr] || { reviews: 0, correct: 0, xp: 0 });
                }

                return weekData;
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // KEYBOARD SHORTCUTS
        // ═══════════════════════════════════════════════════════════════
        const KeyboardShortcuts = {
            init() {
                document.addEventListener('keydown', (e) => {
                    // Only when flashcard modal is open
                    if (!document.getElementById('flashcardModal').classList.contains('active')) {
                        return;
                    }

                    // Prevent in input fields
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                        return;
                    }

                    switch (e.key) {
                        case ' ':
                        case 'Enter':
                            e.preventDefault();
                            if (!Review.isFlipped) {
                                Review.flip();
                            }
                            break;
                        case '1':
                            if (Review.isFlipped) Review.rate(1);
                            break;
                        case '2':
                            if (Review.isFlipped) Review.rate(2);
                            break;
                        case '3':
                            if (Review.isFlipped) Review.rate(3);
                            break;
                        case '4':
                            if (Review.isFlipped) Review.rate(4);
                            break;
                        case 'Escape':
                            Review.close();
                            break;
                        case 's':
                            Review.speak();
                            break;
                    }
                });
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // APP INITIALIZATION
        // ═══════════════════════════════════════════════════════════════
        const App = {
            async init() {
                console.log('🚀 LEXORA v3.5 - Initializing...');

                // Initialize theme
                const settings = Settings.get();
                document.documentElement.setAttribute('data-theme', settings.darkMode ? 'dark' : 'light');

                // Initialize modules
                Toast.init();
                AudioPlayer.init();
                Navigation.init();
                SmartNotifications.init();
                InstallManager.init();
                KeyboardShortcuts.init();

                // Initialize pages
                HomePage.init();
                StatsPage.refresh();
                SettingsPage.refresh();
                Library.render();

                // Show onboarding for new users
                if (Onboarding.shouldShow()) {
                    setTimeout(() => Onboarding.show(), 500);
                }

                // Register service worker
                this.registerServiceWorker();

                // Check for app updates
                this.checkForUpdates();

                console.log('✅ LEXORA initialized successfully!');
            },

            async registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    try {
                        const registration = await navigator.serviceWorker.register('/sw.js');
                        console.log('📦 Service Worker registered:', registration.scope);

                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    Toast.info('🔄 نسخه جدید موجود است. صفحه را رفرش کنید.');
                                }
                            });
                        });
                    } catch (error) {
                        console.error('Service Worker registration failed:', error);
                    }
                }
            },

            checkForUpdates() {
                // Check version
                const currentVersion = '3.5';
                const savedVersion = DB.get('appVersion');

                if (savedVersion && savedVersion !== currentVersion) {
                    Toast.info(`🎉 به نسخه ${currentVersion} خوش آمدید!`);
                }

                DB.set('appVersion', currentVersion);
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // EDIT CARD MODAL (Add to HTML if missing)
        // ═══════════════════════════════════════════════════════════════
        // This creates the edit modal dynamically if not in HTML
        function createEditCardModal() {
            if (document.getElementById('editCardModal')) return;

            const modal = document.createElement('div');
            modal.id = 'editCardModal';
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-container">
                    <div class="modal-header">
                        <h2>✏️ ویرایش کارت</h2>
                        <button class="modal-close" onclick="document.getElementById('editCardModal').classList.remove('active')">✕</button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="editCardId">
                        <div class="form-group">
                            <label class="form-label">کلمه انگلیسی</label>
                            <input type="text" class="form-input" id="editCardWord" dir="ltr">
                        </div>
                        <div class="form-group">
                            <label class="form-label">معنی فارسی</label>
                            <input type="text" class="form-input" id="editCardMeaning">
                        </div>
                        <div class="form-group">
                            <label class="form-label">مثال</label>
                            <textarea class="form-input form-textarea" id="editCardExample" dir="ltr"></textarea>
                        </div>
                        <button class="btn btn-primary btn-block" onclick="Library.saveEditCard()">💾 ذخیره تغییرات</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // ═══════════════════════════════════════════════════════════════
        // START APPLICATION
        // ═══════════════════════════════════════════════════════════════
        document.addEventListener('DOMContentLoaded', () => {
            createEditCardModal();
            App.init();
        });

        // Handle visibility change (for streak tracking)
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                HomePage.updateDailyProgress();
                HomePage.updateStreakDays();
            }
        });

        // Handle online/offline
        window.addEventListener('online', () => {
            Toast.success('اتصال برقرار شد ✅');
        });

        window.addEventListener('offline', () => {
            Toast.warning('حالت آفلاین 📴');
        });
    </script>
</body>
</html>
