<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="LEXORA - برنامه هوشمند یادگیری زبان انگلیسی با الگوریتم FSRS-4.5">
    <title>LEXORA | لکسورا - یادگیری هوشمند انگلیسی</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <style>
        /* ═══════════════════════════════════════════════════════════════ */
        /* FONTS */
        /* ═══════════════════════════════════════════════════════════════ */
        @import url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css');
        
        /* ═══════════════════════════════════════════════════════════════ */
        /* ROOT VARIABLES */
        /* ═══════════════════════════════════════════════════════════════ */
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #8b5cf6;
            --success: #10b981;
            --success-light: #d1fae5;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --danger: #ef4444;
            --danger-light: #fee2e2;
            --info: #3b82f6;
            --info-light: #dbeafe;
            
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --bg-card: #ffffff;
            
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-tertiary: #94a3b8;
            
            --border: #e2e8f0;
            --border-light: #f1f5f9;
            --shadow: rgba(0, 0, 0, 0.1);
            --shadow-lg: rgba(0, 0, 0, 0.15);
            
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --radius-full: 50%;
            
            --transition: all 0.2s ease;
            --transition-slow: all 0.3s ease;
        }

        /* ═══════════════════════════════════════════════════════════════ */
        /* DARK THEME */
        /* ═══════════════════════════════════════════════════════════════ */
        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --bg-card: #1e293b;
            
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-tertiary: #64748b;
            
            --border: #334155;
            --border-light: #475569;
        }

        /* ═══════════════════════════════════════════════════════════════ */
        /* RESET & BASE */
        /* ═══════════════════════════════════════════════════════════════ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Vazirmatn', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            min-height: 100vh;
        }

        a {
            text-decoration: none;
            color: inherit;
        }

        button {
            font-family: inherit;
            cursor: pointer;
            border: none;
            outline: none;
        }

        input, textarea, select {
            font-family: inherit;
            outline: none;
        }

        /* ═══════════════════════════════════════════════════════════════ */
        /* UTILITY CLASSES */
        /* ═══════════════════════════════════════════════════════════════ */
        .hidden {
            display: none !important;
        }

        .flex {
            display: flex;
        }

        .flex-center {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .flex-between {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .text-center {
            text-align: center;
        }

        .text-primary {
            color: var(--primary);
        }

        .text-success {
            color: var(--success);
        }

        .text-danger {
            color: var(--danger);
        }

        .mb-1 { margin-bottom: 8px; }
        .mb-2 { margin-bottom: 16px; }
        .mb-3 { margin-bottom: 24px; }
        .mt-1 { margin-top: 8px; }
        .mt-2 { margin-top: 16px; }
        .mt-3 { margin-top: 24px; }
		/* ═══════════════════════════════════════════════════════════════ */
        /* SCREEN MANAGEMENT */
        /* ═══════════════════════════════════════════════════════════════ */
        .screen {
            display: none;
            min-height: 100vh;
            padding-bottom: 100px;
            animation: fadeIn 0.3s ease;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .screen-header {
            position: sticky;
            top: 0;
            background: var(--bg-primary);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 2px 12px var(--shadow);
            z-index: 100;
            border-bottom: 1px solid var(--border);
        }

        .screen-header h1 {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .back-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: var(--bg-secondary);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-primary);
        }

        .back-btn:hover {
            background: var(--bg-tertiary);
            transform: scale(1.05);
        }

        /* ═══════════════════════════════════════════════════════════════ */
        /* HOME SCREEN - HERO SECTION */
        /* ═══════════════════════════════════════════════════════════════ */
        .hero-section {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 50%, var(--secondary) 100%);
            padding: 50px 20px 40px;
            color: white;
            text-align: center;
            border-radius: 0 0 32px 32px;
            box-shadow: 0 8px 32px rgba(99, 102, 241, 0.35);
            position: relative;
            overflow: hidden;
        }

        .hero-section::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: heroGlow 15s linear infinite;
        }

        @keyframes heroGlow {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hero-content {
            position: relative;
            z-index: 1;
        }

        .hero-logo {
            font-size: 48px;
            margin-bottom: 8px;
        }

        .hero-title {
            font-size: 36px;
            font-weight: 800;
            margin-bottom: 8px;
            letter-spacing: 2px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .hero-subtitle {
            font-size: 15px;
            opacity: 0.95;
            margin-bottom: 32px;
            font-weight: 300;
        }

        .hero-stats {
            display: flex;
            justify-content: center;
            gap: 24px;
        }

        .hero-stat {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 16px 24px;
            border-radius: var(--radius-lg);
            min-width: 90px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .hero-stat-value {
            font-size: 32px;
            font-weight: 800;
            display: block;
            margin-bottom: 4px;
        }

        .hero-stat-label {
            font-size: 12px;
            opacity: 0.9;
            font-weight: 500;
        }

        /* Settings Icon */
        .settings-icon {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            cursor: pointer;
            z-index: 10;
            transition: var(--transition);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .settings-icon:hover {
            transform: rotate(90deg) scale(1.1);
            background: rgba(255, 255, 255, 0.3);
        }

        /* ═══════════════════════════════════════════════════════════════ */
        /* DAILY PROGRESS */
        /* ═══════════════════════════════════════════════════════════════ */
        .daily-progress-section {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin: -20px 20px 20px;
            box-shadow: 0 4px 20px var(--shadow);
            position: relative;
            z-index: 10;
            border: 1px solid var(--border);
        }

        .daily-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .daily-progress-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .daily-progress-text {
            font-size: 14px;
            font-weight: 700;
            color: var(--primary);
        }

        .daily-progress-bar {
            height: 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .daily-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 6px;
            transition: width 0.5s ease;
            position: relative;
        }

        .daily-progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* ═══════════════════════════════════════════════════════════════ */
        /* DECK CARDS */
        /* ═══════════════════════════════════════════════════════════════ */
        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            padding: 0 20px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .decks-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 0 20px 20px;
        }

        .deck-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: 0 2px 12px var(--shadow);
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .deck-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            opacity: 0;
            transition: var(--transition);
        }

        .deck-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px var(--shadow-lg);
            border-color: var(--primary);
        }

        .deck-card:hover::before {
            opacity: 1;
        }

        .deck-card.locked {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .deck-card.locked:hover {
            transform: none;
            box-shadow: 0 2px 12px var(--shadow);
            border-color: var(--border);
        }

        .deck-card.locked::before {
            opacity: 0;
        }

        .deck-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .deck-icon {
            font-size: 36px;
            width: 64px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            border-radius: var(--radius-md);
            flex-shrink: 0;
        }

        .deck-info {
            flex: 1;
            min-width: 0;
        }

        .deck-name {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .deck-description {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .deck-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .deck-stat {
            text-align: center;
            padding: 12px 8px;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
        }

        .deck-stat-value {
            font-size: 22px;
            font-weight: 800;
            color: var(--primary);
            display: block;
        }

        .deck-stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
            font-weight: 500;
        }

        .deck-badge {
            position: absolute;
            top: 16px;
            left: 16px;
            background: linear-gradient(135deg, var(--warning), #f97316);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);
        }

        /* ═══════════════════════════════════════════════════════════════ */
        /* FLASHCARD MODAL */
        /* ═══════════════════════════════════════════════════════════════ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #1e1b4b 100%);
            z-index: 1000;
            display: none;
            flex-direction: column;
            overflow-y: auto;
        }

        .modal-overlay.active {
            display: flex;
        }

        .flashcard-header {
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .flashcard-progress-bar {
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            position: relative;
        }

        .flashcard-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), #34d399);
            transition: width 0.3s ease;
        }

        .close-flashcard {
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.15);
            border: none;
            border-radius: var(--radius-full);
            font-size: 20px;
            color: white;
            cursor: pointer;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }

        .close-flashcard:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.1);
        }

        .flashcard-counter {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        /* Mode Toggle */
        .mode-toggle {
            display: flex;
            gap: 8px;
            padding: 12px 20px;
            margin: 0 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-lg);
            backdrop-filter: blur(10px);
        }

        .mode-btn {
            flex: 1;
            padding: 12px 16px;
            background: transparent;
            border: 2px solid transparent;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            color: rgba(255, 255, 255, 0.7);
        }

        .mode-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .mode-btn.active {
            background: white;
            color: var(--primary);
            border-color: white;
        }

        /* Card Modes */
        .card-mode {
            display: none;
            flex: 1;
        }

        .card-mode.active {
            display: block;
        }

        /* Flashcard */
        .flashcard-container {
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
        }

        .flashcard {
            width: 100%;
            max-width: 400px;
            height: 350px;
            position: relative;
            perspective: 1000px;
            cursor: pointer;
        }

        .flashcard-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
        }

        .flashcard.flipped .flashcard-inner {
            transform: rotateY(180deg);
        }

        .flashcard-front,
        .flashcard-back {
            position: absolute;
            width: 100%;
            height: 100%;
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: 32px 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            backface-visibility: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        }

        .flashcard-back {
            transform: rotateY(180deg);
            overflow-y: auto;
        }

        .speak-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border: none;
            border-radius: var(--radius-full);
            font-size: 22px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        .speak-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.5);
        }

        .card-word {
            font-size: 42px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 12px;
            text-align: center;
        }

        .card-pronunciation {
            font-size: 18px;
            color: var(--text-secondary);
            font-style: italic;
            margin-bottom: 24px;
        }

        .flip-hint {
            font-size: 14px;
            color: var(--text-tertiary);
            padding: 12px 24px;
            background: var(--bg-secondary);
            border-radius: 25px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-meaning {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 16px;
            text-align: center;
        }

        .card-example {
            font-size: 15px;
            color: var(--text-secondary);
            font-style: italic;
            text-align: center;
            margin-bottom: 16px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            border-right: 4px solid var(--primary);
            width: 100%;
        }

        .card-mnemonic {
            font-size: 13px;
            color: var(--text-tertiary);
            text-align: center;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            width: 100%;
        }

        /* ═══════════════════════════════════════════════════════════════ */
        /* RECALL MODE (TYPE ANSWER) */
        /* ═══════════════════════════════════════════════════════════════ */
        .recall-container {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: 32px 24px;
            margin: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .recall-question {
            text-align: center;
            margin-bottom: 32px;
            padding-top: 40px;
        }

        .recall-word {
            font-size: 42px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .recall-pronunciation {
            font-size: 18px;
            color: var(--text-secondary);
            font-style: italic;
            margin-bottom: 20px;
        }

        .recall-example {
            font-size: 15px;
            color: var(--text-secondary);
            font-style: italic;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            border-right: 4px solid var(--primary);
        }

        .recall-input-area {
            margin-bottom: 20px;
        }

        .recall-label {
            display: block;
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .recall-input {
            width: 100%;
            padding: 16px 20px;
            font-size: 18px;
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: var(--transition);
        }

        .recall-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15);
        }

        .check-answer-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        .check-answer-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.5);
        }

        .check-answer-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Feedback */
        .recall-feedback {
            text-align: center;
            padding: 24px;
            border-radius: var(--radius-lg);
            margin-bottom: 20px;
            animation: fadeIn 0.3s ease;
        }

        .recall-feedback.correct {
            background: linear-gradient(135deg, var(--success-light), #a7f3d0);
        }

        .recall-feedback.incorrect {
            background: linear-gradient(135deg, var(--danger-light), #fecaca);
        }

        .feedback-icon {
            font-size: 56px;
            margin-bottom: 12px;
        }

        .feedback-text {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .recall-feedback.correct .feedback-text {
            color: #065f46;
        }

        .recall-feedback.incorrect .feedback-text {
            color: #991b1b;
        }

        .correct-answer {
            font-size: 16px;
            color: var(--text-secondary);
            margin: 16px 0;
        }

        .correct-answer strong {
            color: var(--primary);
            font-size: 18px;
        }

        .recall-mnemonic {
            font-size: 14px;
            color: var(--text-secondary);
            background: var(--bg-tertiary);
            padding: 12px 16px;
            border-radius: var(--radius-sm);
            margin-top: 12px;
        }
		/* ═══════════════════════════════════════════════════════════════ */
        /* RATING BUTTONS */
        /* ═══════════════════════════════════════════════════════════════ */
        .rating-container {
            padding: 20px;
            opacity: 0;
            transform: translateY(20px);
            transition: var(--transition-slow);
            pointer-events: none;
        }

        .rating-container.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }

        .rating-hint {
            text-align: center;
            color: rgba(255, 255, 255, 0.9);
            font-size: 15px;
            margin-bottom: 16px;
            font-weight: 600;
        }

        .rating-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .rating-btn {
            background: var(--bg-card);
            border: 2px solid transparent;
            border-radius: var(--radius-md);
            padding: 16px 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: var(--transition);
        }

        .rating-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        .rating-label {
            font-size: 14px;
            font-weight: 700;
        }

        .rating-interval {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .rating-again { border-color: var(--danger); color: var(--danger); }
        .rating-again:hover { background: var(--danger-light); }

        .rating-hard { border-color: var(--warning); color: var(--warning); }
        .rating-hard:hover { background: var(--warning-light); }

        .rating-good { border-color: var(--success); color: var(--success); }
        .rating-good:hover { background: var(--success-light); }

        .rating-easy { border-color: var(--info); color: var(--info); }
        .rating-easy:hover { background: var(--info-light); }

        /* Complete Screen */
        .complete-screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
            color: white;
            min-height: 60vh;
        }

        .complete-screen.active {
            display: flex;
        }

        .complete-icon {
            font-size: 80px;
            margin-bottom: 24px;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        .complete-title {
            font-size: 26px;
            font-weight: 800;
            margin-bottom: 32px;
            line-height: 1.4;
        }

        .complete-stats {
            display: flex;
            gap: 24px;
            margin-bottom: 40px;
        }

        .complete-stat {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 24px 40px;
            border-radius: var(--radius-lg);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .complete-stat-value {
            font-size: 36px;
            font-weight: 800;
            display: block;
            margin-bottom: 8px;
        }

        .complete-stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .finish-btn {
            background: white;
            color: var(--primary);
            padding: 16px 48px;
            border: none;
            border-radius: var(--radius-lg);
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 4px 20px rgba(255,255,255,0.3);
        }

        .finish-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 30px rgba(255,255,255,0.4);
        }

        /* ═══════════════════════════════════════════════════════════════ */
        /* STATISTICS SCREEN */
        /* ═══════════════════════════════════════════════════════════════ */
        .stats-content {
            padding: 20px;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: var(--radius-lg);
            padding: 20px 16px;
            text-align: center;
            color: white;
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.3);
        }

        .stat-card:nth-child(2) {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);
        }

        .stat-card:nth-child(3) {
            background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
            box-shadow: 0 4px 16px rgba(245, 158, 11, 0.3);
        }

        .stat-card:nth-child(4) {
            background: linear-gradient(135deg, var(--secondary) 0%, #7c3aed 100%);
            box-shadow: 0 4px 16px rgba(139, 92, 246, 0.3);
        }

        .stat-icon {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .stats-section {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 12px var(--shadow);
            border: 1px solid var(--border);
        }

        .stats-section-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .today-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .today-stat-item {
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            border-right: 4px solid var(--primary);
        }

        .today-stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .today-stat-value {
            font-size: 22px;
            font-weight: 800;
            color: var(--primary);
        }

        .chart-container {
            position: relative;
            height: 250px;
            margin: 16px 0;
        }

        .interval-stats {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .interval-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .interval-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            min-width: 100px;
        }

        .interval-bar {
            flex: 1;
            height: 20px;
            background: var(--bg-secondary);
            border-radius: 10px;
            overflow: hidden;
        }

        .interval-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .interval-count {
            font-size: 14px;
            font-weight: 700;
            color: var(--primary);
            min-width: 40px;
            text-align: center;
        }

        .deck-stats-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .deck-stat-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .deck-stat-info {
            flex: 1;
        }

        .deck-stat-name {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .deck-stat-details {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .deck-stat-progress {
            text-align: center;
        }

        .deck-stat-percent {
            font-size: 22px;
            font-weight: 800;
            color: var(--primary);
        }

        .deck-stat-label-sm {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .insights-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .insight-item {
            display: flex;
            gap: 12px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            border-right: 4px solid var(--primary);
        }

        .insight-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .insight-text {
            flex: 1;
        }

        .insight-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .insight-description {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* ═══════════════════════════════════════════════════════════════ */
        /* SETTINGS MODAL */
        /* ═══════════════════════════════════════════════════════════════ */
        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            display: none;
            align-items: flex-end;
            backdrop-filter: blur(4px);
        }

        .settings-modal.active {
            display: flex;
        }

        .modal-container {
            background: var(--bg-primary);
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            max-height: 90vh;
            overflow-y: auto;
            width: 100%;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-header {
            position: sticky;
            top: 0;
            background: var(--bg-primary);
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .modal-header h2 {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .modal-close {
            width: 36px;
            height: 36px;
            background: var(--bg-secondary);
            border: none;
            border-radius: var(--radius-full);
            font-size: 18px;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-primary);
        }

        .modal-close:hover {
            background: var(--bg-tertiary);
            transform: scale(1.1);
        }

        .modal-body {
            padding: 20px;
        }

        .settings-section {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 16px;
        }

        .settings-section-header h3 {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .settings-section-desc {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .settings-item {
            margin-bottom: 16px;
        }

        .settings-item:last-child {
            margin-bottom: 0;
        }

        .settings-item label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .number-input-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .number-btn {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 22px;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
        }

        .number-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        .number-input {
            flex: 1;
            padding: 12px;
            font-size: 20px;
            font-weight: 700;
            text-align: center;
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .number-input:focus {
            border-color: var(--primary);
        }

        .daily-goal-preview {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 16px;
        }

        .goal-preview-item {
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            text-align: center;
        }

        .goal-preview-label {
            display: block;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .goal-preview-value {
            display: block;
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }

        /* Switch Toggle */
        .switch-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .switch {
            position: relative;
            width: 52px;
            height: 28px;
            background: var(--bg-tertiary);
            border-radius: 14px;
            cursor: pointer;
            transition: var(--transition);
        }

        .switch.active {
            background: var(--primary);
        }

        .switch-handle {
            position: absolute;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: var(--radius-full);
            top: 2px;
            left: 2px;
            transition: var(--transition);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .switch.active .switch-handle {
            transform: translateX(24px);
        }

        .switch-text {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Theme Buttons */
        .theme-buttons {
            display: flex;
            gap: 8px;
        }

        .theme-btn {
            flex: 1;
            padding: 14px 12px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-primary);
        }

        .theme-btn:hover {
            border-color: var(--primary);
        }

        .theme-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Streak Display */
        .streak-display {
            text-align: center;
            padding: 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: var(--radius-lg);
            margin-bottom: 16px;
        }

        .streak-number {
            font-size: 56px;
            font-weight: 800;
            color: white;
            line-height: 1;
            margin-bottom: 8px;
        }

        .streak-label {
            font-size: 14px;
            font-weight: 600;
            color: rgba(255,255,255,0.9);
        }

        .streak-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
        }

        .calendar-day {
            aspect-ratio: 1;
            background: var(--bg-primary);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            border: 2px solid transparent;
        }

        .calendar-day.today {
            border-color: var(--primary);
        }

        .calendar-day.completed {
            background: linear-gradient(135deg, var(--success), #34d399);
            color: white;
        }

        .calendar-day.missed {
            background: var(--danger-light);
            color: var(--danger);
        }

        /* Backup Buttons */
        .btn-block {
            width: 100%;
            padding: 14px 20px;
            font-size: 15px;
            font-weight: 600;
            border-radius: var(--radius-md);
            border: none;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #dc2626);
            color: white;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        .settings-hint {
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
            margin-top: -8px;
            margin-bottom: 12px;
        }

        /* Storage Usage */
        .storage-usage {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: 16px;
            margin: 16px 0;
        }

        .storage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .storage-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .storage-value {
            font-size: 15px;
            font-weight: 700;
            color: var(--primary);
        }

        .storage-bar {
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .storage-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 4px;
        }

        .storage-details {
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
        }

        /* Danger Zone */
        .danger-zone {
            background: var(--danger-light);
            border: 2px solid #fecaca;
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-top: 20px;
        }

        .danger-zone-header h4 {
            font-size: 15px;
            font-weight: 700;
            color: var(--danger);
            margin-bottom: 4px;
        }

        .danger-zone-header p {
            font-size: 13px;
            color: #991b1b;
            margin-bottom: 16px;
        }

        /* ═══════════════════════════════════════════════════════════════ */
        /* BOTTOM NAVIGATION */
        /* ═══════════════════════════════════════════════════════════════ */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            display: flex;
            justify-content: space-around;
            padding: 8px 0 calc(8px + env(safe-area-inset-bottom));
            box-shadow: 0 -4px 20px var(--shadow);
            z-index: 100;
            border-top: 1px solid var(--border);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 24px;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-tertiary);
            transition: var(--transition);
            border-radius: var(--radius-md);
        }

        .nav-item:hover {
            color: var(--text-secondary);
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-item svg {
            width: 24px;
            height: 24px;
        }

        .nav-item span {
            font-size: 11px;
            font-weight: 600;
        }

        /* ═══════════════════════════════════════════════════════════════ */
        /* TOAST NOTIFICATIONS */
        /* ═══════════════════════════════════════════════════════════════ */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--text-primary);
            color: white;
            padding: 14px 24px;
            border-radius: var(--radius-lg);
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
            z-index: 10000;
            opacity: 0;
            transition: var(--transition-slow);
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 90%;
            font-weight: 500;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.warning { background: var(--warning); }
        .toast.info { background: var(--primary); }

        /* ═══════════════════════════════════════════════════════════════ */
        /* CONFIRM MODAL */
        /* ═══════════════════════════════════════════════════════════════ */
        .confirm-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(4px);
        }

        .confirm-overlay.active {
            display: flex;
        }

        .confirm-modal {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: 24px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        }

        .confirm-header {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
            text-align: center;
        }

        .confirm-body {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 24px;
            text-align: center;
            line-height: 1.6;
        }

        .confirm-actions {
            display: flex;
            gap: 12px;
        }

        .confirm-actions button {
            flex: 1;
            padding: 14px;
            border-radius: var(--radius-md);
            border: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .confirm-cancel {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .confirm-cancel:hover {
            background: var(--bg-tertiary);
        }

        .confirm-delete {
            background: var(--danger);
            color: white;
        }

        .confirm-delete:hover {
            background: #dc2626;
        }

        /* ═══════════════════════════════════════════════════════════════ */
        /* RESPONSIVE */
        /* ═══════════════════════════════════════════════════════════════ */
        @media (min-width: 768px) {
            .stats-overview {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .today-stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .hero-stats {
                gap: 32px;
            }
            
            .hero-stat {
                min-width: 120px;
            }
        }

        @media (max-width: 360px) {
            .rating-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .hero-stat-value {
                font-size: 26px;
            }
            
            .card-word {
                font-size: 36px;
            }
        }
		/* ═══════════════════════════════════════════════════════════════ */
        /* REVIEW MODE SELECTOR */
        /* ═══════════════════════════════════════════════════════════════ */
        .mode-selector-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1500;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(4px);
        }

        .mode-selector-modal.active {
            display: flex;
        }

        .mode-selector-container {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            max-width: 400px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        .mode-selector-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mode-selector-header h2 {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .mode-selector-body {
            padding: 16px;
        }

        .mode-option {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: var(--radius-lg);
            margin-bottom: 12px;
            cursor: pointer;
            transition: var(--transition);
        }

        .mode-option:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .mode-option.selected {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .mode-option-icon {
            font-size: 32px;
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
        }

        .mode-option-info {
            flex: 1;
        }

        .mode-option-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .mode-option-desc {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .mode-start-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: var(--radius-lg);
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 8px;
            transition: var(--transition);
        }

        .mode-start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
        }

        /* ═══════════════════════════════════════════════════════════════ */
        /* LISTENING MODE */
        /* ═══════════════════════════════════════════════════════════════ */
        .listening-container {
            padding: 32px 24px;
            text-align: center;
        }

        .listening-icon {
            font-size: 80px;
            margin-bottom: 24px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .listening-hint {
            font-size: 18px;
            color: var(--text-secondary);
            margin-bottom: 32px;
        }

        .listening-play-btn {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            font-size: 40px;
            color: white;
            cursor: pointer;
            margin-bottom: 32px;
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.4);
            transition: var(--transition);
        }

        .listening-play-btn:hover {
            transform: scale(1.1);
        }

        .listening-input {
            width: 100%;
            padding: 16px 20px;
            font-size: 20px;
            text-align: center;
            border: 2px solid var(--border);
            border-radius: var(--radius-lg);
            background: var(--bg-secondary);
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        .listening-input:focus {
            border-color: var(--primary);
        }

        /* ═══════════════════════════════════════════════════════════════ */
        /* QUIZ MODE (Multiple Choice) */
        /* ═══════════════════════════════════════════════════════════════ */
        .quiz-container {
            padding: 24px;
        }

        .quiz-question {
            text-align: center;
            margin-bottom: 32px;
        }

        .quiz-word {
            font-size: 36px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .quiz-pronunciation {
            font-size: 16px;
            color: var(--text-secondary);
            font-style: italic;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .quiz-option {
            padding: 18px 20px;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: var(--radius-lg);
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition);
            text-align: right;
        }

        .quiz-option:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .quiz-option.correct {
            border-color: var(--success);
            background: var(--success-light);
            color: #065f46;
        }

        .quiz-option.incorrect {
            border-color: var(--danger);
            background: var(--danger-light);
            color: #991b1b;
        }

        .quiz-option.disabled {
            pointer-events: none;
            opacity: 0.6;
        }

        /* ═══════════════════════════════════════════════════════════════ */
        /* REVERSE MODE */
        /* ═══════════════════════════════════════════════════════════════ */
        .reverse-card-front {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
        }

        .reverse-meaning {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 16px;
        }

        .reverse-hint-text {
            font-size: 14px;
            color: var(--text-secondary);
            padding: 12px 20px;
            background: var(--bg-tertiary);
            border-radius: 20px;
        }

        /* ═══════════════════════════════════════════════════════════════ */
        /* DICTIONARY MODAL */
        /* ═══════════════════════════════════════════════════════════════ */
        .dictionary-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            display: none;
            align-items: flex-end;
            backdrop-filter: blur(4px);
        }

        .dictionary-modal.active {
            display: flex;
        }

        .dictionary-container {
            background: var(--bg-primary);
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            max-height: 90vh;
            width: 100%;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        .dictionary-header {
            position: sticky;
            top: 0;
            background: var(--bg-primary);
            padding: 20px;
            border-bottom: 1px solid var(--border);
            z-index: 10;
        }

        .dictionary-search-box {
            display: flex;
            gap: 12px;
        }

        .dictionary-input {
            flex: 1;
            padding: 14px 20px;
            font-size: 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius-lg);
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .dictionary-input:focus {
            border-color: var(--primary);
        }

        .dictionary-search-btn {
            padding: 14px 24px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: var(--radius-lg);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .dictionary-search-btn:hover {
            transform: scale(1.05);
        }

        .dictionary-body {
            padding: 20px;
        }

        .dictionary-loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .dictionary-loading .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .dictionary-result {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 16px;
        }

        .dict-word-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .dict-word {
            font-size: 28px;
            font-weight: 800;
            color: var(--text-primary);
        }

        .dict-phonetic {
            font-size: 16px;
            color: var(--text-secondary);
            font-style: italic;
        }

        .dict-play-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--primary);
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: var(--transition);
        }

        .dict-play-btn:hover {
            transform: scale(1.1);
        }

        .dict-meanings {
            margin-bottom: 16px;
        }

        .dict-pos {
            font-size: 14px;
            font-weight: 700;
            color: var(--primary);
            text-transform: capitalize;
            margin-bottom: 8px;
            padding: 4px 12px;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 20px;
            display: inline-block;
        }

        .dict-definition {
            font-size: 15px;
            color: var(--text-primary);
            margin-bottom: 8px;
            padding-right: 16px;
            border-right: 3px solid var(--primary);
        }

        .dict-example {
            font-size: 14px;
            color: var(--text-secondary);
            font-style: italic;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            margin-bottom: 12px;
        }

        .dict-add-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            border: none;
            border-radius: var(--radius-lg);
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .dict-add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }

        .dictionary-error {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .dictionary-error-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        /* ═══════════════════════════════════════════════════════════════ */
        /* CUSTOM DECK MODAL */
        /* ═══════════════════════════════════════════════════════════════ */
        .deck-manager-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            display: none;
            align-items: flex-end;
            backdrop-filter: blur(4px);
        }

        .deck-manager-modal.active {
            display: flex;
        }

        .deck-manager-container {
            background: var(--bg-primary);
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            max-height: 90vh;
            width: 100%;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        .deck-manager-header {
            position: sticky;
            top: 0;
            background: var(--bg-primary);
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .deck-manager-header h2 {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .deck-manager-body {
            padding: 20px;
        }

        .deck-form-section {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 20px;
        }

        .deck-form-section h3 {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            font-size: 15px;
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: var(--transition);
        }

        .form-input:focus {
            border-color: var(--primary);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .emoji-picker {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .emoji-option {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition);
        }

        .emoji-option:hover {
            border-color: var(--primary);
        }

        .emoji-option.selected {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .card-form-item {
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
        }

        .card-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        .card-form-row:last-child {
            margin-bottom: 0;
        }

        .remove-card-btn {
            padding: 8px 16px;
            background: var(--danger-light);
            color: var(--danger);
            border: none;
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .remove-card-btn:hover {
            background: var(--danger);
            color: white;
        }

        .add-card-btn {
            width: 100%;
            padding: 14px;
            background: var(--bg-tertiary);
            border: 2px dashed var(--border);
            border-radius: var(--radius-md);
            font-size: 15px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .add-card-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .save-deck-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: var(--radius-lg);
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 16px;
        }

        .save-deck-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
        }

        /* CSV Import */
        .csv-import-area {
            padding: 24px;
            background: var(--bg-tertiary);
            border: 2px dashed var(--border);
            border-radius: var(--radius-lg);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .csv-import-area:hover {
            border-color: var(--primary);
        }

        .csv-import-area.dragover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .csv-import-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .csv-import-text {
            font-size: 15px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .csv-import-hint {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        /* My Decks List */
        .my-decks-list {
            margin-top: 20px;
        }

        .my-deck-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            margin-bottom: 12px;
            border: 1px solid var(--border);
        }

        .my-deck-icon {
            font-size: 32px;
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
        }

        .my-deck-info {
            flex: 1;
        }

        .my-deck-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .my-deck-stats {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .my-deck-actions {
            display: flex;
            gap: 8px;
        }

        .deck-action-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-full);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            font-size: 16px;
        }

        .deck-edit-btn {
            background: var(--info-light);
            color: var(--info);
        }

        .deck-delete-btn {
            background: var(--danger-light);
            color: var(--danger);
        }

        .deck-action-btn:hover {
            transform: scale(1.1);
        }

        /* ═══════════════════════════════════════════════════════════════ */
        /* FAB BUTTONS */
        /* ═══════════════════════════════════════════════════════════════ */
        .fab-container {
            position: fixed;
            bottom: 100px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 90;
        }

        .fab-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fab-btn:hover {
            transform: scale(1.1);
        }

        .fab-dictionary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }

        .fab-add-deck {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
        }
		/* ═══════════════════════════════════════════════════════════════ */
        /* GAMIFICATION - XP & LEVEL SYSTEM */
        /* ═══════════════════════════════════════════════════════════════ */
        .xp-display {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-radius: var(--radius-lg);
            margin-bottom: 16px;
        }

        .level-badge {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 800;
            color: white;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }

        .xp-info {
            flex: 1;
        }

        .xp-level-text {
            font-size: 14px;
            font-weight: 700;
            color: #92400e;
            margin-bottom: 4px;
        }

        .xp-bar-container {
            height: 8px;
            background: rgba(146, 64, 14, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .xp-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #f59e0b, #eab308);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .xp-text {
            font-size: 11px;
            color: #a16207;
            margin-top: 4px;
        }

        /* Daily Reward */
        .daily-reward-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            border: none;
            border-radius: var(--radius-lg);
            color: white;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 16px;
            transition: var(--transition);
            animation: glow 2s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(139, 92, 246, 0.4); }
            50% { box-shadow: 0 0 30px rgba(139, 92, 246, 0.6); }
        }

        .daily-reward-btn:hover {
            transform: translateY(-2px);
        }

        .daily-reward-btn.claimed {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            animation: none;
            cursor: default;
        }

        /* Medals/Badges */
        .badges-section {
            margin-top: 20px;
        }

        .badges-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .badge-item {
            aspect-ratio: 1;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: var(--radius-lg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px 8px;
            transition: var(--transition);
            cursor: pointer;
        }

        .badge-item.earned {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-color: #f59e0b;
        }

        .badge-item.locked {
            opacity: 0.5;
            filter: grayscale(1);
        }

        .badge-icon {
            font-size: 28px;
            margin-bottom: 6px;
        }

        .badge-name {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-secondary);
            text-align: center;
            line-height: 1.2;
        }

        .badge-item.earned .badge-name {
            color: #92400e;
        }

        /* Level Up Modal */
        .level-up-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .level-up-modal.active {
            display: flex;
        }

        .level-up-content {
            background: linear-gradient(135deg, #1e1b4b, #312e81);
            border-radius: var(--radius-xl);
            padding: 40px;
            text-align: center;
            max-width: 320px;
            animation: levelUpAnim 0.5s ease;
        }

        @keyframes levelUpAnim {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        .level-up-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: bounce 1s ease infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .level-up-title {
            font-size: 28px;
            font-weight: 800;
            color: #fde68a;
            margin-bottom: 8px;
        }

        .level-up-level {
            font-size: 48px;
            font-weight: 900;
            color: white;
            margin-bottom: 16px;
        }

        .level-up-reward {
            font-size: 16px;
            color: #a5b4fc;
            margin-bottom: 24px;
        }

        .level-up-btn {
            padding: 14px 32px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            border: none;
            border-radius: var(--radius-lg);
            color: white;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
        }

        /* ═══════════════════════════════════════════════════════════════ */
        /* CHALLENGES */
        /* ═══════════════════════════════════════════════════════════════ */
        .challenges-section {
            margin-top: 24px;
        }

        .challenge-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 16px;
            border: 2px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .challenge-card.active {
            border-color: var(--primary);
        }

        .challenge-card.completed {
            border-color: var(--success);
            background: var(--success-light);
        }

        .challenge-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .challenge-icon {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .challenge-card.completed .challenge-icon {
            background: linear-gradient(135deg, var(--success), #059669);
        }

        .challenge-info {
            flex: 1;
        }

        .challenge-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .challenge-desc {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .challenge-reward {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 14px;
            font-weight: 700;
            color: #f59e0b;
        }

        .challenge-progress {
            margin-bottom: 12px;
        }

        .challenge-progress-bar {
            height: 10px;
            background: var(--bg-tertiary);
            border-radius: 5px;
            overflow: hidden;
        }

        .challenge-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        .challenge-card.completed .challenge-progress-fill {
            background: linear-gradient(90deg, var(--success), #059669);
        }

        .challenge-progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 6px;
        }

        .challenge-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border: none;
            border-radius: var(--radius-md);
            color: white;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
        }

        .challenge-btn:hover {
            transform: translateY(-2px);
        }

        .challenge-btn.claim {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .challenge-time {
            font-size: 12px;
            color: var(--text-tertiary);
            text-align: center;
            margin-top: 8px;
        }

        /* ═══════════════════════════════════════════════════════════════ */
        /* ADVANCED STATS - HEAT MAP */
        /* ═══════════════════════════════════════════════════════════════ */
        .heatmap-section {
            margin-top: 24px;
        }

        .heatmap-container {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 20px;
        }

        .heatmap-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .heatmap-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .heatmap-year-nav {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .heatmap-year-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 16px;
        }

        .heatmap-year {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .heatmap-months {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-right: 32px;
        }

        .heatmap-month {
            font-size: 10px;
            color: var(--text-tertiary);
            width: calc(100% / 12);
            text-align: center;
        }

        .heatmap-grid-wrapper {
            display: flex;
            gap: 8px;
        }

        .heatmap-days {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 90px;
        }

        .heatmap-day-label {
            font-size: 10px;
            color: var(--text-tertiary);
            height: 12px;
        }

        .heatmap-grid {
            flex: 1;
            display: grid;
            grid-template-rows: repeat(7, 1fr);
            grid-auto-flow: column;
            grid-auto-columns: minmax(10px, 1fr);
            gap: 3px;
        }

        .heatmap-cell {
            aspect-ratio: 1;
            background: var(--bg-tertiary);
            border-radius: 2px;
            min-width: 10px;
            min-height: 10px;
        }

        .heatmap-cell.level-1 { background: #dcfce7; }
        .heatmap-cell.level-2 { background: #86efac; }
        .heatmap-cell.level-3 { background: #22c55e; }
        .heatmap-cell.level-4 { background: #16a34a; }
        .heatmap-cell.level-5 { background: #15803d; }

        [data-theme="dark"] .heatmap-cell.level-1 { background: #14532d; }
        [data-theme="dark"] .heatmap-cell.level-2 { background: #166534; }
        [data-theme="dark"] .heatmap-cell.level-3 { background: #22c55e; }
        [data-theme="dark"] .heatmap-cell.level-4 { background: #4ade80; }
        [data-theme="dark"] .heatmap-cell.level-5 { background: #86efac; }

        .heatmap-legend {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 4px;
            margin-top: 12px;
            font-size: 11px;
            color: var(--text-tertiary);
        }

        .heatmap-legend-cell {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        /* Weakness Analysis */
        .weakness-section {
            margin-top: 24px;
        }

        .weakness-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 20px;
        }

        .weakness-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .weakness-item:last-child {
            border-bottom: none;
        }

        .weakness-rank {
            width: 28px;
            height: 28px;
            background: var(--danger-light);
            color: var(--danger);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
        }

        .weakness-info {
            flex: 1;
        }

        .weakness-word {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .weakness-meaning {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .weakness-stats {
            text-align: left;
        }

        .weakness-accuracy {
            font-size: 14px;
            font-weight: 700;
            color: var(--danger);
        }

        .weakness-attempts {
            font-size: 11px;
            color: var(--text-tertiary);
        }

        .weakness-practice-btn {
            padding: 8px 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        /* ═══════════════════════════════════════════════════════════════ */
        /* TAG SYSTEM */
        /* ═══════════════════════════════════════════════════════════════ */
        .tags-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .tag-filter-btn {
            padding: 8px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tag-filter-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .tag-filter-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .tag-count {
            font-size: 11px;
            padding: 2px 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }

        .tag-filter-btn:not(.active) .tag-count {
            background: var(--bg-tertiary);
        }

        /* Card Tags */
        .card-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 12px;
        }

        .card-tag {
            padding: 4px 10px;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: var(--primary);
        }

        /* Favorite/Star */
        .star-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            font-size: 24px;
            cursor: pointer;
            transition: var(--transition);
            opacity: 0.4;
        }

        .star-btn:hover {
            transform: scale(1.2);
            opacity: 0.7;
        }

        .star-btn.starred {
            opacity: 1;
        }

        /* Tag Manager Modal */
        .tag-manager-section {
            margin-top: 20px;
        }

        .tag-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .tag-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }

        .tag-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }

        .tag-name {
            flex: 1;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .tag-card-count {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Quick Stats Mini Cards */
        .mini-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .mini-stat-card {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .mini-stat-icon {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
        }

        .mini-stat-icon.xp { background: #fef3c7; }
        .mini-stat-icon.streak { background: #fee2e2; }
        .mini-stat-icon.accuracy { background: #dbeafe; }
        .mini-stat-icon.mastered { background: #dcfce7; }

        .mini-stat-info {
            flex: 1;
        }

        .mini-stat-value {
            font-size: 20px;
            font-weight: 800;
            color: var(--text-primary);
        }

        .mini-stat-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Confetti Animation */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            pointer-events: none;
            z-index: 9999;
            animation: confetti-fall 3s ease-out forwards;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }
		/* ═══════════════════════════════════════════════════════════════ */
        /* REDESIGNED HOME PAGE - PROFESSIONAL LAYOUT */
        /* ═══════════════════════════════════════════════════════════════ */
        
        /* Hero Section - Completely Redesigned */
        .hero-section-new {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 50%, #7c3aed 100%);
            border-radius: 0 0 32px 32px;
            padding: 20px 20px 28px;
            margin: -20px -20px 24px -20px;
            position: relative;
            overflow: hidden;
        }

        .hero-section-new::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: heroGlow 8s ease-in-out infinite;
        }

        @keyframes heroGlow {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(-20%, 20%) scale(1.2); }
        }

        .hero-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
            z-index: 2;
        }

        .hero-greeting {
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            margin-bottom: 4px;
        }

        .hero-title {
            color: white;
            font-size: 22px;
            font-weight: 800;
        }

        .hero-streak-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 10px 16px;
            border-radius: 20px;
            color: white;
            font-weight: 700;
            font-size: 15px;
        }

        /* Level Card in Hero */
        .level-card-hero {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 16px 20px;
            margin-bottom: 16px;
            position: relative;
            z-index: 2;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .level-card-content {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .level-badge-large {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 900;
            color: white;
            box-shadow: 0 8px 24px rgba(245, 158, 11, 0.4);
            flex-shrink: 0;
        }

        .level-info-hero {
            flex: 1;
            min-width: 0;
        }

        .level-title-hero {
            color: white;
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .level-title-hero .level-name {
            color: #fde68a;
        }

        .xp-bar-hero {
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 6px;
        }

        .xp-bar-fill-hero {
            height: 100%;
            background: linear-gradient(90deg, #fbbf24, #fde68a);
            border-radius: 4px;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .xp-text-hero {
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            display: flex;
            justify-content: space-between;
        }

        /* Quick Stats Row */
        .quick-stats-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            position: relative;
            z-index: 2;
        }

        .quick-stat-item {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 14px;
            padding: 14px 10px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .quick-stat-value {
            font-size: 22px;
            font-weight: 800;
            color: white;
            margin-bottom: 2px;
        }

        .quick-stat-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.8);
        }

        /* Daily Reward - Redesigned */
        .daily-reward-card {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            border-radius: 20px;
            padding: 18px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .daily-reward-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .daily-reward-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 28px rgba(139, 92, 246, 0.4);
        }

        .daily-reward-card.claimed {
            background: var(--bg-secondary);
            cursor: default;
        }

        .daily-reward-card.claimed::before {
            display: none;
        }

        .daily-reward-info {
            display: flex;
            align-items: center;
            gap: 14px;
            position: relative;
            z-index: 1;
        }

        .daily-reward-icon {
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
        }

        .daily-reward-text h4 {
            color: white;
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .daily-reward-text p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
        }

        .daily-reward-card.claimed .daily-reward-text h4,
        .daily-reward-card.claimed .daily-reward-text p {
            color: var(--text-secondary);
        }

        .daily-reward-btn-mini {
            background: rgba(255, 255, 255, 0.25);
            border: none;
            border-radius: 12px;
            padding: 10px 20px;
            color: white;
            font-weight: 700;
            font-size: 13px;
            position: relative;
            z-index: 1;
        }

        /* Action Buttons Grid */
        .action-buttons-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .action-btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            border-color: var(--primary);
        }

        .action-btn:active {
            transform: translateY(-2px);
        }

        .action-btn-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
        }

        .action-btn-icon.challenges { background: linear-gradient(135deg, #fef3c7, #fde68a); }
        .action-btn-icon.stats { background: linear-gradient(135deg, #dbeafe, #bfdbfe); }
        .action-btn-icon.tags { background: linear-gradient(135deg, #ede9fe, #ddd6fe); }
        .action-btn-icon.voice { background: linear-gradient(135deg, #dcfce7, #bbf7d0); }

        .action-btn-text {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-align: center;
        }

        /* Badges Section - Redesigned */
        .badges-section-new {
            margin-bottom: 24px;
        }

        .badges-scroll {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding: 4px 0 12px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .badges-scroll::-webkit-scrollbar {
            display: none;
        }

        .badge-card {
            flex-shrink: 0;
            width: 72px;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 14px 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
        }

        .badge-card.earned {
            background: linear-gradient(135deg, #fef9c3, #fef08a);
            border-color: #eab308;
        }

        .badge-card.locked {
            opacity: 0.5;
            filter: grayscale(0.8);
        }

        .badge-card-icon {
            font-size: 28px;
        }

        .badge-card-name {
            font-size: 9px;
            font-weight: 600;
            color: var(--text-secondary);
            text-align: center;
            line-height: 1.2;
        }

        .badge-card.earned .badge-card-name {
            color: #92400e;
        }

        /* Widget Cards */
        .widgets-section {
            margin-bottom: 24px;
        }

        .widget-card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .widget-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .widget-action {
            font-size: 12px;
            color: var(--primary);
            font-weight: 600;
            cursor: pointer;
        }

        /* Today's Progress Widget */
        .progress-ring-container {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .progress-ring {
            width: 100px;
            height: 100px;
            position: relative;
        }

        .progress-ring svg {
            transform: rotate(-90deg);
        }

        .progress-ring-bg {
            fill: none;
            stroke: var(--bg-tertiary);
            stroke-width: 8;
        }

        .progress-ring-fill {
            fill: none;
            stroke: url(#progressGradient);
            stroke-width: 8;
            stroke-linecap: round;
            stroke-dasharray: 251.2;
            stroke-dashoffset: 251.2;
            transition: stroke-dashoffset 1s ease;
        }

        .progress-ring-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .progress-ring-value {
            font-size: 28px;
            font-weight: 800;
            color: var(--text-primary);
        }

        .progress-ring-label {
            font-size: 10px;
            color: var(--text-secondary);
        }

        .progress-details {
            flex: 1;
        }

        .progress-detail-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .progress-detail-item:last-child {
            border-bottom: none;
        }

        .progress-detail-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .progress-detail-value {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* ═══════════════════════════════════════════════════════════════ */
        /* ENHANCED ANIMATIONS */
        /* ═══════════════════════════════════════════════════════════════ */
        
        /* Page Transitions */
        .screen {
            animation: fadeSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes fadeSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Card Hover Effects */
        .deck-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .deck-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(99, 102, 241, 0.2);
        }

        /* Button Press Effect */
        .btn-primary, .action-btn, .daily-reward-card {
            position: relative;
            overflow: hidden;
        }

        .btn-primary::after, .action-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn-primary:active::after, .action-btn:active::after {
            width: 300px;
            height: 300px;
        }

        /* Floating Animation */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-6px); }
        }

        .floating {
            animation: float 3s ease-in-out infinite;
        }

        /* Pulse Animation */
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .pulse {
            animation: pulse 2s ease-in-out infinite;
        }

        /* Success Celebration */
        @keyframes celebrate {
            0% { transform: scale(1); }
            25% { transform: scale(1.2) rotate(-5deg); }
            50% { transform: scale(1.2) rotate(5deg); }
            75% { transform: scale(1.1) rotate(-3deg); }
            100% { transform: scale(1) rotate(0); }
        }

        .celebrate {
            animation: celebrate 0.6s ease;
        }

        /* ═══════════════════════════════════════════════════════════════ */
        /* VOICE RECOGNITION */
        /* ═══════════════════════════════════════════════════════════════ */
        
        .voice-btn {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
        }

        .voice-btn.listening {
            animation: voicePulse 1.5s ease-in-out infinite;
        }

        @keyframes voicePulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            50% {
                box-shadow: 0 0 0 20px rgba(239, 68, 68, 0);
            }
        }

        .voice-btn::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }

        .voice-btn.listening::before {
            animation: voiceRing 1s ease-out infinite;
        }

        @keyframes voiceRing {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        .voice-status {
            text-align: center;
            margin-top: 16px;
            font-size: 14px;
            color: var(--text-secondary);
            min-height: 24px;
        }

        .voice-result {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
            text-align: center;
        }

        .voice-result-text {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        /* ═══════════════════════════════════════════════════════════════ */
        /* ADVANCED AUDIO PLAYER */
        /* ═══════════════════════════════════════════════════════════════ */
        
        .audio-player {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid var(--border);
        }

        .audio-word-display {
            text-align: center;
            margin-bottom: 20px;
        }

        .audio-word {
            font-size: 32px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .audio-pronunciation {
            font-size: 16px;
            color: var(--primary);
        }

        .audio-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-bottom: 20px;
        }

        .audio-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .audio-btn:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
        }

        .audio-btn.play {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-size: 28px;
        }

        .audio-btn.play:hover {
            transform: scale(1.15);
        }

        .audio-speed-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .speed-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .speed-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .audio-waveform {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
            height: 40px;
            margin: 16px 0;
        }

        .waveform-bar {
            width: 4px;
            background: var(--primary);
            border-radius: 2px;
            animation: waveform 1s ease-in-out infinite;
        }

        .waveform-bar:nth-child(1) { animation-delay: 0s; height: 20px; }
        .waveform-bar:nth-child(2) { animation-delay: 0.1s; height: 30px; }
        .waveform-bar:nth-child(3) { animation-delay: 0.2s; height: 40px; }
        .waveform-bar:nth-child(4) { animation-delay: 0.3s; height: 25px; }
        .waveform-bar:nth-child(5) { animation-delay: 0.4s; height: 35px; }
        .waveform-bar:nth-child(6) { animation-delay: 0.5s; height: 20px; }
        .waveform-bar:nth-child(7) { animation-delay: 0.6s; height: 30px; }

        @keyframes waveform {
            0%, 100% { transform: scaleY(0.5); opacity: 0.5; }
            50% { transform: scaleY(1); opacity: 1; }
        }

        .audio-waveform.paused .waveform-bar {
            animation-play-state: paused;
        }

        /* ═══════════════════════════════════════════════════════════════ */
        /* MINI WIDGETS */
        /* ═══════════════════════════════════════════════════════════════ */
        
        .mini-widget {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 16px;
            border: 1px solid var(--border);
        }

        .mini-widget-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .mini-widget-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .mini-widget-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Streak Widget */
        .streak-widget {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
        }

        .streak-days {
            display: flex;
            justify-content: space-between;
            gap: 6px;
        }

        .streak-day {
            flex: 1;
            aspect-ratio: 1;
            border-radius: 8px;
            background: rgba(146, 64, 14, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .streak-day.completed {
            background: #f59e0b;
        }

        .streak-day.today {
            border: 2px dashed #92400e;
        }

        /* Words of Day Widget */
        .word-of-day {
            text-align: center;
            padding: 8px 0;
        }

        .word-of-day-text {
            font-size: 24px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .word-of-day-meaning {
            font-size: 14px;
            color: var(--text-secondary);
        }
		/* ═══════════════════════════════════════════════════════════════ */
        /* ADDITIONAL ANIMATIONS */
        /* ═══════════════════════════════════════════════════════════════ */
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-10px); }
            40% { transform: translateX(10px); }
            60% { transform: translateX(-10px); }
            80% { transform: translateX(10px); }
        }

        .ripple-effect {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
            border-radius: inherit;
            animation: rippleAnim 0.6s ease-out forwards;
            pointer-events: none;
        }

        @keyframes rippleAnim {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }

        /* Voice Mode Styles */
        .voice-mode-content {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Floating Audio Player */
        .floating-audio-player {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            border-radius: 30px;
            padding: 8px 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border);
            z-index: 1500;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .floating-audio-content {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .floating-audio-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: var(--bg-secondary);
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .floating-audio-btn:hover {
            background: var(--primary);
            transform: scale(1.1);
        }

        .floating-audio-btn.play {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            font-size: 22px;
        }

        /* Card Audio Button */
        .card-audio-btn:hover {
            background: var(--primary) !important;
            transform: scale(1.1);
        }

        .card-audio-btn:active {
            transform: scale(0.95);
        }

        /* Voice Result Animations */
        .voice-result {
            animation: popIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Enhanced Deck Card Animations */
        .deck-card {
            position: relative;
            overflow: hidden;
        }

        .deck-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s ease;
        }

        .deck-card:hover::before {
            left: 100%;
        }

        /* Stats Number Animation */
        .quick-stat-value, .mini-stat-value {
            transition: transform 0.3s ease;
        }

        .quick-stat-item:hover .quick-stat-value,
        .mini-stat-card:hover .mini-stat-value {
            transform: scale(1.1);
        }

        /* Badge Hover Effects */
        .badge-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .badge-card:hover {
            transform: translateY(-4px) scale(1.05);
        }

        .badge-card.earned:hover {
            box-shadow: 0 8px 24px rgba(245, 158, 11, 0.3);
        }

        /* Progress Ring Animation */
        .progress-ring-fill {
            animation: progressFill 1.5s ease-out forwards;
        }

        @keyframes progressFill {
            from { stroke-dashoffset: 251.2; }
        }

        /* Widget Card Hover */
        .widget-card {
            transition: all 0.3s ease;
        }

        .widget-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }

        /* Action Button Press Effect */
        .action-btn:active {
            transform: translateY(0) scale(0.95);
        }

        .action-btn:active .action-btn-icon {
            transform: scale(0.9);
        }

        /* Streak Day Animation */
        .streak-day {
            transition: all 0.3s ease;
        }

        .streak-day:hover {
            transform: scale(1.1);
        }

        .streak-day.completed {
            animation: streakPop 0.5s ease;
        }

        @keyframes streakPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* Daily Reward Claimed State */
        .daily-reward-card.claimed {
            opacity: 0.7;
        }

        .daily-reward-card.claimed:hover {
            transform: none;
            box-shadow: none;
        }

        /* Smooth Scroll for Badges */
        .badges-scroll {
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        /* Hero Section Responsive */
        @media (max-width: 360px) {
            .hero-section-new {
                padding: 16px 16px 24px;
            }

            .level-card-hero {
                padding: 14px 16px;
            }

            .level-badge-large {
                width: 48px;
                height: 48px;
                font-size: 20px;
            }

            .quick-stat-item {
                padding: 12px 8px;
            }

            .quick-stat-value {
                font-size: 18px;
            }

            .action-buttons-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
            }

            .action-btn {
                padding: 12px 4px;
            }

            .action-btn-icon {
                width: 36px;
                height: 36px;
                font-size: 18px;
            }

            .action-btn-text {
                font-size: 10px;
            }
        }

        /* Safe Area for iPhone */
        @supports (padding-top: env(safe-area-inset-top)) {
            .hero-section-new {
                padding-top: calc(20px + env(safe-area-inset-top));
            }
        }

        /* Glassmorphism Enhancement */
        .level-card-hero,
        .quick-stat-item,
        .hero-streak-badge {
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
        }

        /* Dark Mode Adjustments */
        [data-theme="dark"] .hero-section-new {
            background: linear-gradient(135deg, #4338ca 0%, #6366f1 50%, #7c3aed 100%);
        }

        [data-theme="dark"] .streak-widget {
            background: linear-gradient(135deg, #78350f, #92400e);
        }

        [data-theme="dark"] .streak-widget .widget-title {
            color: #fef3c7;
        }

        [data-theme="dark"] .badge-card.earned {
            background: linear-gradient(135deg, #78350f, #92400e);
        }

        [data-theme="dark"] .daily-reward-card.claimed {
            background: var(--bg-tertiary);
        }

        /* Loading States */
        .loading-skeleton {
            background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-tertiary) 50%, var(--bg-secondary) 75%);
            background-size: 200% 100%;
            animation: shimmerSkeleton 1.5s infinite;
            border-radius: 8px;
        }

        @keyframes shimmerSkeleton {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
		/* ═══════════════════════════════════════════════════════════════ */
        /* LIBRARY REDESIGN */
        /* ═══════════════════════════════════════════════════════════════ */
        
        .library-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .library-header-info {
            flex: 1;
        }

        .library-title {
            font-size: 20px;
            font-weight: 800;
            color: var(--text-primary);
            margin: 0;
        }

        .library-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            margin: 4px 0 0 0;
        }

        .btn-back {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .library-actions {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        /* Deck Cards Grid */
        .decks-grid {
            display: grid;
            gap: 16px;
        }

        .deck-card-large {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .deck-card-large:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.1);
            border-color: var(--primary);
        }

        .deck-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .deck-card-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary-light), #e0e7ff);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .deck-card-menu {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .deck-card-menu:hover {
            background: var(--bg-secondary);
        }

        .deck-card-body {
            margin-bottom: 16px;
        }

        .deck-card-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 4px 0;
        }

        .deck-card-desc {
            font-size: 13px;
            color: var(--text-secondary);
            margin: 0;
        }

        .deck-card-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 12px;
        }

        .deck-stat {
            text-align: center;
        }

        .deck-stat-value {
            display: block;
            font-size: 20px;
            font-weight: 800;
            color: var(--text-primary);
        }

        .deck-stat-value.text-warning {
            color: var(--warning);
        }

        .deck-stat-value.text-success {
            color: var(--success);
        }

        .deck-stat-label {
            font-size: 11px;
            color: var(--text-tertiary);
        }

        .deck-card-progress {
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .deck-card-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), #34d399);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .deck-review-btn {
            margin-top: 0;
        }

        .deck-complete-badge {
            text-align: center;
            padding: 12px;
            background: var(--success-light);
            border-radius: 12px;
            color: var(--success);
            font-weight: 600;
            font-size: 14px;
        }

        /* Cards List */
        .cards-filter {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            overflow-x: auto;
            padding-bottom: 8px;
        }

        .filter-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s ease;
        }

        .filter-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .cards-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .card-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: var(--bg-card);
            border-radius: 14px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .card-item:hover {
            border-color: var(--primary);
            transform: translateX(-4px);
        }

        .card-item.due {
            border-right: 4px solid var(--warning);
        }

        .card-item.mastered {
            border-right: 4px solid var(--success);
        }

        .card-item.new {
            border-right: 4px solid var(--primary);
        }

        .card-item-status {
            font-size: 20px;
        }

        .card-item-content {
            flex: 1;
            min-width: 0;
        }

        .card-item-word {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .card-item-meaning {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-item-badge {
            display: inline-block;
            font-size: 12px;
            margin-top: 4px;
        }

        .card-item-actions {
            display: flex;
            gap: 4px;
        }

        .btn-icon-sm {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: var(--bg-secondary);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-icon-sm:hover {
            background: var(--primary);
            transform: scale(1.1);
        }

        .btn-icon-sm.danger:hover {
            background: var(--danger);
        }

        /* Deck Manager */
        .deck-manager-section {
            margin-bottom: 24px;
        }

        .deck-manager-section h3 {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        .deck-manager-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .deck-manager-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: 12px;
        }

        .deck-manager-icon {
            font-size: 24px;
        }

        .deck-manager-name {
            flex: 1;
            font-weight: 600;
            color: var(--text-primary);
        }

        .deck-manager-actions {
            display: flex;
            gap: 4px;
        }

        .icon-picker {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .icon-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            border: 2px solid var(--border);
            background: var(--bg-card);
            font-size: 22px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .icon-btn:hover {
            border-color: var(--primary);
            transform: scale(1.1);
        }

        .icon-btn.selected {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .empty-state {
            text-align: center;
            padding: 48px 24px;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .empty-state h3 {
            font-size: 18px;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .empty-state p {
            color: var(--text-secondary);
            font-size: 14px;
        }
		/* ═══════════════════════════════════════════════════════════════ */
        /* MODAL STYLES */
        /* ═══════════════════════════════════════════════════════════════ */
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 2000;
            display: none;
            align-items: flex-end;
            justify-content: center;
            padding: 0;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-container {
            background: var(--bg-primary);
            border-radius: 24px 24px 0 0;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUpModal 0.3s ease;
        }

        .modal-container.modal-large {
            max-height: 95vh;
        }

        @keyframes slideUpModal {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            background: var(--bg-primary);
            z-index: 10;
        }

        .modal-header h2 {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: var(--bg-secondary);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: var(--danger);
            color: white;
        }

        .modal-body {
            padding: 24px;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 16px;
            position: relative;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 15px;
            font-family: inherit;
            background: var(--bg-card);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .input-addon {
            position: absolute;
            right: 8px;
            top: 38px;
            width: 36px;
            height: 36px;
            border: none;
            background: var(--primary);
            border-radius: 8px;
            cursor: pointer;
        }

        .btn-block {
            width: 100%;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 13px;
        }

        /* Ready Decks Styles */
        .ready-decks-categories {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 16px;
            margin-bottom: 16px;
        }

        .category-btn {
            padding: 10px 20px;
            border-radius: 20px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s ease;
        }

        .category-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .ready-decks-grid {
            display: grid;
            gap: 12px;
        }

        .ready-deck-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px;
            display: flex;
            gap: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ready-deck-card:hover {
            border-color: var(--primary);
            transform: translateX(-4px);
        }

        .ready-deck-card.installed {
            opacity: 0.6;
        }

        .ready-deck-icon {
            width: 52px;
            height: 52px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            flex-shrink: 0;
        }

        .ready-deck-icon.exam { background: linear-gradient(135deg, #fef3c7, #fde68a); }
        .ready-deck-icon.level { background: linear-gradient(135deg, #dbeafe, #bfdbfe); }
        .ready-deck-icon.topic { background: linear-gradient(135deg, #dcfce7, #bbf7d0); }
        .ready-deck-icon.phrase { background: linear-gradient(135deg, #fce7f3, #fbcfe8); }

        .ready-deck-info {
            flex: 1;
            min-width: 0;
        }

        .ready-deck-name {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .ready-deck-desc {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .ready-deck-meta {
            display: flex;
            gap: 12px;
            font-size: 11px;
            color: var(--text-tertiary);
        }

        .ready-deck-action {
            display: flex;
            align-items: center;
        }

        .ready-deck-action button {
            padding: 10px 16px;
            border-radius: 10px;
            border: none;
            background: var(--primary);
            color: white;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ready-deck-action button:hover {
            transform: scale(1.05);
        }

        /* Image Card Styles */
        .image-upload-area {
            border: 2px dashed var(--border);
            border-radius: 16px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .image-upload-area:hover {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .image-upload-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .image-upload-text {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .image-upload-hint {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .image-preview {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 12px;
            margin-bottom: 12px;
        }

        /* Spaced Reading Styles */
        .reading-mode-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .reading-mode-btn {
            flex: 1;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .reading-mode-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .reading-container {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            max-height: 300px;
            overflow-y: auto;
        }

        .reading-text {
            font-size: 16px;
            line-height: 2;
            color: var(--text-primary);
        }

        .reading-text .word {
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .reading-text .word:hover {
            background: var(--primary-light);
        }

        .reading-text .word.known {
            color: var(--success);
        }

        .reading-text .word.unknown {
            background: #fef3c7;
            color: #92400e;
        }

        .reading-text .word.learning {
            background: var(--primary-light);
            color: var(--primary);
        }

        .word-info-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            animation: fadeSlideIn 0.3s ease;
        }

        .word-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .word-info-word {
            font-size: 20px;
            font-weight: 800;
            color: var(--text-primary);
        }

        .word-info-meaning {
            font-size: 16px;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .word-info-example {
            font-size: 14px;
            color: var(--text-secondary);
            font-style: italic;
            margin-bottom: 12px;
        }

        .word-info-actions {
            display: flex;
            gap: 8px;
        }

        .reading-stats {
            display: flex;
            justify-content: space-around;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 12px;
        }

        .reading-stat {
            text-align: center;
        }

        .reading-stat-value {
            display: block;
            font-size: 20px;
            font-weight: 800;
            color: var(--text-primary);
        }

        .reading-stat-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .sample-texts-grid {
            display: grid;
            gap: 12px;
        }

        .sample-text-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .sample-text-card:hover {
            border-color: var(--primary);
        }

        .sample-text-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .sample-text-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Install Modal */
        .install-modal-content,
        .notification-modal-content {
            text-align: center;
            padding: 20px 0;
        }

        .install-icon,
        .notification-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .install-modal-content h2,
        .notification-modal-content h2 {
            font-size: 22px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .install-modal-content p,
        .notification-modal-content p {
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        .install-steps {
            text-align: right;
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .install-step {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
        }

        .install-step:not(:last-child) {
            border-bottom: 1px solid var(--border);
        }

        .step-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            font-weight: 700;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-features {
            text-align: right;
            margin-bottom: 24px;
        }

        .notification-feature {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .feature-icon {
            font-size: 20px;
        }

        .install-buttons,
        .notification-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
		/* ═══════════════════════════════════════════════════════════════ */
        /* IMAGE CARDS IN REVIEW */
        /* ═══════════════════════════════════════════════════════════════ */
        
        .card-image-container {
            width: 100%;
            max-height: 150px;
            overflow: hidden;
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .card-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 12px;
        }

        /* ═══════════════════════════════════════════════════════════════ */
        /* SETTINGS ENHANCEMENTS */
        /* ═══════════════════════════════════════════════════════════════ */
        
        .settings-section {
            margin-bottom: 24px;
        }

        .settings-section-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-secondary);
            margin-bottom: 12px;
            padding: 0 4px;
        }

        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: var(--bg-card);
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--border);
        }

        .setting-item:hover {
            border-color: var(--primary);
            transform: translateX(-4px);
        }

        .setting-info {
            flex: 1;
        }

        .setting-label {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .setting-desc {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .setting-value {
            font-size: 14px;
            color: var(--text-tertiary);
            font-weight: 500;
        }

        /* ═══════════════════════════════════════════════════════════════ */
        /* ACTION BUTTONS GRID - 5 ITEMS */
        /* ═══════════════════════════════════════════════════════════════ */
        
        .action-buttons-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        @media (max-width: 380px) {
            .action-buttons-grid {
                grid-template-columns: repeat(5, 1fr);
                gap: 6px;
            }
            
            .action-btn {
                padding: 10px 4px;
            }
            
            .action-btn-icon {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }
            
            .action-btn-text {
                font-size: 9px;
            }
        }

        /* ═══════════════════════════════════════════════════════════════ */
        /* NOTIFICATION MODAL ENHANCEMENTS */
        /* ═══════════════════════════════════════════════════════════════ */
        
        .notification-time-picker {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 20px 0;
        }

        .time-input {
            width: 60px;
            padding: 12px;
            text-align: center;
            font-size: 20px;
            font-weight: 700;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .time-separator {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-secondary);
        }

        /* ═══════════════════════════════════════════════════════════════ */
        /* READING TEXT IMPROVEMENTS */
        /* ═══════════════════════════════════════════════════════════════ */
        
        .reading-container {
            position: relative;
        }

        .reading-text {
            text-align: justify;
            direction: ltr;
        }

        .reading-text .word.selected {
            background: var(--primary);
            color: white;
            border-radius: 4px;
        }

        .reading-progress-bar {
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            margin-top: 12px;
            overflow: hidden;
        }

        .reading-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        /* ═══════════════════════════════════════════════════════════════ */
        /* LIBRARY CARDS ANIMATIONS */
        /* ═══════════════════════════════════════════════════════════════ */
        
        .deck-card-large {
            animation: fadeSlideIn 0.4s ease;
        }

        .card-item {
            animation: fadeSlideIn 0.3s ease;
        }

        @keyframes fadeSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .deck-card-large:nth-child(1) { animation-delay: 0s; }
        .deck-card-large:nth-child(2) { animation-delay: 0.1s; }
        .deck-card-large:nth-child(3) { animation-delay: 0.2s; }
        .deck-card-large:nth-child(4) { animation-delay: 0.3s; }

        /* ═══════════════════════════════════════════════════════════════ */
        /* READY DECKS LOADING STATE */
        /* ═══════════════════════════════════════════════════════════════ */
        
        .ready-deck-card.installing {
            pointer-events: none;
            opacity: 0.7;
        }

        .ready-deck-card.installing button {
            background: var(--bg-tertiary) !important;
        }

        .ready-deck-card.installing button::after {
            content: '';
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid transparent;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ═══════════════════════════════════════════════════════════════ */
        /* EMPTY STATES */
        /* ═══════════════════════════════════════════════════════════════ */
        
        .empty-state {
            animation: fadeIn 0.5s ease;
        }

        .empty-state .empty-icon {
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* ═══════════════════════════════════════════════════════════════ */
        /* TOAST IMPROVEMENTS */
        /* ═══════════════════════════════════════════════════════════════ */
        
        .toast {
            max-width: 90%;
            word-wrap: break-word;
        }

        /* ═══════════════════════════════════════════════════════════════ */
        /* INSTALL MODAL IMPROVEMENTS */
        /* ═══════════════════════════════════════════════════════════════ */
        
        .install-modal-content {
            max-width: 100%;
        }

        .install-steps {
            text-align: right;
        }

        .install-step {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 0;
            text-align: right;
            line-height: 1.6;
        }

        .step-number {
            flex-shrink: 0;
        }

        /* ═══════════════════════════════════════════════════════════════ */
        /* PWA SPECIFIC STYLES */
        /* ═══════════════════════════════════════════════════════════════ */
        
        @media (display-mode: standalone) {
            /* Styles for installed PWA */
            .install-prompt {
                display: none !important;
            }
            
            body {
                /* Prevent overscroll */
                overscroll-behavior: none;
            }
        }

        /* iOS PWA specific */
        @supports (-webkit-touch-callout: none) {
            .modal-container {
                padding-bottom: env(safe-area-inset-bottom, 20px);
            }
            
            .bottom-nav {
                padding-bottom: env(safe-area-inset-bottom, 0);
            }
        }

        /* ═══════════════════════════════════════════════════════════════ */
        /* DARK MODE ADDITIONS */
        /* ═══════════════════════════════════════════════════════════════ */
        
        [data-theme="dark"] .ready-deck-icon.exam {
            background: linear-gradient(135deg, #78350f, #92400e);
        }
        
        [data-theme="dark"] .ready-deck-icon.level {
            background: linear-gradient(135deg, #1e3a5f, #2563eb);
        }
        
        [data-theme="dark"] .ready-deck-icon.topic {
            background: linear-gradient(135deg, #14532d, #16a34a);
        }
        
        [data-theme="dark"] .ready-deck-icon.phrase {
            background: linear-gradient(135deg, #831843, #db2777);
        }

        [data-theme="dark"] .reading-text .word.unknown {
            background: #78350f;
            color: #fef3c7;
        }

        [data-theme="dark"] .reading-text .word.learning {
            background: #312e81;
            color: #c7d2fe;
        }

        [data-theme="dark"] .image-upload-area {
            border-color: var(--border);
        }

        [data-theme="dark"] .image-upload-area:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        /* ═══════════════════════════════════════════════════════════════ */
        /* RESPONSIVE FIXES */
        /* ═══════════════════════════════════════════════════════════════ */
        
        @media (max-width: 340px) {
            .library-actions {
                flex-direction: column;
            }
            
            .library-actions button {
                width: 100%;
            }
            
            .deck-card-stats {
                gap: 12px;
            }
            
            .deck-stat-value {
                font-size: 18px;
            }
            
            .ready-deck-card {
                flex-direction: column;
                text-align: center;
            }
            
            .ready-deck-icon {
                margin: 0 auto 12px;
            }
            
            .ready-deck-action {
                width: 100%;
                margin-top: 12px;
            }
            
            .ready-deck-action button {
                width: 100%;
            }
        }

        /* ═══════════════════════════════════════════════════════════════ */
        /* PRINT STYLES (for export) */
        /* ═══════════════════════════════════════════════════════════════ */
        
        @media print {
            .bottom-nav,
            .modal-overlay,
            .toast-container {
                display: none !important;
            }
            
            .screen {
                display: block !important;
                opacity: 1 !important;
            }
        }
		
    </style>
</head>
<body>
	<!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- HOME SCREEN -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
            <!-- REDESIGNED HOME SCREEN -->
            <!-- ═══════════════════════════════════════════════════════════════ -->
            
            <!-- Hero Section -->
            <div class="hero-section-new">
                <div class="hero-header">
                    <div>
                        <div class="hero-greeting" id="heroGreeting">سلام! 👋</div>
                        <div class="hero-title">به LEXORA خوش آمدید</div>
                    </div>
                    <div class="hero-streak-badge">
                        <span>🔥</span>
                        <span id="heroStreak">۰</span>
                    </div>
                </div>

                <!-- Level Card -->
                <div class="level-card-hero">
                    <div class="level-card-content">
                        <div class="level-badge-large" id="heroBadge">۱</div>
                        <div class="level-info-hero">
                            <div class="level-title-hero">
                                سطح <span id="heroLevel">۱</span> - <span class="level-name" id="heroLevelName">تازه‌کار</span>
                            </div>
                            <div class="xp-bar-hero">
                                <div class="xp-bar-fill-hero" id="heroXpBar" style="width: 0%"></div>
                            </div>
                            <div class="xp-text-hero">
                                <span><span id="heroXpCurrent">۰</span> XP</span>
                                <span><span id="heroXpNext">۱۰۰</span> XP تا سطح بعد</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="quick-stats-row">
                    <div class="quick-stat-item">
                        <div class="quick-stat-value" id="statTodayReviews">۰</div>
                        <div class="quick-stat-label">امروز</div>
                    </div>
                    <div class="quick-stat-item">
                        <div class="quick-stat-value" id="statTotalCards">۰</div>
                        <div class="quick-stat-label">کل کارت‌ها</div>
                    </div>
                    <div class="quick-stat-item">
                        <div class="quick-stat-value" id="statMastered">۰</div>
                        <div class="quick-stat-label">تسلط</div>
                    </div>
                </div>
            </div>

            <!-- Daily Reward Card -->
            <div class="daily-reward-card" id="dailyRewardCard" onclick="Gamification.claimDailyReward()">
                <div class="daily-reward-info">
                    <div class="daily-reward-icon">🎁</div>
                    <div class="daily-reward-text">
                        <h4>پاداش روزانه</h4>
                        <p id="dailyRewardDesc">برای دریافت XP کلیک کنید!</p>
                    </div>
                </div>
                <div class="daily-reward-btn-mini" id="dailyRewardBtnText">دریافت</div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons-grid">
                <div class="action-btn" onclick="Challenges.open()">
                    <div class="action-btn-icon challenges">🏆</div>
                    <div class="action-btn-text">چالش‌ها</div>
                </div>
                <div class="action-btn" onclick="AdvancedStats.open()">
                    <div class="action-btn-icon stats">📊</div>
                    <div class="action-btn-text">آمار</div>
                </div>
                <div class="action-btn" onclick="TagSystem.open()">
                    <div class="action-btn-icon tags">🏷️</div>
                    <div class="action-btn-text">تگ‌ها</div>
                </div>
                <div class="action-btn" onclick="VoiceMode.open()">
                    <div class="action-btn-icon voice">🎤</div>
                    <div class="action-btn-text">صوتی</div>
                </div>
            </div>

            <!-- Today's Progress Widget -->
            <div class="widget-card">
                <div class="widget-header">
                    <div class="widget-title">
                        <span>📈</span> پیشرفت امروز
                    </div>
                    <div class="widget-action" onclick="AdvancedStats.open()">جزئیات</div>
                </div>
                <div class="progress-ring-container">
                    <div class="progress-ring">
                        <svg width="100" height="100">
                            <defs>
                                <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:#6366f1"/>
                                    <stop offset="100%" style="stop-color:#8b5cf6"/>
                                </linearGradient>
                            </defs>
                            <circle class="progress-ring-bg" cx="50" cy="50" r="40"/>
                            <circle class="progress-ring-fill" id="progressRingFill" cx="50" cy="50" r="40"/>
                        </svg>
                        <div class="progress-ring-text">
                            <div class="progress-ring-value" id="progressPercent">۰٪</div>
                            <div class="progress-ring-label">هدف روزانه</div>
                        </div>
                    </div>
                    <div class="progress-details">
                        <div class="progress-detail-item">
                            <span class="progress-detail-label">مرور شده</span>
                            <span class="progress-detail-value" id="detailReviewed">۰ کارت</span>
                        </div>
                        <div class="progress-detail-item">
                            <span class="progress-detail-label">هدف روزانه</span>
                            <span class="progress-detail-value" id="detailGoal">۲۰ کارت</span>
                        </div>
                        <div class="progress-detail-item">
                            <span class="progress-detail-label">دقت</span>
                            <span class="progress-detail-value" id="detailAccuracy">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Badges Horizontal Scroll -->
            <div class="badges-section-new">
                <div class="section-title">
                    <span>🏅</span> مدال‌ها
                    <span class="section-badge" id="badgeCount">۰/۱۲</span>
                </div>
                <div class="badges-scroll" id="badgesScrollContainer">
                    <!-- Badges will be populated by JS -->
                </div>
            </div>

            <!-- Streak Widget -->
            <div class="widgets-section">
                <div class="widget-card streak-widget">
                    <div class="widget-header">
                        <div class="widget-title" style="color: #92400e;">
                            <span>🔥</span> روند این هفته
                        </div>
                    </div>
                    <div class="streak-days" id="streakDays">
                        <!-- Days will be populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Word of the Day -->
            <div class="widget-card">
                <div class="widget-header">
                    <div class="widget-title">
                        <span>💡</span> کلمه روز
                    </div>
                    <div class="widget-action" onclick="WordOfDay.refresh()">🔄</div>
                </div>
                <div class="word-of-day" id="wordOfDayContainer">
                    <div class="word-of-day-text" id="wodWord">Loading...</div>
                    <div class="word-of-day-meaning" id="wodMeaning"></div>
                    <button class="btn-secondary" style="margin-top: 12px; padding: 10px 24px;" onclick="WordOfDay.play()">
                        🔊 تلفظ
                    </button>
                </div>
            </div>

            <!-- Quick Start Section -->
            <div class="section-title" style="margin-top: 24px;">
                <span>📚</span> شروع سریع
            </div>
            <div id="quickStartDecks">
                <!-- Top decks will be populated by JS -->
            </div>

    // ═══════════════════════════════════════════════════════════════
        // LIBRARY - FIXED VERSION
        // ═══════════════════════════════════════════════════════════════
        const Library = {
            currentDeck: null,
            currentView: 'decks', // 'decks' or 'cards'

            init() {
                this.render();
            },

            render() {
                if (this.currentView === 'decks') {
                    this.renderDecks();
                } else {
                    this.renderCards();
                }
            },

            renderDecks() {
                const container = document.getElementById('libraryContent');
                if (!container) return;

                const decks = DeckManager.getAll();
                
                let html = `
                    <div class="library-header">
                        <h2 class="library-title">📚 کتابخانه</h2>
                        <button class="btn-icon" onclick="Library.openDeckManager()">⚙️</button>
                    </div>
                    
                    <div class="library-actions">
                        <button class="btn-primary" onclick="Library.createNewDeck()" style="flex: 1;">
                            ➕ ساخت Deck جدید
                        </button>
                        <button class="btn-secondary" onclick="ReadyDecks.open()" style="flex: 1;">
                            📦 Deck های آماده
                        </button>
                    </div>
                `;

                if (decks.length === 0) {
                    html += `
                        <div class="empty-state">
                            <div class="empty-icon">📚</div>
                            <h3>هنوز Deck ای ندارید</h3>
                            <p>اولین Deck خود را بسازید یا از Deck های آماده استفاده کنید</p>
                        </div>
                    `;
                } else {
                    html += `<div class="decks-grid">`;
                    
                    decks.forEach(deck => {
                        const cards = Object.values(CardManager.getAll()).filter(c => c.deckId === deck.id);
                        const dueCards = cards.filter(c => {
                            if (!c.nextReview) return true;
                            return new Date(c.nextReview) <= new Date();
                        }).length;
                        const masteredCards = cards.filter(c => c.stability >= 30).length;
                        const progress = cards.length > 0 ? Math.round((masteredCards / cards.length) * 100) : 0;

                        html += `
                            <div class="deck-card-large" onclick="Library.selectDeck('${deck.id}')">
                                <div class="deck-card-header">
                                    <div class="deck-card-icon">${deck.icon || '📚'}</div>
                                    <div class="deck-card-menu" onclick="event.stopPropagation(); Library.showDeckMenu('${deck.id}')">⋮</div>
                                </div>
                                <div class="deck-card-body">
                                    <h3 class="deck-card-title">${deck.name}</h3>
                                    <p class="deck-card-desc">${deck.description || 'بدون توضیحات'}</p>
                                </div>
                                <div class="deck-card-stats">
                                    <div class="deck-stat">
                                        <span class="deck-stat-value">${Utils.toPersian(cards.length)}</span>
                                        <span class="deck-stat-label">کارت</span>
                                    </div>
                                    <div class="deck-stat">
                                        <span class="deck-stat-value ${dueCards > 0 ? 'text-warning' : ''}">${Utils.toPersian(dueCards)}</span>
                                        <span class="deck-stat-label">برای مرور</span>
                                    </div>
                                    <div class="deck-stat">
                                        <span class="deck-stat-value text-success">${Utils.toPersian(progress)}٪</span>
                                        <span class="deck-stat-label">پیشرفت</span>
                                    </div>
                                </div>
                                <div class="deck-card-progress">
                                    <div class="deck-card-progress-fill" style="width: ${progress}%"></div>
                                </div>
                                ${dueCards > 0 ? `
                                    <button class="btn-primary btn-block deck-review-btn" onclick="event.stopPropagation(); Library.startReview('${deck.id}')">
                                        🎯 شروع مرور (${Utils.toPersian(dueCards)})
                                    </button>
                                ` : `
                                    <div class="deck-complete-badge">✅ تکمیل شده برای امروز</div>
                                `}
                            </div>
                        `;
                    });
                    
                    html += `</div>`;
                }

                container.innerHTML = html;
                this.currentView = 'decks';
            },

            renderCards() {
                const container = document.getElementById('libraryContent');
                if (!container || !this.currentDeck) return;

                const deck = DeckManager.getAll().find(d => d.id === this.currentDeck);
                if (!deck) {
                    this.currentView = 'decks';
                    this.renderDecks();
                    return;
                }

                const cards = Object.values(CardManager.getAll()).filter(c => c.deckId === deck.id);
                const dueCards = cards.filter(c => !c.nextReview || new Date(c.nextReview) <= new Date()).length;

                let html = `
                    <div class="library-header">
                        <button class="btn-back" onclick="Library.backToDecks()">→</button>
                        <div class="library-header-info">
                            <h2 class="library-title">${deck.icon || '📚'} ${deck.name}</h2>
                            <p class="library-subtitle">${Utils.toPersian(cards.length)} کارت</p>
                        </div>
                        <button class="btn-icon" onclick="Library.showDeckMenu('${deck.id}')">⚙️</button>
                    </div>

                    <div class="library-actions">
                        <button class="btn-primary" onclick="Library.addNewCard()" style="flex: 1;">
                            ➕ افزودن کارت
                        </button>
                        <button class="btn-secondary" onclick="Library.addImageCard()" style="flex: 1;">
                            🖼️ کارت تصویری
                        </button>
                    </div>

                    ${dueCards > 0 ? `
                        <button class="btn-primary btn-block" onclick="Library.startReview('${deck.id}')" style="margin-bottom: 16px;">
                            🎯 شروع مرور (${Utils.toPersian(dueCards)} کارت)
                        </button>
                    ` : ''}

                    <div class="cards-filter">
                        <button class="filter-btn active" onclick="Library.filterCards('all', this)">همه</button>
                        <button class="filter-btn" onclick="Library.filterCards('due', this)">برای مرور</button>
                        <button class="filter-btn" onclick="Library.filterCards('new', this)">جدید</button>
                        <button class="filter-btn" onclick="Library.filterCards('mastered', this)">تسلط</button>
                    </div>
                `;

                if (cards.length === 0) {
                    html += `
                        <div class="empty-state">
                            <div class="empty-icon">🃏</div>
                            <h3>هنوز کارتی ندارید</h3>
                            <p>اولین کارت خود را اضافه کنید</p>
                        </div>
                    `;
                } else {
                    html += `<div class="cards-list" id="cardsList">`;
                    
                    cards.forEach(card => {
                        const isDue = !card.nextReview || new Date(card.nextReview) <= new Date();
                        const isMastered = card.stability >= 30;
                        const isNew = !card.lastReview;
                        
                        let statusIcon = '📝';
                        let statusClass = '';
                        if (isMastered) {
                            statusIcon = '✅';
                            statusClass = 'mastered';
                        } else if (isDue) {
                            statusIcon = '🔔';
                            statusClass = 'due';
                        } else if (isNew) {
                            statusIcon = '🆕';
                            statusClass = 'new';
                        }

                        html += `
                            <div class="card-item ${statusClass}" data-status="${isMastered ? 'mastered' : isDue ? 'due' : isNew ? 'new' : 'learning'}">
                                <div class="card-item-status">${statusIcon}</div>
                                <div class="card-item-content">
                                    <div class="card-item-word">${card.word}</div>
                                    <div class="card-item-meaning">${card.meaning}</div>
                                    ${card.image ? '<div class="card-item-badge">🖼️</div>' : ''}
                                </div>
                                <div class="card-item-actions">
                                    <button class="btn-icon-sm" onclick="event.stopPropagation(); AudioPlayer.speak('${card.word}')">🔊</button>
                                    <button class="btn-icon-sm" onclick="event.stopPropagation(); Library.editCard('${card.id}')">✏️</button>
                                    <button class="btn-icon-sm danger" onclick="event.stopPropagation(); Library.deleteCard('${card.id}')">🗑️</button>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `</div>`;
                }

                container.innerHTML = html;
                this.currentView = 'cards';
            },

            selectDeck(deckId) {
                this.currentDeck = deckId;
                this.currentView = 'cards';
                this.renderCards();
            },

            backToDecks() {
                this.currentDeck = null;
                this.currentView = 'decks';
                this.renderDecks();
            },

            // Create new deck
            createNewDeck() {
                document.getElementById('deckManagerModal').classList.add('active');
                this.renderDeckManager();
            },

            openDeckManager() {
                document.getElementById('deckManagerModal').classList.add('active');
                this.renderDeckManager();
            },

            renderDeckManager() {
                const container = document.getElementById('deckManagerContent');
                if (!container) return;

                const decks = DeckManager.getAll();

                let html = `
                    <div class="deck-manager-section">
                        <h3>➕ ساخت Deck جدید</h3>
                        <div class="form-group">
                            <label class="form-label">نام Deck</label>
                            <input type="text" class="form-input" id="newDeckName" placeholder="مثال: لغات IELTS">
                        </div>
                        <div class="form-group">
                            <label class="form-label">توضیحات (اختیاری)</label>
                            <input type="text" class="form-input" id="newDeckDesc" placeholder="توضیحات کوتاه...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">آیکون</label>
                            <div class="icon-picker" id="iconPicker">
                                ${['📚', '📖', '🎯', '💼', '🎓', '🌍', '💡', '⭐', '🔥', '📝', '🎨', '🔬'].map(icon => `
                                    <button class="icon-btn ${icon === '📚' ? 'selected' : ''}" onclick="Library.selectIcon('${icon}', this)">${icon}</button>
                                `).join('')}
                            </div>
                        </div>
                        <button class="btn-primary btn-block" onclick="Library.saveDeck()">
                            ✅ ایجاد Deck
                        </button>
                    </div>

                    <div class="deck-manager-section">
                        <h3>📋 مدیریت Deck ها</h3>
                        ${decks.length === 0 ? '<p class="text-muted">هنوز Deck ای ندارید</p>' : ''}
                        <div class="deck-manager-list">
                            ${decks.map(deck => `
                                <div class="deck-manager-item">
                                    <span class="deck-manager-icon">${deck.icon || '📚'}</span>
                                    <span class="deck-manager-name">${deck.name}</span>
                                    <div class="deck-manager-actions">
                                        <button class="btn-icon-sm" onclick="Library.editDeck('${deck.id}')">✏️</button>
                                        <button class="btn-icon-sm danger" onclick="Library.deleteDeck('${deck.id}')">🗑️</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;

                container.innerHTML = html;
            },

            selectedIcon: '📚',

            selectIcon(icon, btn) {
                this.selectedIcon = icon;
                document.querySelectorAll('#iconPicker .icon-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
            },

            saveDeck() {
                const name = document.getElementById('newDeckName')?.value.trim();
                const desc = document.getElementById('newDeckDesc')?.value.trim();

                if (!name) {
                    Toast.warning('لطفاً نام Deck را وارد کنید');
                    return;
                }

                const deck = DeckManager.create(name, desc, this.selectedIcon);
                Toast.success(`Deck "${name}" ایجاد شد`);
                
                document.getElementById('newDeckName').value = '';
                document.getElementById('newDeckDesc').value = '';
                
                this.renderDeckManager();
                this.render();
            },

            editDeck(deckId) {
                const deck = DeckManager.getAll().find(d => d.id === deckId);
                if (!deck) return;

                const newName = prompt('نام جدید:', deck.name);
                if (newName && newName.trim()) {
                    deck.name = newName.trim();
                    DeckManager.save(deck);
                    Toast.success('Deck ویرایش شد');
                    this.renderDeckManager();
                    this.render();
                }
            },

            deleteDeck(deckId) {
                const deck = DeckManager.getAll().find(d => d.id === deckId);
                if (!deck) return;

                if (confirm(`آیا از حذف "${deck.name}" مطمئن هستید؟`)) {
                    DeckManager.delete(deckId);
                    Toast.success('Deck حذف شد');
                    this.renderDeckManager();
                    this.render();
                }
            },

            showDeckMenu(deckId) {
                const deck = DeckManager.getAll().find(d => d.id === deckId);
                if (!deck) return;

                const action = prompt(`${deck.name}\n\n1. ویرایش\n2. حذف\n3. صادر کردن\n\nشماره را وارد کنید:`);
                
                if (action === '1') {
                    this.editDeck(deckId);
                } else if (action === '2') {
                    this.deleteDeck(deckId);
                } else if (action === '3') {
                    this.exportDeck(deckId);
                }
            },

            exportDeck(deckId) {
                const deck = DeckManager.getAll().find(d => d.id === deckId);
                const cards = Object.values(CardManager.getAll()).filter(c => c.deckId === deckId);
                
                const data = { deck, cards };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `${deck.name}.json`;
                a.click();
                
                Toast.success('Deck صادر شد');
            },

            // Card Management
            addNewCard() {
                document.getElementById('addCardModal').classList.add('active');
            },

            addImageCard() {
                ImageCard.open(this.currentDeck);
            },

            editCard(cardId) {
                const card = CardManager.getAll()[cardId];
                if (!card) return;

                // Open edit modal
                document.getElementById('editCardWord').value = card.word;
                document.getElementById('editCardMeaning').value = card.meaning;
                document.getElementById('editCardExample').value = card.example || '';
                document.getElementById('editCardId').value = cardId;
                document.getElementById('editCardModal').classList.add('active');
            },

            deleteCard(cardId) {
                if (confirm('آیا از حذف این کارت مطمئن هستید؟')) {
                    CardManager.delete(cardId);
                    Toast.success('کارت حذف شد');
                    this.renderCards();
                }
            },

            filterCards(filter, btn) {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                const items = document.querySelectorAll('.card-item');
                items.forEach(item => {
                    const status = item.dataset.status;
                    if (filter === 'all') {
                        item.style.display = 'flex';
                    } else if (filter === status) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
            },

            startReview(deckId) {
                const cards = Object.values(CardManager.getAll()).filter(c => c.deckId === deckId);
                const dueCards = cards.filter(c => !c.nextReview || new Date(c.nextReview) <= new Date());

                if (dueCards.length === 0) {
                    Toast.info('هیچ کارتی برای مرور نیست');
                    return;
                }

                Review.start(dueCards);
            }
        };

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- STATISTICS SCREEN -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    <div id="statsScreen" class="screen">
        <div class="screen-header">
            <button class="back-btn" onclick="App.showScreen('home')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M15 18l-6-6 6-6"/>
                </svg>
            </button>
            <h1>📊 آمار و تحلیل</h1>
        </div>

        <div class="stats-content">
            <!-- Overview Stats -->
            <div class="stats-overview">
                <div class="stat-card">
                    <div class="stat-icon">📚</div>
                    <div class="stat-value" id="statTotalCards">0</div>
                    <div class="stat-label">کل کارت‌ها</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">✅</div>
                    <div class="stat-value" id="statReviewedCards">0</div>
                    <div class="stat-label">مرور شده</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">🎯</div>
                    <div class="stat-value" id="statMasteredCards">0</div>
                    <div class="stat-label">تسلط یافته</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">🔥</div>
                    <div class="stat-value" id="statStreak">0</div>
                    <div class="stat-label">روز متوالی</div>
                </div>
            </div>

            <!-- Today's Stats -->
            <div class="stats-section">
                <h3 class="stats-section-title">📅 آمار امروز</h3>
                <div class="today-stats-grid">
                    <div class="today-stat-item">
                        <div class="today-stat-label">مرور شده</div>
                        <div class="today-stat-value" id="statTodayReviews">0</div>
                    </div>
                    <div class="today-stat-item">
                        <div class="today-stat-label">زمان مطالعه</div>
                        <div class="today-stat-value" id="statTodayTime">0 دقیقه</div>
                    </div>
                    <div class="today-stat-item">
                        <div class="today-stat-label">دقت پاسخ</div>
                        <div class="today-stat-value" id="statTodayAccuracy">0%</div>
                    </div>
                    <div class="today-stat-item">
                        <div class="today-stat-label">کارت جدید</div>
                        <div class="today-stat-value" id="statTodayNew">0</div>
                    </div>
                </div>
            </div>

            <!-- Progress Chart -->
            <div class="stats-section">
                <h3 class="stats-section-title">📈 نمودار پیشرفت</h3>
                <div class="chart-container">
                    <canvas id="progressChart"></canvas>
                </div>
            </div>

            <!-- Rating Distribution -->
            <div class="stats-section">
                <h3 class="stats-section-title">📊 توزیع پاسخ‌ها</h3>
                <div class="chart-container" style="max-width: 300px; margin: 0 auto;">
                    <canvas id="ratingChart"></canvas>
                </div>
            </div>

            <!-- Interval Stats -->
            <div class="stats-section">
                <h3 class="stats-section-title">⏰ بازه‌های مرور</h3>
                <div class="interval-stats">
                    <div class="interval-item">
                        <span class="interval-label">کمتر از 1 روز</span>
                        <div class="interval-bar">
                            <div class="interval-bar-fill" id="interval1" style="width: 0%"></div>
                        </div>
                        <span class="interval-count" id="intervalCount1">0</span>
                    </div>
                    <div class="interval-item">
                        <span class="interval-label">1 تا 7 روز</span>
                        <div class="interval-bar">
                            <div class="interval-bar-fill" id="interval2" style="width: 0%"></div>
                        </div>
                        <span class="interval-count" id="intervalCount2">0</span>
                    </div>
                    <div class="interval-item">
                        <span class="interval-label">7 تا 30 روز</span>
                        <div class="interval-bar">
                            <div class="interval-bar-fill" id="interval3" style="width: 0%"></div>
                        </div>
                        <span class="interval-count" id="intervalCount3">0</span>
                    </div>
                    <div class="interval-item">
                        <span class="interval-label">بیش از 30 روز</span>
                        <div class="interval-bar">
                            <div class="interval-bar-fill" id="interval4" style="width: 0%"></div>
                        </div>
                        <span class="interval-count" id="intervalCount4">0</span>
                    </div>
                </div>
            </div>

            <!-- Deck Stats -->
            <div class="stats-section">
                <h3 class="stats-section-title">📁 آمار دسته‌ها</h3>
                <div class="deck-stats-container" id="deckStatsContainer">
                    <!-- Will be populated by JS -->
                </div>
            </div>

            <!-- Insights -->
            <div class="stats-section">
                <h3 class="stats-section-title">💡 پیشنهادات هوشمند</h3>
                <div class="insights-container" id="insightsContainer">
                    <!-- Will be populated by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- FLASHCARD MODAL -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    <div id="flashcardModal" class="modal-overlay">
        <!-- Progress Bar -->
        <div class="flashcard-progress-bar">
            <div class="flashcard-progress-fill" id="flashcardProgress" style="width: 0%"></div>
        </div>

        <!-- Header -->
        <div class="flashcard-header">
            <button class="close-flashcard" onclick="Review.close()">✕</button>
            <div class="flashcard-counter" id="flashcardCounter">0 / 0</div>
        </div>

        <!-- Mode Toggle -->
        <div class="mode-toggle">
            <button class="mode-btn active" data-mode="recognition" onclick="Review.setMode('recognition')">
                👁️ شناسایی
            </button>
            <button class="mode-btn" data-mode="recall" onclick="Review.setMode('recall')">
                ⌨️ تایپ پاسخ
            </button>
        </div>

        <!-- Recognition Mode -->
        <div id="recognitionMode" class="card-mode active">
            <div class="flashcard-container">
                <div class="flashcard" id="flashcard" onclick="Review.flip()">
                    <div class="flashcard-inner">
                        <div class="flashcard-front">
                            <button class="speak-btn" onclick="event.stopPropagation(); Review.speak()">🔊</button>
                            <div class="card-word" id="cardWord">Word</div>
                            <div class="card-pronunciation" id="cardPronunciation">/pronunciation/</div>
                            <div class="flip-hint">👆 برای دیدن معنی کلیک کنید</div>
                        </div>
                        <div class="flashcard-back">
                            <button class="speak-btn" onclick="event.stopPropagation(); Review.speak()">🔊</button>
                            <div class="card-word" id="cardWordBack">Word</div>
                            <div class="card-meaning" id="cardMeaning">معنی</div>
                            <div class="card-example" id="cardExample">مثال کاربردی</div>
                            <div class="card-mnemonic" id="cardMnemonic">💡 نکته حافظه</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recall Mode -->
        <div id="recallMode" class="card-mode">
            <div class="recall-container">
                <button class="speak-btn" onclick="Review.speak()" style="position: absolute; top: 16px; right: 16px;">🔊</button>
                
                <div class="recall-question">
                    <div class="recall-word" id="recallWord">Word</div>
                    <div class="recall-pronunciation" id="recallPronunciation">/pronunciation/</div>
                    <div class="recall-example" id="recallExample">مثال کاربردی</div>
                </div>

                <div class="recall-input-area" id="recallInputArea">
                    <label class="recall-label">معنی فارسی را تایپ کنید:</label>
                    <input type="text" class="recall-input" id="recallInput" placeholder="معنی..." autocomplete="off">
                    <button class="check-answer-btn" id="checkAnswerBtn" onclick="Review.checkAnswer()">بررسی پاسخ</button>
                </div>

                <div class="recall-feedback hidden" id="recallFeedback">
                    <div class="feedback-icon" id="feedbackIcon">✅</div>
                    <div class="feedback-text" id="feedbackText">آفرین! درست بود</div>
                    <div class="correct-answer">
                        پاسخ صحیح: <strong id="correctAnswer">معنی</strong>
                    </div>
                    <div class="recall-mnemonic" id="recallMnemonic">💡 نکته حافظه</div>
                </div>
            </div>
        </div>

        <!-- Rating Buttons -->
        <div class="rating-container" id="ratingContainer">
            <div class="rating-hint">این کلمه را چقدر به خاطر آوردید؟</div>
            <div class="rating-buttons">
                <button class="rating-btn rating-again" onclick="Review.rate(1)">
                    <span class="rating-label">دوباره</span>
                    <span class="rating-interval" id="ratingInterval1">1 دقیقه</span>
                </button>
                <button class="rating-btn rating-hard" onclick="Review.rate(2)">
                    <span class="rating-label">سخت</span>
                    <span class="rating-interval" id="ratingInterval2">6 دقیقه</span>
                </button>
                <button class="rating-btn rating-good" onclick="Review.rate(3)">
                    <span class="rating-label">خوب</span>
                    <span class="rating-interval" id="ratingInterval3">10 دقیقه</span>
                </button>
                <button class="rating-btn rating-easy" onclick="Review.rate(4)">
                    <span class="rating-label">آسان</span>
                    <span class="rating-interval" id="ratingInterval4">4 روز</span>
                </button>
            </div>
        </div>

        <!-- Complete Screen -->
        <div class="complete-screen" id="completeScreen">
            <div class="complete-icon">🎉</div>
            <div class="complete-title">آفرین! همه کارت‌ها را مرور کردید</div>
            <div class="complete-stats">
                <div class="complete-stat">
                    <span class="complete-stat-value" id="completeReviewed">0</span>
                    <span class="complete-stat-label">مرور شده</span>
                </div>
                <div class="complete-stat">
                    <span class="complete-stat-value" id="completeAccuracy">0%</span>
                    <span class="complete-stat-label">دقت</span>
                </div>
            </div>
            <button class="finish-btn" onclick="Review.close()">بازگشت به خانه</button>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- SETTINGS MODAL -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    <div id="settingsModal" class="settings-modal">
        <div class="modal-container">
            <div class="modal-header">
                <h2>⚙️ تنظیمات</h2>
                <button class="modal-close" onclick="Settings.close()">✕</button>
            </div>

            <div class="modal-body">
                <!-- Daily Goal -->
                <div class="settings-section">
                    <div class="settings-section-header">
                        <h3>🎯 هدف روزانه</h3>
                        <p class="settings-section-desc">تعداد کارت‌هایی که می‌خواهید هر روز مرور کنید</p>
                    </div>
                    <div class="settings-item">
                        <div class="number-input-group">
                            <button class="number-btn" onclick="Settings.adjustGoal(-5)">−</button>
                            <input type="number" class="number-input" id="dailyGoalInput" value="20" min="5" max="100">
                            <button class="number-btn" onclick="Settings.adjustGoal(5)">+</button>
                        </div>
                    </div>
                    <div class="daily-goal-preview">
                        <div class="goal-preview-item">
                            <span class="goal-preview-label">هدف روزانه</span>
                            <span class="goal-preview-value" id="goalPreviewTarget">20 کارت</span>
                        </div>
                        <div class="goal-preview-item">
                            <span class="goal-preview-label">پیشرفت امروز</span>
                            <span class="goal-preview-value" id="goalPreviewProgress">0 کارت</span>
                        </div>
                    </div>
                </div>

                <!-- Reminder -->
                <div class="settings-section">
                    <div class="settings-section-header">
                        <h3>🔔 یادآور هوشمند</h3>
                        <p class="settings-section-desc">اعلان روزانه برای یادآوری مرور</p>
                    </div>
                    <div class="settings-item">
                        <div class="switch-container" onclick="Settings.toggleReminder()">
                            <div class="switch" id="reminderSwitch">
                                <div class="switch-handle"></div>
                            </div>
                            <span class="switch-text">فعال‌سازی یادآور</span>
                        </div>
                    </div>
                    <div class="settings-item hidden" id="reminderTimeSection">
                        <label>زمان یادآوری:</label>
                        <input type="time" class="number-input" id="reminderTimeInput" value="20:00" style="text-align: center;">
                    </div>
                </div>

                <!-- Streak -->
                <div class="settings-section">
                    <div class="settings-section-header">
                        <h3>🔥 رکورد تداوم</h3>
                        <p class="settings-section-desc">روزهای متوالی که هدف روزانه را کامل کرده‌اید</p>
                    </div>
                    <div class="streak-display">
                        <div class="streak-number" id="streakNumber">0</div>
                        <div class="streak-label">روز متوالی</div>
                    </div>
                    <div class="streak-calendar" id="streakCalendar">
                        <!-- Calendar days will be generated by JS -->
                    </div>
                </div>

                <!-- Theme -->
                <div class="settings-section">
                    <div class="settings-section-header">
                        <h3>🎨 ظاهر برنامه</h3>
                        <p class="settings-section-desc">انتخاب تم روشن یا تاریک</p>
                    </div>
                    <div class="theme-buttons">
                        <button class="theme-btn active" data-theme="light" onclick="Settings.setTheme('light')">
                            ☀️ روشن
                        </button>
                        <button class="theme-btn" data-theme="dark" onclick="Settings.setTheme('dark')">
                            🌙 تاریک
                        </button>
                    </div>
                </div>

                <!-- Backup -->
                <div class="settings-section">
                    <div class="settings-section-header">
                        <h3>💾 پشتیبان‌گیری</h3>
                        <p class="settings-section-desc">ذخیره و بازیابی داده‌های شما</p>
                    </div>
                    <button class="btn-block btn-primary" onclick="Backup.export()">
                        📥 دانلود پشتیبان
                    </button>
                    <p class="settings-hint">فایل JSON شامل تمام داده‌های شما</p>
                    
                    <input type="file" id="importInput" accept=".json" style="display: none;" onchange="Backup.import(event)">
                    <button class="btn-block btn-secondary" onclick="document.getElementById('importInput').click()">
                        📤 بازیابی از فایل
                    </button>

                    <div class="storage-usage">
                        <div class="storage-header">
                            <span class="storage-label">فضای استفاده شده</span>
                            <span class="storage-value" id="storageValue">0 KB</span>
                        </div>
                        <div class="storage-bar">
                            <div class="storage-bar-fill" id="storageFill" style="width: 0%"></div>
                        </div>
                        <div class="storage-details" id="storageDetails">0 کارت · 0 مرور</div>
                    </div>

                    <div class="danger-zone">
                        <div class="danger-zone-header">
                            <h4>⚠️ منطقه خطرناک</h4>
                            <p>این عملیات قابل بازگشت نیست!</p>
                        </div>
                        <button class="btn-block btn-danger" onclick="Backup.confirmReset()">
                            🗑️ حذف تمام داده‌ها
                        </button>
                    </div>
                </div>

                <!-- About -->
                <div class="settings-section">
                    <div class="settings-section-header">
                        <h3>ℹ️ درباره برنامه</h3>
                    </div>
                    <div style="text-align: center; color: var(--text-secondary); font-size: 14px; line-height: 2;">
                        <div style="font-size: 18px; font-weight: 700; color: var(--primary); margin-bottom: 8px;">LEXORA v1.0</div>
                        <div>یادگیری هوشمند زبان انگلیسی</div>
                        <div>الگوریتم FSRS-4.5</div>
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
                            طراحی و توسعه: <strong style="color: var(--text-primary);">محمد عباسی</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- CONFIRM MODAL -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    <div id="confirmModal" class="confirm-overlay">
        <div class="confirm-modal">
            <div class="confirm-header" id="confirmHeader">آیا مطمئن هستید؟</div>
            <div class="confirm-body" id="confirmBody">این عملیات قابل بازگشت نیست.</div>
            <div class="confirm-actions">
                <button class="confirm-cancel" onclick="Confirm.cancel()">انصراف</button>
                <button class="confirm-delete" id="confirmAction" onclick="Confirm.execute()">حذف</button>
            </div>
        </div>
    </div>
<!-- ═══════════════════════════════════════════════════════════════ -->
            <!-- LIBRARY SCREEN -->
            <!-- ═══════════════════════════════════════════════════════════════ -->
            <div id="library" class="screen">
                <div id="libraryContent">
                    <!-- Content will be rendered by JavaScript -->
                </div>
            </div>
    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- BOTTOM NAVIGATION -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    <nav class="bottom-nav">
        <button class="nav-item active" data-screen="home" onclick="App.showScreen('home')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                <polyline points="9 22 9 12 15 12 15 22"/>
            </svg>
            <span>خانه</span>
        </button>
        <button class="nav-item" data-screen="library" onclick="App.showScreen('library')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
            </svg>
            <span>کتابخانه</span>
        </button>
        <button class="nav-item" data-screen="stats" onclick="App.showScreen('stats')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="20" x2="18" y2="10"/>
                <line x1="12" y1="20" x2="12" y2="4"/>
                <line x1="6" y1="20" x2="6" y2="14"/>
            </svg>
            <span>آمار</span>
        </button>
    </nav>

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- TOAST CONTAINER -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    <div id="toastContainer"></div>
	<!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- JAVASCRIPT -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    <script>
        'use strict';

        // ═══════════════════════════════════════════════════════════════
        // DECKS DATA (Built-in)
        // ═══════════════════════════════════════════════════════════════
        const DECKS_DATA = {
            'essential-100': {
                id: 'essential-100',
                name: '۱۰۰ کلمه ضروری',
                icon: '🔥',
                description: 'پرکاربردترین کلمات روزمره انگلیسی',
                category: 'beginner',
                cards: [
                    { word: 'hello', pronunciation: '/həˈloʊ/', meaning: 'سلام', example: 'Hello, how are you today?', mnemonic: 'هِلو صدای زنگ در است وقتی مهمان می‌آید و سلام می‌کند' },
                    { word: 'goodbye', pronunciation: '/ɡʊdˈbaɪ/', meaning: 'خداحافظ', example: 'Goodbye, see you tomorrow!', mnemonic: 'گود = خوب، بای = خدا، خدای خوب همراهت!' },
                    { word: 'please', pronunciation: '/pliːz/', meaning: 'لطفاً', example: 'Please help me with this.', mnemonic: 'پلیز مثل پلیس که مؤدب درخواست می‌کند' },
                    { word: 'thank', pronunciation: '/θæŋk/', meaning: 'تشکر کردن', example: 'Thank you for your help.', mnemonic: 'تِنک مثل تانک که قوی تشکر می‌کند' },
                    { word: 'sorry', pronunciation: '/ˈsɒri/', meaning: 'متأسفم', example: 'I am sorry for being late.', mnemonic: 'ساری شهری که آدم‌هایش معذرت‌خواه‌اند' },
                    { word: 'yes', pronunciation: '/jes/', meaning: 'بله', example: 'Yes, I understand.', mnemonic: 'یِس صدای خوشحالی وقتی موافقیم' },
                    { word: 'no', pronunciation: '/noʊ/', meaning: 'نه، خیر', example: 'No, I do not agree.', mnemonic: 'نُو مثل نُچ که رد می‌کنیم' },
                    { word: 'help', pronunciation: '/help/', meaning: 'کمک', example: 'Can you help me please?', mnemonic: 'هِلپ صدای فریاد کمک خواستن' },
                    { word: 'water', pronunciation: '/ˈwɔːtər/', meaning: 'آب', example: 'I need some water to drink.', mnemonic: 'واتر = وات + آر، وات برق با آب کار می‌کند' },
                    { word: 'food', pronunciation: '/fuːd/', meaning: 'غذا', example: 'This food is delicious.', mnemonic: 'فود صدای خوردن غذا: فوووود' },
                    { word: 'time', pronunciation: '/taɪm/', meaning: 'زمان، وقت', example: 'What time is it now?', mnemonic: 'تایم صدای تیک‌تاک ساعت' },
                    { word: 'day', pronunciation: '/deɪ/', meaning: 'روز', example: 'Have a nice day!', mnemonic: 'دِی = روز، دی‌روز = روز قبل' },
                    { word: 'night', pronunciation: '/naɪt/', meaning: 'شب', example: 'Good night, sleep well.', mnemonic: 'نایت شبیه نیت است، شب وقت نیت کردن' },
                    { word: 'morning', pronunciation: '/ˈmɔːrnɪŋ/', meaning: 'صبح', example: 'Good morning everyone!', mnemonic: 'مورنینگ = صبح که مور(چه) بیدار می‌شود' },
                    { word: 'friend', pronunciation: '/frend/', meaning: 'دوست', example: 'She is my best friend.', mnemonic: 'فرِند = فرد + اند، فردی که در کنارت ایستاده' },
                    { word: 'family', pronunciation: '/ˈfæməli/', meaning: 'خانواده', example: 'I love my family.', mnemonic: 'فَمیلی = فامیل‌های ما خانواده‌اند' },
                    { word: 'home', pronunciation: '/hoʊm/', meaning: 'خانه', example: 'I am going home now.', mnemonic: 'هوم صدای آسایش وقتی به خانه می‌رسی' },
                    { word: 'work', pronunciation: '/wɜːrk/', meaning: 'کار، کار کردن', example: 'I have a lot of work today.', mnemonic: 'وِرک = ورزش کار، کار مثل ورزش انرژی می‌خواهد' },
                    { word: 'school', pronunciation: '/skuːl/', meaning: 'مدرسه', example: 'Children go to school every day.', mnemonic: 'اِسکول = اِس + کول، کلاس کول و باحال' },
                    { word: 'book', pronunciation: '/bʊk/', meaning: 'کتاب', example: 'I am reading a good book.', mnemonic: 'بوک صدای ورق زدن کتاب' },
                    { word: 'read', pronunciation: '/riːd/', meaning: 'خواندن', example: 'I like to read novels.', mnemonic: 'رید = رد کردن صفحات با چشم' },
                    { word: 'write', pronunciation: '/raɪt/', meaning: 'نوشتن', example: 'Please write your name here.', mnemonic: 'رایت = درست، درست نوشتن مهم است' },
                    { word: 'speak', pronunciation: '/spiːk/', meaning: 'صحبت کردن', example: 'Can you speak English?', mnemonic: 'اِسپیک = پیک زبان، پیک حرف می‌زند' },
                    { word: 'listen', pronunciation: '/ˈlɪsn/', meaning: 'گوش دادن', example: 'Please listen carefully.', mnemonic: 'لیسن = لیست + ن، لیست کردن حرف‌ها با گوش' },
                    { word: 'see', pronunciation: '/siː/', meaning: 'دیدن', example: 'I can see the mountains.', mnemonic: 'سی مثل C که شکل چشم نیمه‌باز است' },
                    { word: 'look', pronunciation: '/lʊk/', meaning: 'نگاه کردن', example: 'Look at this beautiful picture.', mnemonic: 'لوک = لوکیشن، به لوکیشن نگاه کن' },
                    { word: 'eat', pronunciation: '/iːt/', meaning: 'خوردن', example: 'Let us eat dinner together.', mnemonic: 'ایت صدای جویدن غذا' },
                    { word: 'drink', pronunciation: '/drɪŋk/', meaning: 'نوشیدن', example: 'I want to drink some tea.', mnemonic: 'درینک = در + اینک، در را باز کن و بنوش' },
                    { word: 'sleep', pronunciation: '/sliːp/', meaning: 'خوابیدن', example: 'I need to sleep early tonight.', mnemonic: 'اِسلیپ = سُر خوردن به خواب' },
                    { word: 'wake', pronunciation: '/weɪk/', meaning: 'بیدار شدن', example: 'I wake up at 7 AM.', mnemonic: 'ویک = ویکی‌پدیا که بیدارت می‌کند برای یادگیری' },
                    { word: 'walk', pronunciation: '/wɔːk/', meaning: 'راه رفتن، پیاده‌روی', example: 'I walk to work every day.', mnemonic: 'واک = واکس زدن کفش برای راه رفتن' },
                    { word: 'run', pronunciation: '/rʌn/', meaning: 'دویدن', example: 'He can run very fast.', mnemonic: 'ران = ران پا که برای دویدن است' },
                    { word: 'come', pronunciation: '/kʌm/', meaning: 'آمدن', example: 'Please come to my house.', mnemonic: 'کام = کام دهان که برای صدا زدن بیا باز می‌شود' },
                    { word: 'go', pronunciation: '/ɡoʊ/', meaning: 'رفتن', example: 'I have to go now.', mnemonic: 'گو = گوی که می‌غلتد و می‌رود' },
                    { word: 'stop', pronunciation: '/stɒp/', meaning: 'ایستادن، توقف', example: 'Please stop talking.', mnemonic: 'اِستاپ = ایست + آپ، ایست دادن بالا' },
                    { word: 'start', pronunciation: '/stɑːrt/', meaning: 'شروع کردن', example: 'Let us start the meeting.', mnemonic: 'اِستارت = استارت ماشین برای شروع' },
                    { word: 'open', pronunciation: '/ˈoʊpən/', meaning: 'باز کردن', example: 'Please open the window.', mnemonic: 'اوپن = اُپرا که درهایش باز است' },
                    { word: 'close', pronunciation: '/kloʊz/', meaning: 'بستن', example: 'Close the door please.', mnemonic: 'کلوز = کلوزآپ دوربین که بسته می‌شود' },
                    { word: 'big', pronunciation: '/bɪɡ/', meaning: 'بزرگ', example: 'This is a big house.', mnemonic: 'بیگ = بیگ‌بنگ، انفجار بزرگ' },
                    { word: 'small', pronunciation: '/smɔːl/', meaning: 'کوچک', example: 'I have a small car.', mnemonic: 'اِسمال = اِس + مال، مال کوچک من' },
                    { word: 'good', pronunciation: '/ɡʊd/', meaning: 'خوب', example: 'This is a good idea.', mnemonic: 'گود = گود برای خوب است' },
                    { word: 'bad', pronunciation: '/bæd/', meaning: 'بد', example: 'This is a bad habit.', mnemonic: 'بَد = بد فارسی، همان معنی' },
                    { word: 'new', pronunciation: '/njuː/', meaning: 'جدید، نو', example: 'I bought a new phone.', mnemonic: 'نیو = نو فارسی، تازه و جدید' },
                    { word: 'old', pronunciation: '/oʊld/', meaning: 'قدیمی، پیر', example: 'This is an old building.', mnemonic: 'اُلد = آلوده به زمان، کهنه' },
                    { word: 'young', pronunciation: '/jʌŋ/', meaning: 'جوان', example: 'She is a young teacher.', mnemonic: 'یانگ = جوان و پرانرژی' },
                    { word: 'happy', pronunciation: '/ˈhæpi/', meaning: 'خوشحال', example: 'I am very happy today.', mnemonic: 'هَپی = هپ‌هپ خوشحالی' },
                    { word: 'sad', pronunciation: '/sæd/', meaning: 'غمگین', example: 'Why are you so sad?', mnemonic: 'سَد = سد اشک که می‌شکند' },
                    { word: 'love', pronunciation: '/lʌv/', meaning: 'عشق، دوست داشتن', example: 'I love my parents.', mnemonic: 'لاو = لاو‌استوری، داستان عشق' },
                    { word: 'hate', pronunciation: '/heɪt/', meaning: 'متنفر بودن', example: 'I hate being late.', mnemonic: 'هِیت = حیات بدون عشق، نفرت' },
                    { word: 'want', pronunciation: '/wɒnt/', meaning: 'خواستن', example: 'I want to learn English.', mnemonic: 'وانت = وانت که چیزی می‌خواهد حمل کند' }
                ]
            },
            'ielts-academic': {
                id: 'ielts-academic',
                name: 'IELTS آکادمیک',
                icon: '🎓',
                description: 'لغات ضروری آزمون آیلتس آکادمیک',
                category: 'advanced',
                cards: [
                    { word: 'analyze', pronunciation: '/ˈænəlaɪz/', meaning: 'تحلیل کردن', example: 'We need to analyze the data carefully.', mnemonic: 'آنالیز = آنا + لیز، آنا داده‌ها را لیز می‌خورد و تحلیل می‌کند' },
                    { word: 'approach', pronunciation: '/əˈproʊtʃ/', meaning: 'رویکرد، نزدیک شدن', example: 'We need a new approach to solve this problem.', mnemonic: 'اَپروچ = اَپ + روچ، اپلیکیشن روی چیزی نزدیک می‌شود' },
                    { word: 'assess', pronunciation: '/əˈses/', meaning: 'ارزیابی کردن', example: 'The teacher will assess your performance.', mnemonic: 'اَسِس = اساس را ارزیابی کن' },
                    { word: 'benefit', pronunciation: '/ˈbenɪfɪt/', meaning: 'سود، فایده', example: 'Exercise has many health benefits.', mnemonic: 'بِنِفیت = بن + فیت، بن تخفیف فیت و سالم شدن' },
                    { word: 'concept', pronunciation: '/ˈkɒnsept/', meaning: 'مفهوم', example: 'This is a difficult concept to understand.', mnemonic: 'کانسپت = کان + سپت، در کان معدن مفهوم را سپت کن' },
                    { word: 'consist', pronunciation: '/kənˈsɪst/', meaning: 'تشکیل شدن از', example: 'The team consists of five members.', mnemonic: 'کانسیست = سیستم که از اجزا تشکیل شده' },
                    { word: 'constitute', pronunciation: '/ˈkɒnstɪtjuːt/', meaning: 'تشکیل دادن', example: 'Women constitute 60% of the workforce.', mnemonic: 'کانستیتیوت = قانون اساسی که کشور را تشکیل می‌دهد' },
                    { word: 'context', pronunciation: '/ˈkɒntekst/', meaning: 'زمینه، بافت', example: 'You need to understand the context.', mnemonic: 'کانتکست = کان + تکست، متن در کان معدن' },
                    { word: 'contract', pronunciation: '/ˈkɒntrækt/', meaning: 'قرارداد', example: 'Please sign the contract.', mnemonic: 'کانترَکت = کنتراکتور که قرارداد می‌بندد' },
                    { word: 'contribute', pronunciation: '/kənˈtrɪbjuːt/', meaning: 'مشارکت کردن', example: 'Everyone should contribute to the project.', mnemonic: 'کانتریبیوت = کنتری + بیوت، به کشور زیبایی هدیه بده' },
                    { word: 'create', pronunciation: '/kriˈeɪt/', meaning: 'ایجاد کردن، خلق کردن', example: 'Artists create beautiful works.', mnemonic: 'کریِیت = کِری + ایت، کِری خوانده و چیز جدید ساخت' },
                    { word: 'data', pronunciation: '/ˈdeɪtə/', meaning: 'داده‌ها', example: 'We collected data from 100 participants.', mnemonic: 'دِیتا = داده‌ها به انگلیسی' },
                    { word: 'define', pronunciation: '/dɪˈfaɪn/', meaning: 'تعریف کردن', example: 'Please define this term.', mnemonic: 'دیفاین = دی + فاین، روز خوب را تعریف کن' },
                    { word: 'derive', pronunciation: '/dɪˈraɪv/', meaning: 'مشتق شدن، به دست آوردن', example: 'This word derives from Latin.', mnemonic: 'دِرایو = درایو ماشین که از موتور نیرو می‌گیرد' },
                    { word: 'distribute', pronunciation: '/dɪˈstrɪbjuːt/', meaning: 'توزیع کردن', example: 'The company distributes products worldwide.', mnemonic: 'دیستریبیوت = دیس + تری + بیوت، سه دیس را توزیع کن' },
                    { word: 'economy', pronunciation: '/ɪˈkɒnəmi/', meaning: 'اقتصاد', example: 'The economy is growing rapidly.', mnemonic: 'اِکانومی = اکو + نومی، صدای اکو در نام اقتصاد' },
                    { word: 'environment', pronunciation: '/ɪnˈvaɪrənmənt/', meaning: 'محیط زیست', example: 'We must protect the environment.', mnemonic: 'اِنوایرومِنت = این وایر من است، سیم محیط من' },
                    { word: 'establish', pronunciation: '/ɪˈstæblɪʃ/', meaning: 'تأسیس کردن', example: 'The company was established in 1990.', mnemonic: 'اِستَبلیش = استیبل + ایش، اصطبل را تأسیس کن' },
                    { word: 'estimate', pronunciation: '/ˈestɪmeɪt/', meaning: 'تخمین زدن', example: 'Can you estimate the cost?', mnemonic: 'اِستیمِیت = اِستیم + ایت، استیم و بخار را تخمین بزن' },
                    { word: 'evident', pronunciation: '/ˈevɪdənt/', meaning: 'آشکار، واضح', example: 'It is evident that he is lying.', mnemonic: 'اِویدِنت = اویدنس، شاهد و مدرک آشکار' },
                    { word: 'export', pronunciation: '/ˈekspɔːrt/', meaning: 'صادرات', example: 'Iran exports oil to many countries.', mnemonic: 'اِکسپورت = اِکس + پورت، از پورت خارج کردن' },
                    { word: 'factor', pronunciation: '/ˈfæktər/', meaning: 'عامل', example: 'Price is an important factor.', mnemonic: 'فَکتور = فاکتور که عوامل را لیست می‌کند' },
                    { word: 'finance', pronunciation: '/ˈfaɪnæns/', meaning: 'مالی، تأمین مالی', example: 'The project needs more finance.', mnemonic: 'فایننس = فاین + انس، انس طلا و مالی' },
                    { word: 'formula', pronunciation: '/ˈfɔːrmjələ/', meaning: 'فرمول', example: 'Use this formula to solve the problem.', mnemonic: 'فرمولا = فرمول ریاضی' },
                    { word: 'function', pronunciation: '/ˈfʌŋkʃn/', meaning: 'عملکرد، کارکرد', example: 'What is the function of this button?', mnemonic: 'فانکشن = فانک + شن، موسیقی فانک در شن' },
                    { word: 'identify', pronunciation: '/aɪˈdentɪfaɪ/', meaning: 'شناسایی کردن', example: 'Can you identify the problem?', mnemonic: 'آیدِنتیفای = آیدی + فای، شناسه وای‌فای' },
                    { word: 'income', pronunciation: '/ˈɪnkʌm/', meaning: 'درآمد', example: 'His monthly income is high.', mnemonic: 'اینکام = این + کام، این کام و درآمد من است' },
                    { word: 'indicate', pronunciation: '/ˈɪndɪkeɪt/', meaning: 'نشان دادن', example: 'The results indicate a problem.', mnemonic: 'ایندیکِیت = ایندیکاتور که نشان می‌دهد' },
                    { word: 'individual', pronunciation: '/ˌɪndɪˈvɪdʒuəl/', meaning: 'فردی، شخصی', example: 'Each individual has rights.', mnemonic: 'ایندیویجوآل = یک فرد ویژه و جدا' },
                    { word: 'interpret', pronunciation: '/ɪnˈtɜːrprɪt/', meaning: 'تفسیر کردن', example: 'How do you interpret this data?', mnemonic: 'اینترپرِت = اینتر + پرت، اینترنت را تفسیر کن' }
                ]
            },
            'toefl-essential': {
                id: 'toefl-essential',
                name: 'TOEFL ضروری',
                icon: '📝',
                description: 'واژگان پرتکرار آزمون تافل',
                category: 'advanced',
                cards: [
                    { word: 'abandon', pronunciation: '/əˈbændən/', meaning: 'رها کردن، ترک کردن', example: 'They had to abandon the ship.', mnemonic: 'اَبَندان = آب + اندان، آب را در اندان رها کردند' },
                    { word: 'abstract', pronunciation: '/ˈæbstrækt/', meaning: 'انتزاعی، چکیده', example: 'This is an abstract concept.', mnemonic: 'اَبسترَکت = اَبس + ترکت، عضلات شکم انتزاعی' },
                    { word: 'abundant', pronunciation: '/əˈbʌndənt/', meaning: 'فراوان', example: 'Water is abundant in this region.', mnemonic: 'اَباندِنت = آباندان، آب فراوان در آبادان' },
                    { word: 'accumulate', pronunciation: '/əˈkjuːmjəleɪt/', meaning: 'جمع‌آوری کردن، انباشتن', example: 'Dust accumulates quickly.', mnemonic: 'اَکیومولِیت = آکو + مولت، آکواریوم مولت جمع می‌کند' },
                    { word: 'accurate', pronunciation: '/ˈækjərət/', meaning: 'دقیق', example: 'The information is accurate.', mnemonic: 'اَکیورِت = آکورد + ت، آکورد گیتار دقیق' },
                    { word: 'achieve', pronunciation: '/əˈtʃiːv/', meaning: 'دستیابی، موفق شدن', example: 'She achieved her goals.', mnemonic: 'اَچیو = اچ + یو، اچ‌دی یوتیوب به موفقیت رسید' },
                    { word: 'acquire', pronunciation: '/əˈkwaɪər/', meaning: 'به دست آوردن', example: 'She acquired new skills.', mnemonic: 'اَکوایر = آکوا + ایر، آب و هوا را به دست آور' },
                    { word: 'adapt', pronunciation: '/əˈdæpt/', meaning: 'سازگار شدن', example: 'Animals adapt to their environment.', mnemonic: 'اَدَپت = آداپتور که سازگار می‌کند' },
                    { word: 'adequate', pronunciation: '/ˈædɪkwət/', meaning: 'کافی، مناسب', example: 'The salary is adequate.', mnemonic: 'اَدِکوِت = آدکلن کافی و مناسب' },
                    { word: 'adjacent', pronunciation: '/əˈdʒeɪsnt/', meaning: 'مجاور، همجوار', example: 'The hotel is adjacent to the beach.', mnemonic: 'اَجِیسِنت = آجر + سنت، آجرهای مجاور سنتی' },
                    { word: 'adjust', pronunciation: '/əˈdʒʌst/', meaning: 'تنظیم کردن', example: 'Please adjust the volume.', mnemonic: 'اَجاست = آجاست که تنظیم می‌کند' },
                    { word: 'administer', pronunciation: '/ədˈmɪnɪstər/', meaning: 'اداره کردن', example: 'She administers the department.', mnemonic: 'اَدمینیستر = ادمین + ایستر، ادمین سیستم اداره می‌کند' },
                    { word: 'advocate', pronunciation: '/ˈædvəkeɪt/', meaning: 'حمایت کردن، طرفداری', example: 'He advocates for human rights.', mnemonic: 'اَدووکِیت = اَد + وکیل، وکیل از موکل حمایت می‌کند' },
                    { word: 'affect', pronunciation: '/əˈfekt/', meaning: 'تأثیر گذاشتن', example: 'The weather affects my mood.', mnemonic: 'اَفِکت = افکت فیلم که تأثیرگذار است' },
                    { word: 'aggregate', pronunciation: '/ˈæɡrɪɡət/', meaning: 'مجموع، کل', example: 'The aggregate score was high.', mnemonic: 'اَگریگِیت = آگرگات که مجموعه‌ای از سنگ‌هاست' },
                    { word: 'allocate', pronunciation: '/ˈæləkeɪt/', meaning: 'تخصیص دادن', example: 'We need to allocate resources.', mnemonic: 'اَلوکِیت = آلو + کِیت، آلو را به کِیت تخصیص بده' },
                    { word: 'alter', pronunciation: '/ˈɔːltər/', meaning: 'تغییر دادن', example: 'Do not alter the document.', mnemonic: 'آلتر = آلترناتیو، گزینه جایگزین و تغییر' },
                    { word: 'ambiguous', pronunciation: '/æmˈbɪɡjuəs/', meaning: 'مبهم', example: 'The statement is ambiguous.', mnemonic: 'اَمبیگیووس = ام + بیگ، من بزرگ و مبهم' },
                    { word: 'amend', pronunciation: '/əˈmend/', meaning: 'اصلاح کردن', example: 'The law was amended.', mnemonic: 'اَمِند = آمند که اصلاح شد' },
                    { word: 'anticipate', pronunciation: '/ænˈtɪsɪpeɪt/', meaning: 'پیش‌بینی کردن', example: 'We anticipate good results.', mnemonic: 'اَنتیسیپِیت = آنتی + سیپ، ضد سیب را پیش‌بینی کن' },
                    { word: 'apparent', pronunciation: '/əˈpærənt/', meaning: 'آشکار، ظاهری', example: 'The reason is apparent.', mnemonic: 'اَپَرِنت = اَپ + پرنت، اپلیکیشن پرنت آشکار است' },
                    { word: 'appreciate', pronunciation: '/əˈpriːʃieɪt/', meaning: 'قدردانی کردن', example: 'I appreciate your help.', mnemonic: 'اَپریشیِیت = اَپ + رشی + ایت، اپ رشید را قدر بدان' },
                    { word: 'arbitrary', pronunciation: '/ˈɑːrbɪtreri/', meaning: 'دلخواه، خودسرانه', example: 'The decision was arbitrary.', mnemonic: 'آربیترری = آربیتر، داور خودسرانه تصمیم گرفت' },
                    { word: 'aspect', pronunciation: '/ˈæspekt/', meaning: 'جنبه', example: 'Consider every aspect of the issue.', mnemonic: 'اَسپکت = اسپکتروم، طیف و جنبه‌های مختلف' },
                    { word: 'assign', pronunciation: '/əˈsaɪn/', meaning: 'تعیین کردن، واگذار کردن', example: 'The teacher assigned homework.', mnemonic: 'اَساین = آساین که تکلیف تعیین می‌کند' },
                    { word: 'assume', pronunciation: '/əˈsuːm/', meaning: 'فرض کردن', example: 'I assume you are coming.', mnemonic: 'اَسوم = آسوم که فرض می‌کنم' },
                    { word: 'attach', pronunciation: '/əˈtætʃ/', meaning: 'پیوست کردن', example: 'Please attach your resume.', mnemonic: 'اَتَچ = اتچ ایمیل که پیوست می‌کنی' },
                    { word: 'attain', pronunciation: '/əˈteɪn/', meaning: 'دست یافتن', example: 'He attained his goal.', mnemonic: 'اَتِین = آتن، به آتن دست یافتن' },
                    { word: 'authority', pronunciation: '/ɔːˈθɒrəti/', meaning: 'اختیار، مقام', example: 'She has the authority to decide.', mnemonic: 'آتوریتی = آتور + ایتی، آتور مقام و اختیار دارد' },
                    { word: 'available', pronunciation: '/əˈveɪləbl/', meaning: 'در دسترس', example: 'The room is available.', mnemonic: 'اَوِیلِبل = آویل + ابل، آویلا در دسترس است' }
                ]
            },
            'daily-conversation': {
                id: 'daily-conversation',
                name: 'مکالمه روزمره',
                icon: '💬',
                description: 'عبارات کاربردی برای مکالمات روزانه',
                category: 'beginner',
                cards: [
                    { word: 'How are you?', pronunciation: '/haʊ ɑːr juː/', meaning: 'حالت چطوره؟', example: 'Hi John, how are you today?', mnemonic: 'هاو آر یو = حالت چطوره، سوال روزمره' },
                    { word: 'I am fine', pronunciation: '/aɪ æm faɪn/', meaning: 'خوبم', example: 'I am fine, thank you for asking.', mnemonic: 'آی اَم فاین = من فاین و خوبم' },
                    { word: 'Nice to meet you', pronunciation: '/naɪs tuː miːt juː/', meaning: 'از آشناییت خوشوقتم', example: 'Nice to meet you, I am Sarah.', mnemonic: 'نایس تو میت یو = ملاقات نایس با تو' },
                    { word: 'What is your name?', pronunciation: '/wɒt ɪz jɔːr neɪm/', meaning: 'اسمت چیه؟', example: 'Hello, what is your name?', mnemonic: 'وات ایز یور نِیم = چه نامی داری' },
                    { word: 'My name is', pronunciation: '/maɪ neɪm ɪz/', meaning: 'اسم من ... است', example: 'My name is Ali.', mnemonic: 'مای نِیم ایز = نام من این است' },
                    { word: 'Where are you from?', pronunciation: '/weər ɑːr juː frɒm/', meaning: 'اهل کجایی؟', example: 'Where are you from originally?', mnemonic: 'وِر آر یو فرام = از کجا آمدی' },
                    { word: 'I am from', pronunciation: '/aɪ æm frɒm/', meaning: 'من اهل ... هستم', example: 'I am from Tehran.', mnemonic: 'آی اَم فرام = من از آنجا آمدم' },
                    { word: 'How old are you?', pronunciation: '/haʊ oʊld ɑːr juː/', meaning: 'چند سالته؟', example: 'Excuse me, how old are you?', mnemonic: 'هاو اُلد آر یو = چقدر اُلد و کهنه‌ای' },
                    { word: 'I am ... years old', pronunciation: '/aɪ æm ... jɪərz oʊld/', meaning: 'من ... ساله هستم', example: 'I am twenty-five years old.', mnemonic: 'آی اَم ... یِرز اُلد = من این‌قدر سال دارم' },
                    { word: 'What do you do?', pronunciation: '/wɒt duː juː duː/', meaning: 'شغلت چیه؟', example: 'So, what do you do for work?', mnemonic: 'وات دو یو دو = چه کاری انجام می‌دهی' },
                    { word: 'I work as', pronunciation: '/aɪ wɜːrk æz/', meaning: 'من به عنوان ... کار می‌کنم', example: 'I work as a teacher.', mnemonic: 'آی وِرک اَز = من کار می‌کنم به عنوان' },
                    { word: 'Do you speak English?', pronunciation: '/duː juː spiːk ˈɪŋɡlɪʃ/', meaning: 'انگلیسی صحبت می‌کنی؟', example: 'Excuse me, do you speak English?', mnemonic: 'دو یو اسپیک انگلیش = آیا انگلیش اسپیک می‌کنی' },
                    { word: 'I do not understand', pronunciation: '/aɪ doʊnt ˌʌndərˈstænd/', meaning: 'متوجه نمی‌شوم', example: 'Sorry, I do not understand.', mnemonic: 'آی دونت آندرستند = نمی‌فهمم چه می‌گویی' },
                    { word: 'Can you repeat?', pronunciation: '/kæn juː rɪˈpiːt/', meaning: 'می‌تونی تکرار کنی؟', example: 'Can you repeat that please?', mnemonic: 'کَن یو ریپیت = آیا می‌توانی ریپیت کنی' },
                    { word: 'Please speak slowly', pronunciation: '/pliːz spiːk ˈsloʊli/', meaning: 'لطفاً آهسته صحبت کن', example: 'Please speak slowly, I am learning.', mnemonic: 'پلیز اسپیک اِسلولی = آهسته حرف بزن' },
                    { word: 'What does this mean?', pronunciation: '/wɒt dʌz ðɪs miːn/', meaning: 'این یعنی چی؟', example: 'What does this word mean?', mnemonic: 'وات داز دیس مین = معنی این چیست' },
                    { word: 'How do you say?', pronunciation: '/haʊ duː juː seɪ/', meaning: 'چطور می‌گویی؟', example: 'How do you say "thank you" in Farsi?', mnemonic: 'هاو دو یو سِی = چگونه بگویم' },
                    { word: 'Excuse me', pronunciation: '/ɪkˈskjuːz miː/', meaning: 'ببخشید', example: 'Excuse me, where is the bathroom?', mnemonic: 'اِکسکیوز می = اجازه بده من رد شوم' },
                    { word: 'I am sorry', pronunciation: '/aɪ æm ˈsɒri/', meaning: 'متأسفم', example: 'I am sorry for the mistake.', mnemonic: 'آی اَم ساری = من ساری و غمگینم' },
                    { word: 'No problem', pronunciation: '/noʊ ˈprɒbləm/', meaning: 'مشکلی نیست', example: 'No problem, do not worry about it.', mnemonic: 'نو پرابلم = پرابلمی نیست' },
                    { word: 'You are welcome', pronunciation: '/jʊr ˈwelkəm/', meaning: 'خواهش می‌کنم', example: 'You are welcome, anytime!', mnemonic: 'یو آر وِلکام = تو خوش‌آمدی' },
                    { word: 'See you later', pronunciation: '/siː juː ˈleɪtər/', meaning: 'بعداً می‌بینمت', example: 'Okay, see you later!', mnemonic: 'سی یو لِیتر = بعداً چشمم به تو می‌افتد' },
                    { word: 'Take care', pronunciation: '/teɪk keər/', meaning: 'مراقب خودت باش', example: 'Goodbye, take care!', mnemonic: 'تِیک کِر = کِر و مراقبت را بردار' },
                    { word: 'Have a nice day', pronunciation: '/hæv ə naɪs deɪ/', meaning: 'روز خوبی داشته باشی', example: 'Thank you, have a nice day!', mnemonic: 'هَو اِ نایس دِی = روز نایسی داشته باش' },
                    { word: 'What time is it?', pronunciation: '/wɒt taɪm ɪz ɪt/', meaning: 'ساعت چنده؟', example: 'Excuse me, what time is it?', mnemonic: 'وات تایم ایز ایت = تایم و ساعت چند است' },
                    { word: 'How much is this?', pronunciation: '/haʊ mʌtʃ ɪz ðɪs/', meaning: 'این چنده؟', example: 'How much is this shirt?', mnemonic: 'هاو ماچ ایز دیس = این چقدر ارزش دارد' },
                    { word: 'Where is the bathroom?', pronunciation: '/weər ɪz ðə ˈbæθruːm/', meaning: 'دستشویی کجاست؟', example: 'Excuse me, where is the bathroom?', mnemonic: 'وِر ایز د بَثروم = حمام کجاست' },
                    { word: 'I need help', pronunciation: '/aɪ niːd help/', meaning: 'کمک می‌خوام', example: 'Please, I need help with this.', mnemonic: 'آی نید هِلپ = من نیاز به هلپ دارم' },
                    { word: 'Can I have?', pronunciation: '/kæn aɪ hæv/', meaning: 'می‌تونم داشته باشم؟', example: 'Can I have a glass of water?', mnemonic: 'کَن آی هَو = آیا می‌توانم داشته باشم' },
                    { word: 'I would like', pronunciation: '/aɪ wʊd laɪk/', meaning: 'می‌خواستم', example: 'I would like a cup of coffee.', mnemonic: 'آی وود لایک = دوست دارم داشته باشم' }
                ]
            },
            'business-english': {
                id: 'business-english',
                name: 'انگلیسی تجاری',
                icon: '💼',
                description: 'واژگان و عبارات محیط کار و تجارت',
                category: 'intermediate',
                cards: [
                    { word: 'meeting', pronunciation: '/ˈmiːtɪŋ/', meaning: 'جلسه', example: 'We have a meeting at 10 AM.', mnemonic: 'میتینگ = میت + اینگ، ملاقات در اینگ‌لیش' },
                    { word: 'deadline', pronunciation: '/ˈdedlaɪn/', meaning: 'مهلت، ددلاین', example: 'The deadline is next Friday.', mnemonic: 'دِدلاین = دِد + لاین، خط مرگ پروژه' },
                    { word: 'negotiate', pronunciation: '/nɪˈɡoʊʃieɪt/', meaning: 'مذاکره کردن', example: 'We need to negotiate the contract.', mnemonic: 'نِگوشیِیت = نگو + شیت، نگو و مذاکره کن' },
                    { word: 'proposal', pronunciation: '/prəˈpoʊzl/', meaning: 'پیشنهاد', example: 'Please review my proposal.', mnemonic: 'پروپوزال = پروپوز + آل، پیشنهاد به همه' },
                    { word: 'revenue', pronunciation: '/ˈrevənjuː/', meaning: 'درآمد', example: 'Our revenue increased this year.', mnemonic: 'رِوِنیو = ریو + نیو، رودخانه جدید درآمد' },
                    { word: 'budget', pronunciation: '/ˈbʌdʒɪt/', meaning: 'بودجه', example: 'We need to stay within budget.', mnemonic: 'باجت = باج + ت، باج و بودجه شرکت' },
                    { word: 'client', pronunciation: '/ˈklaɪənt/', meaning: 'مشتری', example: 'The client is very satisfied.', mnemonic: 'کلاینت = کلاین + ت، مشتری کلان' },
                    { word: 'colleague', pronunciation: '/ˈkɒliːɡ/', meaning: 'همکار', example: 'My colleague helped me with the project.', mnemonic: 'کالیگ = کالج + همکار، همکار در کالج' },
                    { word: 'contract', pronunciation: '/ˈkɒntrækt/', meaning: 'قرارداد', example: 'Please sign the contract.', mnemonic: 'کانترَکت = کان + ترکت، قرارداد کان معدن' },
                    { word: 'invoice', pronunciation: '/ˈɪnvɔɪs/', meaning: 'فاکتور', example: 'I will send you the invoice.', mnemonic: 'اینویس = این + ویس، این صدای فاکتور' },
                    { word: 'profit', pronunciation: '/ˈprɒfɪt/', meaning: 'سود', example: 'The company made a profit.', mnemonic: 'پرافیت = پر + افیت، پر از سود و فایده' },
                    { word: 'loss', pronunciation: '/lɒs/', meaning: 'ضرر، زیان', example: 'We had a loss this quarter.', mnemonic: 'لاس = لاس زدن با ضرر' },
                    { word: 'investment', pronunciation: '/ɪnˈvestmənt/', meaning: 'سرمایه‌گذاری', example: 'This is a good investment.', mnemonic: 'اینوِستمِنت = این + وست + مِنت، این غربی سرمایه‌گذاری است' },
                    { word: 'marketing', pronunciation: '/ˈmɑːrkɪtɪŋ/', meaning: 'بازاریابی', example: 'Our marketing team is excellent.', mnemonic: 'مارکتینگ = مارکت + اینگ، بازار در اینگ‌لیش' },
                    { word: 'strategy', pronunciation: '/ˈstrætədʒi/', meaning: 'استراتژی', example: 'We need a new strategy.', mnemonic: 'استرَتِجی = استراتژی فارسی' },
                    { word: 'performance', pronunciation: '/pərˈfɔːrməns/', meaning: 'عملکرد', example: 'Your performance was excellent.', mnemonic: 'پرفورمنس = پرفورم + انس، اجرای عالی' },
                    { word: 'feedback', pronunciation: '/ˈfiːdbæk/', meaning: 'بازخورد', example: 'I need your feedback on this.', mnemonic: 'فیدبَک = فید + بک، غذا را برگردان و نظر بده' },
                    { word: 'schedule', pronunciation: '/ˈskedʒuːl/', meaning: 'برنامه زمانی', example: 'Check your schedule for tomorrow.', mnemonic: 'اِسکجول = اسکیت + جول، برنامه اسکیت' },
                    { word: 'agenda', pronunciation: '/əˈdʒendə/', meaning: 'دستور کار', example: 'What is on the agenda today?', mnemonic: 'اَجندا = آژانس + دا، دستور کار آژانس' },
                    { word: 'opportunity', pronunciation: '/ˌɒpərˈtjuːnəti/', meaning: 'فرصت', example: 'This is a great opportunity.', mnemonic: 'آپورچونیتی = آپور + چونیتی، فرصت طلایی' },
                    { word: 'challenge', pronunciation: '/ˈtʃælɪndʒ/', meaning: 'چالش', example: 'This project is a challenge.', mnemonic: 'چَلنج = چالش فارسی' },
                    { word: 'solution', pronunciation: '/səˈluːʃn/', meaning: 'راه‌حل', example: 'We found a solution.', mnemonic: 'سولوشن = سول + یوشن، راه‌حل یوشن' },
                    { word: 'priority', pronunciation: '/praɪˈɒrəti/', meaning: 'اولویت', example: 'This is our top priority.', mnemonic: 'پرایوریتی = پرایور + ایتی، قبل از همه' },
                    { word: 'efficiency', pronunciation: '/ɪˈfɪʃnsi/', meaning: 'کارایی', example: 'We need to improve efficiency.', mnemonic: 'اِفیشنسی = افیش + نسی، ماهی کارآمد' },
                    { word: 'innovation', pronunciation: '/ˌɪnəˈveɪʃn/', meaning: 'نوآوری', example: 'Innovation is key to success.', mnemonic: 'اینوِیشن = این + وِی + شن، این راه جدید نوآوری' },
                    { word: 'collaborate', pronunciation: '/kəˈlæbəreɪt/', meaning: 'همکاری کردن', example: 'Let us collaborate on this project.', mnemonic: 'کالَبورِیت = کالا + بور + ایت، کالا را با هم ببر' },
                    { word: 'implement', pronunciation: '/ˈɪmplɪment/', meaning: 'اجرا کردن', example: 'We will implement the plan.', mnemonic: 'ایمپلِمِنت = ایمپلنت که کار گذاشته می‌شود' },
                    { word: 'delegate', pronunciation: '/ˈdelɪɡeɪt/', meaning: 'واگذار کردن', example: 'You should delegate some tasks.', mnemonic: 'دِلِگِیت = دل + گیت، دل را به گیت بسپار' },
                    { word: 'stakeholder', pronunciation: '/ˈsteɪkhoʊldər/', meaning: 'ذینفع', example: 'All stakeholders must agree.', mnemonic: 'اِستِیک‌هولدر = استیک + هولدر، نگهدارنده سهم' },
                    { word: 'benchmark', pronunciation: '/ˈbentʃmɑːrk/', meaning: 'معیار، شاخص', example: 'This is the industry benchmark.', mnemonic: 'بِنچمارک = بِنچ + مارک، نشان روی نیمکت' }
                ]
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // UTILITY FUNCTIONS
        // ═══════════════════════════════════════════════════════════════
        const Utils = {
            // Convert to Persian numbers
            toPersian(num) {
                const persianDigits = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
                return String(num).replace(/\d/g, d => persianDigits[d]);
            },

            // Generate unique ID
            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            },

            // Format interval for display
            formatInterval(minutes) {
                if (minutes < 60) return `${this.toPersian(Math.round(minutes))} دقیقه`;
                if (minutes < 1440) return `${this.toPersian(Math.round(minutes / 60))} ساعت`;
                return `${this.toPersian(Math.round(minutes / 1440))} روز`;
            },

            // Get today's date string
            getToday() {
                return new Date().toISOString().split('T')[0];
            },

            // Check similarity between two strings
            similarity(s1, s2) {
                s1 = s1.trim().toLowerCase();
                s2 = s2.trim().toLowerCase();
                if (s1 === s2) return 1;
                
                const longer = s1.length > s2.length ? s1 : s2;
                const shorter = s1.length > s2.length ? s2 : s1;
                
                if (longer.length === 0) return 1;
                
                const costs = [];
                for (let i = 0; i <= shorter.length; i++) {
                    let lastValue = i;
                    for (let j = 0; j <= longer.length; j++) {
                        if (i === 0) {
                            costs[j] = j;
                        } else if (j > 0) {
                            let newValue = costs[j - 1];
                            if (shorter[i - 1] !== longer[j - 1]) {
                                newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                            }
                            costs[j - 1] = lastValue;
                            lastValue = newValue;
                        }
                    }
                    if (i > 0) costs[longer.length] = lastValue;
                }
                
                return (longer.length - costs[longer.length]) / longer.length;
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // TOAST NOTIFICATIONS
        // ═══════════════════════════════════════════════════════════════
        const Toast = {
            show(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                document.body.appendChild(toast);

                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            },

            success(msg) { this.show(msg, 'success'); },
            error(msg) { this.show(msg, 'error'); },
            warning(msg) { this.show(msg, 'warning'); },
            info(msg) { this.show(msg, 'info'); }
        };

        // ═══════════════════════════════════════════════════════════════
        // CONFIRM MODAL
        // ═══════════════════════════════════════════════════════════════
        const Confirm = {
            callback: null,

            show(title, message, onConfirm) {
                document.getElementById('confirmHeader').textContent = title;
                document.getElementById('confirmBody').textContent = message;
                document.getElementById('confirmModal').classList.add('active');
                this.callback = onConfirm;
            },

            execute() {
                if (this.callback) this.callback();
                this.cancel();
            },

            cancel() {
                document.getElementById('confirmModal').classList.remove('active');
                this.callback = null;
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // DATABASE (LocalStorage Wrapper)
        // ═══════════════════════════════════════════════════════════════
        const DB = {
            get(key, defaultValue = null) {
                try {
                    const data = localStorage.getItem(`lexora_${key}`);
                    return data ? JSON.parse(data) : defaultValue;
                } catch (e) {
                    return defaultValue;
                }
            },

            set(key, value) {
                try {
                    localStorage.setItem(`lexora_${key}`, JSON.stringify(value));
                    return true;
                } catch (e) {
                    console.error('Storage error:', e);
                    return false;
                }
            },

            remove(key) {
                localStorage.removeItem(`lexora_${key}`);
            },

            clear() {
                const keys = Object.keys(localStorage).filter(k => k.startsWith('lexora_'));
                keys.forEach(k => localStorage.removeItem(k));
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // FSRS-4.5 ALGORITHM
        // ═══════════════════════════════════════════════════════════════
        const FSRS = {
            // Default parameters
            w: [0.4, 0.6, 2.4, 5.8, 4.93, 0.94, 0.86, 0.01, 1.49, 0.14, 0.94, 2.18, 0.05, 0.34, 1.26, 0.29, 2.61],

            // Calculate new card state after review
            calculate(card, rating) {
                const now = Date.now();
                let { stability, difficulty, reps, lapses, lastReview } = card;

                // Initialize for new cards
                if (reps === 0) {
                    stability = this.initStability(rating);
                    difficulty = this.initDifficulty(rating);
                } else {
                    const elapsedDays = lastReview ? (now - lastReview) / (1000 * 60 * 60 * 24) : 0;
                    const retrievability = this.retrievability(elapsedDays, stability);
                    
                    difficulty = this.nextDifficulty(difficulty, rating);
                    stability = this.nextStability(stability, difficulty, retrievability, rating);
                }

                // Calculate interval
                const interval = this.nextInterval(stability, rating);

                // Update counters
                if (rating === 1) lapses++;
                reps++;

                return {
                    stability: Math.max(0.1, stability),
                    difficulty: Math.max(1, Math.min(10, difficulty)),
                    reps,
                    lapses,
                    interval,
                    due: now + interval * 60 * 1000,
                    lastReview: now
                };
            },

            initStability(rating) {
                return this.w[rating - 1];
            },

            initDifficulty(rating) {
                return Math.max(1, Math.min(10, this.w[4] - this.w[5] * (rating - 3)));
            },

            retrievability(elapsedDays, stability) {
                return Math.pow(1 + elapsedDays / (9 * stability), -1);
            },

            nextDifficulty(d, rating) {
                const delta = this.w[6] * (rating - 3);
                return Math.max(1, Math.min(10, d - delta));
            },

            nextStability(s, d, r, rating) {
                if (rating === 1) {
                    // Lapse
                    return this.w[11] * Math.pow(d, -this.w[12]) * (Math.pow(s + 1, this.w[13]) - 1) * Math.exp(this.w[14] * (1 - r));
                } else {
                    // Success
// Success (continued)
                    return s * (1 + Math.exp(this.w[8]) * (11 - d) * Math.pow(s, -this.w[9]) * (Math.exp((1 - r) * this.w[10]) - 1));
                }
            },

            nextInterval(stability, rating) {
                // Return interval in minutes
                if (rating === 1) return 1; // 1 minute for "Again"
                if (rating === 2) return 6; // 6 minutes for "Hard"
                
                const interval = stability * 9 * (1 / 0.9 - 1); // Days
                return Math.max(10, interval * 24 * 60); // Convert to minutes, minimum 10 minutes
            },

            // Get intervals for all ratings (for button display)
            getIntervals(card) {
                return [1, 2, 3, 4].map(rating => {
                    const result = this.calculate({ ...card }, rating);
                    return result.interval;
                });
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // SETTINGS MANAGER
        // ═══════════════════════════════════════════════════════════════
        const Settings = {
            defaults: {
                dailyGoal: 20,
                reminderEnabled: false,
                reminderTime: '20:00',
                theme: 'light',
                streak: 0,
                lastStudyDate: null,
                todayReviews: 0,
                totalReviews: 0
            },

            get() {
                return { ...this.defaults, ...DB.get('settings', {}) };
            },

            set(key, value) {
                const settings = this.get();
                settings[key] = value;
                DB.set('settings', settings);
            },

            save() {
                const settings = this.get();
                settings.dailyGoal = parseInt(document.getElementById('dailyGoalInput').value) || 20;
                settings.reminderTime = document.getElementById('reminderTimeInput').value || '20:00';
                DB.set('settings', settings);
                Toast.success('تنظیمات ذخیره شد');
                this.close();
                App.updateUI();
            },

            open() {
                const settings = this.get();
                document.getElementById('dailyGoalInput').value = settings.dailyGoal;
                document.getElementById('reminderTimeInput').value = settings.reminderTime;
                document.getElementById('streakNumber').textContent = Utils.toPersian(settings.streak);
                document.getElementById('goalPreviewTarget').textContent = `${Utils.toPersian(settings.dailyGoal)} کارت`;
                document.getElementById('goalPreviewProgress').textContent = `${Utils.toPersian(settings.todayReviews)} کارت`;
                
                // Update reminder switch
                const reminderSwitch = document.getElementById('reminderSwitch');
                if (settings.reminderEnabled) {
                    reminderSwitch.classList.add('active');
                    document.getElementById('reminderTimeSection').classList.remove('hidden');
                } else {
                    reminderSwitch.classList.remove('active');
                    document.getElementById('reminderTimeSection').classList.add('hidden');
                }

                // Update theme buttons
                document.querySelectorAll('.theme-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.theme === settings.theme);
                });

                // Generate streak calendar
                this.generateStreakCalendar();

                // Update storage info
                this.updateStorageInfo();

                document.getElementById('settingsModal').classList.add('active');
            },

            close() {
                document.getElementById('settingsModal').classList.remove('active');
            },

            adjustGoal(delta) {
                const input = document.getElementById('dailyGoalInput');
                let value = parseInt(input.value) + delta;
                value = Math.max(5, Math.min(100, value));
                input.value = value;
                document.getElementById('goalPreviewTarget').textContent = `${Utils.toPersian(value)} کارت`;
            },

            toggleReminder() {
                const settings = this.get();
                settings.reminderEnabled = !settings.reminderEnabled;
                DB.set('settings', settings);
                
                const reminderSwitch = document.getElementById('reminderSwitch');
                reminderSwitch.classList.toggle('active');
                document.getElementById('reminderTimeSection').classList.toggle('hidden');

                if (settings.reminderEnabled) {
                    this.requestNotificationPermission();
                }
            },

            async requestNotificationPermission() {
                if ('Notification' in window && Notification.permission === 'default') {
                    await Notification.requestPermission();
                }
            },

            setTheme(theme) {
                this.set('theme', theme);
                document.documentElement.setAttribute('data-theme', theme);
                document.querySelectorAll('.theme-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.theme === theme);
                });
            },

            generateStreakCalendar() {
                const calendar = document.getElementById('streakCalendar');
                const studyDates = DB.get('studyDates', {});
                const today = new Date();
                
                calendar.innerHTML = '';
                
                // Generate last 28 days
                for (let i = 27; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    
                    const day = document.createElement('div');
                    day.className = 'calendar-day';
                    
                    if (i === 0) day.classList.add('today');
                    if (studyDates[dateStr] && studyDates[dateStr] >= this.get().dailyGoal) {
                        day.classList.add('completed');
                        day.textContent = '✓';
                    } else if (studyDates[dateStr]) {
                        day.textContent = Utils.toPersian(studyDates[dateStr]);
                    } else if (i > 0) {
                        day.classList.add('missed');
                    }
                    
                    calendar.appendChild(day);
                }
            },

            updateStorageInfo() {
                const cards = DB.get('cards', {});
                const reviews = DB.get('reviews', []);
                
                const cardCount = Object.keys(cards).length;
                const reviewCount = reviews.length;
                
                // Estimate storage size
                const dataStr = JSON.stringify({ cards, reviews });
                const sizeKB = (new Blob([dataStr]).size / 1024).toFixed(1);
                
                document.getElementById('storageValue').textContent = `${sizeKB} KB`;
                document.getElementById('storageDetails').textContent = `${Utils.toPersian(cardCount)} کارت · ${Utils.toPersian(reviewCount)} مرور`;
                
                // Update storage bar (assume 5MB limit)
                const percent = Math.min(100, (parseFloat(sizeKB) / 5120) * 100);
                document.getElementById('storageFill').style.width = `${percent}%`;
            },

            updateStreak() {
                const settings = this.get();
                const today = Utils.getToday();
                const studyDates = DB.get('studyDates', {});
                
                // Check if studied today
                if (settings.lastStudyDate === today) return;
                
                // Check if yesterday was studied
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().split('T')[0];
                
                if (studyDates[yesterdayStr] >= settings.dailyGoal) {
                    settings.streak++;
                } else if (settings.lastStudyDate !== yesterdayStr) {
                    settings.streak = studyDates[today] >= settings.dailyGoal ? 1 : 0;
                }
                
                settings.lastStudyDate = today;
                DB.set('settings', settings);
            },

            recordReview() {
                const settings = this.get();
                const today = Utils.getToday();
                const studyDates = DB.get('studyDates', {});
                
                settings.todayReviews++;
                settings.totalReviews++;
                studyDates[today] = (studyDates[today] || 0) + 1;
                
                DB.set('settings', settings);
                DB.set('studyDates', studyDates);
                
                // Update streak
                if (studyDates[today] === settings.dailyGoal) {
                    this.updateStreak();
                    Toast.success('🎉 هدف روزانه تکمیل شد!');
                }
            },

            resetTodayIfNeeded() {
                const settings = this.get();
                const today = Utils.getToday();
                
                if (settings.lastStudyDate !== today) {
                    settings.todayReviews = 0;
                    DB.set('settings', settings);
                }
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // CARD MANAGER
        // ═══════════════════════════════════════════════════════════════
        const CardManager = {
            getAll() {
                return DB.get('cards', {});
            },

            get(cardId) {
                const cards = this.getAll();
                return cards[cardId] || null;
            },

            save(card) {
                const cards = this.getAll();
                cards[card.id] = card;
                DB.set('cards', cards);
            },

            getDueCards(deckId = null) {
                const cards = this.getAll();
                const now = Date.now();
                
                return Object.values(cards).filter(card => {
                    if (deckId && card.deckId !== deckId) return false;
                    return !card.due || card.due <= now;
                });
            },

            getNewCards(deckId = null) {
                const cards = this.getAll();
                
                return Object.values(cards).filter(card => {
                    if (deckId && card.deckId !== deckId) return false;
                    return card.reps === 0;
                });
            },

            getMasteredCards(deckId = null) {
                const cards = this.getAll();
                
                return Object.values(cards).filter(card => {
                    if (deckId && card.deckId !== deckId) return false;
                    return card.stability >= 30; // 30+ days stability = mastered
                });
            },

            initializeDeck(deckId) {
                const deck = DECKS_DATA[deckId];
                if (!deck) return;

                const cards = this.getAll();
                
                deck.cards.forEach((cardData, index) => {
                    const cardId = `${deckId}_${index}`;
                    if (!cards[cardId]) {
                        cards[cardId] = {
                            id: cardId,
                            deckId: deckId,
                            ...cardData,
                            stability: 0,
                            difficulty: 5,
                            reps: 0,
                            lapses: 0,
                            due: null,
                            lastReview: null,
                            created: Date.now()
                        };
                    }
                });
                
                DB.set('cards', cards);
            },

            getStats(deckId = null) {
                const cards = this.getAll();
                const cardList = Object.values(cards).filter(c => !deckId || c.deckId === deckId);
                const now = Date.now();
                
                return {
                    total: cardList.length,
                    new: cardList.filter(c => c.reps === 0).length,
                    due: cardList.filter(c => c.reps > 0 && (!c.due || c.due <= now)).length,
                    mastered: cardList.filter(c => c.stability >= 30).length
                };
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // REVIEW SYSTEM
        // ═══════════════════════════════════════════════════════════════
        const Review = {
            currentDeckId: null,
            cards: [],
            currentIndex: 0,
            currentCard: null,
            mode: 'recognition',
            isFlipped: false,
            sessionStats: { reviewed: 0, correct: 0 },

            start(deckId) {
                this.currentDeckId = deckId;
                this.cards = CardManager.getDueCards(deckId);
                
                // Add new cards if no due cards
                if (this.cards.length === 0) {
                    this.cards = CardManager.getNewCards(deckId).slice(0, 10);
                }
                
                if (this.cards.length === 0) {
                    Toast.info('همه کارت‌ها مرور شده‌اند! 🎉');
                    return;
                }
                
                // Shuffle cards
                this.cards.sort(() => Math.random() - 0.5);
                
                this.currentIndex = 0;
                this.sessionStats = { reviewed: 0, correct: 0 };
                this.isFlipped = false;
                
                document.getElementById('flashcardModal').classList.add('active');
                document.getElementById('completeScreen').classList.remove('active');
                document.getElementById('ratingContainer').classList.remove('active');
                
                this.setMode('recognition');
                this.showCard();
            },

            showCard() {
                if (this.currentIndex >= this.cards.length) {
                    this.showComplete();
                    return;
                }
                
                this.currentCard = this.cards[this.currentIndex];
                this.isFlipped = false;
                
                // Update progress
                const progress = ((this.currentIndex + 1) / this.cards.length) * 100;
                document.getElementById('flashcardProgress').style.width = `${progress}%`;
                document.getElementById('flashcardCounter').textContent = 
                    `${Utils.toPersian(this.currentIndex + 1)} / ${Utils.toPersian(this.cards.length)}`;
                
                // Update card content
                document.getElementById('cardWord').textContent = this.currentCard.word;
                document.getElementById('cardWordBack').textContent = this.currentCard.word;
                document.getElementById('cardPronunciation').textContent = this.currentCard.pronunciation;
                document.getElementById('cardMeaning').textContent = this.currentCard.meaning;
                document.getElementById('cardExample').textContent = this.currentCard.example;
                document.getElementById('cardMnemonic').textContent = `💡 ${this.currentCard.mnemonic}`;
                
                // Recall mode
                document.getElementById('recallWord').textContent = this.currentCard.word;
                document.getElementById('recallPronunciation').textContent = this.currentCard.pronunciation;
                document.getElementById('recallExample').textContent = this.currentCard.example;
                document.getElementById('recallInput').value = '';
                document.getElementById('recallInputArea').classList.remove('hidden');
                document.getElementById('recallFeedback').classList.add('hidden');
                
                // Reset flashcard
                document.getElementById('flashcard').classList.remove('flipped');
                document.getElementById('ratingContainer').classList.remove('active');
                
                // Update intervals on rating buttons
                this.updateRatingIntervals();
            },

            updateRatingIntervals() {
                const intervals = FSRS.getIntervals(this.currentCard);
                intervals.forEach((interval, index) => {
                    const el = document.getElementById(`ratingInterval${index + 1}`);
                    if (el) el.textContent = Utils.formatInterval(interval);
                });
            },

            setMode(mode) {
                this.mode = mode;
                
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.mode === mode);
                });
                
                document.getElementById('recognitionMode').classList.toggle('active', mode === 'recognition');
                document.getElementById('recallMode').classList.toggle('active', mode === 'recall');
                
                if (mode === 'recall') {
                    setTimeout(() => document.getElementById('recallInput').focus(), 100);
                }
            },

            flip() {
                if (this.mode !== 'recognition') return;
                
                this.isFlipped = !this.isFlipped;
                document.getElementById('flashcard').classList.toggle('flipped', this.isFlipped);
                
                if (this.isFlipped) {
                    document.getElementById('ratingContainer').classList.add('active');
                }
            },

            speak() {
                if (!this.currentCard) return;
                
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(this.currentCard.word);
                    utterance.lang = 'en-US';
                    utterance.rate = 0.8;
                    speechSynthesis.speak(utterance);
                }
            },

            checkAnswer() {
                const input = document.getElementById('recallInput').value.trim();
                if (!input) return;
                
                const similarity = Utils.similarity(input, this.currentCard.meaning);
                const isCorrect = similarity >= 0.6;
                
                document.getElementById('recallInputArea').classList.add('hidden');
                document.getElementById('recallFeedback').classList.remove('hidden');
                
                const feedback = document.getElementById('recallFeedback');
                feedback.classList.remove('correct', 'incorrect');
                feedback.classList.add(isCorrect ? 'correct' : 'incorrect');
                
                document.getElementById('feedbackIcon').textContent = isCorrect ? '✅' : '❌';
                document.getElementById('feedbackText').textContent = isCorrect ? 'آفرین! درست بود' : 'اشتباه بود';
                document.getElementById('correctAnswer').textContent = this.currentCard.meaning;
                document.getElementById('recallMnemonic').textContent = `💡 ${this.currentCard.mnemonic}`;
                
                // Auto-rate based on answer
                setTimeout(() => {
                    this.rate(isCorrect ? 3 : 1);
                }, 2000);
            },

            rate(rating) {
                if (!this.currentCard) return;
                
                // Calculate new card state using FSRS
                const newState = FSRS.calculate(this.currentCard, rating);
                
                // Update card
                Object.assign(this.currentCard, newState);
                CardManager.save(this.currentCard);
                
                // Record review
                Settings.recordReview();
                
                // Update session stats
                this.sessionStats.reviewed++;
                if (rating >= 3) this.sessionStats.correct++;
                
                // Save review to history
                const reviews = DB.get('reviews', []);
                reviews.push({
                    cardId: this.currentCard.id,
                    rating,
                    timestamp: Date.now()
                });
                DB.set('reviews', reviews);
                
                // Next card
                this.currentIndex++;
                this.showCard();
            },

            showComplete() {
                document.getElementById('completeScreen').classList.add('active');
                document.getElementById('ratingContainer').classList.remove('active');
                
                const accuracy = this.sessionStats.reviewed > 0 
                    ? Math.round((this.sessionStats.correct / this.sessionStats.reviewed) * 100) 
                    : 0;
                
                document.getElementById('completeReviewed').textContent = Utils.toPersian(this.sessionStats.reviewed);
                document.getElementById('completeAccuracy').textContent = `${Utils.toPersian(accuracy)}%`;
                
                // Update main UI
                App.updateUI();
            },

            close() {
                document.getElementById('flashcardModal').classList.remove('active');
                App.updateUI();
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // BACKUP SYSTEM
        // ═══════════════════════════════════════════════════════════════
        const Backup = {
            export() {
                const data = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    settings: Settings.get(),
                    cards: CardManager.getAll(),
                    reviews: DB.get('reviews', []),
                    studyDates: DB.get('studyDates', {})
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `lexora-backup-${Utils.getToday()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                Toast.success('پشتیبان با موفقیت دانلود شد');
            },

            import(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (!data.version || !data.cards) {
                            throw new Error('فایل نامعتبر است');
                        }
                        
                        // Restore data
                        if (data.settings) DB.set('settings', data.settings);
                        if (data.cards) DB.set('cards', data.cards);
                        if (data.reviews) DB.set('reviews', data.reviews);
                        if (data.studyDates) DB.set('studyDates', data.studyDates);
                        
                        Toast.success('بازیابی با موفقیت انجام شد');
                        App.updateUI();
                        Settings.close();
                    } catch (err) {
                        Toast.error('خطا در بازیابی: ' + err.message);
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            },

            confirmReset() {
                Confirm.show(
                    '⚠️ حذف تمام داده‌ها',
                    'آیا مطمئن هستید؟ این عملیات قابل بازگشت نیست و تمام داده‌های شما حذف خواهد شد.',
                    () => {
                        DB.clear();
                        Toast.success('تمام داده‌ها حذف شد');
                        location.reload();
                    }
                );
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // STATISTICS
        // ═══════════════════════════════════════════════════════════════
        const Stats = {
            charts: {},

            load() {
                this.updateOverview();
                this.updateTodayStats();
                this.updateIntervalStats();
                this.updateDeckStats();
                this.updateInsights();
                this.renderProgressChart();
                this.renderRatingChart();
            },

            updateOverview() {
                const stats = CardManager.getStats();
                const settings = Settings.get();
                
                document.getElementById('statTotalCards').textContent = Utils.toPersian(stats.total);
                document.getElementById('statReviewedCards').textContent = Utils.toPersian(stats.total - stats.new);
                document.getElementById('statMasteredCards').textContent = Utils.toPersian(stats.mastered);
                document.getElementById('statStreak').textContent = Utils.toPersian(settings.streak);
            },

            updateTodayStats() {
                const settings = Settings.get();
                const reviews = DB.get('reviews', []);
                const today = Utils.getToday();
                
                const todayReviews = reviews.filter(r => {
                    const date = new Date(r.timestamp).toISOString().split('T')[0];
                    return date === today;
                });
                
                const correct = todayReviews.filter(r => r.rating >= 3).length;
                const accuracy = todayReviews.length > 0 ? Math.round((correct / todayReviews.length) * 100) : 0;
                
                document.getElementById('statTodayReviews').textContent = Utils.toPersian(todayReviews.length);
                document.getElementById('statTodayTime').textContent = `${Utils.toPersian(Math.round(todayReviews.length * 0.5))} دقیقه`;
                document.getElementById('statTodayAccuracy').textContent = `${Utils.toPersian(accuracy)}%`;
                document.getElementById('statTodayNew').textContent = Utils.toPersian(CardManager.getNewCards().length);
            },

            updateIntervalStats() {
                const cards = Object.values(CardManager.getAll());
                const now = Date.now();
                const day = 24 * 60 * 60 * 1000;
                
                const intervals = {
                    lessThan1: cards.filter(c => !c.due || c.due - now < day).length,
                    oneToSeven: cards.filter(c => c.due && c.due - now >= day && c.due - now < 7 * day).length,
                    sevenToThirty: cards.filter(c => c.due && c.due - now >= 7 * day && c.due - now < 30 * day).length,
                    moreThanThirty: cards.filter(c => c.due && c.due - now >= 30 * day).length
                };
                
                const total = cards.length || 1;
                
                document.getElementById('interval1').style.width = `${(intervals.lessThan1 / total) * 100}%`;
                document.getElementById('interval2').style.width = `${(intervals.oneToSeven / total) * 100}%`;
                document.getElementById('interval3').style.width = `${(intervals.sevenToThirty / total) * 100}%`;
                document.getElementById('interval4').style.width = `${(intervals.moreThanThirty / total) * 100}%`;
                
                document.getElementById('intervalCount1').textContent = Utils.toPersian(intervals.lessThan1);
                document.getElementById('intervalCount2').textContent = Utils.toPersian(intervals.oneToSeven);
                document.getElementById('intervalCount3').textContent = Utils.toPersian(intervals.sevenToThirty);
                document.getElementById('intervalCount4').textContent = Utils.toPersian(intervals.moreThanThirty);
            },

            updateDeckStats() {
                const container = document.getElementById('deckStatsContainer');
                container.innerHTML = '';
                
                Object.entries(DECKS_DATA).forEach(([deckId, deck]) => {
                    const stats = CardManager.getStats(deckId);
                    const progress = stats.total > 0 ? Math.round(((stats.total - stats.new) / stats.total) * 100) : 0;
                    
                    container.innerHTML += `
                        <div class="deck-stat-card">
                            <div class="deck-stat-info">
                                <div class="deck-stat-name">${deck.icon} ${deck.name}</div>
                                <div class="deck-stat-details">
                                    <span>کل: ${Utils.toPersian(stats.total)}</span>
                                    <span>جدید: ${Utils.toPersian(stats.new)}</span>
                                    <span>تسلط: ${Utils.toPersian(stats.mastered)}</span>
                                </div>
                            </div>
                            <div class="deck-stat-progress">
                                <div class="deck-stat-percent">${Utils.toPersian(progress)}%</div>
                                <div class="deck-stat-label-sm">پیشرفت</div>
                            </div>
                        </div>
                    `;
                });
            },

            updateInsights() {
                const container = document.getElementById('insightsContainer');
                const settings = Settings.get();
                const stats = CardManager.getStats();
                const insights = [];
                
                if (settings.streak >= 7) {
                    insights.push({
                        icon: '🔥',
                        title: 'رکورد عالی!',
                        text: `شما ${Utils.toPersian(settings.streak)} روز متوالی مطالعه کرده‌اید. ادامه دهید!`
                    });
                }
                
                if (stats.mastered > 0) {
                    insights.push({
                        icon: '🎯',
                        title: 'پیشرفت خوب',
                        text: `${Utils.toPersian(stats.mastered)} کلمه را کاملاً یاد گرفته‌اید.`
                    });
                }
                
                if (stats.due > 10) {
                    insights.push({
                        icon: '⏰',
                        title: 'مرور منتظر شماست',
                        text: `${Utils.toPersian(stats.due)} کارت آماده مرور است. همین الان شروع کنید!`
                    });
                }
                
                if (insights.length === 0) {
                    insights.push({
                        icon: '💡',
                        title: 'شروع کنید!',
                        text: 'یک دسته کلمات را انتخاب کنید و یادگیری را شروع کنید.'
                    });
                }
                
                container.innerHTML = insights.map(i => `
                    <div class="insight-item">
                        <div class="insight-icon">${i.icon}</div>
                        <div class="insight-text">
                            <div class="insight-title">${i.title}</div>
                            <div class="insight-description">${i.text}</div>
                        </div>
                    </div>
                `).join('');
            },

            renderProgressChart() {
                const ctx = document.getElementById('progressChart');
                if (!ctx) return;
                
                if (this.charts.progress) {
                    this.charts.progress.destroy();
                }
                
                const studyDates = DB.get('studyDates', {});
                const labels = [];
                const data = [];
                
                for (let i = 29; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    labels.push(`${date.getMonth() + 1}/${date.getDate()}`);
                    data.push(studyDates[dateStr] || 0);
                }
                
                this.charts.progress = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            label: 'مرور روزانه',
                            data,
                            borderColor: '#6366f1',
                            backgroundColor: 'rgba(99, 102, 241, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            },

            renderRatingChart() {
                const ctx = document.getElementById('ratingChart');
                if (!ctx) return;
                
                if (this.charts.rating) {
                    this.charts.rating.destroy();
                }
                
                const reviews = DB.get('reviews', []);
                const ratings = [0, 0, 0, 0];
                
                reviews.forEach(r => {
                    if (r.rating >= 1 && r.rating <= 4) {
                        ratings[r.rating - 1]++;
                    }
                });
                
                this.charts.rating = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['دوباره', 'سخت', 'خوب', 'آسان'],
                        datasets: [{
                            data: ratings,
                            backgroundColor: ['#ef4444', '#f59e0b', '#10b981', '#3b82f6']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { font: { family: 'Vazirmatn' } }
                            }
                        }
                    }
                });
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // MAIN APP
        // ═══════════════════════════════════════════════════════════════
        const App = {
            init() {
                // Initialize all decks
                Object.keys(DECKS_DATA).forEach(deckId => {
                    CardManager.initializeDeck(deckId);
                });
                
                // Reset today's counter if needed
                Settings.resetTodayIfNeeded();
                
                // Apply saved theme
                const settings = Settings.get();
                document.documentElement.setAttribute('data-theme', settings.theme);
                
                // Update UI
                this.updateUI();
                this.renderDecks();
                
                // Add enter key listener for recall mode
                document.getElementById('recallInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') Review.checkAnswer();
                });
                
                console.log('✅ LEXORA initialized successfully');
            },

            updateUI() {
                const stats = CardManager.getStats();
                const settings = Settings.get();
                
                // Update hero stats
                document.getElementById('totalCards').textContent = Utils.toPersian(stats.total);
                document.getElementById('dueCards').textContent = Utils.toPersian(stats.due + stats.new);
                document.getElementById('masteredCards').textContent = Utils.toPersian(stats.mastered);
                
                // Update daily progress
                const progress = Math.min(100, (settings.todayReviews / settings.dailyGoal) * 100);
                document.getElementById('dailyProgressFill').style.width = `${progress}%`;
                document.getElementById('dailyProgressText').textContent = 
                    `${Utils.toPersian(settings.todayReviews)} / ${Utils.toPersian(settings.dailyGoal)}`;
            },

            renderDecks() {
                const container = document.getElementById('decksContainer');
                const libraryContainer = document.getElementById('libraryDecksContainer');
                
                container.innerHTML = '';
                libraryContainer.innerHTML = '';
                
                Object.entries(DECKS_DATA).forEach(([deckId, deck]) => {
                    const stats = CardManager.getStats(deckId);
                    
                    const deckHTML = `
                        <div class="deck-card" onclick="Review.start('${deckId}')">
                            <div class="deck-header">
                                <div class="deck-icon">${deck.icon}</div>
                                <div class="deck-info">
                                    <div class="deck-name">${deck.name}</div>
                                    <div class="deck-description">${deck.description}</div>
                                </div>
                            </div>
                            <div class="deck-stats">
                                <div class="deck-stat">
                                    <span class="deck-stat-value">${Utils.toPersian(stats.new)}</span>
                                    <span class="deck-stat-label">جدید</span>
                                </div>
                                <div class="deck-stat">
                                    <span class="deck-stat-value">${Utils.toPersian(stats.due)}</span>
                                    <span class="deck-stat-label">مرور</span>
                                </div>
                                <div class="deck-stat">
                                    <span class="deck-stat-value">${Utils.toPersian(stats.total)}</span>
                                    <span class="deck-stat-label">کل</span>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    container.innerHTML += deckHTML;
                    libraryContainer.innerHTML += deckHTML;
                });
            },

            showScreen(screenId) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(`${screenId}Screen`).classList.add('active');
                
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                document.querySelector(`.nav-item[data-screen="${screenId}"]`).classList.add('active');
                
                if (screenId === 'stats') {
                    Stats.load();
                }
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // INITIALIZE APP
        // ═══════════════════════════════════════════════════════════════
        document.addEventListener('DOMContentLoaded', () => {
            App.init();
        });

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(() => {});
        }
		// ═══════════════════════════════════════════════════════════════
        // MODE SELECTOR
        // ═══════════════════════════════════════════════════════════════
        const ModeSelector = {
            selectedMode: 'recognition',
            currentDeckId: null,

            open(deckId) {
                this.currentDeckId = deckId;
                this.selectedMode = 'recognition';
                
                // Reset selection UI
                document.querySelectorAll('.mode-option').forEach(opt => {
                    opt.classList.toggle('selected', opt.dataset.mode === 'recognition');
                });
                
                document.getElementById('modeSelectorModal').classList.add('active');
            },

            close() {
                document.getElementById('modeSelectorModal').classList.remove('active');
            },

            select(mode) {
                this.selectedMode = mode;
                document.querySelectorAll('.mode-option').forEach(opt => {
                    opt.classList.toggle('selected', opt.dataset.mode === mode);
                });
            },

            startReview() {
                this.close();
                Review.startWithMode(this.currentDeckId, this.selectedMode);
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // ENHANCED REVIEW SYSTEM (Replace/Extend existing Review object)
        // ═══════════════════════════════════════════════════════════════
        const ReviewEnhanced = {
            currentDeckId: null,
            cards: [],
            currentIndex: 0,
            currentCard: null,
            reviewMode: 'recognition', // recognition, reverse, listening, spelling, quiz
            isFlipped: false,
            sessionStats: { reviewed: 0, correct: 0 },
            quizOptions: [],

            startWithMode(deckId, mode) {
                this.currentDeckId = deckId;
                this.reviewMode = mode;
                this.cards = CardManager.getDueCards(deckId);
                
                // Add new cards if no due cards
                if (this.cards.length === 0) {
                    this.cards = CardManager.getNewCards(deckId).slice(0, 10);
                }
                
                if (this.cards.length === 0) {
                    Toast.info('همه کارت‌ها مرور شده‌اند! 🎉');
                    return;
                }
                
                // Shuffle cards
                this.cards.sort(() => Math.random() - 0.5);
                
                this.currentIndex = 0;
                this.sessionStats = { reviewed: 0, correct: 0 };
                this.isFlipped = false;
                
                // Show modal and hide all modes first
                document.getElementById('flashcardModal').classList.add('active');
                document.getElementById('completeScreen').classList.remove('active');
                document.getElementById('ratingContainer').classList.remove('active');
                
                // Hide mode toggle for non-recognition modes
                document.querySelector('.mode-toggle').style.display = 
                    (mode === 'recognition') ? 'flex' : 'none';
                
                // Hide all card modes
                document.querySelectorAll('.card-mode').forEach(m => m.classList.remove('active'));
                
                // Show appropriate mode
                this.activateMode(mode);
                this.showCard();
            },

            activateMode(mode) {
                const modeMap = {
                    'recognition': 'recognitionMode',
                    'reverse': 'reverseMode',
                    'listening': 'listeningMode',
                    'spelling': 'spellingMode',
                    'quiz': 'quizMode',
                    'recall': 'recallMode'
                };
                
                const modeId = modeMap[mode];
                if (modeId) {
                    document.getElementById(modeId).classList.add('active');
                }
            },

            showCard() {
                if (this.currentIndex >= this.cards.length) {
                    this.showComplete();
                    return;
                }
                
                this.currentCard = this.cards[this.currentIndex];
                this.isFlipped = false;
                
                // Update progress
                const progress = ((this.currentIndex + 1) / this.cards.length) * 100;
                document.getElementById('flashcardProgress').style.width = `${progress}%`;
                document.getElementById('flashcardCounter').textContent = 
                    `${Utils.toPersian(this.currentIndex + 1)} / ${Utils.toPersian(this.cards.length)}`;
                
                // Update based on mode
                switch (this.reviewMode) {
                    case 'recognition':
                        this.showRecognitionCard();
                        break;
                    case 'reverse':
                        this.showReverseCard();
                        break;
                    case 'listening':
                        this.showListeningCard();
                        break;
                    case 'spelling':
                        this.showSpellingCard();
                        break;
                    case 'quiz':
                        this.showQuizCard();
                        break;
                    case 'recall':
                        this.showRecallCard();
                        break;
                }
                
                // Update rating intervals
                this.updateRatingIntervals();
            },

            showRecognitionCard() {
                document.getElementById('cardWord').textContent = this.currentCard.word;
                document.getElementById('cardWordBack').textContent = this.currentCard.word;
                document.getElementById('cardPronunciation').textContent = this.currentCard.pronunciation;
                document.getElementById('cardMeaning').textContent = this.currentCard.meaning;
                document.getElementById('cardExample').textContent = this.currentCard.example;
                document.getElementById('cardMnemonic').textContent = `💡 ${this.currentCard.mnemonic}`;
                
                document.getElementById('flashcard').classList.remove('flipped');
                document.getElementById('ratingContainer').classList.remove('active');
            },

            showReverseCard() {
                document.getElementById('reverseMeaning').textContent = this.currentCard.meaning;
                document.getElementById('reverseWord').textContent = this.currentCard.word;
                document.getElementById('reversePronunciation').textContent = this.currentCard.pronunciation;
                document.getElementById('reverseExample').textContent = this.currentCard.example;
                document.getElementById('reverseMnemonic').textContent = `💡 ${this.currentCard.mnemonic}`;
                
                document.getElementById('reverseFlashcard').classList.remove('flipped');
                document.getElementById('ratingContainer').classList.remove('active');
            },

            showListeningCard() {
                document.getElementById('listeningInput').value = '';
                document.getElementById('listeningFeedback').classList.add('hidden');
                document.getElementById('ratingContainer').classList.remove('active');
                
                // Auto-play audio after a short delay
                setTimeout(() => this.speakCurrent(), 500);
            },

            showSpellingCard() {
                document.getElementById('spellingMeaning').textContent = this.currentCard.meaning;
                document.getElementById('spellingExample').textContent = this.currentCard.example;
                document.getElementById('spellingInput').value = '';
                document.getElementById('spellingInputArea').classList.remove('hidden');
                document.getElementById('spellingFeedback').classList.add('hidden');
                document.getElementById('ratingContainer').classList.remove('active');
                
                setTimeout(() => document.getElementById('spellingInput').focus(), 100);
            },

            showQuizCard() {
                document.getElementById('quizWord').textContent = this.currentCard.word;
                document.getElementById('quizPronunciation').textContent = this.currentCard.pronunciation;
                
                // Generate quiz options
                this.generateQuizOptions();
                document.getElementById('ratingContainer').classList.remove('active');
            },

            showRecallCard() {
                document.getElementById('recallWord').textContent = this.currentCard.word;
                document.getElementById('recallPronunciation').textContent = this.currentCard.pronunciation;
                document.getElementById('recallExample').textContent = this.currentCard.example;
                document.getElementById('recallInput').value = '';
                document.getElementById('recallInputArea').classList.remove('hidden');
                document.getElementById('recallFeedback').classList.add('hidden');
                document.getElementById('ratingContainer').classList.remove('active');
                
                setTimeout(() => document.getElementById('recallInput').focus(), 100);
            },

            generateQuizOptions() {
                const correctAnswer = this.currentCard.meaning;
                const allCards = Object.values(CardManager.getAll());
                
                // Get wrong answers from other cards
                let wrongAnswers = allCards
                    .filter(c => c.id !== this.currentCard.id && c.meaning !== correctAnswer)
                    .map(c => c.meaning)
                    .sort(() => Math.random() - 0.5)
                    .slice(0, 3);
                
                // If not enough wrong answers, add generic ones
                const genericWrong = ['نامشخص', 'دیگر معانی', 'هیچکدام'];
                while (wrongAnswers.length < 3) {
                    wrongAnswers.push(genericWrong[wrongAnswers.length]);
                }
                
                // Combine and shuffle
                this.quizOptions = [correctAnswer, ...wrongAnswers].sort(() => Math.random() - 0.5);
                
                // Render options
                const container = document.getElementById('quizOptions');
                container.innerHTML = this.quizOptions.map((option, index) => `
                    <button class="quiz-option" onclick="Review.selectQuizOption(${index})">
                        ${option}
                    </button>
                `).join('');
            },

            selectQuizOption(index) {
                const selected = this.quizOptions[index];
                const isCorrect = selected === this.currentCard.meaning;
                
                // Disable all options
                document.querySelectorAll('.quiz-option').forEach((btn, i) => {
                    btn.classList.add('disabled');
                    if (this.quizOptions[i] === this.currentCard.meaning) {
                        btn.classList.add('correct');
                    } else if (i === index && !isCorrect) {
                        btn.classList.add('incorrect');
                    }
                });
                
                // Play sound
                this.speakCurrent();
                
                // Auto-rate after delay
                setTimeout(() => {
                    this.rate(isCorrect ? 3 : 1);
                }, 1500);
            },

            flip() {
                if (this.reviewMode !== 'recognition') return;
                
                this.isFlipped = !this.isFlipped;
                document.getElementById('flashcard').classList.toggle('flipped', this.isFlipped);
                
                if (this.isFlipped) {
                    document.getElementById('ratingContainer').classList.add('active');
                }
            },

            flipReverse() {
                if (this.reviewMode !== 'reverse') return;
                
                this.isFlipped = !this.isFlipped;
                document.getElementById('reverseFlashcard').classList.toggle('flipped', this.isFlipped);
                
                if (this.isFlipped) {
                    document.getElementById('ratingContainer').classList.add('active');
                }
            },

            speakCurrent() {
                if (!this.currentCard) return;
                
                if ('speechSynthesis' in window) {
                    speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(this.currentCard.word);
                    utterance.lang = 'en-US';
                    utterance.rate = 0.8;
                    speechSynthesis.speak(utterance);
                }
            },

            checkListening() {
                const input = document.getElementById('listeningInput').value.trim().toLowerCase();
                const correct = this.currentCard.word.toLowerCase();
                
                if (!input) return;
                
                const similarity = Utils.similarity(input, correct);
                const isCorrect = similarity >= 0.8;
                
                document.getElementById('listeningFeedback').classList.remove('hidden');
                document.getElementById('listeningFeedbackIcon').textContent = isCorrect ? '✅' : '❌';
                document.getElementById('listeningFeedbackText').textContent = 
                    isCorrect ? 'آفرین! درست بود' : 'اشتباه بود';
                document.getElementById('listeningCorrectAnswer').textContent = this.currentCard.word;
                
                setTimeout(() => {
                    this.rate(isCorrect ? 3 : 1);
                }, 2000);
            },

            checkSpelling() {
                const input = document.getElementById('spellingInput').value.trim().toLowerCase();
                const correct = this.currentCard.word.toLowerCase();
                
                if (!input) return;
                
                const similarity = Utils.similarity(input, correct);
                const isCorrect = similarity >= 0.85;
                
                document.getElementById('spellingInputArea').classList.add('hidden');
                document.getElementById('spellingFeedback').classList.remove('hidden');
                
                const feedback = document.getElementById('spellingFeedback');
                feedback.classList.remove('correct', 'incorrect');
                feedback.classList.add(isCorrect ? 'correct' : 'incorrect');
                
                document.getElementById('spellingFeedbackIcon').textContent = isCorrect ? '✅' : '❌';
                document.getElementById('spellingFeedbackText').textContent = 
                    isCorrect ? 'آفرین! درست بود' : 'اشتباه بود';
                document.getElementById('spellingCorrectAnswer').textContent = this.currentCard.word;
                document.getElementById('spellingMnemonic').textContent = `💡 ${this.currentCard.mnemonic}`;
                
                this.speakCurrent();
                
                setTimeout(() => {
                    this.rate(isCorrect ? 3 : 1);
                }, 2000);
            },

            checkAnswer() {
                const input = document.getElementById('recallInput').value.trim();
                if (!input) return;
                
                const similarity = Utils.similarity(input, this.currentCard.meaning);
                const isCorrect = similarity >= 0.6;
                
                document.getElementById('recallInputArea').classList.add('hidden');
                document.getElementById('recallFeedback').classList.remove('hidden');
                
                const feedback = document.getElementById('recallFeedback');
                feedback.classList.remove('correct', 'incorrect');
                feedback.classList.add(isCorrect ? 'correct' : 'incorrect');
                
                document.getElementById('feedbackIcon').textContent = isCorrect ? '✅' : '❌';
                document.getElementById('feedbackText').textContent = isCorrect ? 'آفرین! درست بود' : 'اشتباه بود';
                document.getElementById('correctAnswer').textContent = this.currentCard.meaning;
                document.getElementById('recallMnemonic').textContent = `💡 ${this.currentCard.mnemonic}`;
                
                setTimeout(() => {
                    this.rate(isCorrect ? 3 : 1);
                }, 2000);
            },

            setMode(mode) {
                if (this.reviewMode !== 'recognition') return;
                
                const newMode = mode === 'recall' ? 'recall' : 'recognition';
                
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.mode === mode);
                });
                
                document.getElementById('recognitionMode').classList.toggle('active', mode === 'recognition');
                document.getElementById('recallMode').classList.toggle('active', mode === 'recall');
                
                if (mode === 'recall') {
                    this.reviewMode = 'recall';
                    this.showRecallCard();
                } else {
                    this.reviewMode = 'recognition';
                    this.showRecognitionCard();
                }
            },

            updateRatingIntervals() {
                const intervals = FSRS.getIntervals(this.currentCard);
                intervals.forEach((interval, index) => {
                    const el = document.getElementById(`ratingInterval${index + 1}`);
                    if (el) el.textContent = Utils.formatInterval(interval);
                });
            },

            rate(rating) {
                if (!this.currentCard) return;
                
                // Calculate new card state using FSRS
                const newState = FSRS.calculate(this.currentCard, rating);
                
                // Update card
                Object.assign(this.currentCard, newState);
                CardManager.save(this.currentCard);
                
                // Record review
                Settings.recordReview();
                
                // Update session stats
                this.sessionStats.reviewed++;
                if (rating >= 3) this.sessionStats.correct++;
                
                // Save review to history
                const reviews = DB.get('reviews', []);
                reviews.push({
                    cardId: this.currentCard.id,
                    rating,
                    mode: this.reviewMode,
                    timestamp: Date.now()
                });
                DB.set('reviews', reviews);
                
                // Next card
                this.currentIndex++;
                this.showCard();
            },

            showComplete() {
                document.querySelectorAll('.card-mode').forEach(m => m.classList.remove('active'));
                document.getElementById('completeScreen').classList.add('active');
                document.getElementById('ratingContainer').classList.remove('active');
                
                const accuracy = this.sessionStats.reviewed > 0 
                    ? Math.round((this.sessionStats.correct / this.sessionStats.reviewed) * 100) 
                    : 0;
                
                document.getElementById('completeReviewed').textContent = Utils.toPersian(this.sessionStats.reviewed);
                document.getElementById('completeAccuracy').textContent = `${Utils.toPersian(accuracy)}%`;
                
                App.updateUI();
            },

            close() {
                document.getElementById('flashcardModal').classList.remove('active');
                App.updateUI();
            },

            speak() {
                this.speakCurrent();
            },

            // Backward compatibility
            start(deckId) {
                ModeSelector.open(deckId);
            }
        };

        // Replace original Review with enhanced version
        Object.assign(Review, ReviewEnhanced);
		// ═══════════════════════════════════════════════════════════════
        // DICTIONARY API
        // ═══════════════════════════════════════════════════════════════
        const Dictionary = {
            currentWord: null,
            audioUrl: null,

            open() {
                document.getElementById('dictionaryModal').classList.add('active');
                document.getElementById('dictionaryInput').value = '';
                document.getElementById('dictionaryInput').focus();
                
                // Reset body to placeholder
                document.getElementById('dictionaryBody').innerHTML = `
                    <div class="dictionary-placeholder" style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                        <div style="font-size: 64px; margin-bottom: 16px;">📖</div>
                        <div style="font-size: 16px;">کلمه‌ای را جستجو کنید</div>
                        <div style="font-size: 14px; margin-top: 8px; opacity: 0.7;">
                            معنی، تلفظ و مثال را ببینید و به دک اضافه کنید
                        </div>
                    </div>
                `;
            },

            close() {
                document.getElementById('dictionaryModal').classList.remove('active');
            },

            async search() {
                const word = document.getElementById('dictionaryInput').value.trim().toLowerCase();
                if (!word) {
                    Toast.warning('لطفاً یک کلمه وارد کنید');
                    return;
                }

                const body = document.getElementById('dictionaryBody');
                
                // Show loading
                body.innerHTML = `
                    <div class="dictionary-loading">
                        <div class="spinner"></div>
                        <div>در حال جستجو...</div>
                    </div>
                `;

                try {
                    // Use Free Dictionary API
                    const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`);
                    
                    if (!response.ok) {
                        throw new Error('Word not found');
                    }

                    const data = await response.json();
                    this.displayResults(data);

                } catch (error) {
                    // Try backup: Google Translate approach or show error
                    this.showError(word);
                }
            },

            displayResults(data) {
                const entry = data[0];
                this.currentWord = {
                    word: entry.word,
                    pronunciation: entry.phonetic || (entry.phonetics?.find(p => p.text)?.text) || '',
                    meanings: []
                };

                // Get audio URL
                this.audioUrl = entry.phonetics?.find(p => p.audio)?.audio || null;

                // Process meanings
                entry.meanings.forEach(meaning => {
                    meaning.definitions.slice(0, 2).forEach(def => {
                        this.currentWord.meanings.push({
                            partOfSpeech: meaning.partOfSpeech,
                            definition: def.definition,
                            example: def.example || ''
                        });
                    });
                });

                // Render results
                const body = document.getElementById('dictionaryBody');
                body.innerHTML = `
                    <div class="dictionary-result">
                        <div class="dict-word-header">
                            <div>
                                <div class="dict-word">${this.currentWord.word}</div>
                                <div class="dict-phonetic">${this.currentWord.pronunciation}</div>
                            </div>
                            ${this.audioUrl ? `
                                <button class="dict-play-btn" onclick="Dictionary.playAudio()">🔊</button>
                            ` : `
                                <button class="dict-play-btn" onclick="Dictionary.speakWord()">🔊</button>
                            `}
                        </div>

                        <div class="dict-meanings">
                            ${this.currentWord.meanings.map(m => `
                                <div style="margin-bottom: 16px;">
                                    <div class="dict-pos">${this.translatePOS(m.partOfSpeech)}</div>
                                    <div class="dict-definition">${m.definition}</div>
                                    ${m.example ? `<div class="dict-example">"${m.example}"</div>` : ''}
                                </div>
                            `).join('')}
                        </div>

                        <div class="form-group" style="margin-bottom: 12px;">
                            <label class="form-label">معنی فارسی (دستی وارد کنید):</label>
                            <input type="text" class="form-input" id="dictPersianMeaning" 
                                   placeholder="معنی فارسی کلمه..." dir="rtl">
                        </div>

                        <div class="form-group" style="margin-bottom: 12px;">
                            <label class="form-label">نکته حافظه (اختیاری):</label>
                            <input type="text" class="form-input" id="dictMnemonic" 
                                   placeholder="یک نکته برای به خاطر سپردن..." dir="rtl">
                        </div>

                        <button class="dict-add-btn" onclick="Dictionary.addToDeck()">
                            ➕ افزودن به دک
                        </button>
                    </div>
                `;
            },

            translatePOS(pos) {
                const map = {
                    'noun': 'اسم',
                    'verb': 'فعل',
                    'adjective': 'صفت',
                    'adverb': 'قید',
                    'pronoun': 'ضمیر',
                    'preposition': 'حرف اضافه',
                    'conjunction': 'حرف ربط',
                    'interjection': 'حرف ندا',
                    'exclamation': 'حرف ندا'
                };
                return map[pos.toLowerCase()] || pos;
            },

            showError(word) {
                const body = document.getElementById('dictionaryBody');
                body.innerHTML = `
                    <div class="dictionary-error">
                        <div class="dictionary-error-icon">😕</div>
                        <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">
                            کلمه "${word}" یافت نشد
                        </div>
                        <div style="font-size: 14px; margin-bottom: 20px;">
                            می‌توانید کلمه را به صورت دستی اضافه کنید
                        </div>
                        <button class="btn-block btn-primary" onclick="Dictionary.addManually('${word}')">
                            ➕ افزودن دستی
                        </button>
                    </div>
                `;
            },

            addManually(word) {
                const body = document.getElementById('dictionaryBody');
                this.currentWord = { word: word, pronunciation: '', meanings: [] };
                
                body.innerHTML = `
                    <div class="dictionary-result">
                        <h3 style="margin-bottom: 16px;">➕ افزودن دستی: ${word}</h3>
                        
                        <div class="form-group">
                            <label class="form-label">تلفظ (اختیاری):</label>
                            <input type="text" class="form-input" id="dictManualPronunciation" 
                                   placeholder="/example/" dir="ltr">
                        </div>

                        <div class="form-group">
                            <label class="form-label">معنی فارسی:</label>
                            <input type="text" class="form-input" id="dictPersianMeaning" 
                                   placeholder="معنی فارسی کلمه..." dir="rtl" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">مثال (اختیاری):</label>
                            <input type="text" class="form-input" id="dictManualExample" 
                                   placeholder="An example sentence..." dir="ltr">
                        </div>

                        <div class="form-group">
                            <label class="form-label">نکته حافظه (اختیاری):</label>
                            <input type="text" class="form-input" id="dictMnemonic" 
                                   placeholder="یک نکته برای به خاطر سپردن..." dir="rtl">
                        </div>

                        <button class="dict-add-btn" onclick="Dictionary.addToDeck()">
                            ➕ افزودن به دک
                        </button>
                    </div>
                `;
            },

            playAudio() {
                if (this.audioUrl) {
                    const audio = new Audio(this.audioUrl);
                    audio.play().catch(() => this.speakWord());
                } else {
                    this.speakWord();
                }
            },

            speakWord() {
                if (this.currentWord && 'speechSynthesis' in window) {
                    speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(this.currentWord.word);
                    utterance.lang = 'en-US';
                    utterance.rate = 0.8;
                    speechSynthesis.speak(utterance);
                }
            },

            addToDeck() {
                const persianMeaning = document.getElementById('dictPersianMeaning')?.value.trim();
                
                if (!persianMeaning) {
                    Toast.warning('لطفاً معنی فارسی را وارد کنید');
                    return;
                }

                // Get custom decks and built-in decks
                const customDecks = DB.get('customDecks', {});
                const allDecks = { ...DECKS_DATA, ...customDecks };
                
                // Populate deck selector
                const select = document.getElementById('selectDeckForAdd');
                select.innerHTML = Object.entries(allDecks).map(([id, deck]) => 
                    `<option value="${id}">${deck.icon} ${deck.name}</option>`
                ).join('');
                
                // Show add to deck modal
                document.getElementById('addToDeckModal').classList.add('active');
            },

            closeAddModal() {
                document.getElementById('addToDeckModal').classList.remove('active');
            },

            confirmAddToDeck() {
                const deckId = document.getElementById('selectDeckForAdd').value;
                const persianMeaning = document.getElementById('dictPersianMeaning').value.trim();
                const mnemonic = document.getElementById('dictMnemonic')?.value.trim() || '';
                const manualPronunciation = document.getElementById('dictManualPronunciation')?.value.trim();
                const manualExample = document.getElementById('dictManualExample')?.value.trim();
                
                // Create card
                const cardId = `${deckId}_custom_${Date.now()}`;
                const card = {
                    id: cardId,
                    deckId: deckId,
                    word: this.currentWord.word,
                    pronunciation: manualPronunciation || this.currentWord.pronunciation || '',
                    meaning: persianMeaning,
                    example: manualExample || (this.currentWord.meanings[0]?.example) || '',
                    mnemonic: mnemonic || `${this.currentWord.word} = ${persianMeaning}`,
                    stability: 0,
                    difficulty: 5,
                    reps: 0,
                    lapses: 0,
                    due: null,
                    lastReview: null,
                    created: Date.now(),
                    isCustom: true
                };
                
                // Save card
                CardManager.save(card);
                
                this.closeAddModal();
                this.close();
                Toast.success(`"${this.currentWord.word}" به دک اضافه شد`);
                App.updateUI();
                App.renderDecks();
            }
        };

        // Add enter key listener for dictionary search
        document.getElementById('dictionaryInput')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') Dictionary.search();
        });

        // ═══════════════════════════════════════════════════════════════
        // DECK MANAGER
        // ═══════════════════════════════════════════════════════════════
        const DeckManager = {
            selectedEmoji: '📚',
            cardForms: [],
            editingDeckId: null,

            open() {
                document.getElementById('deckManagerModal').classList.add('active');
                this.showTab('create');
                this.resetForm();
                this.loadMyDecks();
            },

            close() {
                document.getElementById('deckManagerModal').classList.remove('active');
                this.editingDeckId = null;
            },

            showTab(tabName) {
                // Update tab buttons
                document.querySelectorAll('.mode-toggle .mode-btn').forEach((btn, index) => {
                    const tabs = ['create', 'my-decks', 'import'];
                    btn.classList.toggle('active', tabs[index] === tabName);
                });

                // Show/hide tabs
                document.getElementById('createDeckTab').style.display = tabName === 'create' ? 'block' : 'none';
                document.getElementById('myDecksTab').style.display = tabName === 'my-decks' ? 'block' : 'none';
                document.getElementById('importTab').style.display = tabName === 'import' ? 'block' : 'none';
            },

            resetForm() {
                document.getElementById('newDeckName').value = '';
                document.getElementById('newDeckDesc').value = '';
                this.selectedEmoji = '📚';
                this.cardForms = [];
                this.editingDeckId = null;
                
                // Reset emoji selection
                document.querySelectorAll('.emoji-option').forEach(opt => {
                    opt.classList.toggle('selected', opt.dataset.emoji === '📚');
                });
                
                // Clear card forms and add one empty
                document.getElementById('cardFormList').innerHTML = '';
                this.addCardForm();
            },

            selectEmoji(emoji) {
                this.selectedEmoji = emoji;
                document.querySelectorAll('.emoji-option').forEach(opt => {
                    opt.classList.toggle('selected', opt.dataset.emoji === emoji);
                });
            },

            addCardForm(data = null) {
                const index = this.cardForms.length;
                this.cardForms.push(data || {});
                
                const formHTML = `
                    <div class="card-form-item" id="cardForm_${index}">
                        <div class="card-form-row">
                            <div class="form-group">
                                <label class="form-label">کلمه انگلیسی</label>
                                <input type="text" class="form-input" id="cardWord_${index}" 
                                       value="${data?.word || ''}" placeholder="word" dir="ltr">
                            </div>
                            <div class="form-group">
                                <label class="form-label">تلفظ</label>
                                <input type="text" class="form-input" id="cardPron_${index}" 
                                       value="${data?.pronunciation || ''}" placeholder="/pronunciation/" dir="ltr">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">معنی فارسی</label>
                            <input type="text" class="form-input" id="cardMeaning_${index}" 
                                   value="${data?.meaning || ''}" placeholder="معنی">
                        </div>
                        <div class="form-group">
                            <label class="form-label">مثال</label>
                            <input type="text" class="form-input" id="cardExample_${index}" 
                                   value="${data?.example || ''}" placeholder="Example sentence..." dir="ltr">
                        </div>
                        <div class="form-group">
                            <label class="form-label">نکته حافظه</label>
                            <input type="text" class="form-input" id="cardMnemonic_${index}" 
                                   value="${data?.mnemonic || ''}" placeholder="یک نکته برای به خاطر سپردن">
                        </div>
                        <button class="remove-card-btn" onclick="DeckManager.removeCardForm(${index})">
                            🗑️ حذف کارت
                        </button>
                    </div>
                `;
                
                document.getElementById('cardFormList').insertAdjacentHTML('beforeend', formHTML);
            },

            removeCardForm(index) {
                const form = document.getElementById(`cardForm_${index}`);
                if (form) {
                    form.remove();
                    this.cardForms[index] = null; // Mark as removed
                }
            },

            collectCardData() {
                const cards = [];
                
                this.cardForms.forEach((_, index) => {
                    const form = document.getElementById(`cardForm_${index}`);
                    if (!form) return; // Skip removed forms
                    
                    const word = document.getElementById(`cardWord_${index}`)?.value.trim();
                    const meaning = document.getElementById(`cardMeaning_${index}`)?.value.trim();
                    
                    if (word && meaning) {
                        cards.push({
                            word: word,
                            pronunciation: document.getElementById(`cardPron_${index}`)?.value.trim() || '',
                            meaning: meaning,
                            example: document.getElementById(`cardExample_${index}`)?.value.trim() || '',
                            mnemonic: document.getElementById(`cardMnemonic_${index}`)?.value.trim() || `${word} = ${meaning}`
                        });
                    }
                });
                
                return cards;
            },

            saveDeck() {
                const name = document.getElementById('newDeckName').value.trim();
                const description = document.getElementById('newDeckDesc').value.trim();
                const cards = this.collectCardData();
                
                if (!name) {
                    Toast.warning('لطفاً نام دک را وارد کنید');
                    return;
                }
                
                if (cards.length === 0) {
                    Toast.warning('لطفاً حداقل یک کارت با کلمه و معنی اضافه کنید');
                    return;
                }
                
                // Generate deck ID
                const deckId = this.editingDeckId || `custom_${Date.now()}`;
                
                // Save deck info
                const customDecks = DB.get('customDecks', {});
                customDecks[deckId] = {
                    id: deckId,
                    name: name,
                    icon: this.selectedEmoji,
                    description: description || `دک شخصی با ${cards.length} کارت`,
                    category: 'custom',
                    cards: cards,
                    created: Date.now(),
                    isCustom: true
                };
                DB.set('customDecks', customDecks);
                
                // Initialize cards in CardManager
                const allCards = CardManager.getAll();
                cards.forEach((cardData, index) => {
                    const cardId = `${deckId}_${index}`;
                    if (!allCards[cardId] || this.editingDeckId) {
                        allCards[cardId] = {
                            id: cardId,
                            deckId: deckId,
                            ...cardData,
                            stability: 0,
                            difficulty: 5,
                            reps: 0,
                            lapses: 0,
                            due: null,
                            lastReview: null,
                            created: Date.now()
                        };
                    }
                });
                DB.set('cards', allCards);
                
                Toast.success(`دک "${name}" با ${cards.length} کارت ذخیره شد`);
                this.close();
                App.updateUI();
                App.renderDecks();
            },

            loadMyDecks() {
                const customDecks = DB.get('customDecks', {});
                const container = document.getElementById('myDecksList');
                
                if (Object.keys(customDecks).length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <div style="font-size: 48px; margin-bottom: 16px;">📭</div>
                            <div>هنوز دکی نساخته‌اید</div>
                            <button class="btn-block btn-primary" onclick="DeckManager.showTab('create')" style="margin-top: 16px;">
                                ➕ ساخت دک جدید
                            </button>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = Object.entries(customDecks).map(([deckId, deck]) => {
                    const stats = CardManager.getStats(deckId);
                    return `
                        <div class="my-deck-item">
                            <div class="my-deck-icon">${deck.icon}</div>
                            <div class="my-deck-info">
                                <div class="my-deck-name">${deck.name}</div>
                                <div class="my-deck-stats">${Utils.toPersian(stats.total)} کارت · ${Utils.toPersian(stats.mastered)} تسلط</div>
                            </div>
                            <div class="my-deck-actions">
                                <button class="deck-action-btn deck-edit-btn" onclick="DeckManager.editDeck('${deckId}')" title="ویرایش">
                                    ✏️
                                </button>
                                <button class="deck-action-btn deck-delete-btn" onclick="DeckManager.confirmDeleteDeck('${deckId}')" title="حذف">
                                    🗑️
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            editDeck(deckId) {
                const customDecks = DB.get('customDecks', {});
                const deck = customDecks[deckId];
                
                if (!deck) {
                    Toast.error('دک یافت نشد');
                    return;
                }
                
                this.editingDeckId = deckId;
                this.showTab('create');
                
                // Fill form with deck data
                document.getElementById('newDeckName').value = deck.name;
                document.getElementById('newDeckDesc').value = deck.description || '';
                this.selectEmoji(deck.icon);
                
                // Clear and add card forms
                document.getElementById('cardFormList').innerHTML = '';
                this.cardForms = [];
                
                deck.cards.forEach(card => {
                    this.addCardForm(card);
                });
            },

            confirmDeleteDeck(deckId) {
                const customDecks = DB.get('customDecks', {});
                const deck = customDecks[deckId];
                
                Confirm.show(
                    '🗑️ حذف دک',
                    `آیا از حذف دک "${deck?.name}" مطمئن هستید؟ تمام کارت‌ها و پیشرفت شما حذف خواهد شد.`,
                    () => this.deleteDeck(deckId)
                );
            },

            deleteDeck(deckId) {
                // Remove deck
                const customDecks = DB.get('customDecks', {});
                delete customDecks[deckId];
                DB.set('customDecks', customDecks);
                
                // Remove cards
                const cards = CardManager.getAll();
                Object.keys(cards).forEach(cardId => {
                    if (cardId.startsWith(deckId)) {
                        delete cards[cardId];
                    }
                });
                DB.set('cards', cards);
                
                Toast.success('دک حذف شد');
                this.loadMyDecks();
                App.updateUI();
                App.renderDecks();
            },

            importCSV(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const csv = e.target.result;
                        const lines = csv.split('\n').filter(line => line.trim());
                        
                        if (lines.length < 2) {
                            throw new Error('فایل خالی است');
                        }
                        
                        // Parse header
                        const header = lines[0].split(',').map(h => h.trim().toLowerCase());
                        const wordIndex = header.findIndex(h => h === 'word' || h === 'کلمه');
                        const meaningIndex = header.findIndex(h => h === 'meaning' || h === 'معنی');
                        
                        if (wordIndex === -1 || meaningIndex === -1) {
                            throw new Error('ستون word و meaning الزامی است');
                        }
                        
                        // Parse cards
                        const cards = [];
                        for (let i = 1; i < lines.length; i++) {
                            const values = this.parseCSVLine(lines[i]);
                            if (values.length > Math.max(wordIndex, meaningIndex)) {
                                cards.push({
                                    word: values[wordIndex] || '',
                                    pronunciation: values[header.indexOf('pronunciation')] || '',
                                    meaning: values[meaningIndex] || '',
                                    example: values[header.indexOf('example')] || '',
                                    mnemonic: values[header.indexOf('mnemonic')] || ''
                                });
                            }
                        }
                        
                        if (cards.length === 0) {
                            throw new Error('کارتی یافت نشد');
                        }
                        
                        // Switch to create tab and populate
                        this.showTab('create');
                        document.getElementById('newDeckName').value = file.name.replace('.csv', '');
                        document.getElementById('cardFormList').innerHTML = '';
                        this.cardForms = [];
                        
                        cards.forEach(card => {
                            if (card.word && card.meaning) {
                                this.addCardForm(card);
                            }
                        });
                        
                        Toast.success(`${cards.length} کارت از فایل وارد شد`);
                        
                    } catch (err) {
                        Toast.error('خطا در خواندن فایل: ' + err.message);
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            },

            parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current.trim());
                
                return result;
            },

            downloadSampleCSV() {
                const csv = `word,pronunciation,meaning,example,mnemonic
hello,/həˈloʊ/,سلام,Hello everyone!,هِلو صدای زنگ در
goodbye,/ɡʊdˈbaɪ/,خداحافظ,Goodbye my friend,گود بای = خدای خوب
thank,/θæŋk/,تشکر کردن,Thank you so much,تِنک مثل تانک قوی`;
                
                const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'lexora-sample.csv';
                a.click();
                URL.revokeObjectURL(url);
            }
        };

        // Setup emoji picker click handlers
        document.querySelectorAll('.emoji-option').forEach(opt => {
            opt.addEventListener('click', () => {
                DeckManager.selectEmoji(opt.dataset.emoji);
            });
        });

        // Setup CSV drag and drop
        const csvArea = document.getElementById('csvImportArea');
        if (csvArea) {
            csvArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                csvArea.classList.add('dragover');
            });
            
            csvArea.addEventListener('dragleave', () => {
                csvArea.classList.remove('dragover');
            });
            
            csvArea.addEventListener('drop', (e) => {
                e.preventDefault();
                csvArea.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file && file.name.endsWith('.csv')) {
                    DeckManager.importCSV({ target: { files: [file] } });
                } else {
                    Toast.warning('لطفاً فایل CSV انتخاب کنید');
                }
            });
        }

        // ═══════════════════════════════════════════════════════════════
        // UPDATE APP.renderDecks TO INCLUDE CUSTOM DECKS
        // ═══════════════════════════════════════════════════════════════
        const originalRenderDecks = App.renderDecks;
        App.renderDecks = function() {
            const container = document.getElementById('decksContainer');
            const libraryContainer = document.getElementById('libraryDecksContainer');
            
            container.innerHTML = '';
            libraryContainer.innerHTML = '';
            
            // Combine built-in and custom decks
            const customDecks = DB.get('customDecks', {});
            const allDecks = { ...DECKS_DATA, ...customDecks };
            
            Object.entries(allDecks).forEach(([deckId, deck]) => {
                const stats = CardManager.getStats(deckId);
                const isCustom = deck.isCustom || false;
                
                const deckHTML = `
                    <div class="deck-card" onclick="Review.start('${deckId}')">
                        <div class="deck-header">
                            <div class="deck-icon">${deck.icon}</div>
                            <div class="deck-info">
                                <div class="deck-name">
                                    ${deck.name}
                                    ${isCustom ? '<span style="font-size: 10px; background: var(--primary); color: white; padding: 2px 6px; border-radius: 10px; margin-right: 8px;">شخصی</span>' : ''}
                                </div>
                                <div class="deck-description">${deck.description}</div>
                            </div>
                        </div>
                        <div class="deck-stats">
                            <div class="deck-stat">
                                <span class="deck-stat-value">${Utils.toPersian(stats.new)}</span>
                                <span class="deck-stat-label">جدید</span>
                            </div>
                            <div class="deck-stat">
                                <span class="deck-stat-value">${Utils.toPersian(stats.due)}</span>
                                <span class="deck-stat-label">مرور</span>
                            </div>
                            <div class="deck-stat">
                                <span class="deck-stat-value">${Utils.toPersian(stats.total)}</span>
                                <span class="deck-stat-label">کل</span>
                            </div>
                        </div>
                    </div>
                `;
                
                container.innerHTML += deckHTML;
                libraryContainer.innerHTML += deckHTML;
            });
        };

        // ═══════════════════════════════════════════════════════════════
        // ADD KEYBOARD SHORTCUTS
        // ═══════════════════════════════════════════════════════════════
        document.addEventListener('keydown', (e) => {
            // Listening mode - Enter to check
            if (document.getElementById('listeningMode')?.classList.contains('active')) {
                if (e.key === 'Enter') {
                    Review.checkListening();
                }
            }
            
            // Spelling mode - Enter to check
            if (document.getElementById('spellingMode')?.classList.contains('active')) {
                if (e.key === 'Enter') {
                    Review.checkSpelling();
                }
            }
            
            // Space to flip card in recognition/reverse mode
            if (e.key === ' ' && !e.target.matches('input, textarea')) {
                e.preventDefault();
                if (document.getElementById('recognitionMode')?.classList.contains('active')) {
                    Review.flip();
                } else if (document.getElementById('reverseMode')?.classList.contains('active')) {
                    Review.flipReverse();
                }
            }
            
            // Number keys for rating (1-4)
            if (document.getElementById('ratingContainer')?.classList.contains('active')) {
                if (['1', '2', '3', '4'].includes(e.key)) {
                    Review.rate(parseInt(e.key));
                }
            }
        });

        // ═══════════════════════════════════════════════════════════════
        // RE-INITIALIZE APP
        // ═══════════════════════════════════════════════════════════════
        // Make sure custom decks are loaded on startup
        const originalInit = App.init;
        App.init = function() {
            // Initialize built-in decks
            Object.keys(DECKS_DATA).forEach(deckId => {
                CardManager.initializeDeck(deckId);
            });
            
            // Initialize custom decks
            const customDecks = DB.get('customDecks', {});
            Object.keys(customDecks).forEach(deckId => {
                const deck = customDecks[deckId];
                const cards = CardManager.getAll();
                
                deck.cards?.forEach((cardData, index) => {
                    const cardId = `${deckId}_${index}`;
                    if (!cards[cardId]) {
                        cards[cardId] = {
                            id: cardId,
                            deckId: deckId,
                            ...cardData,
                            stability: 0,
                            difficulty: 5,
                            reps: 0,
                            lapses: 0,
                            due: null,
                            lastReview: null,
                            created: Date.now()
                        };
                    }
                });
                DB.set('cards', cards);
            });
            
            // Reset today's counter if needed
            Settings.resetTodayIfNeeded();
            
            // Apply saved theme
            const settings = Settings.get();
            document.documentElement.setAttribute('data-theme', settings.theme);
            
            // Update UI
            this.updateUI();
            this.renderDecks();
            
            // Add enter key listener for recall mode
            document.getElementById('recallInput')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') Review.checkAnswer();
            });
            
            console.log('✅ LEXORA v2.0 initialized with enhanced features');
        };
		// ═══════════════════════════════════════════════════════════════
        // GAMIFICATION SYSTEM - XP, Levels, Badges
        // ═══════════════════════════════════════════════════════════════
        const Gamification = {
            // XP needed for each level (cumulative)
            levelThresholds: [
                0, 100, 250, 450, 700, 1000, 1400, 1900, 2500, 3200,  // 1-10
                4000, 5000, 6200, 7600, 9200, 11000, 13000, 15500, 18500, 22000, // 11-20
                26000, 30500, 35500, 41000, 47000, 54000, 62000, 71000, 81000, 92000 // 21-30
            ],

            // Level titles
            levelTitles: {
                1: 'تازه‌کار',
                5: 'دانش‌آموز',
                10: 'یادگیرنده',
                15: 'پیشرفته',
                20: 'حرفه‌ای',
                25: 'استاد',
                30: 'نابغه'
            },

            // Badge definitions
            badges: [
                { id: 'first_card', icon: '🎯', name: 'اولین قدم', desc: 'اولین کارت را مرور کنید', condition: (s) => s.totalReviews >= 1 },
                { id: 'streak_3', icon: '🔥', name: 'آتش‌پاره', desc: '۳ روز متوالی مرور کنید', condition: (s) => s.maxStreak >= 3 },
                { id: 'streak_7', icon: '💪', name: 'پایدار', desc: '۷ روز متوالی مرور کنید', condition: (s) => s.maxStreak >= 7 },
                { id: 'streak_30', icon: '🏆', name: 'قهرمان', desc: '۳۰ روز متوالی مرور کنید', condition: (s) => s.maxStreak >= 30 },
                { id: 'cards_50', icon: '📚', name: 'کتاب‌خوان', desc: '۵۰ کارت مرور کنید', condition: (s) => s.totalReviews >= 50 },
                { id: 'cards_200', icon: '🎓', name: 'دانشجو', desc: '۲۰۰ کارت مرور کنید', condition: (s) => s.totalReviews >= 200 },
                { id: 'cards_500', icon: '🦉', name: 'جغد دانا', desc: '۵۰۰ کارت مرور کنید', condition: (s) => s.totalReviews >= 500 },
                { id: 'mastered_10', icon: '⭐', name: 'ستاره', desc: 'به ۱۰ کلمه تسلط پیدا کنید', condition: (s) => s.totalMastered >= 10 },
                { id: 'mastered_50', icon: '🌟', name: 'درخشان', desc: 'به ۵۰ کلمه تسلط پیدا کنید', condition: (s) => s.totalMastered >= 50 },
                { id: 'mastered_100', icon: '💎', name: 'الماس', desc: 'به ۱۰۰ کلمه تسلط پیدا کنید', condition: (s) => s.totalMastered >= 100 },
                { id: 'accuracy_80', icon: '🎯', name: 'دقیق', desc: 'دقت بالای ۸۰٪ داشته باشید', condition: (s) => s.avgAccuracy >= 80 },
                { id: 'level_10', icon: '👑', name: 'سلطان', desc: 'به سطح ۱۰ برسید', condition: (s) => s.level >= 10 }
            ],

            // Get gamification data
            getData() {
                return DB.get('gamification', {
                    xp: 0,
                    level: 1,
                    totalReviews: 0,
                    totalMastered: 0,
                    maxStreak: 0,
                    currentStreak: 0,
                    avgAccuracy: 0,
                    dailyRewardClaimed: null,
                    earnedBadges: [],
                    lastActivity: null
                });
            },

            // Save gamification data
            saveData(data) {
                DB.set('gamification', data);
            },

            // Add XP
            addXP(amount, reason = '') {
                const data = this.getData();
                const oldLevel = data.level;
                
                data.xp += amount;
                data.level = this.calculateLevel(data.xp);
                
                this.saveData(data);
                this.updateUI();
                
                // Show toast
                Toast.success(`+${amount} XP ${reason}`);
                
                // Check for level up
                if (data.level > oldLevel) {
                    this.showLevelUp(data.level);
                }
                
                // Check badges
                this.checkBadges();
                
                return amount;
            },

            // Calculate level from XP
            calculateLevel(xp) {
                for (let i = this.levelThresholds.length - 1; i >= 0; i--) {
                    if (xp >= this.levelThresholds[i]) {
                        return i + 1;
                    }
                }
                return 1;
            },

            // Get level title
            getLevelTitle(level) {
                let title = 'تازه‌کار';
                for (const [lvl, name] of Object.entries(this.levelTitles)) {
                    if (level >= parseInt(lvl)) {
                        title = name;
                    }
                }
                return title;
            },

            // Get XP for next level
            getXPForNextLevel(level) {
                if (level >= this.levelThresholds.length) {
                    return this.levelThresholds[this.levelThresholds.length - 1] + 10000;
                }
                return this.levelThresholds[level];
            },

            // Get XP for current level
            getXPForCurrentLevel(level) {
                if (level <= 1) return 0;
                return this.levelThresholds[level - 1];
            },

            // Record a review
            recordReview(isCorrect) {
                const data = this.getData();
                data.totalReviews++;
                data.lastActivity = Date.now();
                
                // Update accuracy
                const reviews = DB.get('reviews', []);
                const recentReviews = reviews.slice(-100);
                const correctCount = recentReviews.filter(r => r.rating >= 3).length;
                data.avgAccuracy = recentReviews.length > 0 
                    ? Math.round((correctCount / recentReviews.length) * 100) 
                    : 0;
                
                // Calculate XP based on performance
                let xpGained = isCorrect ? 10 : 3;
                
                // Streak bonus
                const settings = Settings.get();
                if (settings.streak > 0) {
                    xpGained += Math.min(settings.streak, 10); // Max +10 XP from streak
                }
                
                // Update max streak
                if (settings.streak > data.maxStreak) {
                    data.maxStreak = settings.streak;
                }
                data.currentStreak = settings.streak;
                
                this.saveData(data);
                this.addXP(xpGained, isCorrect ? '✓' : '');
            },

            // Record mastery
            recordMastery() {
                const data = this.getData();
                data.totalMastered++;
                this.saveData(data);
                this.addXP(25, '🎓 تسلط!');
                this.checkBadges();
            },

            // Claim daily reward
            claimDailyReward() {
                const data = this.getData();
                const today = new Date().toDateString();
                
                if (data.dailyRewardClaimed === today) {
                    Toast.info('پاداش امروز را قبلاً دریافت کرده‌اید');
                    return;
                }
                
                data.dailyRewardClaimed = today;
                this.saveData(data);
                
                // Calculate reward based on streak
                const settings = Settings.get();
                const streakBonus = Math.min(settings.streak * 5, 50);
                const reward = 20 + streakBonus;
                
                this.addXP(reward, '🎁 پاداش روزانه');
                this.showConfetti();
                
                // Update button
                this.updateDailyRewardButton();
            },

            // Check and award badges
            checkBadges() {
                const data = this.getData();
                const stats = {
                    totalReviews: data.totalReviews,
                    totalMastered: data.totalMastered,
                    maxStreak: data.maxStreak,
                    avgAccuracy: data.avgAccuracy,
                    level: data.level
                };
                
                let newBadges = [];
                
                this.badges.forEach(badge => {
                    if (!data.earnedBadges.includes(badge.id) && badge.condition(stats)) {
                        data.earnedBadges.push(badge.id);
                        newBadges.push(badge);
                    }
                });
                
                if (newBadges.length > 0) {
                    this.saveData(data);
                    newBadges.forEach(badge => {
                        setTimeout(() => {
                            Toast.success(`🏅 مدال جدید: ${badge.name}`);
                            this.addXP(50, '🏅 مدال');
                        }, 500);
                    });
                    this.renderBadges();
                }
            },

            // Show level up modal
            showLevelUp(newLevel) {
                document.getElementById('newLevelDisplay').textContent = Utils.toPersian(newLevel);
                document.getElementById('levelUpReward').textContent = 
                    `🎁 ${Utils.toPersian(50)} XP جایزه دریافت کردید!`;
                document.getElementById('levelUpModal').classList.add('active');
                
                this.showConfetti();
                
                // Add bonus XP for leveling up
                const data = this.getData();
                data.xp += 50;
                this.saveData(data);
            },

            closeLevelUp() {
                document.getElementById('levelUpModal').classList.remove('active');
            },

            // Show badge detail
            showBadgeDetail(badgeId) {
                const badge = this.badges.find(b => b.id === badgeId);
                const data = this.getData();
                const isEarned = data.earnedBadges.includes(badgeId);
                
                document.getElementById('badgeDetailIcon').textContent = badge.icon;
                document.getElementById('badgeDetailName').textContent = badge.name;
                document.getElementById('badgeDetailDesc').textContent = badge.desc;
                document.getElementById('badgeDetailStatus').innerHTML = isEarned 
                    ? '<span style="color: var(--success);">✅ کسب شده</span>'
                    : '<span style="color: var(--text-tertiary);">🔒 قفل</span>';
                
                document.getElementById('badgeDetailModal').classList.add('active');
            },

            closeBadgeDetail() {
                document.getElementById('badgeDetailModal').classList.remove('active');
            },

            // Show confetti animation
            showConfetti() {
                const colors = ['#f59e0b', '#10b981', '#6366f1', '#ec4899', '#8b5cf6'];
                
                for (let i = 0; i < 50; i++) {
                    setTimeout(() => {
                        const confetti = document.createElement('div');
                        confetti.className = 'confetti';
                        confetti.style.left = Math.random() * 100 + 'vw';
                        confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                        confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                        confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                        document.body.appendChild(confetti);
                        
                        setTimeout(() => confetti.remove(), 4000);
                    }, i * 30);
                }
            },

            // Update UI
            updateUI() {
                const data = this.getData();
                const currentLevelXP = this.getXPForCurrentLevel(data.level);
                const nextLevelXP = this.getXPForNextLevel(data.level);
                const progressXP = data.xp - currentLevelXP;
                const neededXP = nextLevelXP - currentLevelXP;
                const progress = Math.min((progressXP / neededXP) * 100, 100);
                
                // Update level badge
                const levelBadge = document.getElementById('levelBadge');
                if (levelBadge) levelBadge.textContent = Utils.toPersian(data.level);
                
                // Update level text
                const currentLevel = document.getElementById('currentLevel');
                if (currentLevel) currentLevel.textContent = Utils.toPersian(data.level);
                
                // Update XP bar
                const xpBarFill = document.getElementById('xpBarFill');
                if (xpBarFill) xpBarFill.style.width = `${progress}%`;
                
                // Update XP text
                const currentXp = document.getElementById('currentXp');
                if (currentXp) currentXp.textContent = Utils.toPersian(progressXP);
                
                const nextLevelXpEl = document.getElementById('nextLevelXp');
                if (nextLevelXpEl) nextLevelXpEl.textContent = Utils.toPersian(neededXP);
                
                // Update level title
                const xpLevelText = document.querySelector('.xp-level-text');
                if (xpLevelText) {
                    xpLevelText.innerHTML = `سطح <span id="currentLevel">${Utils.toPersian(data.level)}</span> - ${this.getLevelTitle(data.level)}`;
                }
                
                this.updateDailyRewardButton();
                this.renderBadges();
            },

            // Update daily reward button
            updateDailyRewardButton() {
                const data = this.getData();
                const today = new Date().toDateString();
                const btn = document.getElementById('dailyRewardBtn');
                
                if (!btn) return;
                
                if (data.dailyRewardClaimed === today) {
                    btn.classList.add('claimed');
                    btn.innerHTML = '✓ پاداش امروز دریافت شد';
                    btn.disabled = true;
                } else {
                    btn.classList.remove('claimed');
                    btn.innerHTML = '🎁 دریافت پاداش روزانه';
                    btn.disabled = false;
                }
            },

            // Render badges grid
            renderBadges() {
                const grid = document.getElementById('badgesGrid');
                if (!grid) return;
                
                const data = this.getData();
                
                grid.innerHTML = this.badges.map(badge => {
                    const isEarned = data.earnedBadges.includes(badge.id);
                    return `
                        <div class="badge-item ${isEarned ? 'earned' : 'locked'}" 
                             onclick="Gamification.showBadgeDetail('${badge.id}')">
                            <div class="badge-icon">${badge.icon}</div>
                            <div class="badge-name">${badge.name}</div>
                        </div>
                    `;
                }).join('');
                
                // Update count
                const countEl = document.getElementById('earnedBadgesCount');
                if (countEl) {
                    countEl.textContent = `${Utils.toPersian(data.earnedBadges.length)}/${Utils.toPersian(this.badges.length)}`;
                }
            },

            // Initialize
            init() {
                this.updateUI();
                this.checkBadges();
            }
        };
		// ═══════════════════════════════════════════════════════════════
        // CHALLENGES SYSTEM
        // ═══════════════════════════════════════════════════════════════
        const Challenges = {
            // Challenge definitions
            definitions: {
                daily: [
                    {
                        id: 'daily_10',
                        icon: '📖',
                        title: 'مرور روزانه',
                        desc: '۱۰ کارت مرور کنید',
                        target: 10,
                        reward: 30,
                        type: 'reviews_today'
                    },
                    {
                        id: 'daily_20',
                        icon: '📚',
                        title: 'مرور پیشرفته',
                        desc: '۲۰ کارت مرور کنید',
                        target: 20,
                        reward: 50,
                        type: 'reviews_today'
                    },
                    {
                        id: 'daily_perfect',
                        icon: '💯',
                        title: 'بدون خطا',
                        desc: '۱۰ کارت متوالی بدون اشتباه',
                        target: 10,
                        reward: 75,
                        type: 'perfect_streak'
                    }
                ],
                weekly: [
                    {
                        id: 'weekly_100',
                        icon: '🎯',
                        title: 'یادگیرنده هفته',
                        desc: '۱۰۰ کارت در هفته مرور کنید',
                        target: 100,
                        reward: 200,
                        type: 'reviews_week'
                    },
                    {
                        id: 'weekly_streak',
                        icon: '🔥',
                        title: 'هفت روز آتش',
                        desc: '۷ روز متوالی مرور کنید',
                        target: 7,
                        reward: 300,
                        type: 'streak'
                    },
                    {
                        id: 'weekly_mastery',
                        icon: '⭐',
                        title: 'تسلط هفتگی',
                        desc: 'به ۲۰ کلمه تسلط پیدا کنید',
                        target: 20,
                        reward: 250,
                        type: 'mastery_week'
                    }
                ],
                special: [
                    {
                        id: 'speed_demon',
                        icon: '⚡',
                        title: 'سرعتی',
                        desc: '۳۰ کارت در ۱۰ دقیقه',
                        target: 30,
                        reward: 150,
                        type: 'speed_challenge',
                        timeLimit: 600 // 10 minutes in seconds
                    },
                    {
                        id: 'night_owl',
                        icon: '🦉',
                        title: 'جغد شب',
                        desc: 'بین ۱۲ تا ۴ صبح مرور کنید',
                        target: 1,
                        reward: 50,
                        type: 'night_review'
                    },
                    {
                        id: 'early_bird',
                        icon: '🐦',
                        title: 'سحرخیز',
                        desc: 'قبل از ۷ صبح مرور کنید',
                        target: 1,
                        reward: 50,
                        type: 'morning_review'
                    }
                ]
            },

            // Get challenges data
            getData() {
                const today = new Date().toDateString();
                const data = DB.get('challenges', {
                    lastReset: null,
                    weekStart: null,
                    progress: {},
                    claimed: [],
                    perfectStreak: 0,
                    speedChallengeStart: null,
                    speedChallengeCount: 0
                });

                // Reset daily if needed
                if (data.lastReset !== today) {
                    data.lastReset = today;
                    data.progress.reviews_today = 0;
                    data.progress.perfect_streak = 0;
                    data.perfectStreak = 0;
                    // Remove daily claimed
                    data.claimed = data.claimed.filter(id => !id.startsWith('daily_'));
                }

                // Reset weekly if needed
                const weekStart = this.getWeekStart();
                if (data.weekStart !== weekStart) {
                    data.weekStart = weekStart;
                    data.progress.reviews_week = 0;
                    data.progress.mastery_week = 0;
                    // Remove weekly claimed
                    data.claimed = data.claimed.filter(id => !id.startsWith('weekly_'));
                }

                DB.set('challenges', data);
                return data;
            },

            getWeekStart() {
                const now = new Date();
                const dayOfWeek = now.getDay();
                const diff = now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
                return new Date(now.setDate(diff)).toDateString();
            },

            // Record progress
            recordProgress(type, amount = 1) {
                const data = this.getData();
                
                if (!data.progress[type]) {
                    data.progress[type] = 0;
                }
                data.progress[type] += amount;

                // Handle perfect streak
                if (type === 'correct_answer') {
                    data.perfectStreak++;
                    data.progress.perfect_streak = Math.max(data.progress.perfect_streak || 0, data.perfectStreak);
                } else if (type === 'wrong_answer') {
                    data.perfectStreak = 0;
                }

                // Handle streak from settings
                const settings = Settings.get();
                data.progress.streak = settings.streak;

                DB.set('challenges', data);
                this.checkCompletion();
            },

            // Start speed challenge
            startSpeedChallenge() {
                const data = this.getData();
                data.speedChallengeStart = Date.now();
                data.speedChallengeCount = 0;
                DB.set('challenges', data);
                Toast.info('⚡ چالش سرعتی شروع شد! ۱۰ دقیقه فرصت دارید');
            },

            // Record speed challenge progress
            recordSpeedProgress() {
                const data = this.getData();
                if (!data.speedChallengeStart) return;

                const elapsed = (Date.now() - data.speedChallengeStart) / 1000;
                if (elapsed <= 600) { // 10 minutes
                    data.speedChallengeCount++;
                    data.progress.speed_challenge = data.speedChallengeCount;
                    DB.set('challenges', data);
                } else {
                    // Time's up
                    data.speedChallengeStart = null;
                    DB.set('challenges', data);
                }
            },

            // Check time-based challenges
            checkTimeChallenge() {
                const hour = new Date().getHours();
                const data = this.getData();

                // Night owl (12am - 4am)
                if (hour >= 0 && hour < 4) {
                    data.progress.night_review = 1;
                }

                // Early bird (before 7am)
                if (hour >= 5 && hour < 7) {
                    data.progress.morning_review = 1;
                }

                DB.set('challenges', data);
            },

            // Check completion
            checkCompletion() {
                const data = this.getData();
                
                const allChallenges = [
                    ...this.definitions.daily,
                    ...this.definitions.weekly,
                    ...this.definitions.special
                ];

                allChallenges.forEach(challenge => {
                    const progress = data.progress[challenge.type] || 0;
                    if (progress >= challenge.target && !data.claimed.includes(challenge.id)) {
                        // Mark as completed but not claimed
                        // User needs to manually claim
                    }
                });

                if (document.getElementById('challengesModal')?.classList.contains('active')) {
                    this.render();
                }
            },

            // Claim reward
            claimReward(challengeId) {
                const data = this.getData();
                
                if (data.claimed.includes(challengeId)) {
                    Toast.info('این جایزه قبلاً دریافت شده');
                    return;
                }

                const allChallenges = [
                    ...this.definitions.daily,
                    ...this.definitions.weekly,
                    ...this.definitions.special
                ];

                const challenge = allChallenges.find(c => c.id === challengeId);
                if (!challenge) return;

                const progress = data.progress[challenge.type] || 0;
                if (progress < challenge.target) {
                    Toast.warning('هنوز این چالش تکمیل نشده');
                    return;
                }

                data.claimed.push(challengeId);
                DB.set('challenges', data);

                Gamification.addXP(challenge.reward, '🏆 چالش');
                Gamification.showConfetti();
                
                this.render();
            },

            // Open modal
            open() {
                document.getElementById('challengesModal').classList.add('active');
                this.render();
            },

            close() {
                document.getElementById('challengesModal').classList.remove('active');
            },

            // Render challenges
            render() {
                const data = this.getData();

                this.renderCategory('dailyChallenges', this.definitions.daily, data);
                this.renderCategory('weeklyChallenges', this.definitions.weekly, data);
                this.renderCategory('specialChallenges', this.definitions.special, data);
            },

            renderCategory(containerId, challenges, data) {
                const container = document.getElementById(containerId);
                if (!container) return;

                container.innerHTML = challenges.map(challenge => {
                    const progress = data.progress[challenge.type] || 0;
                    const percentage = Math.min((progress / challenge.target) * 100, 100);
                    const isCompleted = progress >= challenge.target;
                    const isClaimed = data.claimed.includes(challenge.id);

                    return `
                        <div class="challenge-card ${isCompleted ? 'completed' : ''} ${!isClaimed && isCompleted ? 'active' : ''}">
                            <div class="challenge-header">
                                <div class="challenge-icon">${challenge.icon}</div>
                                <div class="challenge-info">
                                    <div class="challenge-title">${challenge.title}</div>
                                    <div class="challenge-desc">${challenge.desc}</div>
                                </div>
                                <div class="challenge-reward">
                                    <span>⚡</span>
                                    <span>${Utils.toPersian(challenge.reward)}</span>
                                </div>
                            </div>
                            <div class="challenge-progress">
                                <div class="challenge-progress-bar">
                                    <div class="challenge-progress-fill" style="width: ${percentage}%"></div>
                                </div>
                                <div class="challenge-progress-text">
                                    <span>${Utils.toPersian(Math.min(progress, challenge.target))} / ${Utils.toPersian(challenge.target)}</span>
                                    <span>${Utils.toPersian(Math.round(percentage))}٪</span>
                                </div>
                            </div>
                            ${isClaimed ? `
                                <button class="challenge-btn" disabled style="opacity: 0.5;">
                                    ✓ دریافت شد
                                </button>
                            ` : isCompleted ? `
                                <button class="challenge-btn claim" onclick="Challenges.claimReward('${challenge.id}')">
                                    🎁 دریافت جایزه
                                </button>
                            ` : challenge.type === 'speed_challenge' && !data.speedChallengeStart ? `
                                <button class="challenge-btn" onclick="Challenges.startSpeedChallenge()">
                                    ⚡ شروع چالش
                                </button>
                            ` : `
                                <button class="challenge-btn" onclick="Challenges.close(); Navigation.go('library');">
                                    شروع مرور
                                </button>
                            `}
                            ${challenge.timeLimit && data.speedChallengeStart ? `
                                <div class="challenge-time">⏱️ زمان باقی‌مانده: ${this.formatTimeLeft(data.speedChallengeStart, challenge.timeLimit)}</div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            },

            formatTimeLeft(startTime, limit) {
                const elapsed = (Date.now() - startTime) / 1000;
                const remaining = Math.max(0, limit - elapsed);
                const minutes = Math.floor(remaining / 60);
                const seconds = Math.floor(remaining % 60);
                return `${Utils.toPersian(minutes)}:${Utils.toPersian(seconds.toString().padStart(2, '0'))}`;
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // ADVANCED STATS
        // ═══════════════════════════════════════════════════════════════
        const AdvancedStats = {
            currentYear: new Date().getFullYear(),

            open() {
                document.getElementById('advancedStatsModal').classList.add('active');
                this.render();
            },

            close() {
                document.getElementById('advancedStatsModal').classList.remove('active');
            },

            prevYear() {
                this.currentYear--;
                this.renderHeatmap();
                document.getElementById('heatmapYear').textContent = Utils.toPersian(this.currentYear);
            },

            nextYear() {
                if (this.currentYear < new Date().getFullYear()) {
                    this.currentYear++;
                    this.renderHeatmap();
                    document.getElementById('heatmapYear').textContent = Utils.toPersian(this.currentYear);
                }
            },

            render() {
                this.renderMiniStats();
                this.renderHeatmap();
                this.renderWeakness();
                this.renderProgressChart();
            },

            renderMiniStats() {
                const gamificationData = Gamification.getData();
                const cards = CardManager.getAll();
                
                // Calculate total mastered
                let totalMastered = 0;
                Object.values(cards).forEach(card => {
                    if (card.stability >= 30) totalMastered++;
                });

                document.getElementById('totalXpStat').textContent = Utils.toPersian(gamificationData.xp);
                document.getElementById('maxStreakStat').textContent = Utils.toPersian(gamificationData.maxStreak);
                document.getElementById('avgAccuracyStat').textContent = `${Utils.toPersian(gamificationData.avgAccuracy)}٪`;
                document.getElementById('totalMasteredStat').textContent = Utils.toPersian(totalMastered);
            },

            renderHeatmap() {
                const grid = document.getElementById('heatmapGrid');
                if (!grid) return;

                const reviews = DB.get('reviews', []);
                const reviewsByDay = {};

                // Count reviews per day
                reviews.forEach(review => {
                    const date = new Date(review.timestamp).toDateString();
                    reviewsByDay[date] = (reviewsByDay[date] || 0) + 1;
                });

                // Generate cells for the year
                let html = '';
                const startDate = new Date(this.currentYear, 0, 1);
                const endDate = new Date(this.currentYear, 11, 31);
                
                // Adjust start to first Saturday
                const startDay = startDate.getDay();
                startDate.setDate(startDate.getDate() - startDay);

                const current = new Date(startDate);
                while (current <= endDate || current.getDay() !== 6) {
                    const dateStr = current.toDateString();
                    const count = reviewsByDay[dateStr] || 0;
                    let level = 0;
                    
                    if (count > 0) level = 1;
                    if (count >= 5) level = 2;
                    if (count >= 10) level = 3;
                    if (count >= 20) level = 4;
                    if (count >= 30) level = 5;

                    const isCurrentYear = current.getFullYear() === this.currentYear;
                    const isFuture = current > new Date();

                    html += `<div class="heatmap-cell ${isCurrentYear && !isFuture ? `level-${level}` : ''}" 
                                  title="${isCurrentYear ? `${current.toLocaleDateString('fa-IR')}: ${Utils.toPersian(count)} مرور` : ''}"></div>`;
                    
                    current.setDate(current.getDate() + 1);
                }

                grid.innerHTML = html;
                document.getElementById('heatmapYear').textContent = Utils.toPersian(this.currentYear);
            },

            renderWeakness() {
                const container = document.getElementById('weaknessCard');
                if (!container) return;

                const reviews = DB.get('reviews', []);
                const cardStats = {};

                // Calculate accuracy per card
                reviews.forEach(review => {
                    if (!cardStats[review.cardId]) {
                        cardStats[review.cardId] = { correct: 0, total: 0 };
                    }
                    cardStats[review.cardId].total++;
                    if (review.rating >= 3) {
                        cardStats[review.cardId].correct++;
                    }
                });

                // Find weakest cards
                const cards = CardManager.getAll();
                const weakCards = Object.entries(cardStats)
                    .filter(([cardId, stats]) => stats.total >= 3) // At least 3 reviews
                    .map(([cardId, stats]) => ({
                        card: cards[cardId],
                        accuracy: Math.round((stats.correct / stats.total) * 100),
                        attempts: stats.total
                    }))
                    .filter(item => item.card && item.accuracy < 70) // Less than 70% accuracy
                    .sort((a, b) => a.accuracy - b.accuracy)
                    .slice(0, 5);

                if (weakCards.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 30px; color: var(--text-secondary);">
                            <div style="font-size: 48px; margin-bottom: 12px;">🎉</div>
                            <div>عالی! هیچ نقطه ضعفی پیدا نشد</div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = weakCards.map((item, index) => `
                    <div class="weakness-item">
                        <div class="weakness-rank">${Utils.toPersian(index + 1)}</div>
                        <div class="weakness-info">
                            <div class="weakness-word">${item.card.word}</div>
                            <div class="weakness-meaning">${item.card.meaning}</div>
                        </div>
                        <div class="weakness-stats">
                            <div class="weakness-accuracy">${Utils.toPersian(item.accuracy)}٪</div>
                            <div class="weakness-attempts">${Utils.toPersian(item.attempts)} تلاش</div>
                        </div>
                    </div>
                `).join('');
            },

            renderProgressChart() {
                const container = document.getElementById('progressChart');
                if (!container) return;

                const reviews = DB.get('reviews', []);
                const last7Days = [];
                
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toDateString();
                    
                    const dayReviews = reviews.filter(r => 
                        new Date(r.timestamp).toDateString() === dateStr
                    ).length;
                    
                    last7Days.push({
                        day: date.toLocaleDateString('fa-IR', { weekday: 'short' }),
                        count: dayReviews
                    });
                }

                const maxCount = Math.max(...last7Days.map(d => d.count), 1);

                container.innerHTML = last7Days.map(day => {
                    const height = (day.count / maxCount) * 140 + 10;
                    return `
                        <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                            <div style="font-size: 12px; font-weight: 700; color: var(--text-primary); margin-bottom: 8px;">
                                ${Utils.toPersian(day.count)}
                            </div>
                            <div style="
                                width: 100%;
                                max-width: 32px;
                                height: ${height}px;
                                background: linear-gradient(to top, var(--primary), var(--secondary));
                                border-radius: 6px 6px 0 0;
                                transition: height 0.5s ease;
                            "></div>
                            <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 8px;">
                                ${day.day}
                            </div>
                        </div>
                    `;
                }).join('');
            }
        };
		// ═══════════════════════════════════════════════════════════════
        // TAG SYSTEM
        // ═══════════════════════════════════════════════════════════════
        const TagSystem = {
            currentFilter: 'all',
            selectedCardId: null,

            // Default tags
            defaultTags: [
                { id: 'starred', name: 'ستاره‌دار', icon: '⭐', color: '#f59e0b' },
                { id: 'difficult', name: 'سخت', icon: '🔴', color: '#ef4444' },
                { id: 'easy', name: 'آسان', icon: '🟢', color: '#22c55e' },
                { id: 'important', name: 'مهم', icon: '❗', color: '#8b5cf6' },
                { id: 'review_later', name: 'مرور بعدی', icon: '🔄', color: '#3b82f6' },
                { id: 'noun', name: 'اسم', icon: '📝', color: '#6366f1' },
                { id: 'verb', name: 'فعل', icon: '🏃', color: '#ec4899' },
                { id: 'adjective', name: 'صفت', icon: '🎨', color: '#14b8a6' },
                { id: 'adverb', name: 'قید', icon: '⚡', color: '#f97316' }
            ],

            // Get tags data
            getData() {
                return DB.get('tags', {
                    customTags: [],
                    cardTags: {} // { cardId: [tagId, tagId, ...] }
                });
            },

            saveData(data) {
                DB.set('tags', data);
            },

            // Get all tags (default + custom)
            getAllTags() {
                const data = this.getData();
                return [...this.defaultTags, ...data.customTags];
            },

            // Add tag to card
            addTagToCard(cardId, tagId) {
                const data = this.getData();
                
                if (!data.cardTags[cardId]) {
                    data.cardTags[cardId] = [];
                }
                
                if (!data.cardTags[cardId].includes(tagId)) {
                    data.cardTags[cardId].push(tagId);
                    this.saveData(data);
                    Toast.success('تگ اضافه شد');
                }
            },

            // Remove tag from card
            removeTagFromCard(cardId, tagId) {
                const data = this.getData();
                
                if (data.cardTags[cardId]) {
                    data.cardTags[cardId] = data.cardTags[cardId].filter(t => t !== tagId);
                    this.saveData(data);
                }
            },

            // Get tags for a card
            getCardTags(cardId) {
                const data = this.getData();
                const tagIds = data.cardTags[cardId] || [];
                const allTags = this.getAllTags();
                
                return tagIds.map(id => allTags.find(t => t.id === id)).filter(Boolean);
            },

            // Toggle star for card
            toggleStar(cardId) {
                const data = this.getData();
                
                if (!data.cardTags[cardId]) {
                    data.cardTags[cardId] = [];
                }
                
                const starIndex = data.cardTags[cardId].indexOf('starred');
                
                if (starIndex > -1) {
                    data.cardTags[cardId].splice(starIndex, 1);
                    Toast.info('از ستاره‌دارها حذف شد');
                } else {
                    data.cardTags[cardId].push('starred');
                    Toast.success('به ستاره‌دارها اضافه شد ⭐');
                }
                
                this.saveData(data);
                return data.cardTags[cardId].includes('starred');
            },

            // Check if card is starred
            isStarred(cardId) {
                const data = this.getData();
                return data.cardTags[cardId]?.includes('starred') || false;
            },

            // Create custom tag
            createTag(name, color = '#6366f1') {
                const data = this.getData();
                const id = 'custom_' + Date.now();
                
                data.customTags.push({
                    id: id,
                    name: name,
                    icon: '🏷️',
                    color: color
                });
                
                this.saveData(data);
                Toast.success(`تگ "${name}" ایجاد شد`);
                
                return id;
            },

            // Get cards by filter
            getFilteredCards(filter) {
                const cards = Object.values(CardManager.getAll());
                const data = this.getData();
                
                switch (filter) {
                    case 'all':
                        return cards;
                    
                    case 'starred':
                        return cards.filter(c => data.cardTags[c.id]?.includes('starred'));
                    
                    case 'difficult':
                        return cards.filter(c => c.difficulty >= 7 || data.cardTags[c.id]?.includes('difficult'));
                    
                    case 'new':
                        return cards.filter(c => !c.lastReview);
                    
                    case 'mastered':
                        return cards.filter(c => c.stability >= 30);
                    
                    case 'noun':
                    case 'verb':
                    case 'adjective':
                    case 'adverb':
                        return cards.filter(c => data.cardTags[c.id]?.includes(filter));
                    
                    default:
                        // Custom tag
                        return cards.filter(c => data.cardTags[c.id]?.includes(filter));
                }
            },

            // Count cards for each filter
            getCounts() {
                const cards = Object.values(CardManager.getAll());
                const data = this.getData();
                
                return {
                    all: cards.length,
                    starred: cards.filter(c => data.cardTags[c.id]?.includes('starred')).length,
                    difficult: cards.filter(c => c.difficulty >= 7 || data.cardTags[c.id]?.includes('difficult')).length,
                    new: cards.filter(c => !c.lastReview).length,
                    mastered: cards.filter(c => c.stability >= 30).length,
                    noun: cards.filter(c => data.cardTags[c.id]?.includes('noun')).length,
                    verb: cards.filter(c => data.cardTags[c.id]?.includes('verb')).length,
                    adjective: cards.filter(c => data.cardTags[c.id]?.includes('adjective')).length,
                    adverb: cards.filter(c => data.cardTags[c.id]?.includes('adverb')).length
                };
            },

            // Open tag manager
            open() {
                document.getElementById('tagManagerModal').classList.add('active');
                this.currentFilter = 'all';
                this.updateCounts();
                this.renderFilteredCards();
            },

            close() {
                document.getElementById('tagManagerModal').classList.remove('active');
            },

            // Filter cards
            filter(tag) {
                this.currentFilter = tag;
                
                // Update active button
                document.querySelectorAll('.tag-filter-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.tag === tag);
                });
                
                this.renderFilteredCards();
            },

            // Update tag counts
            updateCounts() {
                const counts = this.getCounts();
                
                document.getElementById('tagCountAll').textContent = Utils.toPersian(counts.all);
                document.getElementById('tagCountStarred').textContent = Utils.toPersian(counts.starred);
                document.getElementById('tagCountDifficult').textContent = Utils.toPersian(counts.difficult);
                document.getElementById('tagCountNew').textContent = Utils.toPersian(counts.new);
                document.getElementById('tagCountMastered').textContent = Utils.toPersian(counts.mastered);
                
                const nounEl = document.getElementById('tagCountNoun');
                const verbEl = document.getElementById('tagCountVerb');
                const adjEl = document.getElementById('tagCountAdjective');
                const advEl = document.getElementById('tagCountAdverb');
                
                if (nounEl) nounEl.textContent = Utils.toPersian(counts.noun);
                if (verbEl) verbEl.textContent = Utils.toPersian(counts.verb);
                if (adjEl) adjEl.textContent = Utils.toPersian(counts.adjective);
                if (advEl) advEl.textContent = Utils.toPersian(counts.adverb);
            },

            // Render filtered cards
            renderFilteredCards() {
                const container = document.getElementById('filteredCardsList');
                const countEl = document.getElementById('filteredCount');
                
                if (!container) return;
                
                const cards = this.getFilteredCards(this.currentFilter);
                countEl.textContent = Utils.toPersian(cards.length);
                
                if (cards.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <div style="font-size: 48px; margin-bottom: 12px;">📭</div>
                            <div>کارتی با این فیلتر یافت نشد</div>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = cards.slice(0, 50).map(card => {
                    const tags = this.getCardTags(card.id);
                    const isStarred = this.isStarred(card.id);
                    
                    return `
                        <div class="weakness-item" style="cursor: pointer;" onclick="TagSystem.showCardActions('${card.id}')">
                            <button class="star-btn ${isStarred ? 'starred' : ''}" 
                                    onclick="event.stopPropagation(); TagSystem.toggleStarUI('${card.id}', this)">
                                ${isStarred ? '⭐' : '☆'}
                            </button>
                            <div class="weakness-info" style="flex: 1;">
                                <div class="weakness-word">${card.word}</div>
                                <div class="weakness-meaning">${card.meaning}</div>
                                ${tags.length > 0 ? `
                                    <div class="card-tags">
                                        ${tags.map(t => `<span class="card-tag" style="border-color: ${t.color}; color: ${t.color};">${t.icon} ${t.name}</span>`).join('')}
                                    </div>
                                ` : ''}
                            </div>
                            <button class="weakness-practice-btn" onclick="event.stopPropagation(); TagSystem.openAddTag('${card.id}')">
                                🏷️
                            </button>
                        </div>
                    `;
                }).join('');
            },

            // Toggle star UI
            toggleStarUI(cardId, btn) {
                const isStarred = this.toggleStar(cardId);
                btn.classList.toggle('starred', isStarred);
                btn.textContent = isStarred ? '⭐' : '☆';
                this.updateCounts();
            },

            // Show card actions
            showCardActions(cardId) {
                const card = CardManager.getAll()[cardId];
                if (!card) return;
                
                // Could open a detail modal or start review
                Toast.info(`${card.word}: ${card.meaning}`);
            },

            // Open add tag modal
            openAddTag(cardId) {
                this.selectedCardId = cardId;
                
                const allTags = this.getAllTags();
                const currentTags = this.getCardTags(cardId).map(t => t.id);
                
                const container = document.getElementById('tagSelectOptions');
                container.innerHTML = allTags.map(tag => `
                    <button class="tag-filter-btn ${currentTags.includes(tag.id) ? 'active' : ''}" 
                            data-tag="${tag.id}"
                            onclick="TagSystem.toggleTagSelection('${tag.id}', this)"
                            style="border-color: ${tag.color};">
                        ${tag.icon} ${tag.name}
                    </button>
                `).join('');
                
                document.getElementById('newTagInput').value = '';
                document.getElementById('addTagModal').classList.add('active');
            },

            closeAddTag() {
                document.getElementById('addTagModal').classList.remove('active');
                this.selectedCardId = null;
            },

            toggleTagSelection(tagId, btn) {
                btn.classList.toggle('active');
            },

            confirmAddTag() {
                if (!this.selectedCardId) return;
                
                const data = this.getData();
                const cardId = this.selectedCardId;
                
                // Get selected tags from buttons
                const selectedTags = [];
                document.querySelectorAll('#tagSelectOptions .tag-filter-btn.active').forEach(btn => {
                    selectedTags.push(btn.dataset.tag);
                });
                
                // Check for new tag
                const newTagName = document.getElementById('newTagInput').value.trim();
                if (newTagName) {
                    const newTagId = this.createTag(newTagName);
                    selectedTags.push(newTagId);
                }
                
                // Update card tags
                data.cardTags[cardId] = selectedTags;
                this.saveData(data);
                
                this.closeAddTag();
                this.updateCounts();
                this.renderFilteredCards();
                
                Toast.success('تگ‌ها به‌روز شد');
            },

            // Practice starred cards
            practiceStarred() {
                const starredCards = this.getFilteredCards('starred');
                
                if (starredCards.length === 0) {
                    Toast.warning('هیچ کارت ستاره‌داری ندارید');
                    return;
                }
                
                // Start review with starred cards only
                Review.cards = starredCards;
                Review.currentIndex = 0;
                Review.sessionStats = { reviewed: 0, correct: 0 };
                Review.reviewMode = 'recognition';
                
                document.getElementById('flashcardModal').classList.add('active');
                document.getElementById('completeScreen').classList.remove('active');
                document.querySelectorAll('.card-mode').forEach(m => m.classList.remove('active'));
                document.getElementById('recognitionMode').classList.add('active');
                
                Review.showCard();
                this.close();
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // INTEGRATION - Update existing functions
        // ═══════════════════════════════════════════════════════════════

        // Extend Review.rate to include gamification
        const originalRate = Review.rate;
        Review.rate = function(rating) {
            const isCorrect = rating >= 3;
            
            // Record for challenges
            Challenges.recordProgress('reviews_today');
            Challenges.recordProgress('reviews_week');
            Challenges.recordProgress(isCorrect ? 'correct_answer' : 'wrong_answer');
            Challenges.checkTimeChallenge();
            Challenges.recordSpeedProgress();
            
            // Record for gamification
            Gamification.recordReview(isCorrect);
            
            // Check mastery
            if (this.currentCard) {
                const newStability = FSRS.calculate(this.currentCard, rating).stability;
                const oldStability = this.currentCard.stability || 0;
                
                if (oldStability < 30 && newStability >= 30) {
                    Gamification.recordMastery();
                    Challenges.recordProgress('mastery_week');
                }
            }
            
            // Call original
            originalRate.call(this, rating);
        };

        // Add star button to flashcard
        const addStarToFlashcard = () => {
            const flashcardBack = document.querySelector('.flashcard-back');
            if (flashcardBack && !flashcardBack.querySelector('.star-btn')) {
                const starBtn = document.createElement('button');
                starBtn.className = 'star-btn';
                starBtn.style.cssText = 'position: absolute; top: 12px; left: 12px;';
                starBtn.onclick = (e) => {
                    e.stopPropagation();
                    if (Review.currentCard) {
                        const isStarred = TagSystem.toggleStar(Review.currentCard.id);
                        starBtn.classList.toggle('starred', isStarred);
                        starBtn.textContent = isStarred ? '⭐' : '☆';
                    }
                };
                flashcardBack.appendChild(starBtn);
            }
        };

        // Update star button when showing card
        const originalShowCard = Review.showCard;
        Review.showCard = function() {
            originalShowCard.call(this);
            
            if (this.currentCard) {
                const starBtn = document.querySelector('.flashcard-back .star-btn');
                if (starBtn) {
                    const isStarred = TagSystem.isStarred(this.currentCard.id);
                    starBtn.classList.toggle('starred', isStarred);
                    starBtn.textContent = isStarred ? '⭐' : '☆';
                }
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // FINAL INITIALIZATION
        // ═══════════════════════════════════════════════════════════════
        const originalAppInit = App.init;
        App.init = function() {
            // Call original init
            originalAppInit.call(this);
            
            // Initialize gamification
            Gamification.init();
            
            // Add star button to flashcard
            setTimeout(addStarToFlashcard, 100);
            
            // Log
            console.log('✅ LEXORA v2.5 - Gamification, Challenges, Stats, Tags initialized');
        };

        // Re-initialize if already loaded
        if (document.readyState === 'complete') {
            Gamification.init();
            setTimeout(addStarToFlashcard, 100);
        }
		// ═══════════════════════════════════════════════════════════════
        // VOICE MODE - Speech Recognition & Audio
        // ═══════════════════════════════════════════════════════════════
        const VoiceMode = {
            currentMode: 'listen', // 'listen' or 'speak'
            currentIndex: 0,
            words: [],
            isPlaying: false,
            isRecording: false,
            recognition: null,
            speechSpeed: 0.75,
            autoPlay: false,

            // Initialize
            init() {
                // Check for Speech Recognition support
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    this.recognition.continuous = false;
                    this.recognition.interimResults = true;
                    this.recognition.lang = 'en-US';

                    this.recognition.onresult = (event) => {
                        const result = event.results[event.results.length - 1];
                        const transcript = result[0].transcript.toLowerCase().trim();
                        this.handleRecognitionResult(transcript, result.isFinal);
                    };

                    this.recognition.onend = () => {
                        this.isRecording = false;
                        this.updateRecordingUI();
                    };

                    this.recognition.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        this.isRecording = false;
                        this.updateRecordingUI();
                        
                        if (event.error === 'not-allowed') {
                            Toast.warning('لطفاً دسترسی میکروفون را فعال کنید');
                        }
                    };
                }
            },

            // Open modal
            open() {
                this.loadWords();
                document.getElementById('voiceModeModal').classList.add('active');
                this.render();
            },

            close() {
                document.getElementById('voiceModeModal').classList.remove('active');
                this.stopPlay();
                if (this.isRecording) {
                    this.stopRecording();
                }
            },

            // Load words from cards
            loadWords() {
                const cards = Object.values(CardManager.getAll());
                this.words = cards.slice(0, 50).map(card => ({
                    id: card.id,
                    word: card.word,
                    meaning: card.meaning,
                    pronunciation: card.pronunciation || '',
                    example: card.example || ''
                }));

                if (this.words.length === 0) {
                    this.words = [
                        { word: 'Hello', meaning: 'سلام', pronunciation: '/həˈloʊ/' },
                        { word: 'World', meaning: 'جهان', pronunciation: '/wɜːrld/' },
                        { word: 'Learn', meaning: 'یاد گرفتن', pronunciation: '/lɜːrn/' }
                    ];
                }
            },

            // Set mode (listen/speak)
            setMode(mode) {
                this.currentMode = mode;
                
                document.querySelectorAll('#voiceModeModal .mode-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');

                document.getElementById('voiceListenMode').style.display = mode === 'listen' ? 'block' : 'none';
                document.getElementById('voiceSpeakMode').style.display = mode === 'speak' ? 'block' : 'none';

                this.render();
            },

            // Render current word
            render() {
                if (this.words.length === 0) return;
                
                const word = this.words[this.currentIndex];

                // Listen mode
                document.getElementById('audioWord').textContent = word.word;
                document.getElementById('audioPronunciation').textContent = word.pronunciation || '';
                document.getElementById('audioMeaning').textContent = word.meaning;
                document.getElementById('audioExample').textContent = word.example || '';
                document.getElementById('audioMeaningReveal').style.display = 'none';

                // Speak mode
                document.getElementById('speakTargetWord').textContent = word.word;
                document.getElementById('speakTargetPron').textContent = word.pronunciation || '';
                document.getElementById('voiceResult').style.display = 'none';
                document.getElementById('voiceStatus').textContent = 'برای شروع ضبط کلیک کنید';

                this.renderWordList();
            },

            // Render word list
            renderWordList() {
                const container = document.getElementById('voiceWordList');
                if (!container) return;

                container.innerHTML = this.words.map((word, index) => `
                    <div class="weakness-item" style="cursor: pointer; ${index === this.currentIndex ? 'background: var(--primary-light);' : ''}" 
                         onclick="VoiceMode.goToWord(${index})">
                        <div style="font-size: 18px; margin-left: 12px;">
                            ${index === this.currentIndex ? '🔊' : '📝'}
                        </div>
                        <div class="weakness-info">
                            <div class="weakness-word">${word.word}</div>
                            <div class="weakness-meaning">${word.meaning}</div>
                        </div>
                        <button class="weakness-practice-btn" onclick="event.stopPropagation(); VoiceMode.playWord(${index})">
                            🔊
                        </button>
                    </div>
                `).join('');
            },

            // Navigation
            goToWord(index) {
                this.currentIndex = index;
                this.render();
            },

            prevWord() {
                if (this.currentIndex > 0) {
                    this.currentIndex--;
                    this.render();
                    if (this.autoPlay) this.playCurrentWord();
                }
            },

            nextWord() {
                if (this.currentIndex < this.words.length - 1) {
                    this.currentIndex++;
                    this.render();
                    if (this.autoPlay) this.playCurrentWord();
                }
            },

            nextSpeakWord() {
                this.nextWord();
            },

            // Audio Controls
            togglePlay() {
                if (this.isPlaying) {
                    this.stopPlay();
                } else {
                    this.playCurrentWord();
                }
            },

            playCurrentWord() {
                if (this.words.length === 0) return;
                this.playWord(this.currentIndex);
            },

            playWord(index) {
                const word = this.words[index];
                if (!word) return;

                this.stopPlay();
                this.isPlaying = true;
                this.updatePlayUI();

                AudioPlayer.speak(word.word, this.speechSpeed, () => {
                    this.isPlaying = false;
                    this.updatePlayUI();
                });
            },

            stopPlay() {
                this.isPlaying = false;
                speechSynthesis.cancel();
                this.updatePlayUI();
            },

            updatePlayUI() {
                const btn = document.getElementById('audioPlayBtn');
                const waveform = document.getElementById('audioWaveform');
                
                if (btn) {
                    btn.textContent = this.isPlaying ? '⏸️' : '▶️';
                }
                if (waveform) {
                    waveform.classList.toggle('paused', !this.isPlaying);
                }
            },

            // Speed control
            setSpeed(speed) {
                this.speechSpeed = speed;
                
                document.querySelectorAll('.speed-btn').forEach(btn => {
                    btn.classList.toggle('active', parseFloat(btn.dataset.speed) === speed);
                });

                Toast.info(`سرعت: ${speed}x`);
            },

            showMeaning() {
                document.getElementById('audioMeaningReveal').style.display = 'block';
            },

            // ═══════════════════════════════════════════════════════════════
            // VOICE RECOGNITION (Speak Mode)
            // ═══════════════════════════════════════════════════════════════
            
            toggleRecording() {
                if (this.isRecording) {
                    this.stopRecording();
                } else {
                    this.startRecording();
                }
            },

            startRecording() {
                if (!this.recognition) {
                    Toast.warning('مرورگر شما از تشخیص صدا پشتیبانی نمی‌کند');
                    return;
                }

                try {
                    this.recognition.start();
                    this.isRecording = true;
                    this.updateRecordingUI();
                    document.getElementById('voiceResult').style.display = 'none';
                    document.getElementById('voiceStatus').textContent = '🎤 در حال گوش دادن...';
                } catch (e) {
                    console.error('Error starting recognition:', e);
                }
            },

            stopRecording() {
                if (this.recognition && this.isRecording) {
                    this.recognition.stop();
                    this.isRecording = false;
                    this.updateRecordingUI();
                }
            },

            updateRecordingUI() {
                const btn = document.getElementById('voiceRecordBtn');
                if (btn) {
                    btn.classList.toggle('listening', this.isRecording);
                }
            },

            handleRecognitionResult(transcript, isFinal) {
                const statusEl = document.getElementById('voiceStatus');
                
                if (!isFinal) {
                    statusEl.textContent = `🎤 "${transcript}"`;
                    return;
                }

                // Final result
                const targetWord = this.words[this.currentIndex]?.word.toLowerCase();
                const spokenWord = transcript.toLowerCase().trim();
                
                const resultContainer = document.getElementById('voiceResult');
                const resultText = document.getElementById('voiceResultText');
                const resultFeedback = document.getElementById('voiceResultFeedback');
                
                resultContainer.style.display = 'block';
                resultText.textContent = `"${transcript}"`;

                // Check similarity
                const similarity = this.calculateSimilarity(spokenWord, targetWord);
                
                if (similarity >= 0.8) {
                    resultFeedback.innerHTML = `
                        <div style="color: var(--success); font-size: 48px; margin: 12px 0;">🎉</div>
                        <div style="color: var(--success); font-weight: 700; font-size: 18px;">عالی! تلفظ صحیح</div>
                        <div style="color: var(--text-secondary); font-size: 14px; margin-top: 8px;">
                            تطابق: ${Math.round(similarity * 100)}٪
                        </div>
                    `;
                    Gamification.addXP(5, '🎤 تلفظ صحیح');
                    
                    // Auto advance after success
                    setTimeout(() => {
                        this.nextSpeakWord();
                    }, 2000);
                } else if (similarity >= 0.5) {
                    resultFeedback.innerHTML = `
                        <div style="color: var(--warning); font-size: 48px; margin: 12px 0;">🤔</div>
                        <div style="color: var(--warning); font-weight: 700; font-size: 18px;">نزدیک بود!</div>
                        <div style="color: var(--text-secondary); font-size: 14px; margin-top: 8px;">
                            تطابق: ${Math.round(similarity * 100)}٪ - دوباره تلاش کنید
                        </div>
                    `;
                } else {
                    resultFeedback.innerHTML = `
                        <div style="color: var(--danger); font-size: 48px; margin: 12px 0;">😅</div>
                        <div style="color: var(--danger); font-weight: 700; font-size: 18px;">دوباره تلاش کنید</div>
                        <div style="color: var(--text-secondary); font-size: 14px; margin-top: 8px;">
                            به تلفظ صحیح گوش دهید و تکرار کنید
                        </div>
                    `;
                }

                statusEl.textContent = 'برای تلاش مجدد کلیک کنید';
            },

            // Calculate string similarity (Levenshtein distance based)
            calculateSimilarity(str1, str2) {
                if (str1 === str2) return 1;
                if (!str1 || !str2) return 0;

                const len1 = str1.length;
                const len2 = str2.length;
                const matrix = [];

                for (let i = 0; i <= len1; i++) {
                    matrix[i] = [i];
                }
                for (let j = 0; j <= len2; j++) {
                    matrix[0][j] = j;
                }

                for (let i = 1; i <= len1; i++) {
                    for (let j = 1; j <= len2; j++) {
                        const cost = str1[i - 1] === str2[j - 1] ? 0 : 1;
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j - 1] + cost
                        );
                    }
                }

                const maxLen = Math.max(len1, len2);
                return (maxLen - matrix[len1][len2]) / maxLen;
            },

            hearCorrect() {
                this.playCurrentWord();
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // ADVANCED AUDIO PLAYER
        // ═══════════════════════════════════════════════════════════════
        const AudioPlayer = {
            currentSpeed: 1,
            isPlaying: false,
            repeatMode: false,
            currentWord: null,

            // Speak word using Web Speech API
            speak(text, speed = 1, onEnd = null) {
                if (!text) return;

                // Cancel any ongoing speech
                speechSynthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = speed;
                utterance.pitch = 1;
                utterance.volume = 1;

                // Try to get a good English voice
                const voices = speechSynthesis.getVoices();
                const englishVoice = voices.find(v => 
                    v.lang.startsWith('en') && (v.name.includes('Google') || v.name.includes('Samantha') || v.name.includes('Alex'))
                ) || voices.find(v => v.lang.startsWith('en'));
                
                if (englishVoice) {
                    utterance.voice = englishVoice;
                }

                utterance.onend = () => {
                    this.isPlaying = false;
                    if (this.repeatMode) {
                        setTimeout(() => this.speak(text, speed, onEnd), 500);
                    } else if (onEnd) {
                        onEnd();
                    }
                };

                utterance.onerror = (e) => {
                    console.error('Speech error:', e);
                    this.isPlaying = false;
                };

                this.isPlaying = true;
                this.currentWord = text;
                speechSynthesis.speak(utterance);
            },

            // Speak with pronunciation guide
            speakWithPronunciation(word, pronunciation) {
                this.speak(word);
            },

            // Control methods
            toggle() {
                if (this.isPlaying) {
                    this.stop();
                } else if (this.currentWord) {
                    this.speak(this.currentWord, this.currentSpeed);
                }
            },

            stop() {
                speechSynthesis.cancel();
                this.isPlaying = false;
            },

            toggleRepeat() {
                this.repeatMode = !this.repeatMode;
                Toast.info(this.repeatMode ? '🔁 تکرار فعال' : '🔁 تکرار غیرفعال');
            },

            slower() {
                this.currentSpeed = Math.max(0.25, this.currentSpeed - 0.25);
                Toast.info(`سرعت: ${this.currentSpeed}x`);
                if (this.currentWord) {
                    this.speak(this.currentWord, this.currentSpeed);
                }
            },

            faster() {
                this.currentSpeed = Math.min(2, this.currentSpeed + 0.25);
                Toast.info(`سرعت: ${this.currentSpeed}x`);
                if (this.currentWord) {
                    this.speak(this.currentWord, this.currentSpeed);
                }
            },

            // Play word from flashcard
            playFlashcardWord(word) {
                this.currentWord = word;
                this.speak(word, this.currentSpeed);
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // WORD OF THE DAY
        // ═══════════════════════════════════════════════════════════════
        const WordOfDay = {
            word: null,

            init() {
                this.load();
            },

            load() {
                const cards = Object.values(CardManager.getAll());
                
                if (cards.length === 0) {
                    this.word = {
                        word: 'Serendipity',
                        meaning: 'خوش‌شانسی غیرمنتظره',
                        pronunciation: '/ˌserənˈdɪpɪti/'
                    };
                } else {
                    // Get a word based on today's date (consistent for the day)
                    const today = new Date().toDateString();
                    const savedWod = DB.get('wordOfDay', {});
                    
                    if (savedWod.date === today && savedWod.word) {
                        this.word = savedWod.word;
                    } else {
                        // Pick a new word
                        const seed = today.split('').reduce((a, c) => a + c.charCodeAt(0), 0);
                        const index = seed % cards.length;
                        this.word = cards[index];
                        
                        DB.set('wordOfDay', {
                            date: today,
                            word: this.word
                        });
                    }
                }

                this.render();
            },

            refresh() {
                const cards = Object.values(CardManager.getAll());
                if (cards.length > 0) {
                    const randomIndex = Math.floor(Math.random() * cards.length);
                    this.word = cards[randomIndex];
                    this.render();
                    Toast.success('کلمه جدید انتخاب شد');
                }
            },

            render() {
                if (!this.word) return;

                const wordEl = document.getElementById('wodWord');
                const meaningEl = document.getElementById('wodMeaning');

                if (wordEl) wordEl.textContent = this.word.word;
                if (meaningEl) meaningEl.textContent = this.word.meaning;
            },

            play() {
                if (this.word) {
                    AudioPlayer.speak(this.word.word);
                }
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // HOME PAGE UPDATES
        // ═══════════════════════════════════════════════════════════════
        const HomePage = {
            init() {
                this.updateGreeting();
                this.updateStats();
                this.updateProgress();
                this.updateStreak();
                this.updateBadges();
                this.updateQuickStart();
                this.updateDailyReward();
            },

            updateGreeting() {
                const hour = new Date().getHours();
                let greeting = 'سلام! 👋';
                
                if (hour >= 5 && hour < 12) {
                    greeting = 'صبح بخیر! ☀️';
                } else if (hour >= 12 && hour < 17) {
                    greeting = 'ظهر بخیر! 🌤️';
                } else if (hour >= 17 && hour < 21) {
                    greeting = 'عصر بخیر! 🌅';
                } else {
                    greeting = 'شب بخیر! 🌙';
                }

                const el = document.getElementById('heroGreeting');
                if (el) el.textContent = greeting;
            },

            updateStats() {
                const gamificationData = Gamification.getData();
                const settings = Settings.get();
                const cards = Object.values(CardManager.getAll());
                const reviews = DB.get('reviews', []);

                // Today's reviews
                const today = new Date().toDateString();
                const todayReviews = reviews.filter(r => 
                    new Date(r.timestamp).toDateString() === today
                ).length;

                // Mastered cards
                const mastered = cards.filter(c => c.stability >= 30).length;

                // Update hero section
                const streakEl = document.getElementById('heroStreak');
                if (streakEl) streakEl.textContent = Utils.toPersian(settings.streak || 0);

                const levelEl = document.getElementById('heroLevel');
                const badgeEl = document.getElementById('heroBadge');
                const levelNameEl = document.getElementById('heroLevelName');
                
                if (levelEl) levelEl.textContent = Utils.toPersian(gamificationData.level);
                if (badgeEl) badgeEl.textContent = Utils.toPersian(gamificationData.level);
                if (levelNameEl) levelNameEl.textContent = Gamification.getLevelTitle(gamificationData.level);

                // XP Bar
                const currentLevelXP = Gamification.getXPForCurrentLevel(gamificationData.level);
                const nextLevelXP = Gamification.getXPForNextLevel(gamificationData.level);
                const progressXP = gamificationData.xp - currentLevelXP;
                const neededXP = nextLevelXP - currentLevelXP;
                const progress = Math.min((progressXP / neededXP) * 100, 100);

                const xpBarEl = document.getElementById('heroXpBar');
                const xpCurrentEl = document.getElementById('heroXpCurrent');
                const xpNextEl = document.getElementById('heroXpNext');

                if (xpBarEl) xpBarEl.style.width = `${progress}%`;
                if (xpCurrentEl) xpCurrentEl.textContent = Utils.toPersian(progressXP);
                if (xpNextEl) xpNextEl.textContent = Utils.toPersian(neededXP);

                // Quick stats
                const statToday = document.getElementById('statTodayReviews');
                const statTotal = document.getElementById('statTotalCards');
                const statMastered = document.getElementById('statMastered');

                if (statToday) statToday.textContent = Utils.toPersian(todayReviews);
                if (statTotal) statTotal.textContent = Utils.toPersian(cards.length);
                if (statMastered) statMastered.textContent = Utils.toPersian(mastered);
            },

            updateProgress() {
                const settings = Settings.get();
                const reviews = DB.get('reviews', []);
                const today = new Date().toDateString();
                
                const todayReviews = reviews.filter(r => 
                    new Date(r.timestamp).toDateString() === today
                );
                
                const goal = settings.dailyGoal || 20;
                const reviewed = todayReviews.length;
                const percent = Math.min(Math.round((reviewed / goal) * 100), 100);

                // Update ring
                const ringFill = document.getElementById('progressRingFill');
                if (ringFill) {
                    const circumference = 2 * Math.PI * 40; // radius = 40
                    const offset = circumference - (percent / 100) * circumference;
                    ringFill.style.strokeDashoffset = offset;
                }

                // Update text
                const percentEl = document.getElementById('progressPercent');
                if (percentEl) percentEl.textContent = `${Utils.toPersian(percent)}٪`;

                // Update details
                const detailReviewed = document.getElementById('detailReviewed');
                const detailGoal = document.getElementById('detailGoal');
                const detailAccuracy = document.getElementById('detailAccuracy');

                if (detailReviewed) detailReviewed.textContent = `${Utils.toPersian(reviewed)} کارت`;
                if (detailGoal) detailGoal.textContent = `${Utils.toPersian(goal)} کارت`;
                
                if (detailAccuracy && todayReviews.length > 0) {
                    const correct = todayReviews.filter(r => r.rating >= 3).length;
                    const accuracy = Math.round((correct / todayReviews.length) * 100);
                    detailAccuracy.textContent = `${Utils.toPersian(accuracy)}٪`;
                }
            },

            updateStreak() {
                const container = document.getElementById('streakDays');
                if (!container) return;

                const settings = Settings.get();
                const reviews = DB.get('reviews', []);
                const today = new Date();
                
                let html = '';
                const dayNames = ['ش', 'ی', 'د', 'س', 'چ', 'پ', 'ج'];

                for (let i = 6; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toDateString();
                    
                    const hasReview = reviews.some(r => 
                        new Date(r.timestamp).toDateString() === dateStr
                    );
                    
                    const isToday = i === 0;
                    const dayIndex = date.getDay();

                    html += `
                        <div class="streak-day ${hasReview ? 'completed' : ''} ${isToday ? 'today' : ''}">
                            ${hasReview ? '🔥' : (isToday ? '?' : '')}
                        </div>
                    `;
                }

                container.innerHTML = html;
            },

            updateBadges() {
                const container = document.getElementById('badgesScrollContainer');
                const countEl = document.getElementById('badgeCount');
                if (!container) return;

                const gamificationData = Gamification.getData();
                
                container.innerHTML = Gamification.badges.map(badge => {
                    const isEarned = gamificationData.earnedBadges.includes(badge.id);
                    return `
                        <div class="badge-card ${isEarned ? 'earned' : 'locked'}" 
                             onclick="Gamification.showBadgeDetail('${badge.id}')">
                            <div class="badge-card-icon">${badge.icon}</div>
                            <div class="badge-card-name">${badge.name}</div>
                        </div>
                    `;
                }).join('');

                if (countEl) {
                    countEl.textContent = `${Utils.toPersian(gamificationData.earnedBadges.length)}/${Utils.toPersian(Gamification.badges.length)}`;
                }
            },

            updateQuickStart() {
                const container = document.getElementById('quickStartDecks');
                if (!container) return;

                const decks = DeckManager.getAll();
                const topDecks = decks.slice(0, 3);

                if (topDecks.length === 0) {
                    container.innerHTML = `
                        <div class="deck-card" onclick="Navigation.go('library')" style="text-align: center; padding: 30px;">
                            <div style="font-size: 48px; margin-bottom: 12px;">📚</div>
                            <div style="font-size: 16px; font-weight: 700; color: var(--text-primary);">
                                اولین Deck خود را بسازید
                            </div>
                            <div style="font-size: 14px; color: var(--text-secondary); margin-top: 8px;">
                                به کتابخانه بروید و شروع کنید
                            </div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = topDecks.map(deck => {
                    const cards = Object.values(CardManager.getAll()).filter(c => c.deckId === deck.id);
                    const dueCards = cards.filter(c => !c.nextReview || new Date(c.nextReview) <= new Date()).length;
                    
                    return `
                        <div class="deck-card" onclick="Library.selectDeck('${deck.id}')" style="margin-bottom: 12px;">
                            <div class="deck-icon">${deck.icon || '📚'}</div>
                            <div class="deck-info">
                                <div class="deck-name">${deck.name}</div>
                                <div class="deck-meta">${Utils.toPersian(cards.length)} کارت</div>
                            </div>
                            ${dueCards > 0 ? `
                                <div class="deck-badge">${Utils.toPersian(dueCards)}</div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            },

            updateDailyReward() {
                const gamificationData = Gamification.getData();
                const today = new Date().toDateString();
                const claimed = gamificationData.dailyRewardClaimed === today;

                const card = document.getElementById('dailyRewardCard');
                const desc = document.getElementById('dailyRewardDesc');
                const btnText = document.getElementById('dailyRewardBtnText');

                if (card) card.classList.toggle('claimed', claimed);
                if (desc) desc.textContent = claimed ? 'فردا دوباره بیایید!' : 'برای دریافت XP کلیک کنید!';
                if (btnText) btnText.textContent = claimed ? '✓' : 'دریافت';
            }
        };
		// ═══════════════════════════════════════════════════════════════
        // ENHANCED ANIMATIONS HELPER
        // ═══════════════════════════════════════════════════════════════
        const Animations = {
            // Add celebration effect to element
            celebrate(element) {
                if (!element) return;
                element.classList.add('celebrate');
                setTimeout(() => element.classList.remove('celebrate'), 600);
            },

            // Add float effect
            float(element) {
                if (!element) return;
                element.classList.add('floating');
            },

            // Pulse effect
            pulse(element) {
                if (!element) return;
                element.classList.add('pulse');
                setTimeout(() => element.classList.remove('pulse'), 2000);
            },

            // Shake effect for wrong answers
            shake(element) {
                if (!element) return;
                element.style.animation = 'shake 0.5s ease';
                setTimeout(() => element.style.animation = '', 500);
            },

            // Success ripple
            ripple(element) {
                if (!element) return;
                const ripple = document.createElement('div');
                ripple.className = 'ripple-effect';
                element.appendChild(ripple);
                setTimeout(() => ripple.remove(), 600);
            },

            // Counter animation
            animateCounter(element, start, end, duration = 1000) {
                if (!element) return;
                const range = end - start;
                const startTime = performance.now();
                
                const updateCounter = (currentTime) => {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    // Easing function
                    const easeOutQuart = 1 - Math.pow(1 - progress, 4);
                    const current = Math.round(start + (range * easeOutQuart));
                    
                    element.textContent = Utils.toPersian(current);
                    
                    if (progress < 1) {
                        requestAnimationFrame(updateCounter);
                    }
                };
                
                requestAnimationFrame(updateCounter);
            },

            // Progress bar animation
            animateProgress(element, targetPercent, duration = 1000) {
                if (!element) return;
                element.style.transition = `width ${duration}ms cubic-bezier(0.4, 0, 0.2, 1)`;
                element.style.width = `${targetPercent}%`;
            },

            // Stagger children animation
            staggerChildren(container, selector, delay = 100) {
                if (!container) return;
                const children = container.querySelectorAll(selector);
                children.forEach((child, index) => {
                    child.style.opacity = '0';
                    child.style.transform = 'translateY(20px)';
                    setTimeout(() => {
                        child.style.transition = 'all 0.4s ease';
                        child.style.opacity = '1';
                        child.style.transform = 'translateY(0)';
                    }, index * delay);
                });
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // WIDGET MANAGER
        // ═══════════════════════════════════════════════════════════════
        const Widgets = {
            // Motivational quotes
            quotes: [
                { text: 'هر روز یک قدم جلوتر', author: 'LEXORA' },
                { text: 'یادگیری پایان ندارد', author: 'LEXORA' },
                { text: 'امروز بهتر از دیروز', author: 'LEXORA' },
                { text: 'تکرار مادر مهارت است', author: 'ضرب‌المثل' },
                { text: 'ذهن مثل چتر است، وقتی باز باشد کار می‌کند', author: 'آلبرت انیشتین' }
            ],

            // Get random quote
            getQuote() {
                const index = Math.floor(Math.random() * this.quotes.length);
                return this.quotes[index];
            },

            // Create notification widget
            createNotification(title, message, type = 'info') {
                const colors = {
                    info: 'var(--primary)',
                    success: 'var(--success)',
                    warning: 'var(--warning)',
                    error: 'var(--danger)'
                };

                const icons = {
                    info: 'ℹ️',
                    success: '✅',
                    warning: '⚠️',
                    error: '❌'
                };

                return `
                    <div class="mini-widget" style="border-right: 4px solid ${colors[type]};">
                        <div class="mini-widget-header">
                            <div class="mini-widget-icon" style="background: ${colors[type]}20;">
                                ${icons[type]}
                            </div>
                            <div class="mini-widget-title">${title}</div>
                        </div>
                        <div style="font-size: 13px; color: var(--text-secondary);">${message}</div>
                    </div>
                `;
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // FINAL APP INITIALIZATION - UPDATED
        // ═══════════════════════════════════════════════════════════════
        const AppInit = {
            run() {
                // Initialize all systems
                VoiceMode.init();
                WordOfDay.init();
                
                // Load voices for speech synthesis
                if ('speechSynthesis' in window) {
                    speechSynthesis.getVoices();
                    speechSynthesis.onvoiceschanged = () => {
                        speechSynthesis.getVoices();
                    };
                }

                // Update home page
                HomePage.init();

                // Add animation to page transitions
                this.setupPageTransitions();

                // Setup periodic updates
                this.setupPeriodicUpdates();

                console.log('✅ LEXORA v3.0 - All features initialized');
            },

            setupPageTransitions() {
                // Add smooth transitions when navigating
                const originalGo = Navigation.go;
                Navigation.go = function(screenId) {
                    const currentScreen = document.querySelector('.screen.active');
                    if (currentScreen) {
                        currentScreen.style.opacity = '0';
                        currentScreen.style.transform = 'translateY(-10px)';
                    }
                    
                    setTimeout(() => {
                        originalGo.call(Navigation, screenId);
                        
                        const newScreen = document.querySelector('.screen.active');
                        if (newScreen) {
                            newScreen.style.opacity = '0';
                            newScreen.style.transform = 'translateY(20px)';
                            
                            requestAnimationFrame(() => {
                                newScreen.style.transition = 'all 0.4s ease';
                                newScreen.style.opacity = '1';
                                newScreen.style.transform = 'translateY(0)';
                            });
                        }

                        // Update home page when navigating to home
                        if (screenId === 'home') {
                            HomePage.init();
                        }
                    }, 150);
                };
            },

            setupPeriodicUpdates() {
                // Update home page every minute
                setInterval(() => {
                    if (document.querySelector('#home.active')) {
                        HomePage.updateStats();
                        HomePage.updateProgress();
                    }
                }, 60000);

                // Check for midnight reset
                setInterval(() => {
                    const now = new Date();
                    if (now.getHours() === 0 && now.getMinutes() === 0) {
                        HomePage.updateDailyReward();
                        WordOfDay.load();
                    }
                }, 60000);
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // OVERRIDE ORIGINAL INIT
        // ═══════════════════════════════════════════════════════════════
        const originalAppInit2 = App.init;
        App.init = function() {
            originalAppInit2.call(this);
            
            // Run new initializations
            setTimeout(() => {
                AppInit.run();
            }, 100);
        };

        // Re-run if already loaded
        if (document.readyState === 'complete') {
            setTimeout(() => {
                AppInit.run();
            }, 100);
        }

        // ═══════════════════════════════════════════════════════════════
        // ENHANCED FLASHCARD WITH AUDIO
        // ═══════════════════════════════════════════════════════════════
        const originalShowCard2 = Review.showCard;
        Review.showCard = function() {
            originalShowCard2.call(this);
            
            // Add audio button to flashcard if not exists
            const flashcardFront = document.querySelector('.flashcard-front');
            if (flashcardFront && this.currentCard && !flashcardFront.querySelector('.card-audio-btn')) {
                const audioBtn = document.createElement('button');
                audioBtn.className = 'card-audio-btn';
                audioBtn.innerHTML = '🔊';
                audioBtn.style.cssText = `
                    position: absolute;
                    top: 12px;
                    right: 12px;
                    width: 40px;
                    height: 40px;
                    border-radius: 50%;
                    border: none;
                    background: var(--bg-secondary);
                    font-size: 20px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    z-index: 10;
                `;
                audioBtn.onclick = (e) => {
                    e.stopPropagation();
                    if (this.currentCard) {
                        AudioPlayer.playFlashcardWord(this.currentCard.word);
                        audioBtn.style.transform = 'scale(1.2)';
                        setTimeout(() => audioBtn.style.transform = 'scale(1)', 200);
                    }
                };
                flashcardFront.style.position = 'relative';
                flashcardFront.appendChild(audioBtn);
            }

            // Update existing audio button
            const existingBtn = flashcardFront?.querySelector('.card-audio-btn');
            if (existingBtn) {
                existingBtn.onclick = (e) => {
                    e.stopPropagation();
                    if (this.currentCard) {
                        AudioPlayer.playFlashcardWord(this.currentCard.word);
                        existingBtn.style.transform = 'scale(1.2)';
                        setTimeout(() => existingBtn.style.transform = 'scale(1)', 200);
                    }
                };
            }
        };
		// ═══════════════════════════════════════════════════════════════
        // ADD CARD MANAGER
        // ═══════════════════════════════════════════════════════════════
        const AddCard = {
            save() {
                const word = document.getElementById('newCardWord')?.value.trim();
                const meaning = document.getElementById('newCardMeaning')?.value.trim();
                const pronunciation = document.getElementById('newCardPronunciation')?.value.trim();
                const example = document.getElementById('newCardExample')?.value.trim();
                const note = document.getElementById('newCardNote')?.value.trim();

                if (!word || !meaning) {
                    Toast.warning('لطفاً کلمه و معنی را وارد کنید');
                    return;
                }

                if (!Library.currentDeck) {
                    Toast.warning('لطفاً ابتدا یک Deck انتخاب کنید');
                    return;
                }

                const card = CardManager.create({
                    deckId: Library.currentDeck,
                    word: word,
                    meaning: meaning,
                    pronunciation: pronunciation,
                    example: example,
                    note: note
                });

                // Clear form
                document.getElementById('newCardWord').value = '';
                document.getElementById('newCardMeaning').value = '';
                document.getElementById('newCardPronunciation').value = '';
                document.getElementById('newCardExample').value = '';
                document.getElementById('newCardNote').value = '';

                Toast.success('کارت اضافه شد');
                Gamification.addXP(5, '➕ کارت جدید');
                
                document.getElementById('addCardModal').classList.remove('active');
                Library.renderCards();
            },

            saveEdit() {
                const cardId = document.getElementById('editCardId')?.value;
                const word = document.getElementById('editCardWord')?.value.trim();
                const meaning = document.getElementById('editCardMeaning')?.value.trim();
                const example = document.getElementById('editCardExample')?.value.trim();

                if (!cardId || !word || !meaning) {
                    Toast.warning('لطفاً فیلدهای ضروری را پر کنید');
                    return;
                }

                const cards = CardManager.getAll();
                if (cards[cardId]) {
                    cards[cardId].word = word;
                    cards[cardId].meaning = meaning;
                    cards[cardId].example = example;
                    DB.set('cards', cards);
                    
                    Toast.success('کارت ویرایش شد');
                    document.getElementById('editCardModal').classList.remove('active');
                    Library.renderCards();
                }
            },

            async fetchFromDictionary() {
                const word = document.getElementById('newCardWord')?.value.trim();
                if (!word) {
                    Toast.warning('لطفاً ابتدا کلمه را وارد کنید');
                    return;
                }

                Toast.info('در حال جستجو...');

                try {
                    const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
                    if (!response.ok) throw new Error('Not found');
                    
                    const data = await response.json();
                    const entry = data[0];

                    // Get pronunciation
                    const phonetic = entry.phonetics?.find(p => p.text)?.text || '';
                    document.getElementById('newCardPronunciation').value = phonetic;

                    // Get first definition
                    const meaning = entry.meanings?.[0];
                    const definition = meaning?.definitions?.[0];
                    
                    if (definition?.example) {
                        document.getElementById('newCardExample').value = definition.example;
                    }

                    Toast.success('اطلاعات دریافت شد');
                } catch (error) {
                    Toast.warning('کلمه در دیکشنری یافت نشد');
                }
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // READY DECKS - Pre-made vocabulary decks
        // ═══════════════════════════════════════════════════════════════
        const ReadyDecks = {
            currentCategory: 'all',

            // Deck definitions
            decks: [
                // Exam Decks
                {
                    id: 'ielts_1000',
                    name: 'IELTS Essential 1000',
                    desc: 'هزار لغت ضروری آیلتس',
                    icon: '🎯',
                    category: 'exam',
                    count: 1000,
                    level: 'متوسط تا پیشرفته',
                    cards: [
                        { word: 'Abandon', meaning: 'رها کردن، ترک کردن', example: 'They abandoned the sinking ship.' },
                        { word: 'Abolish', meaning: 'لغو کردن، برانداختن', example: 'The government abolished the old law.' },
                        { word: 'Abundant', meaning: 'فراوان، زیاد', example: 'The region has abundant natural resources.' },
                        { word: 'Accelerate', meaning: 'شتاب دادن، سرعت بخشیدن', example: 'The car accelerated rapidly.' },
                        { word: 'Accessible', meaning: 'قابل دسترس', example: 'The building is accessible to wheelchairs.' },
                        { word: 'Accommodate', meaning: 'جا دادن، تطبیق دادن', example: 'The hotel can accommodate 500 guests.' },
                        { word: 'Accumulate', meaning: 'انباشتن، جمع کردن', example: 'He accumulated wealth over the years.' },
                        { word: 'Accurate', meaning: 'دقیق، صحیح', example: 'The report was accurate and detailed.' },
                        { word: 'Achieve', meaning: 'دستیابی، رسیدن به', example: 'She achieved her goals through hard work.' },
                        { word: 'Acknowledge', meaning: 'تصدیق کردن، پذیرفتن', example: 'He acknowledged his mistakes.' },
                        { word: 'Acquire', meaning: 'کسب کردن، به دست آوردن', example: 'She acquired new skills.' },
                        { word: 'Adapt', meaning: 'تطبیق دادن، سازگار شدن', example: 'Animals adapt to their environment.' },
                        { word: 'Adequate', meaning: 'کافی، مناسب', example: 'The food supply is adequate.' },
                        { word: 'Adjacent', meaning: 'مجاور، همسایه', example: 'The park is adjacent to the school.' },
                        { word: 'Advocate', meaning: 'حمایت کردن، طرفداری کردن', example: 'She advocates for human rights.' },
                        { word: 'Affect', meaning: 'تأثیر گذاشتن', example: 'The weather affects our mood.' },
                        { word: 'Aggregate', meaning: 'مجموع، کل', example: 'The aggregate score was high.' },
                        { word: 'Allocate', meaning: 'تخصیص دادن', example: 'Funds were allocated for research.' },
                        { word: 'Alter', meaning: 'تغییر دادن', example: 'They altered the original plan.' },
                        { word: 'Ambiguous', meaning: 'مبهم، دو پهلو', example: 'The statement was ambiguous.' }
                    ]
                },
                {
                    id: 'toefl_500',
                    name: 'TOEFL Top 500',
                    desc: 'پانصد لغت پرکاربرد تافل',
                    icon: '📚',
                    category: 'exam',
                    count: 500,
                    level: 'متوسط',
                    cards: [
                        { word: 'Analyze', meaning: 'تحلیل کردن', example: 'Scientists analyze the data carefully.' },
                        { word: 'Approach', meaning: 'نزدیک شدن، رویکرد', example: 'We need a new approach to this problem.' },
                        { word: 'Assume', meaning: 'فرض کردن', example: 'I assume you know the answer.' },
                        { word: 'Benefit', meaning: 'سود، فایده', example: 'Exercise has many health benefits.' },
                        { word: 'Concept', meaning: 'مفهوم، ایده', example: 'The concept is difficult to understand.' },
                        { word: 'Constitute', meaning: 'تشکیل دادن', example: 'Women constitute 50% of the population.' },
                        { word: 'Context', meaning: 'زمینه، بافت', example: 'You need to understand the context.' },
                        { word: 'Contract', meaning: 'قرارداد، منقبض شدن', example: 'They signed a contract.' },
                        { word: 'Create', meaning: 'ایجاد کردن، خلق کردن', example: 'Artists create beautiful works.' },
                        { word: 'Define', meaning: 'تعریف کردن', example: 'Can you define this word?' },
                        { word: 'Derive', meaning: 'مشتق شدن، به دست آوردن', example: 'This word derives from Latin.' },
                        { word: 'Distribute', meaning: 'توزیع کردن', example: 'They distribute food to the poor.' },
                        { word: 'Economy', meaning: 'اقتصاد', example: 'The economy is growing.' },
                        { word: 'Environment', meaning: 'محیط زیست', example: 'We must protect the environment.' },
                        { word: 'Establish', meaning: 'تأسیس کردن', example: 'The company was established in 1990.' }
                    ]
                },
                {
                    id: 'gre_800',
                    name: 'GRE High Frequency',
                    desc: 'لغات پرتکرار GRE',
                    icon: '🎓',
                    category: 'exam',
                    count: 800,
                    level: 'پیشرفته',
                    cards: [
                        { word: 'Aberrant', meaning: 'غیرعادی، منحرف', example: 'His aberrant behavior worried his parents.' },
                        { word: 'Abscond', meaning: 'فرار کردن، گریختن', example: 'The thief absconded with the jewels.' },
                        { word: 'Acumen', meaning: 'تیزهوشی، زیرکی', example: 'She has great business acumen.' },
                        { word: 'Adamant', meaning: 'سرسخت، لجوج', example: 'He was adamant about his decision.' },
                        { word: 'Admonish', meaning: 'هشدار دادن، نصیحت کردن', example: 'The teacher admonished the students.' },
                        { word: 'Aesthetic', meaning: 'زیبایی‌شناختی', example: 'The building has aesthetic appeal.' },
                        { word: 'Alacrity', meaning: 'چالاکی، اشتیاق', example: 'She accepted the offer with alacrity.' },
                        { word: 'Ambivalent', meaning: 'دودل، مردد', example: 'He felt ambivalent about the change.' },
                        { word: 'Ameliorate', meaning: 'بهبود بخشیدن', example: 'The medicine ameliorated her condition.' },
                        { word: 'Anachronism', meaning: 'ناهمزمانی', example: 'The knight in modern times is an anachronism.' }
                    ]
                },
                // Level-based Decks
                {
                    id: 'elementary_300',
                    name: 'Elementary 300',
                    desc: 'لغات پایه برای مبتدیان',
                    icon: '🌱',
                    category: 'level',
                    count: 300,
                    level: 'مبتدی',
                    cards: [
                        { word: 'Hello', meaning: 'سلام', example: 'Hello, how are you?' },
                        { word: 'Goodbye', meaning: 'خداحافظ', example: 'Goodbye, see you tomorrow!' },
                        { word: 'Thank you', meaning: 'متشکرم', example: 'Thank you for your help.' },
                        { word: 'Please', meaning: 'لطفاً', example: 'Please sit down.' },
                        { word: 'Yes', meaning: 'بله', example: 'Yes, I understand.' },
                        { word: 'No', meaning: 'نه', example: 'No, I don\'t agree.' },
                        { word: 'Water', meaning: 'آب', example: 'I need some water.' },
                        { word: 'Food', meaning: 'غذا', example: 'The food is delicious.' },
                        { word: 'House', meaning: 'خانه', example: 'This is my house.' },
                        { word: 'Family', meaning: 'خانواده', example: 'I love my family.' },
                        { word: 'Friend', meaning: 'دوست', example: 'She is my best friend.' },
                        { word: 'School', meaning: 'مدرسه', example: 'I go to school every day.' },
                        { word: 'Book', meaning: 'کتاب', example: 'I\'m reading a book.' },
                        { word: 'Happy', meaning: 'خوشحال', example: 'I am very happy today.' },
                        { word: 'Sad', meaning: 'غمگین', example: 'Why are you sad?' }
                    ]
                },
                {
                    id: 'intermediate_500',
                    name: 'Intermediate 500',
                    desc: 'لغات سطح متوسط',
                    icon: '📈',
                    category: 'level',
                    count: 500,
                    level: 'متوسط',
                    cards: [
                        { word: 'Accomplish', meaning: 'انجام دادن، به نتیجه رساندن', example: 'She accomplished her mission.' },
                        { word: 'Anxious', meaning: 'مضطرب، نگران', example: 'He felt anxious before the exam.' },
                        { word: 'Appreciate', meaning: 'قدردانی کردن', example: 'I appreciate your help.' },
                        { word: 'Argument', meaning: 'بحث، استدلال', example: 'They had an argument.' },
                        { word: 'Behavior', meaning: 'رفتار', example: 'His behavior was strange.' },
                        { word: 'Celebrate', meaning: 'جشن گرفتن', example: 'We celebrate birthdays.' },
                        { word: 'Challenge', meaning: 'چالش', example: 'This is a big challenge.' },
                        { word: 'Communicate', meaning: 'ارتباط برقرار کردن', example: 'We communicate by email.' },
                        { word: 'Compare', meaning: 'مقایسه کردن', example: 'Compare these two products.' },
                        { word: 'Consider', meaning: 'در نظر گرفتن', example: 'Please consider my offer.' }
                    ]
                },
                {
                    id: 'advanced_600',
                    name: 'Advanced 600',
                    desc: 'لغات پیشرفته',
                    icon: '🚀',
                    category: 'level',
                    count: 600,
                    level: 'پیشرفته',
                    cards: [
                        { word: 'Exacerbate', meaning: 'بدتر کردن، تشدید کردن', example: 'The drought exacerbated the famine.' },
                        { word: 'Ephemeral', meaning: 'زودگذر، ناپایدار', example: 'Fame is often ephemeral.' },
                        { word: 'Ubiquitous', meaning: 'همه‌جا حاضر، فراگیر', example: 'Smartphones are ubiquitous today.' },
                        { word: 'Pernicious', meaning: 'مضر، زیان‌آور', example: 'Smoking has pernicious effects.' },
                        { word: 'Pragmatic', meaning: 'عمل‌گرا، واقع‌بین', example: 'She takes a pragmatic approach.' },
                        { word: 'Resilient', meaning: 'انعطاف‌پذیر، مقاوم', example: 'Children are resilient.' },
                        { word: 'Scrutinize', meaning: 'موشکافی کردن، بررسی دقیق', example: 'They scrutinized the document.' },
                        { word: 'Substantiate', meaning: 'اثبات کردن، مستند کردن', example: 'Can you substantiate your claim?' },
                        { word: 'Synergy', meaning: 'هم‌افزایی', example: 'The team has great synergy.' },
                        { word: 'Tenacious', meaning: 'سرسخت، پایدار', example: 'She is a tenacious fighter.' }
                    ]
                },
                // Topic Decks
                {
                    id: 'business_400',
                    name: 'Business English',
                    desc: 'اصطلاحات تجاری و کسب‌وکار',
                    icon: '💼',
                    category: 'topic',
                    count: 400,
                    level: 'متوسط',
                    cards: [
                        { word: 'Revenue', meaning: 'درآمد', example: 'The company\'s revenue increased.' },
                        { word: 'Profit', meaning: 'سود', example: 'They made a huge profit.' },
                        { word: 'Investment', meaning: 'سرمایه‌گذاری', example: 'It\'s a good investment.' },
                        { word: 'Negotiate', meaning: 'مذاکره کردن', example: 'We need to negotiate the terms.' },
                        { word: 'Strategy', meaning: 'استراتژی', example: 'We need a new marketing strategy.' },
                        { word: 'Deadline', meaning: 'مهلت', example: 'The deadline is tomorrow.' },
                        { word: 'Budget', meaning: 'بودجه', example: 'We are over budget.' },
                        { word: 'Stakeholder', meaning: 'ذینفع', example: 'All stakeholders were informed.' },
                        { word: 'Merger', meaning: 'ادغام', example: 'The merger was successful.' },
                        { word: 'Quarterly', meaning: 'سه‌ماهه', example: 'Quarterly reports are due.' }
                    ]
                },
                {
                    id: 'tech_350',
                    name: 'Technology Terms',
                    desc: 'اصطلاحات فناوری و کامپیوتر',
                    icon: '💻',
                    category: 'topic',
                    count: 350,
                    level: 'متوسط',
                    cards: [
                        { word: 'Algorithm', meaning: 'الگوریتم', example: 'The algorithm is efficient.' },
                        { word: 'Database', meaning: 'پایگاه داده', example: 'Store it in the database.' },
                        { word: 'Interface', meaning: 'رابط کاربری', example: 'The interface is user-friendly.' },
                        { word: 'Bandwidth', meaning: 'پهنای باند', example: 'We need more bandwidth.' },
                        { word: 'Encryption', meaning: 'رمزنگاری', example: 'Use encryption for security.' },
                        { word: 'Debugging', meaning: 'اشکال‌زدایی', example: 'Debugging takes time.' },
                        { word: 'Framework', meaning: 'چارچوب', example: 'We use React framework.' },
                        { word: 'Repository', meaning: 'مخزن', example: 'Push to the repository.' },
                        { word: 'Scalable', meaning: 'مقیاس‌پذیر', example: 'The system is scalable.' },
                        { word: 'Optimize', meaning: 'بهینه‌سازی کردن', example: 'Optimize the code.' }
                    ]
                },
                {
                    id: 'academic_450',
                    name: 'Academic Words',
                    desc: 'لغات آکادمیک و علمی',
                    icon: '🔬',
                    category: 'topic',
                    count: 450,
                    level: 'پیشرفته',
                    cards: [
                        { word: 'Hypothesis', meaning: 'فرضیه', example: 'Test the hypothesis.' },
                        { word: 'Methodology', meaning: 'روش‌شناسی', example: 'Explain your methodology.' },
                        { word: 'Empirical', meaning: 'تجربی', example: 'Empirical evidence is needed.' },
                        { word: 'Synthesis', meaning: 'ترکیب، سنتز', example: 'The synthesis was successful.' },
                        { word: 'Paradigm', meaning: 'پارادایم، الگو', example: 'A paradigm shift occurred.' },
                        { word: 'Phenomenon', meaning: 'پدیده', example: 'It\'s a natural phenomenon.' },
                        { word: 'Variable', meaning: 'متغیر', example: 'Control the variables.' },
                        { word: 'Correlation', meaning: 'همبستگی', example: 'There\'s a correlation.' },
                        { word: 'Implication', meaning: 'پیامد، تلویح', example: 'Consider the implications.' },
                        { word: 'Criterion', meaning: 'معیار', example: 'What\'s the criterion?' }
                    ]
                },
                // Phrase Decks
                {
                    id: 'idioms_200',
                    name: 'Essential Idioms',
                    desc: 'اصطلاحات رایج انگلیسی',
                    icon: '💬',
                    category: 'phrase',
                    count: 200,
                    level: 'متوسط',
                    cards: [
                        { word: 'Break the ice', meaning: 'سر صحبت را باز کردن', example: 'His joke broke the ice.' },
                        { word: 'Hit the nail on the head', meaning: 'درست حدس زدن', example: 'You hit the nail on the head!' },
                        { word: 'Piece of cake', meaning: 'کار آسان', example: 'The test was a piece of cake.' },
                        { word: 'Cost an arm and a leg', meaning: 'خیلی گران بودن', example: 'That car costs an arm and a leg.' },
                        { word: 'Under the weather', meaning: 'کسالت داشتن', example: 'I\'m feeling under the weather.' },
                        { word: 'Beat around the bush', meaning: 'طفره رفتن', example: 'Don\'t beat around the bush.' },
                        { word: 'Bite the bullet', meaning: 'دندان روی جگر گذاشتن', example: 'Just bite the bullet and do it.' },
                        { word: 'Break a leg', meaning: 'موفق باشی', example: 'Break a leg in your interview!' },
                        { word: 'Cut to the chase', meaning: 'سر اصل مطلب رفتن', example: 'Let\'s cut to the chase.' },
                        { word: 'Get out of hand', meaning: 'از کنترل خارج شدن', example: 'The situation got out of hand.' }
                    ]
                },
                {
                    id: 'phrasal_250',
                    name: 'Phrasal Verbs',
                    desc: 'افعال عبارتی پرکاربرد',
                    icon: '🔗',
                    category: 'phrase',
                    count: 250,
                    level: 'متوسط',
                    cards: [
                        { word: 'Give up', meaning: 'دست کشیدن، تسلیم شدن', example: 'Never give up on your dreams.' },
                        { word: 'Look forward to', meaning: 'مشتاقانه منتظر بودن', example: 'I look forward to meeting you.' },
                        { word: 'Put off', meaning: 'به تعویق انداختن', example: 'Don\'t put off your homework.' },
                        { word: 'Turn down', meaning: 'رد کردن', example: 'He turned down the offer.' },
                        { word: 'Come across', meaning: 'تصادفاً پیدا کردن', example: 'I came across an old photo.' },
                        { word: 'Break down', meaning: 'خراب شدن، فروپاشیدن', example: 'My car broke down.' },
                        { word: 'Figure out', meaning: 'فهمیدن، حل کردن', example: 'I figured out the problem.' },
                        { word: 'Run out of', meaning: 'تمام کردن', example: 'We ran out of milk.' },
                        { word: 'Get along with', meaning: 'کنار آمدن با', example: 'I get along with my neighbors.' },
                        { word: 'Look up to', meaning: 'احترام گذاشتن، الگو قرار دادن', example: 'I look up to my father.' }
                    ]
                },
                {
                    id: 'collocations_300',
                    name: 'Common Collocations',
                    desc: 'ترکیبات رایج کلمات',
                    icon: '🧩',
                    category: 'phrase',
                    count: 300,
                    level: 'متوسط تا پیشرفته',
                    cards: [
                        { word: 'Make a decision', meaning: 'تصمیم گرفتن', example: 'You need to make a decision.' },
                        { word: 'Take a break', meaning: 'استراحت کردن', example: 'Let\'s take a break.' },
                        { word: 'Pay attention', meaning: 'توجه کردن', example: 'Pay attention to the details.' },
                        { word: 'Keep in mind', meaning: 'در نظر داشتن', example: 'Keep in mind the deadline.' },
                        { word: 'Come to an end', meaning: 'به پایان رسیدن', example: 'The meeting came to an end.' },
                        { word: 'Make progress', meaning: 'پیشرفت کردن', example: 'We\'re making good progress.' },
                        { word: 'Take responsibility', meaning: 'مسئولیت پذیرفتن', example: 'Take responsibility for your actions.' },
                        { word: 'Have an impact', meaning: 'تأثیر داشتن', example: 'It had a huge impact.' },
                        { word: 'Reach a conclusion', meaning: 'به نتیجه رسیدن', example: 'They reached a conclusion.' },
                        { word: 'Meet expectations', meaning: 'انتظارات را برآورده کردن', example: 'The product met expectations.' }
                    ]
                }
            ],

            open() {
                document.getElementById('readyDecksModal').classList.add('active');
                this.render();
            },

            close() {
                document.getElementById('readyDecksModal').classList.remove('active');
            },

            filterCategory(category, btn) {
                this.currentCategory = category;
                
                document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                this.render();
            },

            render() {
                const container = document.getElementById('readyDecksGrid');
                if (!container) return;

                const installedDecks = DB.get('installedReadyDecks', []);
                
                let filteredDecks = this.decks;
                if (this.currentCategory !== 'all') {
                    filteredDecks = this.decks.filter(d => d.category === this.currentCategory);
                }

                container.innerHTML = filteredDecks.map(deck => {
                    const isInstalled = installedDecks.includes(deck.id);
                    
                    return `
                        <div class="ready-deck-card ${isInstalled ? 'installed' : ''}">
                            <div class="ready-deck-icon ${deck.category}">${deck.icon}</div>
                            <div class="ready-deck-info">
                                <div class="ready-deck-name">${deck.name}</div>
                                <div class="ready-deck-desc">${deck.desc}</div>
                                <div class="ready-deck-meta">
                                    <span>📚 ${Utils.toPersian(deck.count)} کلمه</span>
                                    <span>📊 ${deck.level}</span>
                                </div>
                            </div>
                            <div class="ready-deck-action">
                                ${isInstalled ? `
                                    <button disabled style="background: var(--success);">✓ نصب شده</button>
                                ` : `
                                    <button onclick="ReadyDecks.install('${deck.id}')">+ نصب</button>
                                `}
                            </div>
                        </div>
                    `;
                }).join('');
            },

            install(deckId) {
                const deck = this.decks.find(d => d.id === deckId);
                if (!deck) return;

                // Create deck
                const newDeck = DeckManager.create(deck.name, deck.desc, deck.icon);

                // Add cards
                deck.cards.forEach(card => {
                    CardManager.create({
                        deckId: newDeck.id,
                        word: card.word,
                        meaning: card.meaning,
                        example: card.example || ''
                    });
                });

                // Mark as installed
                const installed = DB.get('installedReadyDecks', []);
                installed.push(deckId);
                DB.set('installedReadyDecks', installed);

                Toast.success(`"${deck.name}" نصب شد`);
                Gamification.addXP(50, '📦 Deck جدید');
                
                this.render();
                Library.render();
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // IMAGE CARD MANAGER
        // ═══════════════════════════════════════════════════════════════
        const ImageCard = {
            currentImage: null,
            targetDeckId: null,

            open(deckId) {
                this.targetDeckId = deckId || Library.currentDeck;
                this.currentImage = null;
                
                document.getElementById('imageCardWord').value = '';
                document.getElementById('imageCardMeaning').value = '';
                document.getElementById('imageCardDesc').value = '';
                document.getElementById('imagePreviewContainer').style.display = 'none';
                document.getElementById('imageUploadArea').style.display = 'block';
                
                document.getElementById('imageCardModal').classList.add('active');
            },

            close() {
                document.getElementById('imageCardModal').classList.remove('active');
                this.currentImage = null;
            },

            handleUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                if (!file.type.startsWith('image/')) {
                    Toast.warning('لطفاً یک فایل تصویری انتخاب کنید');
                    return;
                }

                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    Toast.warning('حجم تصویر نباید بیشتر از 5MB باشد');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    this.currentImage = e.target.result;
                    document.getElementById('imagePreview').src = this.currentImage;
                    document.getElementById('imagePreviewContainer').style.display = 'block';
                    document.getElementById('imageUploadArea').style.display = 'none';
                };
                reader.readAsDataURL(file);
            },

            removeImage() {
                this.currentImage = null;
                document.getElementById('imagePreviewContainer').style.display = 'none';
                document.getElementById('imageUploadArea').style.display = 'block';
                document.getElementById('imageInput').value = '';
            },

            save() {
                const word = document.getElementById('imageCardWord')?.value.trim();
                const meaning = document.getElementById('imageCardMeaning')?.value.trim();
                const desc = document.getElementById('imageCardDesc')?.value.trim();

                if (!word || !meaning) {
                    Toast.warning('لطفاً کلمه و معنی را وارد کنید');
                    return;
                }

                if (!this.targetDeckId) {
                    Toast.warning('لطفاً ابتدا یک Deck انتخاب کنید');
                    return;
                }

                const card = CardManager.create({
                    deckId: this.targetDeckId,
                    word: word,
                    meaning: meaning,
                    note: desc,
                    image: this.currentImage
                });

                Toast.success('کارت تصویری اضافه شد');
                Gamification.addXP(10, '🖼️ کارت تصویری');
                
                this.close();
                Library.renderCards();
            }
        };
		// ═══════════════════════════════════════════════════════════════
        // SPACED READING - Reading with vocabulary learning
        // ═══════════════════════════════════════════════════════════════
        const SpacedReading = {
            currentMode: 'learn',
            currentText: '',
            words: [],
            knownWords: [],
            selectedWord: null,

            // Sample texts for reading
            sampleTexts: [
                {
                    id: 'tech1',
                    title: 'The Future of AI',
                    level: 'متوسط',
                    category: 'technology',
                    text: `Artificial intelligence is rapidly transforming our world. From virtual assistants to self-driving cars, AI applications are becoming ubiquitous in our daily lives. Machine learning algorithms can now recognize patterns, make predictions, and even generate creative content. However, this technological revolution also raises important ethical questions about privacy, employment, and the nature of human intelligence itself.`
                },
                {
                    id: 'science1',
                    title: 'Climate Change',
                    level: 'متوسط',
                    category: 'science',
                    text: `Climate change represents one of the most significant challenges facing humanity today. Rising global temperatures are causing polar ice caps to melt, sea levels to rise, and weather patterns to become increasingly unpredictable. Scientists emphasize the urgent need for sustainable practices and renewable energy sources to mitigate these effects and protect our planet for future generations.`
                },
                {
                    id: 'business1',
                    title: 'Entrepreneurship',
                    level: 'پیشرفته',
                    category: 'business',
                    text: `Successful entrepreneurs possess a unique combination of vision, resilience, and adaptability. They identify market opportunities, develop innovative solutions, and navigate the challenges of building a business. While the path to success is rarely linear, those who persevere often find that their failures provide invaluable lessons. The most successful companies are those that continuously evolve and remain responsive to changing customer needs.`
                },
                {
                    id: 'health1',
                    title: 'Mental Health',
                    level: 'متوسط',
                    category: 'health',
                    text: `Mental health awareness has grown significantly in recent years. People are increasingly recognizing the importance of psychological well-being alongside physical health. Practices such as meditation, exercise, and therapy can help manage stress and anxiety. Creating supportive environments where individuals feel comfortable discussing their mental health is crucial for building healthier communities.`
                },
                {
                    id: 'story1',
                    title: 'The Journey',
                    level: 'مبتدی',
                    category: 'story',
                    text: `Sarah always dreamed of traveling the world. One day, she decided to take a chance and booked a flight to Japan. The journey was long, but the experience was incredible. She visited ancient temples, tried delicious food, and met wonderful people. This trip changed her life forever and taught her that dreams can come true if you have the courage to pursue them.`
                },
                {
                    id: 'philosophy1',
                    title: 'The Nature of Happiness',
                    level: 'پیشرفته',
                    category: 'philosophy',
                    text: `Philosophers have long debated the nature of happiness and what constitutes a meaningful life. Some argue that happiness comes from external achievements and possessions, while others believe it stems from internal states of mind and meaningful relationships. Ancient wisdom traditions often emphasize contentment, gratitude, and living in harmony with nature as pathways to lasting fulfillment.`
                }
            ],

            // Word definitions dictionary (expanded)
            dictionary: {
                'artificial': { meaning: 'مصنوعی', example: 'Artificial flowers look real.' },
                'intelligence': { meaning: 'هوش', example: 'Human intelligence is remarkable.' },
                'rapidly': { meaning: 'به سرعت', example: 'Technology is changing rapidly.' },
                'transforming': { meaning: 'متحول کردن', example: 'The internet is transforming education.' },
                'virtual': { meaning: 'مجازی', example: 'Virtual reality is amazing.' },
                'assistants': { meaning: 'دستیاران', example: 'Virtual assistants help with tasks.' },
                'ubiquitous': { meaning: 'همه‌جا حاضر', example: 'Smartphones are ubiquitous.' },
                'algorithms': { meaning: 'الگوریتم‌ها', example: 'Search algorithms are complex.' },
                'recognize': { meaning: 'تشخیص دادن', example: 'I recognize your voice.' },
                'patterns': { meaning: 'الگوها', example: 'Weather patterns are changing.' },
                'predictions': { meaning: 'پیش‌بینی‌ها', example: 'His predictions were accurate.' },
                'generate': { meaning: 'تولید کردن', example: 'Wind can generate electricity.' },
                'creative': { meaning: 'خلاقانه', example: 'She has creative ideas.' },
                'revolution': { meaning: 'انقلاب', example: 'The industrial revolution changed society.' },
                'ethical': { meaning: 'اخلاقی', example: 'Ethical decisions are important.' },
                'privacy': { meaning: 'حریم خصوصی', example: 'Privacy is a fundamental right.' },
                'employment': { meaning: 'اشتغال', example: 'Employment rates are rising.' },
                'climate': { meaning: 'آب و هوا', example: 'Climate affects agriculture.' },
                'significant': { meaning: 'قابل توجه', example: 'This is a significant achievement.' },
                'challenges': { meaning: 'چالش‌ها', example: 'Life is full of challenges.' },
                'humanity': { meaning: 'بشریت', example: 'Humanity must work together.' },
                'temperatures': { meaning: 'دماها', example: 'Temperatures are rising globally.' },
                'polar': { meaning: 'قطبی', example: 'Polar bears live in the Arctic.' },
                'increasingly': { meaning: 'به طور فزاینده', example: 'It is increasingly difficult.' },
                'unpredictable': { meaning: 'غیرقابل پیش‌بینی', example: 'Weather is unpredictable.' },
                'emphasize': { meaning: 'تأکید کردن', example: 'I want to emphasize this point.' },
                'urgent': { meaning: 'فوری', example: 'This is an urgent matter.' },
                'sustainable': { meaning: 'پایدار', example: 'We need sustainable solutions.' },
                'renewable': { meaning: 'تجدیدپذیر', example: 'Solar is renewable energy.' },
                'mitigate': { meaning: 'کاهش دادن', example: 'We must mitigate the risks.' },
                'entrepreneurs': { meaning: 'کارآفرینان', example: 'Entrepreneurs create jobs.' },
                'possess': { meaning: 'داشتن', example: 'She possesses great talent.' },
                'unique': { meaning: 'منحصر به فرد', example: 'Everyone is unique.' },
                'combination': { meaning: 'ترکیب', example: 'It\'s a perfect combination.' },
                'vision': { meaning: 'چشم‌انداز، بینایی', example: 'She has a clear vision.' },
                'resilience': { meaning: 'تاب‌آوری', example: 'Resilience helps us overcome.' },
                'adaptability': { meaning: 'سازگاری', example: 'Adaptability is crucial.' },
                'identify': { meaning: 'شناسایی کردن', example: 'Can you identify this bird?' },
                'opportunities': { meaning: 'فرصت‌ها', example: 'New opportunities arise daily.' },
                'innovative': { meaning: 'نوآورانه', example: 'This is an innovative solution.' },
                'navigate': { meaning: 'هدایت کردن', example: 'Navigate through difficulties.' },
                'persevere': { meaning: 'پشتکار داشتن', example: 'If you persevere, you\'ll succeed.' },
                'invaluable': { meaning: 'بسیار ارزشمند', example: 'Your help is invaluable.' },
                'continuously': { meaning: 'به طور مداوم', example: 'We continuously improve.' },
                'evolve': { meaning: 'تکامل یافتن', example: 'Species evolve over time.' },
                'responsive': { meaning: 'پاسخگو', example: 'Be responsive to feedback.' },
                'mental': { meaning: 'ذهنی', example: 'Mental health matters.' },
                'awareness': { meaning: 'آگاهی', example: 'Raise awareness about issues.' },
                'psychological': { meaning: 'روانشناختی', example: 'Psychological support helps.' },
                'meditation': { meaning: 'مدیتیشن', example: 'Meditation reduces stress.' },
                'therapy': { meaning: 'درمان', example: 'Therapy can be helpful.' },
                'anxiety': { meaning: 'اضطراب', example: 'Anxiety affects many people.' },
                'supportive': { meaning: 'حمایتی', example: 'She is very supportive.' },
                'environments': { meaning: 'محیط‌ها', example: 'Work environments vary.' },
                'communities': { meaning: 'جوامع', example: 'Strong communities thrive.' },
                'dreamed': { meaning: 'رویا داشت', example: 'She dreamed of success.' },
                'traveling': { meaning: 'سفر کردن', example: 'Traveling broadens the mind.' },
                'decided': { meaning: 'تصمیم گرفت', example: 'He decided to leave.' },
                'chance': { meaning: 'شانس، فرصت', example: 'Take a chance!' },
                'incredible': { meaning: 'باورنکردنی', example: 'The view was incredible.' },
                'ancient': { meaning: 'باستانی', example: 'Ancient civilizations fascinate me.' },
                'temples': { meaning: 'معابد', example: 'Japanese temples are beautiful.' },
                'delicious': { meaning: 'خوشمزه', example: 'The food was delicious.' },
                'courage': { meaning: 'شجاعت', example: 'Have courage to try.' },
                'pursue': { meaning: 'دنبال کردن', example: 'Pursue your dreams.' },
                'philosophers': { meaning: 'فیلسوفان', example: 'Philosophers seek truth.' },
                'debated': { meaning: 'بحث کردند', example: 'They debated for hours.' },
                'constitutes': { meaning: 'تشکیل می‌دهد', example: 'What constitutes success?' },
                'meaningful': { meaning: 'معنادار', example: 'A meaningful conversation.' },
                'achievements': { meaning: 'دستاوردها', example: 'Celebrate your achievements.' },
                'possessions': { meaning: 'دارایی‌ها', example: 'Material possessions don\'t bring happiness.' },
                'internal': { meaning: 'درونی', example: 'Internal peace is valuable.' },
                'relationships': { meaning: 'روابط', example: 'Good relationships matter.' },
                'wisdom': { meaning: 'خرد', example: 'Wisdom comes with experience.' },
                'traditions': { meaning: 'سنت‌ها', example: 'Cultural traditions are important.' },
                'contentment': { meaning: 'رضایت', example: 'Find contentment in simplicity.' },
                'gratitude': { meaning: 'قدردانی', example: 'Practice gratitude daily.' },
                'harmony': { meaning: 'هماهنگی', example: 'Live in harmony with nature.' },
                'pathways': { meaning: 'مسیرها', example: 'There are many pathways to success.' },
                'fulfillment': { meaning: 'رضایت‌مندی', example: 'Find fulfillment in your work.' }
            },

            open() {
                document.getElementById('spacedReadingModal').classList.add('active');
                this.loadKnownWords();
                this.renderSampleTexts();
            },

            close() {
                document.getElementById('spacedReadingModal').classList.remove('active');
            },

            setMode(mode, btn) {
                this.currentMode = mode;
                document.querySelectorAll('.reading-mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            },

            loadKnownWords() {
                this.knownWords = DB.get('knownWords', []);
            },

            saveKnownWords() {
                DB.set('knownWords', this.knownWords);
            },

            renderSampleTexts() {
                const container = document.getElementById('sampleTextsGrid');
                if (!container) return;

                container.innerHTML = this.sampleTexts.map(text => `
                    <div class="sample-text-card" onclick="SpacedReading.loadText('${text.id}')">
                        <div class="sample-text-title">${text.title}</div>
                        <div class="sample-text-meta">📊 ${text.level} • 📚 ${text.category}</div>
                    </div>
                `).join('');
            },

            loadText(textId) {
                const text = this.sampleTexts.find(t => t.id === textId);
                if (text) {
                    this.processText(text.text);
                }
            },

            loadCustomText() {
                const text = document.getElementById('customReadingText')?.value.trim();
                if (!text) {
                    Toast.warning('لطفاً یک متن وارد کنید');
                    return;
                }
                this.processText(text);
            },

            processText(text) {
                this.currentText = text;
                
                // Extract words
                const wordRegex = /[a-zA-Z]+/g;
                const allWords = text.match(wordRegex) || [];
                const uniqueWords = [...new Set(allWords.map(w => w.toLowerCase()))];
                
                this.words = uniqueWords;
                
                // Render text with clickable words
                this.renderText(text);
                this.updateStats();
            },

            renderText(text) {
                const container = document.getElementById('readingText');
                if (!container) return;

                // Replace words with clickable spans
                let html = text;
                const wordRegex = /\b([a-zA-Z]+)\b/g;
                
                html = text.replace(wordRegex, (match) => {
                    const lowerWord = match.toLowerCase();
                    const isKnown = this.knownWords.includes(lowerWord);
                    const inDictionary = this.dictionary[lowerWord];
                    const inUserCards = this.isInUserCards(lowerWord);
                    
                    let className = 'word';
                    if (isKnown) {
                        className += ' known';
                    } else if (inDictionary || inUserCards) {
                        className += ' learning';
                    } else {
                        className += ' unknown';
                    }
                    
                    return `<span class="${className}" onclick="SpacedReading.selectWord('${lowerWord}', '${match}')">${match}</span>`;
                });

                container.innerHTML = html;
            },

            isInUserCards(word) {
                const cards = Object.values(CardManager.getAll());
                return cards.some(c => c.word.toLowerCase() === word.toLowerCase());
            },

            selectWord(word, original) {
                this.selectedWord = word;
                
                const infoCard = document.getElementById('wordInfoCard');
                const wordEl = document.getElementById('wordInfoWord');
                const meaningEl = document.getElementById('wordInfoMeaning');
                const exampleEl = document.getElementById('wordInfoExample');

                wordEl.textContent = original;
                
                // Check dictionary first
                if (this.dictionary[word]) {
                    meaningEl.textContent = this.dictionary[word].meaning;
                    exampleEl.textContent = this.dictionary[word].example || '';
                } else {
                    // Check user cards
                    const cards = Object.values(CardManager.getAll());
                    const userCard = cards.find(c => c.word.toLowerCase() === word);
                    
                    if (userCard) {
                        meaningEl.textContent = userCard.meaning;
                        exampleEl.textContent = userCard.example || '';
                    } else {
                        meaningEl.textContent = 'معنی یافت نشد - می‌توانید اضافه کنید';
                        exampleEl.textContent = '';
                    }
                }

                infoCard.style.display = 'block';
                
                // Play pronunciation
                AudioPlayer.speak(original, 0.8);
            },

            markKnown() {
                if (!this.selectedWord) return;
                
                if (!this.knownWords.includes(this.selectedWord)) {
                    this.knownWords.push(this.selectedWord);
                    this.saveKnownWords();
                }
                
                Toast.success('به کلمات آشنا اضافه شد');
                Gamification.addXP(2, '✅ کلمه آشنا');
                
                this.renderText(this.currentText);
                this.updateStats();
                
                document.getElementById('wordInfoCard').style.display = 'none';
            },

            addToReview() {
                if (!this.selectedWord) return;

                const wordInfo = this.dictionary[this.selectedWord];
                
                // Check if deck exists for reading words
                let decks = DeckManager.getAll();
                let readingDeck = decks.find(d => d.name === 'کلمات مطالعه');
                
                if (!readingDeck) {
                    readingDeck = DeckManager.create('کلمات مطالعه', 'کلماتی که در مطالعه یاد گرفتید', '📖');
                }

                // Check if card already exists
                const cards = Object.values(CardManager.getAll());
                const exists = cards.some(c => 
                    c.word.toLowerCase() === this.selectedWord && 
                    c.deckId === readingDeck.id
                );

                if (exists) {
                    Toast.info('این کلمه قبلاً اضافه شده');
                    return;
                }

                CardManager.create({
                    deckId: readingDeck.id,
                    word: this.selectedWord.charAt(0).toUpperCase() + this.selectedWord.slice(1),
                    meaning: wordInfo?.meaning || 'معنی را اضافه کنید',
                    example: wordInfo?.example || ''
                });

                Toast.success('به لیست مرور اضافه شد');
                Gamification.addXP(5, '📖 کلمه جدید از مطالعه');
                
                document.getElementById('wordInfoCard').style.display = 'none';
            },

            updateStats() {
                const totalWords = this.words.length;
                const knownCount = this.words.filter(w => this.knownWords.includes(w)).length;
                const newCount = totalWords - knownCount;

                document.getElementById('readingWordsCount').textContent = Utils.toPersian(totalWords);
                document.getElementById('readingKnownCount').textContent = Utils.toPersian(knownCount);
                document.getElementById('readingNewCount').textContent = Utils.toPersian(newCount);
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // INSTALL MANAGER - Better PWA Installation
        // ═══════════════════════════════════════════════════════════════
        const InstallManager = {
            deferredPrompt: null,
            isInstalled: false,

            init() {
                // Check if already installed
                if (window.matchMedia('(display-mode: standalone)').matches) {
                    this.isInstalled = true;
                    return;
                }

                // Listen for install prompt
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    this.deferredPrompt = e;
                    
                    // Show install button after delay
                    setTimeout(() => {
                        if (!this.isInstalled && !this.wasPromptShown()) {
                            this.showPrompt();
                        }
                    }, 30000); // Show after 30 seconds
                });

                // Listen for successful install
                window.addEventListener('appinstalled', () => {
                    this.isInstalled = true;
                    this.deferredPrompt = null;
                    Toast.success('برنامه با موفقیت نصب شد! 🎉');
                    Gamification.addXP(100, '📲 نصب برنامه');
                });

                // Check if should show prompt
                this.checkAutoPrompt();
            },

            wasPromptShown() {
                const lastShown = DB.get('installPromptShown', 0);
                const daysSince = (Date.now() - lastShown) / (1000 * 60 * 60 * 24);
                return daysSince < 7; // Don't show again for 7 days
            },

            showPrompt() {
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                const stepsContainer = document.getElementById('installSteps');
                const installBtn = document.getElementById('installBtn');

                if (isIOS) {
                    // iOS specific instructions
                    stepsContainer.innerHTML = `
                        <div class="install-step">
                            <span class="step-number">۱</span>
                            <span>روی دکمه Share (اشتراک) در پایین Safari کلیک کنید</span>
                        </div>
                        <div class="install-step">
                            <span class="step-number">۲</span>
                            <span>گزینه "Add to Home Screen" را انتخاب کنید</span>
                        </div>
                        <div class="install-step">
                            <span class="step-number">۳</span>
                            <span>روی "Add" کلیک کنید</span>
                        </div>
                    `;
                    installBtn.textContent = '📖 متوجه شدم';
                    installBtn.onclick = () => this.close();
                } else if (this.deferredPrompt) {
                    // Android/Chrome with native prompt
                    stepsContainer.innerHTML = `
                        <div class="install-step">
                            <span class="step-number">۱</span>
                            <span>روی دکمه "نصب برنامه" کلیک کنید</span>
                        </div>
                        <div class="install-step">
                            <span class="step-number">۲</span>
                            <span>در پنجره باز شده "Install" را بزنید</span>
                        </div>
                    `;
                    installBtn.textContent = '📲 نصب برنامه';
                    installBtn.onclick = () => this.install();
                } else {
                    // Generic instructions
                    stepsContainer.innerHTML = `
                        <div class="install-step">
                            <span class="step-number">۱</span>
                            <span>از منوی مرورگر گزینه "Install App" یا "Add to Home Screen" را انتخاب کنید</span>
                        </div>
                    `;
                    installBtn.style.display = 'none';
                }

                document.getElementById('installModal').classList.add('active');
                DB.set('installPromptShown', Date.now());
            },

            async install() {
                if (!this.deferredPrompt) {
                    Toast.info('از منوی مرورگر برنامه را نصب کنید');
                    return;
                }

                this.deferredPrompt.prompt();
                const { outcome } = await this.deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    this.close();
                }
                
                this.deferredPrompt = null;
            },

            later() {
                this.close();
                DB.set('installPromptShown', Date.now());
            },

            close() {
                document.getElementById('installModal').classList.remove('active');
            },

            checkAutoPrompt() {
                // Check conditions for auto-showing install prompt
                const settings = Settings.get();
                const reviews = DB.get('reviews', []);
                
                // Show if: used for 3+ days, 50+ reviews, not installed
                if (settings.streak >= 3 && reviews.length >= 50 && !this.isInstalled) {
                    if (!this.wasPromptShown()) {
                        setTimeout(() => this.showPrompt(), 5000);
                    }
                }
            },

            // Manual trigger from settings
            showInstallGuide() {
                this.showPrompt();
            }
        };
		// ═══════════════════════════════════════════════════════════════
        // SMART NOTIFICATIONS SYSTEM
        // ═══════════════════════════════════════════════════════════════
        const SmartNotifications = {
            permission: 'default',
            scheduledNotifications: [],

            init() {
                // Check current permission status
                if ('Notification' in window) {
                    this.permission = Notification.permission;
                }

                // Load scheduled notifications
                this.scheduledNotifications = DB.get('scheduledNotifications', []);

                // Check if should ask for permission
                this.checkAutoAsk();

                // Start notification scheduler
                this.startScheduler();
            },

            checkAutoAsk() {
                if (this.permission === 'default') {
                    const settings = Settings.get();
                    const reviews = DB.get('reviews', []);
                    
                    // Ask after some usage
                    if (settings.streak >= 2 || reviews.length >= 20) {
                        const lastAsked = DB.get('notificationLastAsked', 0);
                        const daysSince = (Date.now() - lastAsked) / (1000 * 60 * 60 * 24);
                        
                        if (daysSince > 7) {
                            setTimeout(() => this.showModal(), 10000);
                        }
                    }
                }
            },

            showModal() {
                document.getElementById('notificationModal').classList.add('active');
                DB.set('notificationLastAsked', Date.now());
            },

            closeModal() {
                document.getElementById('notificationModal').classList.remove('active');
            },

            async requestPermission() {
                if (!('Notification' in window)) {
                    Toast.warning('مرورگر شما از اعلان‌ها پشتیبانی نمی‌کند');
                    this.closeModal();
                    return;
                }

                try {
                    const permission = await Notification.requestPermission();
                    this.permission = permission;

                    if (permission === 'granted') {
                        Toast.success('اعلان‌ها فعال شدند! 🔔');
                        Gamification.addXP(20, '🔔 فعال‌سازی اعلان‌ها');
                        
                        // Schedule default notifications
                        this.scheduleDefaultNotifications();
                        
                        // Show welcome notification
                        this.show('خوش آمدید! 🎉', 'اعلان‌های LEXORA فعال شدند');
                    } else {
                        Toast.info('می‌توانید بعداً از تنظیمات فعال کنید');
                    }
                } catch (error) {
                    console.error('Notification permission error:', error);
                    Toast.warning('خطا در دریافت مجوز');
                }

                this.closeModal();
            },

            // Show a notification
            show(title, body, options = {}) {
                if (this.permission !== 'granted') return;

                const defaultOptions = {
                    icon: '/icon-192.png',
                    badge: '/icon-192.png',
                    vibrate: [200, 100, 200],
                    tag: options.tag || 'lexora-notification',
                    renotify: true,
                    requireInteraction: false,
                    ...options
                };

                try {
                    const notification = new Notification(title, {
                        body: body,
                        ...defaultOptions
                    });

                    notification.onclick = () => {
                        window.focus();
                        notification.close();
                        if (options.onClick) options.onClick();
                    };

                    // Auto close after 5 seconds
                    setTimeout(() => notification.close(), 5000);
                } catch (error) {
                    console.error('Notification error:', error);
                }
            },

            // Schedule default notifications
            scheduleDefaultNotifications() {
                const settings = Settings.get();
                
                // Daily review reminder
                this.scheduleDaily('review_reminder', {
                    hour: settings.reminderTime || 20,
                    minute: 0,
                    title: 'وقت مرور است! 📚',
                    body: 'کارت‌های امروز منتظر شما هستند'
                });

                // Streak warning (evening before streak breaks)
                this.scheduleDaily('streak_warning', {
                    hour: 21,
                    minute: 30,
                    title: 'Streak در خطر است! 🔥',
                    body: 'امروز مرور نکردید - streak خود را حفظ کنید'
                });

                // Morning motivation
                this.scheduleDaily('morning_motivation', {
                    hour: 8,
                    minute: 0,
                    title: 'صبح بخیر! ☀️',
                    body: 'یک روز عالی برای یادگیری در پیش است'
                });
            },

            // Schedule a daily notification
            scheduleDaily(id, config) {
                const existing = this.scheduledNotifications.find(n => n.id === id);
                
                if (existing) {
                    existing.config = config;
                    existing.enabled = true;
                } else {
                    this.scheduledNotifications.push({
                        id: id,
                        type: 'daily',
                        config: config,
                        enabled: true,
                        lastShown: null
                    });
                }

                DB.set('scheduledNotifications', this.scheduledNotifications);
            },

            // Toggle a scheduled notification
            toggleNotification(id, enabled) {
                const notification = this.scheduledNotifications.find(n => n.id === id);
                if (notification) {
                    notification.enabled = enabled;
                    DB.set('scheduledNotifications', this.scheduledNotifications);
                }
            },

            // Start the notification scheduler
            startScheduler() {
                // Check every minute
                setInterval(() => this.checkScheduledNotifications(), 60000);
                
                // Also check immediately
                this.checkScheduledNotifications();
            },

            checkScheduledNotifications() {
                if (this.permission !== 'granted') return;

                const now = new Date();
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();
                const today = now.toDateString();

                this.scheduledNotifications.forEach(notification => {
                    if (!notification.enabled) return;
                    if (notification.lastShown === today) return;

                    const config = notification.config;
                    
                    if (currentHour === config.hour && currentMinute === config.minute) {
                        // Check conditions before showing
                        if (this.shouldShowNotification(notification)) {
                            this.show(config.title, config.body, {
                                tag: notification.id
                            });
                            notification.lastShown = today;
                            DB.set('scheduledNotifications', this.scheduledNotifications);
                        }
                    }
                });
            },

            shouldShowNotification(notification) {
                const reviews = DB.get('reviews', []);
                const today = new Date().toDateString();
                const todayReviews = reviews.filter(r => 
                    new Date(r.timestamp).toDateString() === today
                );

                switch (notification.id) {
                    case 'review_reminder':
                        // Only show if haven't reviewed today
                        return todayReviews.length === 0;
                    
                    case 'streak_warning':
                        // Only show if haven't reviewed and it's getting late
                        return todayReviews.length === 0;
                    
                    case 'morning_motivation':
                        // Always show morning motivation
                        return true;
                    
                    default:
                        return true;
                }
            },

            // Trigger specific notifications based on events
            onReviewComplete(count) {
                if (this.permission !== 'granted') return;

                const settings = Settings.get();
                const goal = settings.dailyGoal || 20;

                if (count >= goal) {
                    this.show('هدف روزانه تکمیل شد! 🎯', `عالی! ${Utils.toPersian(count)} کارت مرور کردید`);
                }
            },

            onStreakMilestone(streak) {
                if (this.permission !== 'granted') return;

                const milestones = [3, 7, 14, 30, 50, 100];
                if (milestones.includes(streak)) {
                    this.show(`🔥 ${Utils.toPersian(streak)} روز متوالی!`, 'به پیشرفت فوق‌العاده‌ات ادامه بده!');
                }
            },

            onBadgeEarned(badge) {
                if (this.permission !== 'granted') return;

                this.show(`مدال جدید! ${badge.icon}`, badge.name);
            },

            onLevelUp(level) {
                if (this.permission !== 'granted') return;

                this.show(`🎉 سطح ${Utils.toPersian(level)}!`, 'تبریک! به سطح جدید رسیدید');
            },

            // Get notification settings for UI
            getSettings() {
                return {
                    permission: this.permission,
                    notifications: this.scheduledNotifications
                };
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // ENHANCED GAMIFICATION HOOKS
        // ═══════════════════════════════════════════════════════════════
        const originalAddXP = Gamification.addXP;
        Gamification.addXP = function(amount, reason) {
            const oldLevel = this.getData().level;
            const result = originalAddXP.call(this, amount, reason);
            const newLevel = this.getData().level;
            
            // Check for level up
            if (newLevel > oldLevel) {
                SmartNotifications.onLevelUp(newLevel);
            }
            
            return result;
        };

        const originalEarnBadge = Gamification.earnBadge;
        Gamification.earnBadge = function(badgeId) {
            const badge = this.badges.find(b => b.id === badgeId);
            const result = originalEarnBadge.call(this, badgeId);
            
            if (badge) {
                SmartNotifications.onBadgeEarned(badge);
            }
            
            return result;
        };

        // ═══════════════════════════════════════════════════════════════
        // ENHANCED REVIEW HOOKS FOR FLASHCARD WITH IMAGE
        // ═══════════════════════════════════════════════════════════════
        const originalShowCard3 = Review.showCard;
        Review.showCard = function() {
            originalShowCard3.call(this);
            
            if (!this.currentCard) return;

            // Add image to flashcard if exists
            const flashcardFront = document.querySelector('.flashcard-front');
            const flashcardBack = document.querySelector('.flashcard-back');
            
            if (this.currentCard.image && flashcardFront) {
                // Check if image already added
                if (!flashcardFront.querySelector('.card-image')) {
                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'card-image-container';
                    imgContainer.innerHTML = `
                        <img src="${this.currentCard.image}" class="card-image" alt="${this.currentCard.word}">
                    `;
                    flashcardFront.insertBefore(imgContainer, flashcardFront.firstChild);
                }
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // SETTINGS PAGE ADDITIONS
        // ═══════════════════════════════════════════════════════════════
        const SettingsUI = {
            addNotificationSettings() {
                const settingsContainer = document.querySelector('#settings .settings-section');
                if (!settingsContainer) return;

                // Check if already added
                if (document.getElementById('notificationSettingsSection')) return;

                const notifSection = document.createElement('div');
                notifSection.id = 'notificationSettingsSection';
                notifSection.className = 'settings-section';
                notifSection.innerHTML = `
                    <h3 class="settings-section-title">🔔 اعلان‌ها</h3>
                    <div class="setting-item" onclick="SmartNotifications.showModal()">
                        <div class="setting-info">
                            <div class="setting-label">مدیریت اعلان‌ها</div>
                            <div class="setting-desc">یادآوری مرور و پیشرفت</div>
                        </div>
                        <div class="setting-value" id="notifStatus">
                            ${SmartNotifications.permission === 'granted' ? '✅ فعال' : '❌ غیرفعال'}
                        </div>
                    </div>
                    <div class="setting-item" onclick="InstallManager.showInstallGuide()">
                        <div class="setting-info">
                            <div class="setting-label">نصب برنامه</div>
                            <div class="setting-desc">نصب روی صفحه اصلی گوشی</div>
                        </div>
                        <div class="setting-value">📲</div>
                    </div>
                `;

                settingsContainer.parentNode.insertBefore(notifSection, settingsContainer.nextSibling);
            },

            addReadingButton() {
                // Add Spaced Reading button to home action buttons
                const actionGrid = document.querySelector('.action-buttons-grid');
                if (actionGrid && !actionGrid.querySelector('[data-action="reading"]')) {
                    const readingBtn = document.createElement('div');
                    readingBtn.className = 'action-btn';
                    readingBtn.setAttribute('data-action', 'reading');
                    readingBtn.onclick = () => SpacedReading.open();
                    readingBtn.innerHTML = `
                        <div class="action-btn-icon" style="background: linear-gradient(135deg, #fef3c7, #fde68a);">📖</div>
                        <div class="action-btn-text">مطالعه</div>
                    `;
                    actionGrid.appendChild(readingBtn);
                }
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // FINAL INITIALIZATION - UPDATED
        // ═══════════════════════════════════════════════════════════════
        const FinalInit = {
            run() {
                // Initialize new systems
                InstallManager.init();
                SmartNotifications.init();
                
                // Add UI enhancements
                setTimeout(() => {
                    SettingsUI.addNotificationSettings();
                    SettingsUI.addReadingButton();
                    Library.init();
                }, 500);

                // Re-render library when navigating
                const originalNavGo = Navigation.go;
                Navigation.go = function(screenId) {
                    originalNavGo.call(this, screenId);
                    
                    if (screenId === 'library') {
                        setTimeout(() => Library.render(), 100);
                    }
                };

                console.log('✅ LEXORA v3.5 - All new features initialized');
            }
        };

        // Override final init
        const originalAppInit3 = App.init;
        App.init = function() {
            originalAppInit3.call(this);
            setTimeout(() => FinalInit.run(), 200);
        };

        // Run if already loaded
        if (document.readyState === 'complete') {
            setTimeout(() => FinalInit.run(), 200);
        }
    </script>
	<!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- MODE SELECTOR MODAL -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    <div id="modeSelectorModal" class="mode-selector-modal">
        <div class="mode-selector-container">
            <div class="mode-selector-header">
                <h2>🎮 انتخاب حالت مرور</h2>
                <button class="modal-close" onclick="ModeSelector.close()">✕</button>
            </div>
            <div class="mode-selector-body">
                <div class="mode-option selected" data-mode="recognition" onclick="ModeSelector.select('recognition')">
                    <div class="mode-option-icon">👁️</div>
                    <div class="mode-option-info">
                        <div class="mode-option-title">شناسایی (Recognition)</div>
                        <div class="mode-option-desc">کلمه را ببینید و معنی را به خاطر بیاورید</div>
                    </div>
                </div>

                <div class="mode-option" data-mode="reverse" onclick="ModeSelector.select('reverse')">
                    <div class="mode-option-icon">🔄</div>
                    <div class="mode-option-info">
                        <div class="mode-option-title">معکوس (Reverse)</div>
                        <div class="mode-option-desc">معنی فارسی را ببینید و کلمه انگلیسی را حدس بزنید</div>
                    </div>
                </div>

                <div class="mode-option" data-mode="listening" onclick="ModeSelector.select('listening')">
                    <div class="mode-option-icon">🎧</div>
                    <div class="mode-option-info">
                        <div class="mode-option-title">شنیداری (Listening)</div>
                        <div class="mode-option-desc">صدا را بشنوید و کلمه را تایپ کنید</div>
                    </div>
                </div>

                <div class="mode-option" data-mode="spelling" onclick="ModeSelector.select('spelling')">
                    <div class="mode-option-icon">✍️</div>
                    <div class="mode-option-info">
                        <div class="mode-option-title">املا (Spelling)</div>
                        <div class="mode-option-desc">معنی را ببینید و املای کلمه را تایپ کنید</div>
                    </div>
                </div>

                <div class="mode-option" data-mode="quiz" onclick="ModeSelector.select('quiz')">
                    <div class="mode-option-icon">🎯</div>
                    <div class="mode-option-info">
                        <div class="mode-option-title">آزمون (Quiz)</div>
                        <div class="mode-option-desc">از بین چهار گزینه معنی درست را انتخاب کنید</div>
                    </div>
                </div>

                <button class="mode-start-btn" onclick="ModeSelector.startReview()">
                    🚀 شروع مرور
                </button>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- LISTENING MODE CONTAINER (داخل flashcardModal) -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    <div id="listeningMode" class="card-mode">
        <div class="listening-container">
            <div class="listening-icon">🎧</div>
            <div class="listening-hint">به تلفظ کلمه گوش دهید و آن را تایپ کنید</div>
            
            <button class="listening-play-btn" onclick="Review.speakCurrent()">
                🔊
            </button>
            
            <input type="text" class="listening-input" id="listeningInput" 
                   placeholder="کلمه انگلیسی را تایپ کنید..." autocomplete="off">
            
            <button class="check-answer-btn" onclick="Review.checkListening()">
                بررسی پاسخ
            </button>
            
            <div class="recall-feedback hidden" id="listeningFeedback">
                <div class="feedback-icon" id="listeningFeedbackIcon">✅</div>
                <div class="feedback-text" id="listeningFeedbackText">آفرین!</div>
                <div class="correct-answer">
                    پاسخ صحیح: <strong id="listeningCorrectAnswer">word</strong>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- SPELLING MODE CONTAINER -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    <div id="spellingMode" class="card-mode">
        <div class="recall-container">
            <div class="recall-question">
                <div class="reverse-meaning" id="spellingMeaning">معنی</div>
                <div class="recall-example" id="spellingExample">مثال کاربردی</div>
            </div>

            <div class="recall-input-area" id="spellingInputArea">
                <label class="recall-label">کلمه انگلیسی را تایپ کنید:</label>
                <input type="text" class="recall-input" id="spellingInput" 
                       placeholder="English word..." autocomplete="off" dir="ltr">
                <button class="check-answer-btn" onclick="Review.checkSpelling()">
                    بررسی پاسخ
                </button>
            </div>

            <div class="recall-feedback hidden" id="spellingFeedback">
                <div class="feedback-icon" id="spellingFeedbackIcon">✅</div>
                <div class="feedback-text" id="spellingFeedbackText">آفرین!</div>
                <div class="correct-answer">
                    پاسخ صحیح: <strong id="spellingCorrectAnswer">word</strong>
                </div>
                <div class="recall-mnemonic" id="spellingMnemonic">💡 نکته</div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- REVERSE MODE CONTAINER -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    <div id="reverseMode" class="card-mode">
        <div class="flashcard-container">
            <div class="flashcard" id="reverseFlashcard" onclick="Review.flipReverse()">
                <div class="flashcard-inner">
                    <div class="flashcard-front reverse-card-front">
                        <div class="reverse-meaning" id="reverseMeaning">معنی فارسی</div>
                        <div class="reverse-hint-text">کلمه انگلیسی چیست؟</div>
                        <div class="flip-hint">👆 برای دیدن جواب کلیک کنید</div>
                    </div>
                    <div class="flashcard-back">
                        <button class="speak-btn" onclick="event.stopPropagation(); Review.speakCurrent()">🔊</button>
                        <div class="card-word" id="reverseWord">Word</div>
                        <div class="card-pronunciation" id="reversePronunciation">/pronunciation/</div>
                        <div class="card-example" id="reverseExample">مثال</div>
                        <div class="card-mnemonic" id="reverseMnemonic">💡 نکته</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- QUIZ MODE CONTAINER -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    <div id="quizMode" class="card-mode">
        <div class="quiz-container">
            <button class="speak-btn" onclick="Review.speakCurrent()" 
                    style="position: absolute; top: 16px; right: 16px;">🔊</button>
            
            <div class="quiz-question">
                <div class="quiz-word" id="quizWord">Word</div>
                <div class="quiz-pronunciation" id="quizPronunciation">/pronunciation/</div>
            </div>

            <div class="quiz-options" id="quizOptions">
                <!-- Options will be generated by JS -->
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- DICTIONARY MODAL -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    <div id="dictionaryModal" class="dictionary-modal">
        <div class="dictionary-container">
            <div class="dictionary-header">
                <div class="dictionary-search-box">
                    <input type="text" class="dictionary-input" id="dictionaryInput" 
                           placeholder="کلمه انگلیسی را وارد کنید..." dir="ltr">
                    <button class="dictionary-search-btn" onclick="Dictionary.search()">
                        🔍
                    </button>
                </div>
                <button class="modal-close" onclick="Dictionary.close()" style="margin-top: 12px;">✕ بستن</button>
            </div>
            <div class="dictionary-body" id="dictionaryBody">
                <div class="dictionary-placeholder" style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                    <div style="font-size: 64px; margin-bottom: 16px;">📖</div>
                    <div style="font-size: 16px;">کلمه‌ای را جستجو کنید</div>
                    <div style="font-size: 14px; margin-top: 8px; opacity: 0.7;">
                        معنی، تلفظ و مثال را ببینید و به دک اضافه کنید
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- DECK MANAGER MODAL -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    <div id="deckManagerModal" class="deck-manager-modal">
        <div class="deck-manager-container">
            <div class="deck-manager-header">
                <h2>📚 مدیریت دک‌ها</h2>
                <button class="modal-close" onclick="DeckManager.close()">✕</button>
            </div>
            <div class="deck-manager-body">
                <!-- Tabs -->
                <div class="mode-toggle" style="margin-bottom: 20px;">
                    <button class="mode-btn active" onclick="DeckManager.showTab('create')">➕ ساخت دک</button>
                    <button class="mode-btn" onclick="DeckManager.showTab('my-decks')">📁 دک‌های من</button>
                    <button class="mode-btn" onclick="DeckManager.showTab('import')">📥 وارد کردن</button>
                </div>

                <!-- Create Deck Tab -->
                <div id="createDeckTab" class="deck-tab active">
                    <div class="deck-form-section">
                        <h3>📝 اطلاعات دک</h3>
                        <div class="form-group">
                            <label class="form-label">نام دک</label>
                            <input type="text" class="form-input" id="newDeckName" 
                                   placeholder="مثال: کلمات پیشرفته">
                        </div>
                        <div class="form-group">
                            <label class="form-label">توضیحات</label>
                            <textarea class="form-input form-textarea" id="newDeckDesc" 
                                      placeholder="توضیح کوتاه درباره این دک..."></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">آیکون</label>
                            <div class="emoji-picker" id="emojiPicker">
                                <div class="emoji-option selected" data-emoji="📚">📚</div>
                                <div class="emoji-option" data-emoji="🎯">🎯</div>
                                <div class="emoji-option" data-emoji="💼">💼</div>
                                <div class="emoji-option" data-emoji="🎓">🎓</div>
                                <div class="emoji-option" data-emoji="✈️">✈️</div>
                                <div class="emoji-option" data-emoji="🏠">🏠</div>
                                <div class="emoji-option" data-emoji="💻">💻</div>
                                <div class="emoji-option" data-emoji="🎬">🎬</div>
                                <div class="emoji-option" data-emoji="🎵">🎵</div>
                                <div class="emoji-option" data-emoji="⚽">⚽</div>
                                <div class="emoji-option" data-emoji="🍔">🍔</div>
                                <div class="emoji-option" data-emoji="❤️">❤️</div>
                            </div>
                        </div>
                    </div>

                    <div class="deck-form-section">
                        <h3>🃏 کارت‌ها</h3>
                        <div id="cardFormList">
                            <!-- Card forms will be added here -->
                        </div>
                        <button class="add-card-btn" onclick="DeckManager.addCardForm()">
                            ➕ افزودن کارت جدید
                        </button>
                    </div>

                    <button class="save-deck-btn" onclick="DeckManager.saveDeck()">
                        💾 ذخیره دک
                    </button>
                </div>

                <!-- My Decks Tab -->
                <div id="myDecksTab" class="deck-tab" style="display: none;">
                    <div id="myDecksList" class="my-decks-list">
                        <!-- Custom decks will be listed here -->
                    </div>
                </div>

                <!-- Import Tab -->
                <div id="importTab" class="deck-tab" style="display: none;">
                    <div class="deck-form-section">
                        <h3>📥 وارد کردن از CSV</h3>
                        <div class="csv-import-area" id="csvImportArea" onclick="document.getElementById('csvFileInput').click()">
                            <div class="csv-import-icon">📄</div>
                            <div class="csv-import-text">فایل CSV را اینجا بکشید یا کلیک کنید</div>
                            <div class="csv-import-hint">فرمت: word, pronunciation, meaning, example, mnemonic</div>
                        </div>
                        <input type="file" id="csvFileInput" accept=".csv" style="display: none;" 
                               onchange="DeckManager.importCSV(event)">
                    </div>

                    <div class="deck-form-section">
                        <h3>📋 نمونه فرمت CSV</h3>
                        <pre style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; font-size: 12px; overflow-x: auto; direction: ltr;">
word,pronunciation,meaning,example,mnemonic
hello,/həˈloʊ/,سلام,Hello world!,هِلو صدای زنگ در
goodbye,/ɡʊdˈbaɪ/,خداحافظ,Goodbye friend,گود بای = خدای خوب</pre>
                        <button class="btn-block btn-secondary" onclick="DeckManager.downloadSampleCSV()" style="margin-top: 12px;">
                            📥 دانلود نمونه CSV
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- ADD TO DECK MODAL -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    <div id="addToDeckModal" class="confirm-overlay">
        <div class="confirm-modal" style="max-width: 360px;">
            <div class="confirm-header">➕ افزودن به دک</div>
            <div class="confirm-body">
                <div class="form-group">
                    <label class="form-label">انتخاب دک:</label>
                    <select class="form-input" id="selectDeckForAdd" style="padding: 14px;">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
            </div>
            <div class="confirm-actions">
                <button class="confirm-cancel" onclick="Dictionary.closeAddModal()">انصراف</button>
                <button class="confirm-delete" style="background: var(--success);" onclick="Dictionary.confirmAddToDeck()">
                    افزودن
                </button>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- FAB BUTTONS -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    <div class="fab-container">
        <button class="fab-btn fab-dictionary" onclick="Dictionary.open()" title="دیکشنری">
            📖
        </button>
        <button class="fab-btn fab-add-deck" onclick="DeckManager.open()" title="ساخت دک">
            ➕
        </button>
    </div>
	<!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- LEVEL UP MODAL -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    <div id="levelUpModal" class="level-up-modal">
        <div class="level-up-content">
            <div class="level-up-icon">🎉</div>
            <div class="level-up-title">سطح بالا رفت!</div>
            <div class="level-up-level" id="newLevelDisplay">۵</div>
            <div class="level-up-reward" id="levelUpReward">🎁 ۵۰ XP جایزه دریافت کردید!</div>
            <button class="level-up-btn" onclick="Gamification.closeLevelUp()">عالی! 🚀</button>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- BADGE DETAIL MODAL -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    <div id="badgeDetailModal" class="confirm-overlay">
        <div class="confirm-modal" style="max-width: 320px; text-align: center;">
            <div style="font-size: 64px; margin-bottom: 16px;" id="badgeDetailIcon">🏆</div>
            <div class="confirm-header" id="badgeDetailName">نام مدال</div>
            <div class="confirm-body" style="padding: 0 20px 20px;">
                <p id="badgeDetailDesc" style="color: var(--text-secondary); margin-bottom: 12px;">توضیحات مدال</p>
                <div id="badgeDetailStatus" style="font-weight: 700; color: var(--success);">✅ کسب شده</div>
            </div>
            <div class="confirm-actions">
                <button class="confirm-cancel" onclick="Gamification.closeBadgeDetail()" style="flex: 1;">بستن</button>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- CHALLENGES MODAL -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    <div id="challengesModal" class="dictionary-modal">
        <div class="dictionary-container">
            <div class="deck-manager-header">
                <h2>🏆 چالش‌های یادگیری</h2>
                <button class="modal-close" onclick="Challenges.close()">✕</button>
            </div>
            <div class="dictionary-body" style="padding: 20px;">
                <!-- Daily Challenges -->
                <div class="section-title" style="margin-bottom: 16px;">
                    <span>📅</span> چالش‌های روزانه
                </div>
                <div id="dailyChallenges">
                    <!-- Will be populated by JS -->
                </div>

                <!-- Weekly Challenges -->
                <div class="section-title" style="margin: 24px 0 16px;">
                    <span>📆</span> چالش‌های هفتگی
                </div>
                <div id="weeklyChallenges">
                    <!-- Will be populated by JS -->
                </div>

                <!-- Special Challenges -->
                <div class="section-title" style="margin: 24px 0 16px;">
                    <span>⭐</span> چالش‌های ویژه
                </div>
                <div id="specialChallenges">
                    <!-- Will be populated by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- ADVANCED STATS MODAL -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    <div id="advancedStatsModal" class="dictionary-modal">
        <div class="dictionary-container">
            <div class="deck-manager-header">
                <h2>📊 آمار پیشرفته</h2>
                <button class="modal-close" onclick="AdvancedStats.close()">✕</button>
            </div>
            <div class="dictionary-body" style="padding: 20px;">
                <!-- Mini Stats -->
                <div class="mini-stats">
                    <div class="mini-stat-card">
                        <div class="mini-stat-icon xp">⚡</div>
                        <div class="mini-stat-info">
                            <div class="mini-stat-value" id="totalXpStat">۰</div>
                            <div class="mini-stat-label">کل XP</div>
                        </div>
                    </div>
                    <div class="mini-stat-card">
                        <div class="mini-stat-icon streak">🔥</div>
                        <div class="mini-stat-info">
                            <div class="mini-stat-value" id="maxStreakStat">۰</div>
                            <div class="mini-stat-label">بیشترین Streak</div>
                        </div>
                    </div>
                    <div class="mini-stat-card">
                        <div class="mini-stat-icon accuracy">🎯</div>
                        <div class="mini-stat-info">
                            <div class="mini-stat-value" id="avgAccuracyStat">۰٪</div>
                            <div class="mini-stat-label">میانگین دقت</div>
                        </div>
                    </div>
                    <div class="mini-stat-card">
                        <div class="mini-stat-icon mastered">✅</div>
                        <div class="mini-stat-info">
                            <div class="mini-stat-value" id="totalMasteredStat">۰</div>
                            <div class="mini-stat-label">تسلط یافته</div>
                        </div>
                    </div>
                </div>

                <!-- Heat Map -->
                <div class="heatmap-section">
                    <div class="heatmap-container">
                        <div class="heatmap-header">
                            <div class="heatmap-title">📅 فعالیت سالانه</div>
                            <div class="heatmap-year-nav">
                                <button class="heatmap-year-btn" onclick="AdvancedStats.prevYear()">◀</button>
                                <span class="heatmap-year" id="heatmapYear">۱۴۰۳</span>
                                <button class="heatmap-year-btn" onclick="AdvancedStats.nextYear()">▶</button>
                            </div>
                        </div>
                        <div class="heatmap-months">
                            <span class="heatmap-month">فرو</span>
                            <span class="heatmap-month">ارد</span>
                            <span class="heatmap-month">خرد</span>
                            <span class="heatmap-month">تیر</span>
                            <span class="heatmap-month">مرد</span>
                            <span class="heatmap-month">شهر</span>
                            <span class="heatmap-month">مهر</span>
                            <span class="heatmap-month">آبا</span>
                            <span class="heatmap-month">آذر</span>
                            <span class="heatmap-month">دی</span>
                            <span class="heatmap-month">بهم</span>
                            <span class="heatmap-month">اسف</span>
                        </div>
                        <div class="heatmap-grid-wrapper">
                            <div class="heatmap-days">
                                <span class="heatmap-day-label">ش</span>
                                <span class="heatmap-day-label">د</span>
                                <span class="heatmap-day-label">س</span>
                                <span class="heatmap-day-label">چ</span>
                                <span class="heatmap-day-label">پ</span>
                                <span class="heatmap-day-label">ج</span>
                                <span class="heatmap-day-label">ش</span>
                            </div>
                            <div class="heatmap-grid" id="heatmapGrid">
                                <!-- Will be populated by JS -->
                            </div>
                        </div>
                        <div class="heatmap-legend">
                            <span>کمتر</span>
                            <div class="heatmap-legend-cell" style="background: var(--bg-tertiary);"></div>
                            <div class="heatmap-legend-cell level-1"></div>
                            <div class="heatmap-legend-cell level-2"></div>
                            <div class="heatmap-legend-cell level-3"></div>
                            <div class="heatmap-legend-cell level-4"></div>
                            <div class="heatmap-legend-cell level-5"></div>
                            <span>بیشتر</span>
                        </div>
                    </div>
                </div>

                <!-- Weakness Analysis -->
                <div class="weakness-section">
                    <div class="section-title" style="margin-bottom: 16px;">
                        <span>📉</span> کلمات نیازمند تمرین بیشتر
                    </div>
                    <div class="weakness-card" id="weaknessCard">
                        <!-- Will be populated by JS -->
                    </div>
                </div>

                <!-- Learning Progress Chart -->
                <div class="section-title" style="margin: 24px 0 16px;">
                    <span>📈</span> روند یادگیری ۷ روز اخیر
                </div>
                <div class="weakness-card">
                    <div id="progressChart" style="height: 200px; display: flex; align-items: flex-end; justify-content: space-around; gap: 8px; padding: 20px 0;">
                        <!-- Will be populated by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- TAG MANAGER MODAL -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    <div id="tagManagerModal" class="dictionary-modal">
        <div class="dictionary-container">
            <div class="deck-manager-header">
                <h2>🏷️ مدیریت تگ‌ها</h2>
                <button class="modal-close" onclick="TagSystem.close()">✕</button>
            </div>
            <div class="dictionary-body" style="padding: 20px;">
                <!-- Quick Filters -->
                <div class="section-title" style="margin-bottom: 16px;">
                    <span>🔍</span> فیلتر سریع
                </div>
                <div class="tags-filter" id="tagsFilter">
                    <button class="tag-filter-btn active" data-tag="all" onclick="TagSystem.filter('all')">
                        همه <span class="tag-count" id="tagCountAll">۰</span>
                    </button>
                    <button class="tag-filter-btn" data-tag="starred" onclick="TagSystem.filter('starred')">
                        ⭐ ستاره‌دار <span class="tag-count" id="tagCountStarred">۰</span>
                    </button>
                    <button class="tag-filter-btn" data-tag="difficult" onclick="TagSystem.filter('difficult')">
                        🔴 سخت <span class="tag-count" id="tagCountDifficult">۰</span>
                    </button>
                    <button class="tag-filter-btn" data-tag="new" onclick="TagSystem.filter('new')">
                        🆕 جدید <span class="tag-count" id="tagCountNew">۰</span>
                    </button>
                    <button class="tag-filter-btn" data-tag="mastered" onclick="TagSystem.filter('mastered')">
                        ✅ تسلط <span class="tag-count" id="tagCountMastered">۰</span>
                    </button>
                </div>

                <!-- Part of Speech Tags -->
                <div class="section-title" style="margin: 24px 0 16px;">
                    <span>📝</span> نوع کلمه
                </div>
                <div class="tags-filter" id="posTagsFilter">
                    <button class="tag-filter-btn" data-tag="noun" onclick="TagSystem.filter('noun')">
                        اسم <span class="tag-count" id="tagCountNoun">۰</span>
                    </button>
                    <button class="tag-filter-btn" data-tag="verb" onclick="TagSystem.filter('verb')">
                        فعل <span class="tag-count" id="tagCountVerb">۰</span>
                    </button>
                    <button class="tag-filter-btn" data-tag="adjective" onclick="TagSystem.filter('adjective')">
                        صفت <span class="tag-count" id="tagCountAdjective">۰</span>
                    </button>
                    <button class="tag-filter-btn" data-tag="adverb" onclick="TagSystem.filter('adverb')">
                        قید <span class="tag-count" id="tagCountAdverb">۰</span>
                    </button>
                </div>

                <!-- Filtered Cards List -->
                <div class="section-title" style="margin: 24px 0 16px;">
                    <span>🃏</span> کارت‌ها (<span id="filteredCount">۰</span>)
                </div>
                <div id="filteredCardsList" style="max-height: 400px; overflow-y: auto;">
                    <!-- Will be populated by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- ADD TAG TO CARD MODAL -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    <div id="addTagModal" class="confirm-overlay">
        <div class="confirm-modal" style="max-width: 360px;">
            <div class="confirm-header">🏷️ افزودن تگ</div>
            <div class="confirm-body">
                <div class="form-group">
                    <label class="form-label">انتخاب تگ:</label>
                    <div class="tags-filter" style="margin-top: 8px;" id="tagSelectOptions">
                        <!-- Tags will be populated by JS -->
                    </div>
                </div>
                <div class="form-group" style="margin-top: 16px;">
                    <label class="form-label">یا تگ جدید بسازید:</label>
                    <input type="text" class="form-input" id="newTagInput" placeholder="نام تگ جدید...">
                </div>
            </div>
            <div class="confirm-actions">
                <button class="confirm-cancel" onclick="TagSystem.closeAddTag()">انصراف</button>
                <button class="confirm-delete" style="background: var(--primary);" onclick="TagSystem.confirmAddTag()">
                    افزودن
                </button>
            </div>
        </div>
    </div>
	<!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- VOICE MODE MODAL -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    <div id="voiceModeModal" class="dictionary-modal">
        <div class="dictionary-container">
            <div class="deck-manager-header">
                <h2>🎤 حالت صوتی</h2>
                <button class="modal-close" onclick="VoiceMode.close()">✕</button>
            </div>
            <div class="dictionary-body" style="padding: 20px;">
                <!-- Mode Selection -->
                <div class="mode-toggle" style="margin-bottom: 24px;">
                    <button class="mode-btn active" onclick="VoiceMode.setMode('listen')">🎧 گوش دادن</button>
                    <button class="mode-btn" onclick="VoiceMode.setMode('speak')">🎤 صحبت کردن</button>
                </div>

                <!-- Listen Mode -->
                <div id="voiceListenMode" class="voice-mode-content active">
                    <div class="audio-player">
                        <div class="audio-word-display">
                            <div class="audio-word" id="audioWord">Hello</div>
                            <div class="audio-pronunciation" id="audioPronunciation">/həˈloʊ/</div>
                        </div>
                        
                        <div class="audio-waveform" id="audioWaveform">
                            <div class="waveform-bar"></div>
                            <div class="waveform-bar"></div>
                            <div class="waveform-bar"></div>
                            <div class="waveform-bar"></div>
                            <div class="waveform-bar"></div>
                            <div class="waveform-bar"></div>
                            <div class="waveform-bar"></div>
                        </div>

                        <div class="audio-controls">
                            <button class="audio-btn" onclick="VoiceMode.prevWord()">⏮️</button>
                            <button class="audio-btn play" id="audioPlayBtn" onclick="VoiceMode.togglePlay()">▶️</button>
                            <button class="audio-btn" onclick="VoiceMode.nextWord()">⏭️</button>
                        </div>

                        <div class="audio-speed-control">
                            <span style="font-size: 12px; color: var(--text-secondary);">سرعت:</span>
                            <button class="speed-btn" data-speed="0.5" onclick="VoiceMode.setSpeed(0.5)">۰.۵x</button>
                            <button class="speed-btn active" data-speed="0.75" onclick="VoiceMode.setSpeed(0.75)">۰.۷۵x</button>
                            <button class="speed-btn" data-speed="1" onclick="VoiceMode.setSpeed(1)">۱x</button>
                            <button class="speed-btn" data-speed="1.25" onclick="VoiceMode.setSpeed(1.25)">۱.۲۵x</button>
                        </div>

                        <div style="text-align: center; margin-top: 20px;">
                            <button class="btn-primary" onclick="VoiceMode.showMeaning()" style="padding: 12px 32px;">
                                👁️ نمایش معنی
                            </button>
                        </div>

                        <div id="audioMeaningReveal" style="display: none; margin-top: 16px; text-align: center;">
                            <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);" id="audioMeaning">سلام</div>
                            <div style="font-size: 14px; color: var(--text-secondary); margin-top: 8px;" id="audioExample"></div>
                        </div>
                    </div>
                </div>

                <!-- Speak Mode (Voice Recognition) -->
                <div id="voiceSpeakMode" class="voice-mode-content" style="display: none;">
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 18px; color: var(--text-secondary); margin-bottom: 8px;">این کلمه را بخوانید:</div>
                        <div style="font-size: 36px; font-weight: 800; color: var(--text-primary); margin-bottom: 8px;" id="speakTargetWord">Hello</div>
                        <div style="font-size: 16px; color: var(--primary); margin-bottom: 32px;" id="speakTargetPron">/həˈloʊ/</div>
                        
                        <button class="voice-btn" id="voiceRecordBtn" onclick="VoiceMode.toggleRecording()">
                            🎤
                        </button>
                        
                        <div class="voice-status" id="voiceStatus">برای شروع ضبط کلیک کنید</div>
                        
                        <div class="voice-result" id="voiceResult" style="display: none;">
                            <div class="voice-result-text" id="voiceResultText"></div>
                            <div id="voiceResultFeedback"></div>
                        </div>

                        <div style="margin-top: 24px; display: flex; gap: 12px; justify-content: center;">
                            <button class="btn-secondary" onclick="VoiceMode.hearCorrect()">🔊 تلفظ صحیح</button>
                            <button class="btn-primary" onclick="VoiceMode.nextSpeakWord()">بعدی ➡️</button>
                        </div>
                    </div>
                </div>

                <!-- Word List for Practice -->
                <div class="section-title" style="margin-top: 24px;">
                    <span>📝</span> لیست کلمات
                </div>
                <div id="voiceWordList" style="max-height: 200px; overflow-y: auto;">
                    <!-- Words will be populated -->
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- AUDIO PLAYER FLOATING (for cards) -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    <div id="floatingAudioPlayer" class="floating-audio-player" style="display: none;">
        <div class="floating-audio-content">
            <button class="floating-audio-btn" onclick="AudioPlayer.toggleRepeat()">🔁</button>
            <button class="floating-audio-btn play" onclick="AudioPlayer.toggle()">▶️</button>
            <button class="floating-audio-btn" onclick="AudioPlayer.slower()">🐢</button>
            <button class="floating-audio-btn" onclick="AudioPlayer.faster()">🐇</button>
        </div>
    </div>
	<!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- DECK MANAGER MODAL -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    <div id="deckManagerModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h2>⚙️ مدیریت Deck ها</h2>
                <button class="modal-close" onclick="document.getElementById('deckManagerModal').classList.remove('active')">✕</button>
            </div>
            <div class="modal-body" id="deckManagerContent">
                <!-- Content rendered by JS -->
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- ADD CARD MODAL -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    <div id="addCardModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h2>➕ افزودن کارت جدید</h2>
                <button class="modal-close" onclick="document.getElementById('addCardModal').classList.remove('active')">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">کلمه انگلیسی *</label>
                    <input type="text" class="form-input" id="newCardWord" placeholder="مثال: Serendipity">
                    <button class="btn-icon input-addon" onclick="AddCard.fetchFromDictionary()" title="جستجوی خودکار">🔍</button>
                </div>
                <div class="form-group">
                    <label class="form-label">معنی فارسی *</label>
                    <input type="text" class="form-input" id="newCardMeaning" placeholder="مثال: خوش‌شانسی غیرمنتظره">
                </div>
                <div class="form-group">
                    <label class="form-label">تلفظ (اختیاری)</label>
                    <input type="text" class="form-input" id="newCardPronunciation" placeholder="مثال: /ˌserənˈdɪpɪti/">
                </div>
                <div class="form-group">
                    <label class="form-label">مثال (اختیاری)</label>
                    <textarea class="form-input form-textarea" id="newCardExample" placeholder="مثال: It was serendipity that we met."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">یادداشت / داستان ذهنی (اختیاری)</label>
                    <textarea class="form-input form-textarea" id="newCardNote" placeholder="هر چیزی که به یادآوری کمک کند..."></textarea>
                </div>
                <button class="btn-primary btn-block" onclick="AddCard.save()">
                    ✅ ذخیره کارت
                </button>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- EDIT CARD MODAL -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    <div id="editCardModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h2>✏️ ویرایش کارت</h2>
                <button class="modal-close" onclick="document.getElementById('editCardModal').classList.remove('active')">✕</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editCardId">
                <div class="form-group">
                    <label class="form-label">کلمه انگلیسی</label>
                    <input type="text" class="form-input" id="editCardWord">
                </div>
                <div class="form-group">
                    <label class="form-label">معنی فارسی</label>
                    <input type="text" class="form-input" id="editCardMeaning">
                </div>
                <div class="form-group">
                    <label class="form-label">مثال</label>
                    <textarea class="form-input form-textarea" id="editCardExample"></textarea>
                </div>
                <button class="btn-primary btn-block" onclick="AddCard.saveEdit()">
                    ✅ ذخیره تغییرات
                </button>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- READY DECKS MODAL -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    <div id="readyDecksModal" class="modal-overlay">
        <div class="modal-container modal-large">
            <div class="modal-header">
                <h2>📦 Deck های آماده</h2>
                <button class="modal-close" onclick="ReadyDecks.close()">✕</button>
            </div>
            <div class="modal-body">
                <!-- Categories -->
                <div class="ready-decks-categories">
                    <button class="category-btn active" onclick="ReadyDecks.filterCategory('all', this)">همه</button>
                    <button class="category-btn" onclick="ReadyDecks.filterCategory('exam', this)">آزمون‌ها</button>
                    <button class="category-btn" onclick="ReadyDecks.filterCategory('level', this)">سطح‌بندی</button>
                    <button class="category-btn" onclick="ReadyDecks.filterCategory('topic', this)">موضوعی</button>
                    <button class="category-btn" onclick="ReadyDecks.filterCategory('phrase', this)">اصطلاحات</button>
                </div>
                
                <!-- Decks Grid -->
                <div class="ready-decks-grid" id="readyDecksGrid">
                    <!-- Rendered by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- IMAGE CARD MODAL -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    <div id="imageCardModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h2>🖼️ کارت تصویری</h2>
                <button class="modal-close" onclick="ImageCard.close()">✕</button>
            </div>
            <div class="modal-body">
                <div class="image-upload-area" id="imageUploadArea" onclick="document.getElementById('imageInput').click()">
                    <div class="image-upload-icon">🖼️</div>
                    <div class="image-upload-text">برای آپلود تصویر کلیک کنید</div>
                    <div class="image-upload-hint">یا تصویر را اینجا رها کنید</div>
                    <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="ImageCard.handleUpload(event)">
                </div>
                <div id="imagePreviewContainer" style="display: none;">
                    <img id="imagePreview" class="image-preview">
                    <button class="btn-secondary btn-sm" onclick="ImageCard.removeImage()">🗑️ حذف تصویر</button>
                </div>
                
                <div class="form-group">
                    <label class="form-label">کلمه انگلیسی *</label>
                    <input type="text" class="form-input" id="imageCardWord" placeholder="مثال: Apple">
                </div>
                <div class="form-group">
                    <label class="form-label">معنی فارسی *</label>
                    <input type="text" class="form-input" id="imageCardMeaning" placeholder="مثال: سیب">
                </div>
                <div class="form-group">
                    <label class="form-label">توضیح تصویر (اختیاری)</label>
                    <input type="text" class="form-input" id="imageCardDesc" placeholder="توضیح کوتاه...">
                </div>
                
                <button class="btn-primary btn-block" onclick="ImageCard.save()">
                    ✅ ذخیره کارت تصویری
                </button>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- SPACED READING MODAL -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    <div id="spacedReadingModal" class="modal-overlay">
        <div class="modal-container modal-large">
            <div class="modal-header">
                <h2>📖 مطالعه فاصله‌دار</h2>
                <button class="modal-close" onclick="SpacedReading.close()">✕</button>
            </div>
            <div class="modal-body">
                <!-- Reading Mode Toggle -->
                <div class="reading-mode-toggle">
                    <button class="reading-mode-btn active" onclick="SpacedReading.setMode('learn', this)">🎓 یادگیری</button>
                    <button class="reading-mode-btn" onclick="SpacedReading.setMode('read', this)">📖 مطالعه</button>
                </div>

                <!-- Text Display -->
                <div class="reading-container">
                    <div class="reading-text" id="readingText">
                        <!-- Text with highlighted words will be here -->
                    </div>
                </div>

                <!-- Word Info Card -->
                <div class="word-info-card" id="wordInfoCard" style="display: none;">
                    <div class="word-info-header">
                        <span class="word-info-word" id="wordInfoWord"></span>
                        <button class="btn-icon-sm" onclick="AudioPlayer.speak(document.getElementById('wordInfoWord').textContent)">🔊</button>
                    </div>
                    <div class="word-info-meaning" id="wordInfoMeaning"></div>
                    <div class="word-info-example" id="wordInfoExample"></div>
                    <div class="word-info-actions">
                        <button class="btn-sm" onclick="SpacedReading.markKnown()">✅ می‌دانم</button>
                        <button class="btn-sm btn-primary" onclick="SpacedReading.addToReview()">➕ اضافه به مرور</button>
                    </div>
                </div>

                <!-- Reading Stats -->
                <div class="reading-stats">
                    <div class="reading-stat">
                        <span class="reading-stat-value" id="readingWordsCount">۰</span>
                        <span class="reading-stat-label">کلمه</span>
                    </div>
                    <div class="reading-stat">
                        <span class="reading-stat-value" id="readingKnownCount">۰</span>
                        <span class="reading-stat-label">شناخته</span>
                    </div>
                    <div class="reading-stat">
                        <span class="reading-stat-value" id="readingNewCount">۰</span>
                        <span class="reading-stat-label">جدید</span>
                    </div>
                </div>

                <!-- Sample Texts -->
                <div class="section-title" style="margin-top: 20px;">
                    <span>📚</span> متن‌های نمونه
                </div>
                <div class="sample-texts-grid" id="sampleTextsGrid">
                    <!-- Rendered by JS -->
                </div>

                <!-- Custom Text Input -->
                <div class="form-group" style="margin-top: 16px;">
                    <label class="form-label">متن دلخواه</label>
                    <textarea class="form-input form-textarea" id="customReadingText" rows="4" placeholder="متن انگلیسی خود را اینجا وارد کنید..."></textarea>
                    <button class="btn-primary btn-block" style="margin-top: 12px;" onclick="SpacedReading.loadCustomText()">
                        📖 شروع مطالعه
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- INSTALL PROMPT MODAL -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    <div id="installModal" class="modal-overlay">
        <div class="modal-container">
            <div class="install-modal-content">
                <div class="install-icon">📲</div>
                <h2>نصب LEXORA</h2>
                <p>برنامه را روی گوشی خود نصب کنید تا سریع‌تر به آن دسترسی داشته باشید.</p>
                
                <div class="install-steps" id="installSteps">
                    <!-- Steps will be shown based on device -->
                </div>

                <div class="install-buttons">
                    <button class="btn-primary btn-block" id="installBtn" onclick="InstallManager.install()">
                        📲 نصب برنامه
                    </button>
                    <button class="btn-secondary btn-block" onclick="InstallManager.later()">
                        بعداً
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- NOTIFICATION PERMISSION MODAL -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    <div id="notificationModal" class="modal-overlay">
        <div class="modal-container">
            <div class="notification-modal-content">
                <div class="notification-icon">🔔</div>
                <h2>اعلان‌های هوشمند</h2>
                <p>با فعال‌سازی اعلان‌ها، یادآوری مرور و پیشرفت‌های روزانه را دریافت کنید.</p>
                
                <div class="notification-features">
                    <div class="notification-feature">
                        <span class="feature-icon">⏰</span>
                        <span>یادآوری مرور روزانه</span>
                    </div>
                    <div class="notification-feature">
                        <span class="feature-icon">🔥</span>
                        <span>هشدار از دست دادن Streak</span>
                    </div>
                    <div class="notification-feature">
                        <span class="feature-icon">🏆</span>
                        <span>اطلاع از دستاوردها</span>
                    </div>
                </div>

                <div class="notification-buttons">
                    <button class="btn-primary btn-block" onclick="SmartNotifications.requestPermission()">
                        🔔 فعال‌سازی اعلان‌ها
                    </button>
                    <button class="btn-secondary btn-block" onclick="SmartNotifications.closeModal()">
                        بعداً
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>

